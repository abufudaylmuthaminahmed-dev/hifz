<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ﬁ§ﬁ™ﬁÉﬁ∞ﬁáﬁßﬁÇﬁ∞ ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ - V5.0 (Student View)</title>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');
        
        :root {
            --primary-color: #2c3e50;
            --accent-color: #27ae60;
            --student-color: #e67e22;
            --bg-color: #f4f7f6;
            --sidebar-width: 280px;
            --mushaf-width: 35%;
        }

        body {
            font-family: 'Faruma', 'MV Faseyha', 'Noto Sans Thaana', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SCREENS --- */
        .full-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 999;
        }

        #loading-overlay { background: white; z-index: 10000; }
        #login-screen { background: linear-gradient(135deg, #2c3e50, #3498db); color: white; }

        .login-box {
            background: white; padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
            width: 320px; color: #333;
        }
        .login-btn {
            width: 100%; padding: 12px; margin: 10px 0; border: none;
            border-radius: 8px; font-size: 16px; cursor: pointer;
            font-family: inherit; font-weight: bold; transition: 0.2s;
        }
        .btn-teacher { background: #2c3e50; color: white; }
        .btn-student { background: var(--student-color); color: white; }
        
        /* --- LAYOUTS --- */
        #teacher-dashboard, #student-dashboard {
            display: none; width: 100%; height: 100%;
        }
        .dashboard-active { display: flex !important; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); background: white; border-left: 1px solid #ddd;
            display: flex; flex-direction: column; padding: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); flex-shrink: 0;
        }

        .student-list-container { flex: 1; overflow-y: auto; }
        .student-btn {
            background: none; border: none; padding: 12px 10px; text-align: right; width: 100%;
            cursor: pointer; font-family: inherit; font-size: 14px; border-radius: 6px;
            margin-bottom: 4px; border-bottom: 1px solid #f9f9f9; transition: 0.2s; color: #2c3e50;
        }
        .student-btn:hover, .student-btn.active { background-color: #e8f6ef; color: var(--accent-color); font-weight:bold;}

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

        /* --- MUSHAF --- */
        .mushaf-panel {
            width: var(--mushaf-width); background: #2c3e50; display: flex; flex-direction: column;
            border-right: 1px solid #ccc; transition: width 0.3s;
        }
        .mushaf-container { flex: 1; overflow: auto; background: #fdfdfd; display: flex; justify-content: center; }
        .mushaf-wrapper { position: relative; display: inline-block; margin: 10px; }
        .mushaf-page-img { max-width: 100%; display: block; border: 1px solid #ddd; }
        
        .mistake-dot {
            position: absolute; width: 20px; height: 20px; background-color: rgba(231, 76, 60, 0.8);
            border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);
            z-index: 100; cursor: pointer;
        }
        /* Read-only dots for students */
        .mistake-dot.readonly { cursor: default; background-color: rgba(231, 76, 60, 1); border-color: yellow;}

        /* --- FORMS --- */
        .entry-form { background: white; padding: 20px; border-radius: 10px; }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;}
        
        .section-box { padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 2px solid transparent; }
        .section-box.active-section { border-color: var(--accent-color); background: white; border-left: 5px solid var(--accent-color); box-shadow: 0 5px 15px rgba(0,0,0,0.05);}
        .section-new { background: #eafaf1; } .section-short { background: #ebf5fb; } .section-long { background: #fef9e7; }

        /* --- CARDS --- */
        .history-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-right: 5px solid var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;}
        .card-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; }
        
        /* --- STUDENT VIEW SPECIFIC --- */
        .student-header-area {
            background: linear-gradient(to right, #e67e22, #f39c12); color: white;
            padding: 20px; border-radius: 10px; margin-bottom: 20px;
        }
        .student-stat-box {
            background: white; color: #333; padding: 15px; border-radius: 8px; text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex: 1;
        }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; position:relative;}
        .close-modal { position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; }

        .btn { padding: 8px 16px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; }
        .btn-green { background: var(--accent-color); }
        .btn-blue { background: #3498db; }
        .btn-red { background: #e74c3c; }
        
        .loader-spin { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay" class="full-screen">
        <div class="loader-spin"></div>
        <p>Loading...</p>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="full-screen" style="display:none;">
        <div class="login-box">
            <h2>ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞</h2>
            <button class="login-btn btn-student" onclick="loginAs('student')">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</button>
            <div style="margin:15px 0; border-bottom:1px solid #eee;"></div>
            <button class="login-btn btn-teacher" onclick="loginAs('teacher')">üë®‚Äçüè´ ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
        </div>
        <p style="margin-top:20px; opacity:0.7; font-size:12px;">¬© Hifz Tracker v5.0</p>
    </div>

    <!-- TEACHER DASHBOARD -->
    <div id="teacher-dashboard">
        <div class="sidebar">
            <h3 style="text-align:center; color:var(--primary-color);">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞</h3>
            <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px;">
                <label>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                <select id="classSelect" onchange="switchClass(this.value)" style="width:100%; margin-bottom:5px;"></select>
                <button class="btn btn-blue" style="width:100%; font-size:12px;" onclick="openSettingsModal()">‚öôÔ∏è ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞</button>
            </div>
            <h4>ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</h4>
            <div id="studentListContainer" class="student-list-container"></div>
            <button class="btn btn-red" onclick="logout()" style="margin-top:10px;">üö™ Logout</button>
        </div>

        <div class="main-content">
            <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border-radius:10px;">
                <h2 id="teacherHeader">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</h2>
                <div>
                    <button class="btn btn-green" onclick="exportExcel()">Excel</button>
                    <button class="btn btn-blue" onclick="toggleMushaf()">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ∞</button>
                </div>
            </div>

            <!-- TEACHER ENTRY FORM -->
            <div class="entry-form">
                <div class="form-row">
                    <div style="flex:1"><label>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="entryDate"></div>
                    <div style="flex:1"><label>ﬁàﬁ¶ﬁáﬁ∞ﬁåﬁ¶ﬁÉﬁ™</label>
                        <select id="lessonType" onchange="toggleFormSection(this.value)">
                            <option value="daily">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</option>
                            <option value="exam">ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</option>
                        </select>
                    </div>
                </div>

                <!-- Daily Sections -->
                <div id="container-daily">
                    <!-- NEW LESSON -->
                    <div id="box-new" class="section-box section-new active-section" onclick="setActiveSection('new')">
                        <label style="color:#27ae60; font-weight:bold;">ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ (ﬁÜﬁ™ﬁÅﬁ∞ﬁñﬁ¶ﬁÄﬁ¶ﬁÇﬁ∞ ﬁäﬁ®ﬁåﬁßﬁçﬁß)</label>
                        <div class="form-row">
                            <input type="number" id="newPage" placeholder="Page" onchange="loadMushaf(this.value)" style="flex:0.5">
                            <select id="newSurah" style="flex:2"><option>Surah...</option></select>
                            <input type="number" id="newStart" placeholder="Start" style="flex:0.8">
                            <input type="number" id="newEnd" placeholder="End" style="flex:0.8">
                            <input type="number" id="newMistakes" placeholder="Mistakes" style="flex:0.5" readonly>
                        </div>
                    </div>
                    <!-- Other sections (Short/Long) simplified for brevity but work same logic -->
                </div>

                <div style="margin-top:10px;">
                    <button class="btn btn-green" style="width:100%" onclick="saveRecord()">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß (ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁÜﬁ¶ﬁÇﬁ® ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ®)</button>
                </div>
            </div>

            <!-- HISTORY -->
            <div id="historyContainer"></div>
        </div>

        <div class="mushaf-panel" id="mushafPanel">
            <div class="mushaf-header">
                <span id="pageIndicator">Page 1</span>
                <div>
                    <button onclick="changePage(1)">></button>
                    <button onclick="changePage(-1)"><</button>
                </div>
            </div>
            <div class="mushaf-container">
                <div class="mushaf-wrapper" id="mushafWrapper" onclick="onImageClick(event)">
                    <img id="mushafImg" class="mushaf-page-img" src="">
                </div>
            </div>
        </div>
    </div>

    <!-- STUDENT DASHBOARD -->
    <div id="student-dashboard">
        <div class="sidebar">
            <h3 style="text-align:center; color:var(--student-color);">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁÑﬁ¶ﬁáﬁ®</h3>
            <div style="margin-bottom:20px;">
                <label>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                <select id="stClassSelect" onchange="stLoadStudents(this.value)" style="width:100%;"></select>
            </div>
            <label>ﬁÇﬁ¶ﬁÇﬁ∞:</label>
            <select id="stNameSelect" onchange="stSelectStudent(this.value)" style="width:100%;"></select>
            <button class="btn btn-red" onclick="logout()" style="margin-top:auto;">üö™ Logout</button>
        </div>

        <div class="main-content">
            <div class="student-header-area">
                <h2 id="stWelcomeName">ﬁâﬁ¶ﬁÉﬁ™ﬁôﬁ¶ﬁÑﬁß!</h2>
                <p>ﬁåﬁ®ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ®ﬁàﬁß ﬁåﬁßﬁàﬁ¶ﬁçﬁ™ﬁÇﬁ∞ ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨ ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁÑﬁ¶ﬁáﬁ∞ﬁçﬁ¶ﬁàﬁß.</p>
            </div>
            
            <div id="stHistoryContainer">
                <!-- Student records go here -->
            </div>
        </div>
    </div>

    <!-- MUSHAF MODAL (For Students) -->
    <div id="stMushafModal" class="modal">
        <div class="modal-content" style="width:600px; text-align:center;">
            <span class="close-modal" onclick="document.getElementById('stMushafModal').style.display='none'">&times;</span>
            <h3>ﬁÜﬁ™ﬁÅﬁ∞ ﬁäﬁßﬁÄﬁ¶ﬁéﬁ¶ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁéﬁÆﬁåﬁ∞</h3>
            <div style="position:relative; display:inline-block;" id="stMushafWrapper">
                <img id="stMushafImg" style="max-width:100%; border:1px solid #ddd;">
                <!-- Dots will be injected here -->
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL (Teacher) -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('settingsModal').style.display='none'">&times;</span>
            <h3>ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞</h3>
            <!-- Minimal settings for demo -->
            <label>ﬁáﬁ¶ﬁáﬁ™ ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
            <input type="text" id="newClassName">
            <button class="btn btn-blue" onclick="createNewClass()">ﬁÄﬁ¶ﬁãﬁß</button>
            <hr>
            <label>ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁáﬁ¨ﬁëﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Name, ID):</label>
            <textarea id="bulkStudents" style="width:100%; height:100px;"></textarea>
            <button class="btn btn-green" onclick="addStudentsBulk()">ﬁáﬁ¨ﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ≠</button>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    // PASTE YOUR FIREBASE CONFIG HERE
    const firebaseConfig = {
      apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
      authDomain: "hifz-cde3b.firebaseapp.com",
      databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
      projectId: "hifz-cde3b",
      storageBucket: "hifz-cde3b.firebasestorage.app",
      messagingSenderId: "566754658580",
      appId: "1:566754658580:web:d63d0f167960f53bab9a01"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch(e) { console.error(e); }

    // --- GLOBAL VARS ---
    const surahNames = ["ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©","ÿßŸÑÿ®ŸÇÿ±ÿ©","ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ","ÿßŸÑŸÜÿ≥ÿßÿ°","ÿßŸÑŸÖÿßÿ¶ÿØÿ©","ÿßŸÑÿ£ŸÜÿπÿßŸÖ","ÿßŸÑÿ£ÿπÿ±ÿßŸÅ","ÿßŸÑÿ£ŸÜŸÅÿßŸÑ","ÿßŸÑÿ™Ÿàÿ®ÿ©","ŸäŸàŸÜÿ≥","ŸáŸàÿØ","ŸäŸàÿ≥ŸÅ","ÿßŸÑÿ±ÿπÿØ","ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ","ÿßŸÑÿ≠ÿ¨ÿ±","ÿßŸÑŸÜÿ≠ŸÑ","ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°","ÿßŸÑŸÉŸáŸÅ","ŸÖÿ±ŸäŸÖ","ÿ∑Ÿá","ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°","ÿßŸÑÿ≠ÿ¨","ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ","ÿßŸÑŸÜŸàÿ±","ÿßŸÑŸÅÿ±ŸÇÿßŸÜ","ÿßŸÑÿ¥ÿπÿ±ÿßÿ°","ÿßŸÑŸÜŸÖŸÑ","ÿßŸÑŸÇÿµÿµ","ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™","ÿßŸÑÿ±ŸàŸÖ","ŸÑŸÇŸÖÿßŸÜ","ÿßŸÑÿ≥ÿ¨ÿØÿ©","ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®","ÿ≥ÿ®ÿ£","ŸÅÿßÿ∑ÿ±","Ÿäÿ≥","ÿßŸÑÿµÿßŸÅÿßÿ™","ÿµ","ÿßŸÑÿ≤ŸÖÿ±","ÿ∫ÿßŸÅÿ±","ŸÅÿµŸÑÿ™","ÿßŸÑÿ¥Ÿàÿ±Ÿâ","ÿßŸÑÿ≤ÿÆÿ±ŸÅ","ÿßŸÑÿØÿÆÿßŸÜ","ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©","ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ","ŸÖÿ≠ŸÖÿØ","ÿßŸÑŸÅÿ™ÿ≠","ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™","ŸÇ","ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™","ÿßŸÑÿ∑Ÿàÿ±","ÿßŸÑŸÜÿ¨ŸÖ","ÿßŸÑŸÇŸÖÿ±","ÿßŸÑÿ±ÿ≠ŸÖŸÜ","ÿßŸÑŸàÿßŸÇÿπÿ©","ÿßŸÑÿ≠ÿØŸäÿØ","ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©","ÿßŸÑÿ≠ÿ¥ÿ±","ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©","ÿßŸÑÿ∂ŸÅ","ÿßŸÑÿ¨ŸÖÿπÿ©","ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ","ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ","ÿßŸÑÿ∑ŸÑÿßŸÇ","ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ","ÿßŸÑŸÖŸÑŸÉ","ÿßŸÑŸÇŸÑŸÖ","ÿßŸÑÿÆÿßŸÇÿ©","ÿßŸÑŸÖÿπÿßÿ±ÿ¨","ŸÜŸàÿ≠","ÿßŸÑÿ¨ŸÜ","ÿßŸÑŸÖÿ≤ŸÖŸÑ","ÿßŸÑŸÖÿØÿ´ÿ±","ÿßŸÑŸÇŸäÿßŸÖÿ©","ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ","ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™","ÿßŸÑŸÜÿ®ÿ£","ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™","ÿπÿ®ÿ≥","ÿßŸÑÿ™ŸÉŸàŸäÿ±","ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±","ÿßŸÑÿ∑ŸÅŸäŸÅŸäŸÜ","ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ","ÿßŸÑÿ®ÿ±Ÿàÿ¨","ÿßŸÑÿ∑ÿßÿ±ŸÇ","ÿßŸÑÿ£ÿπŸÑŸâ","ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©","ÿßŸÑŸÅÿ¨ÿ±","ÿßŸÑÿ®ŸÑÿØ","ÿßŸÑÿ¥ŸÖÿ≥","ÿßŸÑŸÑŸäŸÑ","ÿßŸÑÿ∂ÿ≠Ÿâ","ÿßŸÑÿ¥ÿ±ÿ≠","ÿßŸÑÿ™ŸäŸÜ","ÿßŸÑÿπŸÑŸÇ","ÿßŸÑŸÇÿØÿ±","ÿßŸÑÿ®ŸäŸÜÿ©","ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©","ÿßŸÑÿπÿßÿØŸäÿßÿ™","ÿßŸÑŸÇÿßÿ±ÿπÿ©","ÿßŸÑÿ™ŸÉÿßÿ´ÿ±","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸÅŸäŸÑ","ŸÇÿ±Ÿäÿ¥","ÿßŸÑŸÖÿßÿπŸàŸÜ","ÿßŸÑŸÉŸàÿ´ÿ±","ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ","ÿßŸÑŸÜÿµÿ±","ÿßŸÑŸÖÿ≥ÿØ","ÿßŸÑÿ•ÿÆŸÑÿßÿµ","ÿßŸÑŸÅŸÑŸÇ","ÿßŸÑŸÜÿßÿ≥"];
    let classes = {};
    let records = [];
    let currentClass = "";
    let currentStudent = null;
    let currentActiveSection = 'new'; // 'new', 'short', 'long'
    let currentPage = 1;
    let sessionDots = []; // Stores dots for the CURRENT session being edited

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        populateSurahSelects();
        document.getElementById('entryDate').valueAsDate = new Date();
        loadMushaf(1);

        if(db) {
            db.ref('classes').on('value', snap => {
                classes = snap.val() || {};
                refreshDropdowns();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            });
            db.ref('records').on('value', snap => {
                const data = snap.val();
                records = [];
                if(data) Object.keys(data).forEach(k => records.push({...data[k], key: k}));
                if(currentStudent) renderTeacherHistory();
            });
        }
    });

    function populateSurahSelects() {
        const sel = document.getElementById('newSurah');
        surahNames.forEach((s, i) => {
            let opt = document.createElement('option');
            opt.value = i+1; opt.innerText = (i+1)+". "+s;
            sel.appendChild(opt);
        });
    }

    // --- NAVIGATION & LOGIN ---
    function loginAs(role) {
        document.getElementById('login-screen').style.display = 'none';
        if(role === 'teacher') {
            if(prompt("Password:") === "1234") {
                document.getElementById('teacher-dashboard').classList.add('dashboard-active');
            } else { location.reload(); }
        } else {
            document.getElementById('student-dashboard').classList.add('dashboard-active');
            setupStudentView();
        }
    }

    function logout() { location.reload(); }

    // --- TEACHER FUNCTIONS ---
    function refreshDropdowns() {
        const sel = document.getElementById('classSelect');
        sel.innerHTML = '';
        Object.keys(classes).forEach(c => {
            let opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            sel.appendChild(opt);
        });
        if(Object.keys(classes).length > 0) switchClass(Object.keys(classes)[0]);
    }

    function switchClass(cls) {
        currentClass = cls;
        const list = document.getElementById('studentListContainer');
        list.innerHTML = '';
        const students = classes[cls]?.students || [];
        students.forEach(s => {
            let btn = document.createElement('button');
            btn.className = 'student-btn';
            btn.innerText = s;
            btn.onclick = () => selectTeacherStudent(s);
            list.appendChild(btn);
        });
    }

    function selectTeacherStudent(name) {
        currentStudent = name;
        document.getElementById('teacherHeader').innerText = name;
        sessionDots = []; // Clear dots for new student
        clearDots();
        renderTeacherHistory();
    }

    // --- MUSHAF & DOTS (Teacher) ---
    function loadMushaf(p) {
        currentPage = p;
        document.getElementById('mushafImg').src = `https://android.quran.com/data/width_1260/page${p.toString().padStart(3,'0')}.png`;
        document.getElementById('pageIndicator').innerText = "Page " + p;
        clearDots();
        // Redraw session dots if they match this page
        sessionDots.forEach(d => {
            if(d.page == p) drawDot(d.x, d.y, false);
        });
    }

    function changePage(d) { loadMushaf(parseInt(currentPage) + d); }
    function toggleMushaf() { 
        const p = document.getElementById('mushafPanel');
        p.style.width = p.style.width === '0px' ? '35%' : '0px';
    }

    function setActiveSection(sec) {
        currentActiveSection = sec;
        document.querySelectorAll('.section-box').forEach(b => b.classList.remove('active-section'));
        document.getElementById('box-'+sec).classList.add('active-section');
        // When switching sections, we might want to clear dots or load dots specific to section
        // For simplicity V5, we treat dots as "currently marked on screen".
    }

    function onImageClick(e) {
        const rect = document.getElementById('mushafWrapper').getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Add to session data
        sessionDots.push({x, y, page: currentPage});
        
        // Update mistake count for active section
        const countInput = document.getElementById(currentActiveSection + 'Mistakes');
        if(countInput) countInput.value = parseInt(countInput.value || 0) + 1;

        drawDot(x, y, true);
    }

    function drawDot(x, y, isClickable) {
        const dot = document.createElement('div');
        dot.className = 'mistake-dot';
        dot.style.left = x + 'px'; dot.style.top = y + 'px';
        if(isClickable) {
            dot.onclick = (e) => {
                e.stopPropagation();
                dot.remove();
                // Remove from array
                sessionDots = sessionDots.filter(d => d.x !== x && d.y !== y);
                // Decrease count
                const countInput = document.getElementById(currentActiveSection + 'Mistakes');
                if(countInput) countInput.value = Math.max(0, parseInt(countInput.value) - 1);
            };
        }
        document.getElementById('mushafWrapper').appendChild(dot);
    }

    function clearDots() {
        document.querySelectorAll('#mushafWrapper .mistake-dot').forEach(d => d.remove());
    }

    // --- SAVE LOGIC (Selected Part Only) ---
    function saveRecord() {
        if(!currentStudent) return alert("Select a student");
        
        // Construct ONLY the data for the active section
        const sectionData = {
            s: document.getElementById(currentActiveSection+'Surah').value,
            st: document.getElementById(currentActiveSection+'Start').value,
            en: document.getElementById(currentActiveSection+'End').value,
            m: document.getElementById(currentActiveSection+'Mistakes').value,
            // SAVE DOTS: Filter dots that belong to this save action
            dots: sessionDots 
        };

        if(!sectionData.s || sectionData.s === "Surah...") return alert("Please fill surah");

        const record = {
            id: Date.now(),
            date: document.getElementById('entryDate').value,
            class: currentClass,
            student: currentStudent,
            type: 'daily',
            // Dynamic key based on section (new, short, long)
            [currentActiveSection]: sectionData 
        };

        db.ref('records').push(record);
        
        alert("Saved " + currentActiveSection + " only!");
        
        // Reset
        sessionDots = [];
        clearDots();
        document.getElementById(currentActiveSection+'Mistakes').value = "";
    }

    function renderTeacherHistory() {
        const div = document.getElementById('historyContainer');
        div.innerHTML = '';
        const myRecs = records.filter(r => r.class === currentClass && r.student === currentStudent);
        myRecs.sort((a,b) => new Date(b.date) - new Date(a.date));

        myRecs.forEach(r => {
            let html = `<div class="history-card">
                <div class="card-header"><b>${r.date}</b> <button onclick="delRec('${r.key}')" style="color:red;border:none;">&times;</button></div>`;
            
            // Show whatever sections exist in this record
            ['new', 'short', 'long'].forEach(sec => {
                if(r[sec]) {
                    html += `<div style="font-size:13px; margin-top:5px;">
                        <span style="font-weight:bold; color:${sec=='new'?'#27ae60':'#2980b9'}">${sec.toUpperCase()}:</span> 
                        Surah ${r[sec].s} (${r[sec].st}-${r[sec].en}) 
                        <span style="color:red; font-weight:bold;">${r[sec].m || 0} Mistakes</span>
                    </div>`;
                }
            });
            html += `</div>`;
            div.innerHTML += html;
        });
    }

    function delRec(k) { if(confirm("Delete?")) db.ref('records/'+k).remove(); }

    // --- STUDENT VIEW LOGIC ---
    function setupStudentView() {
        const sel = document.getElementById('stClassSelect');
        sel.innerHTML = '<option>Select Class</option>';
        Object.keys(classes).forEach(c => {
            sel.innerHTML += `<option value="${c}">${c}</option>`;
        });
    }

    function stLoadStudents(cls) {
        const sel = document.getElementById('stNameSelect');
        sel.innerHTML = '<option>Select Name</option>';
        if(classes[cls]) {
            classes[cls].students.forEach(s => {
                sel.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }
    }

    function stSelectStudent(name) {
        const cls = document.getElementById('stClassSelect').value;
        document.getElementById('stWelcomeName').innerText = name;
        
        const div = document.getElementById('stHistoryContainer');
        div.innerHTML = '';
        
        const myRecs = records.filter(r => r.class === cls && r.student === name);
        myRecs.sort((a,b) => new Date(b.date) - new Date(a.date));

        myRecs.forEach(r => {
            let sectionsHtml = '';
            ['new', 'short', 'long'].forEach(sec => {
                if(r[sec]) {
                    // Button to open Mushaf with dots for this specific section
                    // We pass the data to the function
                    const dataStr = encodeURIComponent(JSON.stringify(r[sec]));
                    
                    sectionsHtml += `
                    <div style="background:#f9f9f9; padding:10px; margin-top:5px; border-radius:5px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>${sec.toUpperCase()}</strong>: Surah ${r[sec].s} (${r[sec].st}-${r[sec].en})
                            <br><span style="color:red; font-size:12px;">${r[sec].m || 0} Mistakes</span>
                        </div>
                        <button class="btn btn-blue" style="font-size:12px; padding:5px;" onclick="stOpenMushaf('${dataStr}')">üìñ ﬁÑﬁ¶ﬁçﬁßﬁçﬁ™ﬁâﬁ¶ﬁÅﬁ∞</button>
                    </div>`;
                }
            });

            div.innerHTML += `
            <div class="history-card" style="border-right-color:#e67e22;">
                <div class="card-header"><b>${r.date}</b></div>
                ${sectionsHtml}
            </div>`;
        });
    }

    // Function called when student clicks "View"
    window.stOpenMushaf = function(encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const dots = data.dots || [];
        
        // Default to page 1 if no dots, or the page of the first dot
        // In a real app, we'd calculate page from Surah/Verse API. 
        // For V5 simplified, let's assume dots have page info or default to 1.
        let pageToShow = 1;
        if(dots.length > 0) pageToShow = dots[0].page;

        const img = document.getElementById('stMushafImg');
        img.src = `https://android.quran.com/data/width_1260/page${pageToShow.toString().padStart(3,'0')}.png`;
        
        // Draw readonly dots
        const wrapper = document.getElementById('stMushafWrapper');
        // Clear old dots (keep img)
        while(wrapper.children.length > 1) { wrapper.removeChild(wrapper.lastChild); }

        dots.forEach(d => {
            // Only draw if on same page (simple logic)
            if(d.page == pageToShow) {
                const dot = document.createElement('div');
                dot.className = 'mistake-dot readonly';
                dot.style.left = d.x + 'px';
                dot.style.top = d.y + 'px';
                wrapper.appendChild(dot);
            }
        });

        document.getElementById('stMushafModal').style.display = 'flex';
    }

    // --- SETTINGS (Simplified) ---
    function openSettingsModal() { document.getElementById('settingsModal').style.display = 'flex'; }
    function createNewClass() {
        const name = document.getElementById('newClassName').value;
        if(name) {
            db.ref('classes/' + name).set({students: []});
            alert('Class Created');
        }
    }
    function addStudentsBulk() {
        const cls = document.getElementById('classSelect').value;
        const txt = document.getElementById('bulkStudents').value;
        const students = txt.split('\n').filter(s => s.trim() !== "");
        // Get existing, merge
        const existing = classes[cls]?.students || [];
        const updated = [...new Set([...existing, ...students])];
        db.ref('classes/' + cls + '/students').set(updated);
        alert("Students Added");
    }

</script>
</body>
</html>
