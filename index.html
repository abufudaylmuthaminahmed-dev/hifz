<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁ§ﬁ™ﬁÉﬁ∞ﬁáﬁßﬁÇﬁ∞ ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ - v9.0 Final</title>
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* FONT SETUP */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
        
        @font-face { font-family: 'Faruma'; src: local('Faruma'); }
        @font-face { font-family: 'MV Waheed'; src: local('MV Waheed'); }

        :root {
            --primary-color: #2c3e50;
            --accent-color: #27ae60;
            --bg-color: #f4f7f6;
            --sidebar-width: 280px;
            --mushaf-width: 35%;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.05);
            --font-heading: 'MV Waheed', 'mv waheed', 'Noto Sans Thaana', sans-serif;
            --font-body: 'Faruma', 'faruma', 'Noto Sans Thaana', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-body) !important;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
        }
        
        h1, h2, h3, h4, h5, h6, .modal-header h3, .login-title, label, th, .tab-btn, .section-label, .exam-header {
            font-family: var(--font-heading) !important;
        }

        input, select, button, textarea {
            font-family: var(--font-body) !important;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; padding: 20px;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
            width: 100%; max-width: 350px; color: #333;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd;
            border-radius: 8px; font-size: 16px; text-align: center;
        }
        .login-btn {
            width: 100%; padding: 14px; margin-top: 15px; border: none;
            border-radius: 8px; font-size: 16px; cursor: pointer;
            font-weight: bold; transition: 0.2s;
        }
        .btn-teacher-login { background: #2c3e50; color: white; }
        .btn-student-login { background: #27ae60; color: white; }
        
        .login-tab { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .login-tab-btn { flex: 1; padding: 10px; cursor: pointer; background: none; border: none; border-bottom: 3px solid transparent; font-size: 14px; }
        .login-tab-btn.active { border-color: var(--accent-color); color: var(--accent-color); }

        body.student-mode .teacher-only { display: none !important; }
        body.student-mode .delete-card-btn { display: none !important; }
        body.student-mode .entry-form { display: none !important; }
        body.student-mode .mushaf-panel { pointer-events: none; } 
        
        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); background-color: white; border-left: 1px solid #ddd;
            display: flex; flex-direction: column; padding: 15px; box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            flex-shrink: 0; z-index: 20; transition: transform 0.3s ease;
        }
        .class-control-area { background-color: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
        .class-select { width: 100%; padding: 10px; font-size: 14px; font-weight: bold; color: #2c3e50; border: 2px solid #3498db; border-radius: 5px; background-color: white; margin-bottom: 10px; cursor: pointer; }
        .manage-btn { width: 100%; background: #e67e22; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .student-list-container { flex: 1; overflow-y: auto; }
        .student-btn { background: none; border: none; padding: 14px 10px; text-align: right; width: 100%; cursor: pointer; font-size: 16px; border-radius: 6px; margin-bottom: 4px; border-bottom: 1px solid #f9f9f9; transition: 0.2s; color: #2c3e50; }
        .student-btn.active { background-color: var(--accent-color); color: white; font-weight: bold; padding-right: 15px; }
        
        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

        .mobile-header { display: none; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .hamburger-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--primary-color); padding: 5px; }

        /* --- MUSHAF & FORMS --- */
        .mushaf-panel { width: var(--mushaf-width); background: #2c3e50; display: flex; flex-direction: column; transition: width 0.3s ease; border-right: 1px solid #ccc; }
        .mushaf-header { background: #34495e; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .mushaf-container { flex: 1; overflow: auto; background: #fdfdfd; display: flex; justify-content: center; position: relative; }
        .mushaf-wrapper { position: relative; display: inline-block; margin: 10px; }
        .mushaf-page-img { max-width: 100%; display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: crosshair; border: 1px solid #ddd; }
        .mistake-dot { position: absolute; width: 25px; height: 25px; background-color: rgba(231, 76, 60, 0.8); border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); cursor: pointer; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .entry-form { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-group { flex: 1; }
        input, select { width: 100%; padding: 10px; border: 1px solid #dcdcdc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        .arabic-input { font-family: 'Amiri', serif !important; direction: rtl; }
        .section-box { padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 2px solid transparent; transition: 0.2s; }
        .section-new { background-color: #eafaf1; }
        .section-short { background-color: #ebf5fb; }
        .section-long { background-color: #fef9e7; }
        .section-box.active-section { border-color: var(--accent-color); box-shadow: 0 0 10px rgba(39, 174, 96, 0.15); background-color: white; border-left: 5px solid var(--accent-color); }
        .radio-label { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 20px; border: 1px solid #ddd; cursor: pointer; font-size: 14px; font-weight: bold; transition: 0.2s; }
        
        .mistake-wrapper { display: flex; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; height: 38px; }
        .mistake-btn { width: 35px; border: none; background: #eee; cursor: pointer; font-weight: bold; font-size: 16px;}
        .mistake-display { text-align: center; font-weight: bold; width: 40px; border: none; border-left: 1px solid #ddd; border-right: 1px solid #ddd; padding: 0;}

        /* --- HISTORY & MODAL --- */
        .history-card { background: white; border-radius: 10px; box-shadow: var(--card-shadow); margin-bottom: 15px; padding: 15px; border-right: 5px solid var(--primary-color); position: relative; }
        .history-card.exam-card { border-right-color: #f1c40f; background: #fffdf0; }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .card-body { display: flex; gap: 10px; flex-wrap: wrap; }
        .card-section { flex: 1; min-width: 150px; padding: 10px; border-radius: 6px; font-size: 13px; }
        .card-section.new { background-color: #eafaf1; color: #27ae60; }
        
        /* IMPROVED MODAL STUDENT LIST */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background-color: white; padding: 0; border-radius: 10px; width: 550px; max-width: 95%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border-top: 5px solid #3498db; overflow: hidden; display:flex; flex-direction:column; max-height:90vh;}
        .modal-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-student-list { max-height: 300px; overflow-y: auto; }
        .modal-student-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; margin-bottom: 8px; border-radius: 8px;
            background: #f9f9f9; border: 1px solid #eee; transition: 0.2s;
        }
        .modal-student-item:hover { background: #f0f8ff; border-color: #3498db; }
        
        .btn { padding: 10px 16px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; font-size: 14px;}
        .btn-green { background: var(--accent-color); }
        .btn-blue { background: #3498db; }
        .btn-red { background: #e74c3c; }
        .btn-grey { background: #95a5a6; color: white; }
        .btn-yellow { background: #f39c12; color: white; }
        .filter-btn { padding:8px 14px; font-size:13px; margin-bottom: 5px; border-radius: 20px; }

        /* --- MOBILE SPECIFIC STYLES --- */
        @media (max-width: 768px) {
            body { flex-direction: column; position: relative; }
            .sidebar {
                position: fixed; top: 0; right: 0; width: 80%; max-width: 300px; height: 100%;
                transform: translateX(100%); z-index: 5000; box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            }
            .sidebar.active { transform: translateX(0); }
            #sidebar-overlay {
                display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 4000;
            }
            #sidebar-overlay.active { display: block; }
            .mobile-header { display: flex; }
            .main-content { width: 100%; padding: 10px; }
            .form-row { flex-direction: column; gap: 10px; }
            .form-row > div { width: 100%; }
            .form-group { width: 100%; }
            .mushaf-panel {
                position: fixed; top: 0; left: 0; width: 100% !important; height: 100%;
                z-index: 6000; transform: translateY(100%); transition: transform 0.3s ease;
                border-right: none;
            }
            .mushaf-panel.active { transform: translateY(0); }
            h2 { font-size: 20px; }
            .btn { flex: 1; justify-content: center; padding: 12px; }
            .history-card { font-size: 14px; }
        }
    </style>
</head>
<body>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <h2 class="login-title" style="color:var(--primary-color); margin-top:0;">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞</h2>
            
            <div class="login-tab">
                <button class="login-tab-btn active" id="tabStudent" onclick="switchLoginTab('student')">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</button>
                <button class="login-tab-btn" id="tabTeacher" onclick="switchLoginTab('teacher')">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
            </div>

            <div id="login-form-student">
                <input type="text" id="loginStudentId" class="login-input" placeholder="ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© (ﬁâﬁ®ﬁêﬁßﬁçﬁ™: IUM123)" style="text-transform: uppercase;">
                <input type="password" id="studentPassword" class="login-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ (ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁäﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁÆﬁÅﬁ∞)">
                <button class="login-btn btn-student-login" onclick="handleStudentLogin()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
                <p style="font-size:12px; color:#666; margin-top:10px;">ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁäﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ ﬁàﬁ¶ﬁÇﬁ∞ﬁÇﬁ¶ﬁÇﬁ¶ﬁâﬁ¶ÿå ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁñﬁ¨ﬁÄﬁ™ﬁâﬁ¶ﬁÅﬁ∞ﬁäﬁ¶ﬁÄﬁ™ ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁÑﬁ¶ﬁÄﬁ¶ﬁáﬁ∞ﬁìﬁ¶ﬁàﬁß.</p>
            </div>

            <div id="login-form-teacher" style="display:none;">
                <p style="font-size:14px; margin-bottom:15px;">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁöﬁßﬁáﬁ∞ﬁûﬁ¶ ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß</p>
                <input type="password" id="teacherPassword" class="login-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
                <button class="login-btn btn-teacher-login" onclick="handleTeacherLogin()">ﬁìﬁ©ﬁóﬁ¶ﬁÉ ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
        </div>
        <p style="margin-top:20px; opacity:0.7; font-size:12px; color:white;">¬© Quran Hifz Tracker v9.0</p>
    </div>

    <!-- PASSWORD MODAL -->
    <div id="passwordSetupModal" class="modal">
        <div class="modal-content" style="width:90%; max-width:400px;">
            <div class="modal-header">
                <h3 style="margin:0; color:var(--primary-color);">ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁêﬁ¨ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</h3>
            </div>
            <div class="modal-body">
                <p style="font-size:14px; color:#555;">ﬁâﬁ® ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁßﬁáﬁ¶ﬁÅﬁ∞ ﬁáﬁ¶ﬁãﬁ® ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁÄﬁ¨ﬁãﬁ®ﬁäﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞. ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ﬁãﬁ®ﬁáﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁÄﬁ¶ﬁáﬁ∞ﬁãﬁ¶ﬁàﬁß.</p>
                <label>ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞:</label>
                <input type="password" id="newPass1" style="margin-bottom:10px;">
                <label>ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÜﬁ¶ﬁÅﬁ¶ﬁàﬁ¶ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ≠:</label>
                <input type="password" id="newPass2" style="margin-bottom:20px;">
                <button class="btn btn-green" style="width:100%; justify-content:center;" onclick="saveNewPassword()">ﬁêﬁ≠ﬁàﬁ∞ & ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" style="display:none; width:100%; height:100%;">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color:var(--primary-color);">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞</h3>
                <span style="font-size:24px; cursor:pointer; color:#7f8c8d; display:none;" class="mobile-close-sidebar" onclick="toggleSidebar()">&times;</span>
            </div>
            
            <div class="class-control-area">
                <label style="color:#7f8c8d; margin-bottom: 5px;">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                <select id="classSelect" class="class-select" onchange="switchClass(this.value)"></select>
                <button class="manage-btn teacher-only" onclick="openModal()"><span>‚öôÔ∏è</span> ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ / ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞</button>
            </div>
            
            <h4 style="margin: 10px 0; color:#555; border-bottom:1px solid #eee; padding-bottom:5px;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</h4>
            <div id="studentListContainer" class="student-list-container"></div>
            <button class="btn btn-grey" onclick="logout()" style="margin-top:10px; width:100%; justify-content:center;">üö™ ﬁÇﬁ™ﬁÜﬁ™ﬁâﬁ¨ﬁàﬁ¶ﬁëﬁ¶ﬁáﬁ®ﬁéﬁ¶ﬁÇﬁ∞ﬁÇﬁ¶ﬁàﬁß</button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="mobile-header">
                <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
                <h3 style="margin:0; color:var(--primary-color);">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁìﬁ∞ﬁÉﬁ¨ﬁÜﬁ¶ﬁÉ</h3>
            </div>

            <div style="background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:10px;">
                    <div>
                        <small style="color:#7f8c8d; font-weight:bold; display:block;" id="currentClassDisplay">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞: -</small>
                        <div style="display:flex; align-items:baseline; gap:10px;">
                            <h2 id="studentHeader" style="margin:0; color:var(--primary-color);">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</h2>
                            <span id="classTeacherDisplay" style="font-size:12px; color:#27ae60; background:#eafaf1; padding:2px 8px; border-radius:10px; display:none;"></span>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; width:100%; sm-width:auto;">
                        <button class="btn btn-green teacher-only" onclick="exportExcel()">üì• Excel</button>
                        <button class="btn btn-blue" style="background:#8e44ad;" onclick="openProgressModal()">üìà ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁ¨ﬁêﬁ∞</button>
                        <button class="btn btn-blue" onclick="toggleMushaf()">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ∞</button>
                    </div>
                </div>
            </div>

            <!-- ENTRY FORM -->
            <div class="entry-form teacher-only">
                <div class="form-row">
                    <div class="form-group"><label>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="entryDate" onchange="updateSelectedDate()"></div>
                    <div class="form-group"><label>ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</label><input type="text" id="teacherName" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞"></div>
                    <div class="form-group">
                        <label>ﬁàﬁ¶ﬁáﬁ∞ﬁåﬁ¶ﬁÉﬁ™</label>
                        <select id="lessonType" onchange="toggleFormSection(this.value)">
                            <option value="daily">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ﬁåﬁ¶ﬁáﬁ∞</option>
                            <option value="exam">ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</option>
                        </select>
                    </div>
                </div>

                <!-- DAILY LESSONS -->
                <div id="container-daily">
                    <div id="box-new" class="section-box section-new active-section">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#27ae60; font-size:16px;">ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ <span id="loader-new" style="display:none;" class="loader-spin"></span></label>
                            <label class="radio-label">
                                <input type="radio" name="activeSec" value="new" checked onchange="setActiveSection('new')">
                                <span>ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</span>
                            </label>
                        </div>
                        <div class="form-row">
                            <div style="flex:1"><input type="number" id="newPage" placeholder="ﬁû: ﬁáﬁÆﬁìﬁØ" onchange="autoLoadPage('new')" style="background:#fffde7; border-color:#f1c40f; text-align:center;"></div>
                            <div style="flex:2"><select id="newSurah" class="arabic-input"><option value="">ﬁäﬁ¨ﬁÅﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:1"><input type="number" id="newStart" placeholder="ﬁäﬁ¨ﬁÅﬁ® ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞"></div>
                        </div>
                        <div class="form-row">
                            <div style="flex:2"><select id="newEndSurah" class="arabic-input"><option value="">ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:1"><input type="number" id="newEnd" placeholder="ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁ® ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞"></div>
                            <div>
                                <div class="mistake-wrapper">
                                    <button class="mistake-btn plus" onclick="adjustMistake('newMistakes', 1)">+</button>
                                    <input id="newMistakes" class="mistake-display" value="0" readonly>
                                    <button class="mistake-btn minus" onclick="adjustMistake('newMistakes', -1)">-</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="box-short" class="section-box section-short">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#2980b9; font-size:16px;">ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß <span id="loader-short" style="display:none;" class="loader-spin"></span></label>
                            <label class="radio-label"><input type="radio" name="activeSec" value="short" onchange="setActiveSection('short')"> <span>ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</span></label>
                        </div>
                        <div class="form-row">
                            <div style="flex:1"><input type="number" id="shortPage" placeholder="ﬁû: ﬁáﬁÆﬁìﬁØ" onchange="autoLoadPage('short')" style="background:#fffde7; border-color:#f1c40f; text-align:center;"></div>
                            <div style="flex:2"><select id="shortSurah" class="arabic-input"><option value="">ﬁäﬁ¨ﬁÅﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:1"><input type="number" id="shortStart" placeholder="ﬁäﬁ¨ﬁÅﬁ®"></div>
                        </div>
                        <div class="form-row">
                            <div style="flex:2"><select id="shortEndSurah" class="arabic-input"><option value="">ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:1"><input type="number" id="shortEnd" placeholder="ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁ®"></div>
                            <div>
                                <div class="mistake-wrapper">
                                    <button class="mistake-btn plus" onclick="adjustMistake('shortMistakes', 1)">+</button>
                                    <input id="shortMistakes" class="mistake-display" value="0" readonly>
                                    <button class="mistake-btn minus" onclick="adjustMistake('shortMistakes', -1)">-</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="box-long" class="section-box section-long">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#d35400; font-size:16px;">ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß <span id="loader-long" style="display:none;" class="loader-spin"></span></label>
                            <label class="radio-label"><input type="radio" name="activeSec" value="long" onchange="setActiveSection('long')"> <span>ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</span></label>
                        </div>
                        <div class="form-row">
                            <div style="flex:1"><input type="number" id="longPage" placeholder="ﬁû: ﬁáﬁÆﬁìﬁØ" onchange="autoLoadPage('long')" style="background:#fffde7; border-color:#f1c40f; text-align:center;"></div>
                            <div style="flex:2"><select id="longSurah" class="arabic-input"><option value="">ﬁäﬁ¨ﬁÅﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:1"><input type="number" id="longStart" placeholder="ﬁäﬁ¨ﬁÅﬁ®"></div>
                        </div>
                        <div class="form-row">
                            <div style="flex:2"><select id="longEndSurah" class="arabic-input"><option value="">ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:1"><input type="number" id="longEnd" placeholder="ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁ®"></div>
                            <div>
                                <div class="mistake-wrapper">
                                    <button class="mistake-btn plus" onclick="adjustMistake('longMistakes', 1)">+</button>
                                    <input id="longMistakes" class="mistake-display" value="0" readonly>
                                    <button class="mistake-btn minus" onclick="adjustMistake('longMistakes', -1)">-</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EXAM -->
                <div id="container-exam" style="display:none;">
                    <div id="box-exam" class="section-box section-exam active-section">
                        <div class="exam-header"><span>üèÜ ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</span> <span id="totalExamScore">100%</span></div>
                        <div class="form-row">
                            <div style="flex:1">
                                <label>ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™:</label>
                                <select id="examJuzu"></select>
                            </div>
                            <div style="flex:1">
                                <label>ﬁÑﬁ¶ﬁáﬁ®:</label>
                                <select id="examPortion">
                                    <option value="whole">ﬁâﬁ™ﬁÖﬁ® ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ¨ﬁáﬁ∞ﬁÜﬁÆﬁÅﬁ∞</option>
                                    <option value="half">ﬁáﬁ¨ﬁáﬁ∞ﬁÑﬁ¶ﬁáﬁ® (1/2)</option>
                                    <option value="third">ﬁåﬁ®ﬁÇﬁ∞ﬁÑﬁ¶ﬁáﬁ®ﬁÜﬁ™ﬁÖﬁ¶ ﬁáﬁ¨ﬁáﬁ∞ﬁÑﬁ¶ﬁáﬁ® (1/3)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div style="flex:1"><label>ﬁáﬁ¨ﬁéﬁ∞ﬁíﬁßﬁâﬁ®ﬁÇﬁ¶ﬁÉ:</label><input type="text" id="examExaminer" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞"></div>
                        </div>
                        <div class="form-row" style="background:white; padding:10px; border-radius:6px; border:1px solid #ddd;">
                            <div style="flex:1"><label>ﬁäﬁ¨ﬁÅﬁ®:</label><input type="time" id="examStartTime" onchange="calculateDuration()"></div>
                            <div style="flex:1"><label>ﬁÇﬁ®ﬁâﬁ™ﬁÇﬁ™:</label><input type="time" id="examEndTime" onchange="calculateDuration()"></div>
                            <div style="flex:0.5; text-align:center;"><label>ﬁâﬁ®ﬁÇﬁ¨ﬁìﬁ∞</label><br><span id="examDuration" style="font-weight:bold; color:blue;">0</span></div>
                        </div>
                        <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                            <h5 style="margin:5px 0;">ﬁÄﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁÜﬁ™ﬁÅﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (80%)</h5>
                            <div style="display:flex; gap:10px;">
                                <div style="flex:1; background:#ffebee; padding:5px; border-radius:5px;">
                                    <label style="color:#c0392b; font-size:12px;">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ (-2)</label>
                                    <div class="mistake-wrapper"><button class="mistake-btn" onclick="updateExamMistake('teacher', 1)">+</button><input id="examTeacherMistakes" class="mistake-display" value="0" readonly><button class="mistake-btn" onclick="updateExamMistake('teacher', -1)">-</button></div>
                                </div>
                                <div style="flex:1; background:#fff8e1; padding:5px; border-radius:5px;">
                                    <label style="color:#d35400; font-size:12px;">ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ (-1)</label>
                                    <div class="mistake-wrapper"><button class="mistake-btn" onclick="updateExamMistake('self', 1)">+</button><input id="examSelfMistakes" class="mistake-display" value="0" readonly><button class="mistake-btn" onclick="updateExamMistake('self', -1)">-</button></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row" style="margin-top:10px;">
                            <div class="form-group"><label>ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞ 1</label><input type="number" id="markMutha1" step="0.5" max="2.5" value="2.5" onchange="calculateExamScore()"></div>
                            <div class="form-group"><label>ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞ 2</label><input type="number" id="markMutha2" step="0.5" max="2.5" value="2.5" onchange="calculateExamScore()"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>ﬁåﬁ¶ﬁñﬁ∞ﬁàﬁ©ﬁãﬁ™ (10)</label><input type="number" id="markTajweed" step="0.5" max="10" value="10" onchange="calculateExamScore()"></div>
                            <div class="form-group"><label>ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞ (5)</label><input type="number" id="markFluency" step="0.5" max="5" value="5" onchange="calculateExamScore()"></div>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-green" style="flex:1; justify-content: center;" onclick="saveRecord()">ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</button>
                    <button class="btn btn-red" style="width:auto; justify-content: center;" onclick="clearForm()">ﬁêﬁßﬁäﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                </div>
            </div>

            <!-- HISTORY -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0 10px 0; border-bottom: 2px solid #eee; padding-bottom:8px; flex-wrap:wrap; gap:5px;">
                <h4 style="margin:0; color:#555;">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁåﬁßﬁàﬁ¶ﬁçﬁ∞</h4>
                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="filter-btn active" id="btnFilterAll" onclick="setHistoryFilter('all')">ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß</button>
                    <button class="filter-btn" id="btnFilterNew" onclick="setHistoryFilter('new')">ﬁáﬁß</button>
                    <button class="filter-btn" id="btnFilterShort" onclick="setHistoryFilter('short')">ﬁÜﬁ™ﬁÉﬁ™</button>
                    <button class="filter-btn" id="btnFilterLong" onclick="setHistoryFilter('long')">ﬁãﬁ®ﬁéﬁ™</button>
                    <button class="filter-btn" id="btnFilterExam" onclick="setHistoryFilter('exam')">ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</button>
                </div>
            </div>
            
            <div id="historyContainer" class="history-container"></div>
        </div>

        <!-- MUSHAF PANEL -->
        <div class="mushaf-panel" id="mushafPanel">
            <div class="mushaf-header">
                <span id="pageIndicator" style="font-weight:bold; font-size:16px;">Page 1</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn" style="background:#555; padding:0 10px;" onclick="changePage(1)">&gt;</button>
                    <input type="number" id="navPage" style="width:50px; text-align:center; padding:5px; border-radius:4px; border:none;" min="1" max="604" onchange="loadMushaf(this.value)">
                    <button class="btn" style="background:#555; padding:0 10px;" onclick="changePage(-1)">&lt;</button>
                    <button class="btn" style="background:#c0392b; margin-left:10px;" onclick="toggleMushaf()">X</button>
                </div>
            </div>
            <div class="mushaf-container">
                <div class="mushaf-wrapper" id="mushafWrapper" onclick="onImageClick(event)">
                    <img id="mushafImg" class="mushaf-page-img" src="" alt="Quran Page">
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:var(--primary-color);">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ & ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div class="tab-header">
                <div class="tab-btn active" onclick="switchTab('tab-students')">ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</div>
                <div class="tab-btn" onclick="switchTab('tab-class')">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞</div>
                <div class="tab-btn" onclick="switchTab('tab-data')">ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞</div>
            </div>
            <div class="modal-body">
                <div id="tab-students" class="tab-content active">
                    <label>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                    <select id="modalClassSelect" class="class-select" style="margin-bottom:15px;" onchange="renderModalStudentList()"></select>
                    <div style="background:#f9f9f9; padding:10px; border:1px solid #eee; border-radius:5px;">
                        <label>ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞:</label>
                        <p style="font-size:11px; margin:5px 0;">ﬁäﬁØﬁâﬁ¨ﬁìﬁ∞: <code>IUM-ID (ﬁÇﬁ¶ﬁÇﬁ∞)</code></p>
                        <textarea id="bulkStudents" placeholder="IUM202301 (Ali Ahmed)"></textarea>
                        <button class="btn btn-green" style="width:100%; justify-content: center;" onclick="importStudents()">‚ûï ﬁáﬁ¨ﬁëﬁ∞</button>
                    </div>
                    <label style="margin-top:15px; font-weight:bold;">ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™:</label>
                    <div id="modalStudentList" class="modal-student-list"></div>
                </div>
                <div id="tab-class" class="tab-content">
                    <div style="background:#eafaf1; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <label>ﬁáﬁß ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                        <input type="text" id="newClassName" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞" style="margin-top:5px;">
                        <input type="text" id="newClassTeacher" placeholder="ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞" style="margin-top:5px;">
                        <button class="btn btn-blue" style="width:100%; margin-top:10px;" onclick="createClass()">ﬁÄﬁ¶ﬁãﬁß</button>
                    </div>
                    <div style="background:#fff5f5; padding:15px; border:1px dashed red; border-radius:8px;">
                        <label style="color:red;">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ™ﬁÇﬁ∞:</label>
                        <select id="deleteClassSelect" class="class-select" style="margin-top:5px; border-color:red;"></select>
                        <button class="btn btn-red" style="width:100%;" onclick="deleteSelectedClass()">ﬁäﬁÆﬁÄﬁ¨ﬁçﬁß</button>
                    </div>
                </div>
                <div id="tab-data" class="tab-content">
                    <button class="btn btn-blue" style="width:100%; margin-bottom:10px;" onclick="downloadBackup()">üì• Backup Download</button>
                    <input type="file" id="restoreFile" style="margin-bottom:10px; width:100%;">
                    <button class="btn btn-red" style="width:100%; margin-bottom:20px;" onclick="restoreBackup()">üì§ Restore</button>
                    <button style="font-size:11px; color:red; border:none; background:none; text-decoration:underline; width:100%;" onclick="hardReset()">‚ö†Ô∏è Reset All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PROGRESS MODAL -->
    <div id="progressModal" class="modal">
        <div class="modal-content" style="width:90%; max-width:400px;">
            <div class="modal-header">
                <h3>ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁ¨ﬁêﬁ∞</h3>
                <span class="close-modal" onclick="closeProgressModal()">&times;</span>
            </div>
            <div class="modal-body">
                <label>ﬁäﬁ¨ﬁÅﬁ≠ ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞:</label><input type="date" id="progStartDate" style="margin-bottom:10px;">
                <label>ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁß ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞:</label><input type="date" id="progEndDate" style="margin-bottom:10px;">
                <button class="btn btn-blue" style="width:100%;" onclick="calculateProgress()">ﬁÑﬁ¶ﬁçﬁßﬁçﬁ™ﬁâﬁ¶ﬁÅﬁ∞</button>
                <div id="progressResult" style="margin-top:20px; padding:15px; background:#f0f8ff; border-radius:8px; text-align:center; display:none;">
                    <div style="font-size:14px;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß:</div>
                    <div style="font-size:36px; font-weight:bold; color:#2c3e50;" id="progCount">0</div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
      authDomain: "hifz-cde3b.firebaseapp.com",
      databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
      projectId: "hifz-cde3b",
      storageBucket: "hifz-cde3b.firebasestorage.app",
      messagingSenderId: "566754658580",
      appId: "1:566754658580:web:d63d0f167960f53bab9a01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const surahNames = ["ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©","ÿßŸÑÿ®ŸÇÿ±ÿ©","ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ","ÿßŸÑŸÜÿ≥ÿßÿ°","ÿßŸÑŸÖÿßÿ¶ÿØÿ©","ÿßŸÑÿ£ŸÜÿπÿßŸÖ","ÿßŸÑÿ£ÿπÿ±ÿßŸÅ","ÿßŸÑÿ£ŸÜŸÅÿßŸÑ","ÿßŸÑÿ™Ÿàÿ®ÿ©","ŸäŸàŸÜÿ≥","ŸáŸàÿØ","ŸäŸàÿ≥ŸÅ","ÿßŸÑÿ±ÿπÿØ","ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ","ÿßŸÑÿ≠ÿ¨ÿ±","ÿßŸÑŸÜÿ≠ŸÑ","ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°","ÿßŸÑŸÉŸáŸÅ","ŸÖÿ±ŸäŸÖ","ÿ∑Ÿá","ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°","ÿßŸÑÿ≠ÿ¨","ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ","ÿßŸÑŸÜŸàÿ±","ÿßŸÑŸÅÿ±ŸÇÿßŸÜ","ÿßŸÑÿ¥ÿπÿ±ÿßÿ°","ÿßŸÑŸÜŸÖŸÑ","ÿßŸÑŸÇÿµÿµ","ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™","ÿßŸÑÿ±ŸàŸÖ","ŸÑŸÇŸÖÿßŸÜ","ÿßŸÑÿ≥ÿ¨ÿØÿ©","ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®","ÿ≥ÿ®ÿ£","ŸÅÿßÿ∑ÿ±","Ÿäÿ≥","ÿßŸÑÿµÿßŸÅÿßÿ™","ÿµ","ÿßŸÑÿ≤ŸÖÿ±","ÿ∫ÿßŸÅÿ±","ŸÅÿµŸÑÿ™","ÿßŸÑÿ¥Ÿàÿ±Ÿâ","ÿßŸÑÿ≤ÿÆÿ±ŸÅ","ÿßŸÑÿØÿÆÿßŸÜ","ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©","ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ","ŸÖÿ≠ŸÖÿØ","ÿßŸÑŸÅÿ™ÿ≠","ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™","ŸÇ","ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™","ÿßŸÑÿ∑Ÿàÿ±","ÿßŸÑŸÜÿ¨ŸÖ","ÿßŸÑŸÇŸÖÿ±","ÿßŸÑÿ±ÿ≠ŸÖŸÜ","ÿßŸÑŸàÿßŸÇÿπÿ©","ÿßŸÑÿ≠ÿØŸäÿØ","ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©","ÿßŸÑÿÆÿ¥ÿ±","ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©","ÿßŸÑÿ∂ŸÅ","ÿßŸÑÿ¨ŸÖÿπÿ©","ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ","ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ","ÿßŸÑÿ∑ŸÑÿßŸÇ","ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ","ÿßŸÑŸÖŸÑŸÉ","ÿßŸÑŸÇŸÑŸÖ","ÿßŸÑÿÆÿßŸÇÿ©","ÿßŸÑŸÖÿπÿßÿ±ÿ¨","ŸÜŸàÿ≠","ÿßŸÑÿ¨ŸÜ","ÿßŸÑŸÖÿ≤ŸÖŸÑ","ÿßŸÑŸÖÿØÿ´ÿ±","ÿßŸÑŸÇŸäÿßŸÖÿ©","ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ","ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™","ÿßŸÑŸÜÿ®ÿ£","ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™","ÿπÿ®ÿ≥","ÿßŸÑÿ™ŸÉŸàŸäÿ±","ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±","ÿßŸÑÿ∑ŸÅŸäŸÅŸäŸÜ","ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ","ÿßŸÑÿ®ÿ±Ÿàÿ¨","ÿßŸÑÿ∑ÿßÿ±ŸÇ","ÿßŸÑÿ£ÿπŸÑŸâ","ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©","ÿßŸÑŸÅÿ¨ÿ±","ÿßŸÑÿ®ŸÑÿØ","ÿßŸÑÿ¥ŸÖÿ≥","ÿßŸÑŸÑŸäŸÑ","ÿßŸÑÿ∂ÿ≠Ÿâ","ÿßŸÑÿ¥ÿ±ÿ≠","ÿßŸÑÿ™ŸäŸÜ","ÿßŸÑÿπŸÑŸÇ","ÿßŸÑŸÇÿØÿ±","ÿßŸÑÿ®ŸäŸÜÿ©","ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©","ÿßŸÑÿπÿßÿØŸäÿßÿ™","ÿßŸÑŸÇÿßÿ±ÿπÿ©","ÿßŸÑÿ™ŸÉÿßÿ´ÿ±","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸÅŸäŸÑ","ŸÇÿ±Ÿäÿ¥","ÿßŸÑŸÖÿßÿπŸàŸÜ","ÿßŸÑŸÉŸàÿ´ÿ±","ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ","ÿßŸÑŸÜÿµÿ±","ÿßŸÑŸÖÿ≥ÿØ","ÿßŸÑÿ•ÿÆŸÑÿßÿµ","ÿßŸÑŸÅŸÑŸÇ","ÿßŸÑŸÜÿßÿ≥"];
    const TEACHER_PASSWORD = "1234"; 

    let classes = {}; let records = [];
    let currentClass = ""; let currentStudent = null; 
    let currentActiveSection = 'new'; let currentPage = 1; let historyFilter = 'all'; 
    let tempLoginClass = ""; let tempLoginStudentIdx = -1;
    let editingRecordId = null;
    let currentDots = { new: [], short: [], long: [], exam: [] };
    let selectedDate = new Date().toISOString().split('T')[0]; // Persist date

    // PERSISTENT LOGIN CHECK
    function checkSession() {
        const session = JSON.parse(localStorage.getItem('hifz_session'));
        if(session) {
            if(session.type === 'teacher') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                // Wait for data load
            } else if (session.type === 'student') {
                loginSuccess(session.class, session.student, 'student');
            }
        }
    }

    // Load Data
    const dbRef = ref(db, 'hifz_data');
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            classes = data.classes || { "Default Class": { teacher: "", students: [] } };
            records = data.records || [];
            
            // Re-apply state if logged in
            if(document.getElementById('app-container').style.display !== 'none') {
                if(!currentClass) {
                    // Try to restore from session or default
                    const session = JSON.parse(localStorage.getItem('hifz_session'));
                    if(session && session.type === 'teacher') {
                        refreshClassDropdowns();
                    }
                } else {
                    refreshClassDropdowns();
                    if(currentStudent) renderHistory();
                }
            }
        } else {
            classes = { "Default Class": { teacher: "", students: [] } };
            records = [];
            saveData();
        }
    });

    function saveData() {
        set(ref(db, 'hifz_data'), { classes: classes, records: records })
        .catch(err => alert("Error saving: " + err));
    }

    document.addEventListener('DOMContentLoaded', () => {
        populateSurahSelects();
        populateJuzuSelect();
        document.getElementById('entryDate').value = selectedDate;
        loadMushaf(1);
        checkSession();
    });

    // --- MOBILE SIDEBAR LOGIC ---
    window.toggleSidebar = function() {
        const sb = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        sb.classList.toggle('active');
        overlay.classList.toggle('active');
        const closeBtn = document.querySelector('.mobile-close-sidebar');
        if(sb.classList.contains('active')) closeBtn.style.display = 'block';
        else closeBtn.style.display = 'none';
    }

    // --- LOGIN ---
    window.switchLoginTab = function(type) {
        document.querySelectorAll('.login-tab-btn').forEach(b => b.classList.remove('active'));
        if(type === 'student') {
            document.getElementById('tabStudent').classList.add('active');
            document.getElementById('login-form-student').style.display = 'block';
            document.getElementById('login-form-teacher').style.display = 'none';
        } else {
            document.getElementById('tabTeacher').classList.add('active');
            document.getElementById('login-form-student').style.display = 'none';
            document.getElementById('login-form-teacher').style.display = 'block';
        }
    }

    window.handleStudentLogin = function() {
        const inputId = document.getElementById('loginStudentId').value.trim();
        const pass = document.getElementById('studentPassword').value;

        if(!inputId) return alert("ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß");

        let foundClass = null;
        let foundStudentIdx = -1;

        Object.keys(classes).forEach(cls => {
            const students = classes[cls].students;
            const idx = students.findIndex(s => {
                const storedName = s.name.trim();
                const input = inputId.trim().toLowerCase();
                const firstPart = storedName.split(/[\s\(]+/)[0].toLowerCase();
                if (firstPart === input) return true;
                const match = storedName.match(/\(([^)]+)\)/);
                if (match && match[1]) return match[1].trim().toLowerCase() === input;
                return false;
            });
            if(idx !== -1) { foundClass = cls; foundStudentIdx = idx; }
        });

        if(!foundClass) return alert("ﬁåﬁ®ﬁîﬁ¶ ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™");

        const studentObj = classes[foundClass].students[foundStudentIdx];
        
        if ((!studentObj.password || studentObj.password === "") && pass === "") {
            tempLoginClass = foundClass; tempLoginStudentIdx = foundStudentIdx;
            document.getElementById('passwordSetupModal').style.display = 'flex';
            return;
        }
        if (pass === studentObj.password) loginSuccess(foundClass, studentObj.name, 'student');
        else alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®");
    }

    window.saveNewPassword = function() {
        const p1 = document.getElementById('newPass1').value;
        const p2 = document.getElementById('newPass2').value;
        if(!p1 || p1 !== p2) return alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁãﬁ®ﬁâﬁßﬁÇﬁ™ﬁàﬁ≠");
        classes[tempLoginClass].students[tempLoginStudentIdx].password = p1;
        saveData();
        document.getElementById('passwordSetupModal').style.display = 'none';
        loginSuccess(tempLoginClass, classes[tempLoginClass].students[tempLoginStudentIdx].name, 'student');
    }

    window.handleTeacherLogin = function() {
        if(document.getElementById('teacherPassword').value === TEACHER_PASSWORD) {
            let startClass = Object.keys(classes)[0] || "Default Class";
            loginSuccess(startClass, null, 'teacher');
        } else alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®");
    }

    function loginSuccess(cls, studentName, mode) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        
        // Save Session
        localStorage.setItem('hifz_session', JSON.stringify({
            type: mode,
            class: cls,
            student: studentName
        }));

        if (mode === 'student') {
            document.body.classList.add('student-mode');
            document.getElementById('classSelect').value = cls;
            switchClass(cls);
            setTimeout(() => {
                const btns = document.querySelectorAll('.student-btn');
                btns.forEach(b => { if(b.innerText === studentName) b.click(); });
                const sb = document.getElementById('sidebar');
                sb.classList.remove('active');
                document.getElementById('sidebar-overlay').classList.remove('active');
                let displayName = studentName.includes('(') ? studentName.match(/\(([^)]+)\)/)[1] : studentName;
                document.querySelector('.mobile-header h3').innerText = displayName;
            }, 100);
        } else {
            document.body.classList.remove('student-mode');
            refreshClassDropdowns();
        }
    }

    window.logout = function() { 
        localStorage.removeItem('hifz_session');
        location.reload(); 
    }

    // --- MAIN APP ---
    function populateSurahSelects() {
        const ids = ['newSurah', 'newEndSurah','shortSurah', 'shortEndSurah','longSurah', 'longEndSurah'];
        ids.forEach(id => {
            const sel = document.getElementById(id);
            if(sel) {
                sel.innerHTML = sel.innerHTML; 
                surahNames.forEach((s, i) => {
                    let opt = document.createElement('option');
                    opt.value = i + 1; opt.innerText = (i+1) + ". " + s;
                    sel.appendChild(opt);
                });
            }
        });
    }

    function populateJuzuSelect() {
        const sel = document.getElementById('examJuzu');
        for(let i=1; i<=30; i++) {
            let opt = document.createElement('option');
            opt.value = i; opt.innerText = i + " ﬁàﬁ¶ﬁÇﬁ¶ ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™";
            sel.appendChild(opt);
        }
    }

    window.refreshClassDropdowns = function() {
        const mainSel = document.getElementById('classSelect');
        const modalSel = document.getElementById('modalClassSelect');
        const deleteSel = document.getElementById('deleteClassSelect');
        [mainSel, modalSel, deleteSel].forEach(sel => sel.innerHTML = '');
        const keys = Object.keys(classes);
        if(keys.length === 0) { classes = {"Default Class": { teacher: "", students: [] }}; keys.push("Default Class"); saveData(); }
        keys.forEach(k => { [mainSel, modalSel, deleteSel].forEach(sel => { let opt = document.createElement('option'); opt.value = k; opt.innerText = k; sel.appendChild(opt); }); });
        
        // Restore session class if available
        const session = JSON.parse(localStorage.getItem('hifz_session'));
        if(session && session.class && classes[session.class]) {
            currentClass = session.class;
        } else if (keys.includes(currentClass)) {
            // keep current
        } else { 
            mainSel.value = keys[0]; currentClass = keys[0]; 
        }
        mainSel.value = currentClass;
        switchClass(mainSel.value);
    }

    window.switchClass = function(className) {
        currentClass = className;
        document.getElementById('currentClassDisplay').innerText = "ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞: " + currentClass;
        const teacherDisplay = document.getElementById('classTeacherDisplay');
        const teacherName = classes[currentClass].teacher;
        if(teacherName) { teacherDisplay.style.display = 'inline-block'; teacherDisplay.innerText = "ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞: " + teacherName; document.getElementById('teacherName').value = teacherName; }
        else teacherDisplay.style.display = 'none';

        const list = document.getElementById('studentListContainer');
        list.innerHTML = '';
        currentStudent = null;
        document.getElementById('studentHeader').innerText = "ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞";
        document.getElementById('historyContainer').innerHTML = ''; 

        (classes[currentClass].students || []).forEach(s => {
            const btn = document.createElement('button');
            btn.className = 'student-btn'; btn.innerText = s.name;
            btn.onclick = () => {
                selectStudent(s.name, btn);
                if(window.innerWidth <= 768) toggleSidebar();
            };
            list.appendChild(btn);
        });
    }

    function selectStudent(name, btnEl) {
        currentStudent = name;
        document.querySelectorAll('.student-btn').forEach(b => b.classList.remove('active'));
        if(btnEl) btnEl.classList.add('active');
        document.getElementById('studentHeader').innerText = name;
        
        // Update Session
        const session = JSON.parse(localStorage.getItem('hifz_session'));
        if(session && session.type === 'teacher') {
            session.class = currentClass;
            localStorage.setItem('hifz_session', JSON.stringify(session));
        }

        // Keep date
        document.getElementById('entryDate').value = selectedDate;

        renderHistory();
    }

    window.updateSelectedDate = function() {
        selectedDate = document.getElementById('entryDate').value;
    }

    // --- AUTO FILL DATA ---
    window.autoLoadPage = async function(sec) {
        const p = document.getElementById(sec+'Page').value;
        if(!p) return;
        loadMushaf(p, true);
        setActiveSection(sec);
        document.querySelector(`input[name="activeSec"][value="${sec}"]`).checked = true;
    }

    async function fillSurahFromPage(page, section) {
        document.getElementById('loader-'+section).style.display = 'inline-block';
        try {
            const res = await fetch(`https://api.quran.com/api/v4/verses/by_page/${page}?per_page=300`); const d = await res.json();
            if(d.verses.length) {
                // Fill Start
                document.getElementById(section+'Surah').value = d.verses[0].verse_key.split(':')[0];
                document.getElementById(section+'Start').value = d.verses[0].verse_key.split(':')[1];
                // Fill End
                document.getElementById(section+'EndSurah').value = d.verses[d.verses.length-1].verse_key.split(':')[0];
                document.getElementById(section+'End').value = d.verses[d.verses.length-1].verse_key.split(':')[1];
            }
        } catch(e){} finally { document.getElementById('loader-'+section).style.display='none'; }
    }

    // --- UTILS ---
    window.openModal = function() { document.getElementById('classModal').style.display = 'flex'; document.getElementById('modalClassSelect').value = currentClass; renderModalStudentList(); }
    window.closeModal = function() { document.getElementById('classModal').style.display = 'none'; }
    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        if(tabId==='tab-students') btns[0].classList.add('active');
        if(tabId==='tab-class') btns[1].classList.add('active');
        if(tabId==='tab-data') btns[2].classList.add('active');
    }

    window.createClass = function() {
        const name = document.getElementById('newClassName').value.trim();
        if(!name || classes[name]) return alert("ﬁÇﬁ¶ﬁÇﬁ∞ ﬁÉﬁ¶ﬁÇﬁéﬁ¶ﬁÖﬁ¨ﬁáﬁ∞ ﬁÇﬁ´ﬁÇﬁ∞");
        classes[name] = { teacher: document.getElementById('newClassTeacher').value.trim(), students: [] };
        saveData(); refreshClassDropdowns(); document.getElementById('classSelect').value = name; switchClass(name); closeModal();
    }

    window.importStudents = function() {
        const cls = document.getElementById('modalClassSelect').value;
        const txt = document.getElementById('bulkStudents').value;
        const lines = txt.split('\n');
        let count = 0;
        lines.forEach(line => {
            if(!line.trim()) return;
            let parts = line.split(/[\t,]+/); if(parts.length < 2 && line.includes('-')) parts = line.split('-');
            let name = parts[0].trim().replace(/\(\d+\)$/, '').trim();
            let id = "";
            if(parts.length > 1) id = parts[1].trim().toUpperCase();
            let fullName = name;
            if (id) {
                if (name.match(/\d/)) fullName = `${name} (${parts[1].trim()})`; 
                else if (id.match(/\d/)) fullName = `${id} (${name})`;
            }
            if(!classes[cls].students.find(s => s.name === fullName)) {
                classes[cls].students.push({ name: fullName, password: "" }); count++;
            }
        });
        saveData(); document.getElementById('bulkStudents').value = ''; renderModalStudentList(); if(currentClass === cls) switchClass(cls); alert(count + " ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨");
    }

    window.renderModalStudentList = function() {
        const cls = document.getElementById('modalClassSelect').value;
        const listDiv = document.getElementById('modalStudentList'); listDiv.innerHTML = '';
        (classes[cls] ? classes[cls].students : []).forEach(s => {
            const item = document.createElement('div'); item.className = 'modal-student-item';
            item.innerHTML = `
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold; color:#2c3e50;">${s.name}</span>
                    <span style="font-size:12px; color:#95a5a6;">${s.password ? 'üîë Pwd: '+s.password : 'üîì No Pwd'}</span>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-del-mini" style="background:#3498db; color:white;" onclick="resetPass('${s.name}')">Reset</button>
                    <button class="btn-del-mini" onclick="deleteStudent('${s.name}')">Del</button>
                </div>`;
            listDiv.appendChild(item);
        });
    }

    window.deleteStudent = function(n) { if(confirm("ﬁîﬁ¶ﬁ§ﬁ©ﬁÇﬁ∞ÿü")) { const c = document.getElementById('modalClassSelect').value; classes[c].students = classes[c].students.filter(s=>s.name!==n); saveData(); renderModalStudentList(); if(currentClass===c) switchClass(c); } }
    window.resetPass = function(n) { if(confirm("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÉﬁ®ﬁêﬁ¨ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ﬁàﬁ©ÿü")) { const c = document.getElementById('modalClassSelect').value; classes[c].students.find(s=>s.name===n).password=""; saveData(); renderModalStudentList(); } }
    window.deleteSelectedClass = function() { const c = document.getElementById('deleteClassSelect').value; if(confirm("ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ﬁàﬁ©ÿü")) { delete classes[c]; saveData(); refreshClassDropdowns(); } }
    window.hardReset = function() { if(confirm("ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁëﬁ≠ﬁìﬁßﬁáﬁ¨ﬁáﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁàﬁ≠ﬁÇﬁ¨!")) { set(ref(db, 'hifz_data'), null); location.reload(); } }
    window.downloadBackup = function() { 
        const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({classes, records})); 
        a.download = "backup.json"; document.body.appendChild(a); a.click(); a.remove(); 
    }
    window.restoreBackup = function() {
        const f = document.getElementById('restoreFile').files[0];
        if(f) { const r = new FileReader(); r.onload = e => { const d = JSON.parse(e.target.result); classes = d.classes; records = d.records; saveData(); location.reload(); }; r.readAsText(f); }
    }

    // --- MUSHAF/RECORD ---
    window.loadMushaf = function(p, sync=true) {
        if(p<1||p>604) return; currentPage = parseInt(p);
        document.getElementById('navPage').value = currentPage; document.getElementById('pageIndicator').innerText = "Page "+currentPage;
        document.getElementById('mushafImg').src = `https://android.quran.com/data/width_1260/page${currentPage.toString().padStart(3,'0')}.png`;
        clearDots();
        
        const sec = document.getElementById('lessonType').value === 'exam' ? 'exam' : currentActiveSection;
        // Display dots logic
        if(editingRecordId) {
             const r = records.find(rec => rec.id === editingRecordId);
             if(r) {
                 if(r.type === 'exam') {
                     (currentDots.exam || []).forEach(d => { if(parseInt(d.page) === currentPage) drawDot(d.x, d.y, true); });
                 } else {
                     // For Daily, only show dots for the active section being edited? 
                     // Or all? Let's show all for clarity but only allow edit of active section
                     (currentDots[sec] || []).forEach(d => { if(parseInt(d.page) === currentPage) drawDot(d.x, d.y, true); });
                 }
             }
        } else {
             (currentDots[sec] || []).forEach(d => { if(parseInt(d.page) === currentPage) drawDot(d.x, d.y, true); });
        }

        if(sync && !document.body.classList.contains('student-mode') && document.getElementById('lessonType').value !== 'exam') {
            const inp = document.getElementById(currentActiveSection+'Page'); if(inp && !editingRecordId && inp.value == "") { inp.value=currentPage; fillSurahFromPage(currentPage, currentActiveSection); }
        }
    }
    window.changePage = (d) => loadMushaf(currentPage+d, false);
    window.toggleMushaf = function() { 
        const panel = document.getElementById('mushafPanel');
        panel.classList.toggle('active');
        if(window.innerWidth > 768) {
            const w = getComputedStyle(document.documentElement).getPropertyValue('--mushaf-width').trim();
            document.documentElement.style.setProperty('--mushaf-width', w === '0px' ? '35%' : '0px');
        }
    }
    window.setActiveSection = (s) => { currentActiveSection=s; document.querySelectorAll('.section-box').forEach(b=>b.classList.remove('active-section')); document.getElementById('box-'+s).classList.add('active-section'); }
    
    window.onImageClick = function(e) {
        if(document.body.classList.contains('student-mode')) return;
        if(e.target.classList.contains('mistake-dot')) return;
        const rect = document.getElementById('mushafWrapper').getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const sec = document.getElementById('lessonType').value === 'exam' ? 'exam' : currentActiveSection;
        currentDots[sec].push({ page: currentPage, x: x, y: y });
        
        drawDot(x, y, true);
        
        const isEx = document.getElementById('lessonType').value==='exam';
        isEx ? updateExamMistake('teacher', 1) : adjustMistake(currentActiveSection+'Mistakes', 1);
    }

    function drawDot(x, y, isInteractive) {
        const dot = document.createElement('div'); dot.className = 'mistake-dot';
        dot.style.left = x+'px'; dot.style.top = y+'px';
        if(isInteractive) {
            dot.onclick = (ev) => { 
                ev.stopPropagation(); 
                dot.remove(); 
                const sec = document.getElementById('lessonType').value === 'exam' ? 'exam' : currentActiveSection;
                currentDots[sec] = currentDots[sec].filter(d => d.x !== x || d.y !== y);
                const isEx = document.getElementById('lessonType').value==='exam';
                isEx ? updateExamMistake('teacher', -1) : adjustMistake(currentActiveSection+'Mistakes', -1); 
            };
        }
        document.getElementById('mushafWrapper').appendChild(dot);
    }

    window.viewMistakes = function(id) {
        const r = records.find(rec => rec.id === id);
        if(!r) return;
        let dots = [];
        if(r.type === 'exam' && r.new && r.new.dots) dots = r.new.dots; 
        else {
            if(r.new && r.new.dots) dots = dots.concat(r.new.dots);
            if(r.short && r.short.dots) dots = dots.concat(r.short.dots);
            if(r.long && r.long.dots) dots = dots.concat(r.long.dots);
        }
        if(dots.length === 0) return alert("ﬁÜﬁ™ﬁÅﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞");
        loadMushaf(dots[0].page, false);
        const panel = document.getElementById('mushafPanel');
        if(!panel.classList.contains('active')) toggleMushaf(); // Open if closed
        setTimeout(() => {
            clearDots();
            dots.forEach(d => { if(parseInt(d.page) === currentPage) drawDot(d.x, d.y, false); });
        }, 300);
    }

    window.adjustMistake = (id, d) => { const el=document.getElementById(id); let v=parseInt(el.value)||0; el.value = Math.max(0, v+d); }
    window.updateExamMistake = (t, d) => { const id = t==='teacher'?'examTeacherMistakes':'examSelfMistakes'; const el=document.getElementById(id); el.value = Math.max(0, (parseInt(el.value)||0)+d); calculateExamScore(); }
    window.calculateDuration = () => {
        const s = document.getElementById('examStartTime').value, e = document.getElementById('examEndTime').value;
        if(s&&e) document.getElementById('examDuration').innerText = Math.max(0, (new Date("01/01/2000 "+e) - new Date("01/01/2000 "+s))/60000);
    }
    window.calculateExamScore = () => {
        const hifz = Math.max(0, 80 - (parseInt(document.getElementById('examTeacherMistakes').value||0)*2) - (parseInt(document.getElementById('examSelfMistakes').value||0)));
        const total = hifz + parseFloat(document.getElementById('markMutha1').value||0) + parseFloat(document.getElementById('markMutha2').value||0) + parseFloat(document.getElementById('markTajweed').value||0) + parseFloat(document.getElementById('markFluency').value||0);
        document.getElementById('totalExamScore').innerText = total + "%";
    }
    function clearDots() { document.querySelectorAll('.mistake-dot').forEach(d=>d.remove()); }
    
    window.clearForm = () => {
        ['new','short','long'].forEach(s => { 
            document.getElementById(s+'Mistakes').value=0; document.getElementById(s+'Page').value=''; 
            document.getElementById(s+'Start').value=''; document.getElementById(s+'End').value='';
            document.getElementById(s+'Surah').value=''; document.getElementById(s+'EndSurah').value=''; 
        });
        document.getElementById('examJuzu').value = "1";
        document.getElementById('examPortion').value = "whole";
        document.getElementById('examExaminer').value = "";
        document.getElementById('examTeacherMistakes').value = 0;
        document.getElementById('examSelfMistakes').value = 0;
        document.getElementById('markMutha1').value = 2.5; document.getElementById('markMutha2').value = 2.5;
        document.getElementById('markTajweed').value = 10; document.getElementById('markFluency').value = 5;
        currentDots = { new: [], short: [], long: [], exam: [] };
        editingRecordId = null;
        clearDots();
    }
    window.toggleFormSection = (v) => { 
        document.getElementById('container-daily').style.display = v==='exam'?'none':'block'; 
        document.getElementById('container-exam').style.display = v==='exam'?'block':'none';
        setActiveSection(v==='exam'?'exam':'new');
    }
    window.setHistoryFilter = (t) => { historyFilter=t; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); document.getElementById('btnFilter'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active'); renderHistory(); }

    window.saveRecord = () => {
        if(!currentStudent) return alert("ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ∞");
        const type = document.getElementById('lessonType').value;
        const getV = id => document.getElementById(id).value;
        const getS = id => { const el=document.getElementById(id); return el.value ? el.options[el.selectedIndex].text.split('. ')[1] : ""; };
        
        let rec = { 
            id: editingRecordId || Date.now(), 
            class: currentClass, 
            student: currentStudent, 
            date: getV('entryDate'), 
            teacher: getV('teacherName') 
        };

        if(type==='exam') {
            rec = { 
                ...rec, type:'exam', 
                juzu: getV('examJuzu'), 
                portion: getV('examPortion'),
                examiner: getV('examExaminer'), 
                duration: document.getElementById('examDuration').innerText, 
                mistakes: { teacher:getV('examTeacherMistakes'), self:getV('examSelfMistakes') }, 
                scores: { 
                    mutha1:getV('markMutha1'), mutha2:getV('markMutha2'), 
                    tajweed:getV('markTajweed'), fluency:getV('markFluency'), 
                    total:document.getElementById('totalExamScore').innerText 
                },
                new: { dots: currentDots.exam } 
            };
        } else {
            // ONLY SAVE ACTIVE SECTION
            rec.type = 'daily';
            // Start with blank objects
            rec.new = {s:"", es:"", st:"", en:"", m:0};
            rec.short = {s:"", es:"", st:"", en:"", m:0};
            rec.long = {s:"", es:"", st:"", en:"", m:0};

            const active = currentActiveSection; // 'new', 'short', 'long'
            
            // Helper to build object from inputs
            const buildObj = (sec) => ({
                s:getS(sec+'Surah'), es:getS(sec+'EndSurah'), 
                st:getV(sec+'Start'), en:getV(sec+'End'), 
                m:getV(sec+'Mistakes'), p: sec==='new'?getV('newPage'):"",
                dots: currentDots[sec]
            });

            // Populate only the active section
            if(active === 'new') rec.new = buildObj('new');
            if(active === 'short') rec.short = buildObj('short');
            if(active === 'long') rec.long = buildObj('long');
        }
        
        if(editingRecordId) {
            records = records.filter(r => r.id !== editingRecordId);
        }
        records.push(rec); 
        saveData(); 
        renderHistory(); 
        clearForm(); // Reset fields
        alert("ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨");
    }

    window.editRecord = function(id) {
        const r = records.find(rec => rec.id === id);
        if(!r) return;
        editingRecordId = id;
        document.getElementById('entryDate').value = r.date;
        document.getElementById('teacherName').value = r.teacher;
        document.getElementById('lessonType').value = r.type;
        toggleFormSection(r.type);

        currentDots = { new: [], short: [], long: [], exam: [] };

        if(r.type === 'exam') {
            document.getElementById('examJuzu').value = r.juzu;
            document.getElementById('examPortion').value = r.portion || 'whole';
            document.getElementById('examExaminer').value = r.examiner;
            document.getElementById('examTeacherMistakes').value = r.mistakes.teacher;
            document.getElementById('examSelfMistakes').value = r.mistakes.self;
            document.getElementById('markMutha1').value = r.scores.mutha1;
            document.getElementById('markMutha2').value = r.scores.mutha2;
            document.getElementById('markTajweed').value = r.scores.tajweed;
            document.getElementById('markFluency').value = r.scores.fluency;
            document.getElementById('totalExamScore').innerText = r.scores.total;
            currentDots.exam = r.new?.dots || [];
        } else {
            // Function to load data to inputs
            const loadSec = (sec, data) => {
                if(!data || !data.s) return; // Skip if empty
                setActiveSection(sec); document.querySelector(`input[name="activeSec"][value="${sec}"]`).checked = true;
                
                const sEl = document.getElementById(sec+'Surah');
                for(let i=0; i<sEl.options.length; i++) { if(sEl.options[i].text.includes(data.s)) sEl.value = sEl.options[i].value; }
                
                const esEl = document.getElementById(sec+'EndSurah');
                for(let i=0; i<esEl.options.length; i++) { if(esEl.options[i].text.includes(data.es)) esEl.value = esEl.options[i].value; }
                
                document.getElementById(sec+'Start').value = data.st;
                document.getElementById(sec+'End').value = data.en;
                document.getElementById(sec+'Mistakes').value = data.m;
                if(sec==='new') document.getElementById('newPage').value = data.p;
                currentDots[sec] = data.dots || [];
            };
            
            // Prioritize loading active data. Since we only save active, usually only one is full.
            if(r.new && r.new.s) loadSec('new', r.new);
            else if(r.short && r.short.s) loadSec('short', r.short);
            else if(r.long && r.long.s) loadSec('long', r.long);
        }
        window.scrollTo(0,0);
        alert("ﬁáﬁ¨ﬁëﬁ®ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨");
    }

    function renderHistory() {
        const con = document.getElementById('historyContainer'); con.innerHTML = '';
        const data = records.filter(r => r.class === currentClass && r.student === currentStudent).sort((a,b)=>new Date(b.date)-new Date(a.date));
        
        data.forEach(r => {
            if(historyFilter !== 'all' && r.type !== historyFilter && !(r.type==='daily' && (r[historyFilter]?.s || r[historyFilter]?.st))) return;
            
            const card = document.createElement('div'); 
            if(r.type === 'exam') {
                card.className = 'history-card exam-card';
                let portionText = "";
                if(r.portion === 'half') portionText = "(ﬁáﬁ¨ﬁáﬁ∞ﬁÑﬁ¶ﬁáﬁ®)";
                if(r.portion === 'third') portionText = "(1/3)";
                
                card.innerHTML = `
                    <button class="delete-card-btn" onclick="delRec(${r.id})">&times;</button>
                    <div class="card-header">
                        <span class="card-date">üèÜ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞ (ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ${r.juzu}) ${portionText} - ${r.date}</span>
                        <span class="card-teacher">${r.scores.total}</span>
                    </div>
                    <div class="card-body">
                        <div class="card-section exam">ﬁáﬁ¨ﬁéﬁ∞ﬁíﬁßﬁâﬁ®ﬁÇﬁ¶ﬁÉ: ${r.examiner}<br>ﬁÜﬁ™ﬁÅﬁ∞: T(${r.mistakes.teacher}) S(${r.mistakes.self})</div>
                    </div>
                    <div style="padding:10px; border-top:1px solid #eee; display:flex; gap:10px;">
                        <button class="btn btn-yellow" style="font-size:12px; padding:5px 10px;" onclick="editRecord(${r.id})">ﬁáﬁ®ﬁûﬁ∞ﬁçﬁßﬁôﬁ∞</button>
                        <button class="btn btn-blue" style="font-size:12px; padding:5px 10px;" onclick="viewMistakes(${r.id})">ﬁÜﬁ™ﬁÅﬁ∞ﬁåﬁ¶ﬁáﬁ∞</button>
                    </div>`;
            } else {
                card.className = 'history-card';
                const sec = (lbl, o, c) => (!o || (!o.s && !o.st && o.m==0)) ? '' : `<div class="card-section ${c}"><span class="section-label">${lbl}</span><div class="surah-name">${o.s}${o.es&&o.es!==o.s?' - '+o.es:''}</div><div>ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞: ${o.st}-${o.en}</div>${o.p ? '<div>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß: '+o.p+'</div>' : ''}<span class="mistake-badge ${o.m>0?'red':'green'}">${o.m} ﬁÜﬁ™ﬁÅﬁ∞</span></div>`;
                card.innerHTML = `
                    <button class="delete-card-btn" onclick="delRec(${r.id})">&times;</button>
                    <div class="card-header"><span class="card-date">üìÖ ${r.date}</span><span class="card-teacher">${r.teacher}</span></div>
                    <div class="card-body">${sec('ﬁáﬁß', r.new, 'new')}${sec('ﬁÜﬁ™ﬁÉﬁ™', r.short, 'short')}${sec('ﬁãﬁ®ﬁéﬁ™', r.long, 'long')}</div>
                    <div style="padding:10px; border-top:1px solid #eee; display:flex; gap:10px;">
                        <button class="btn btn-yellow" style="font-size:12px; padding:5px 10px;" onclick="editRecord(${r.id})">ﬁáﬁ®ﬁûﬁ∞ﬁçﬁßﬁôﬁ∞</button>
                        <button class="btn btn-blue" style="font-size:12px; padding:5px 10px;" onclick="viewMistakes(${r.id})">ﬁÜﬁ™ﬁÅﬁ∞ﬁåﬁ¶ﬁáﬁ∞</button>
                    </div>`;
            }
            con.appendChild(card);
        });
        if(con.innerHTML === '') con.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</div>';
    }

    window.delRec = (id) => { if(confirm("ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ﬁàﬁ©ÿü")) { records = records.filter(r=>r.id!==id); saveData(); renderHistory(); } }
    
    window.exportExcel = () => {
        if(!records.length) return alert("ﬁÇﬁØ ﬁëﬁ≠ﬁìﬁß");
        const data = records.filter(r => r.class === currentClass).map(r => {
            if(r.type === 'exam') return { Date: r.date, Student: r.student, Type: 'Exam', Juzu: r.juzu, Portion: r.portion, Total: r.scores.total };
            const s = (o) => o.s ? `${o.s} ${o.st}-${o.en} (${o.m})` : '';
            return { Date: r.date, Student: r.student, New: s(r.new), Short: s(r.short), Long: s(r.long) };
        });
        const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, currentClass); XLSX.writeFile(wb, `Hifz_${currentClass}.xlsx`);
    }

    window.openProgressModal = () => document.getElementById('progressModal').style.display='flex';
    window.closeProgressModal = () => document.getElementById('progressModal').style.display='none';
    window.calculateProgress = () => {
        const s = new Date(document.getElementById('progStartDate').value), e = new Date(document.getElementById('progEndDate').value);
        if(isNaN(s)||isNaN(e)) return alert("ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞ ﬁÇﬁ¶ﬁéﬁß");
        const c = records.filter(r => r.class===currentClass && r.student===currentStudent && r.type==='daily' && r.new.s && new Date(r.date)>=s && new Date(r.date)<=e).length;
        document.getElementById('progCount').innerText = c; document.getElementById('progressResult').style.display='block';
    }
</script>
</body>
</html>
