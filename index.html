<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ﬁ§ﬁ™ﬁÉﬁ∞ﬁáﬁßﬁÇﬁ∞ ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ - Online v6.0</title>
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* FONT SETUP */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
        
        @font-face { font-family: 'Faruma'; src: local('Faruma'); }
        @font-face { font-family: 'MV Waheed'; src: local('MV Waheed'); }

        :root {
            --primary-color: #2c3e50;
            --accent-color: #27ae60;
            --bg-color: #f4f7f6;
            --sidebar-width: 280px;
            --mushaf-width: 35%;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.05);
            --font-heading: 'MV Waheed', 'mv waheed', 'Noto Sans Thaana', sans-serif;
            --font-body: 'Faruma', 'faruma', 'Noto Sans Thaana', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
        }
        
        h1, h2, h3, h4, h5, h6, .modal-header h3, .login-title, label, th, .tab-btn, .section-label {
            font-family: var(--font-heading);
        }

        /* LOGIN SCREEN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
            width: 350px; color: #333;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd;
            border-radius: 8px; font-family: var(--font-body); box-sizing: border-box;
            font-size: 14px; text-align: center;
        }
        .login-input:focus { border-color: var(--accent-color); outline: none; }

        .login-btn {
            width: 100%; padding: 12px; margin-top: 15px; border: none;
            border-radius: 8px; font-size: 16px; cursor: pointer;
            font-family: var(--font-heading); font-weight: bold; transition: 0.2s;
        }
        .btn-teacher-login { background: #2c3e50; color: white; }
        .btn-student-login { background: #27ae60; color: white; }
        .btn-student-login:hover { background: #219150; }
        
        .login-tab {
            display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px;
        }
        .login-tab-btn {
            flex: 1; padding: 10px; cursor: pointer; font-family: var(--font-heading);
            background: none; border: none; border-bottom: 3px solid transparent;
        }
        .login-tab-btn.active { border-color: var(--accent-color); color: var(--accent-color); }

        /* PARENT/STUDENT MODE HIDING */
        body.student-mode .teacher-only { display: none !important; }
        body.student-mode .delete-card-btn { display: none !important; }
        body.student-mode .entry-form { display: none !important; }
        body.student-mode .mushaf-panel { pointer-events: none; } 
        
        /* SIDEBAR & MAIN CONTENT */
        .sidebar {
            width: var(--sidebar-width); background-color: white; border-left: 1px solid #ddd;
            display: flex; flex-direction: column; padding: 15px; box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            flex-shrink: 0; z-index: 20;
        }
        .class-control-area { background-color: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
        .class-select { width: 100%; padding: 10px; font-family: inherit; font-size: 14px; font-weight: bold; color: #2c3e50; border: 2px solid #3498db; border-radius: 5px; background-color: white; margin-bottom: 10px; cursor: pointer; }
        .manage-btn { width: 100%; background: #e67e22; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px; font-family: var(--font-body); }
        .manage-btn:hover { background: #d35400; }
        .student-list-container { flex: 1; overflow-y: auto; }
        .student-btn { background: none; border: none; padding: 12px 10px; text-align: right; width: 100%; cursor: pointer; font-family: inherit; font-size: 16px; border-radius: 6px; margin-bottom: 4px; border-bottom: 1px solid #f9f9f9; transition: 0.2s; color: #2c3e50; }
        .student-btn:hover { background-color: #e8f6ef; color: var(--accent-color); padding-right: 15px; }
        .student-btn.active { background-color: var(--accent-color); color: white; font-weight: bold; padding-right: 15px; box-shadow: 0 2px 4px rgba(39, 174, 96, 0.2); }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

        /* MUSHAF & FORMS */
        .mushaf-panel { width: var(--mushaf-width); background: #2c3e50; display: flex; flex-direction: column; transition: width 0.3s ease; border-right: 1px solid #ccc; }
        .mushaf-header { background: #34495e; color: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .mushaf-container { flex: 1; overflow: auto; background: #fdfdfd; display: flex; justify-content: center; position: relative; }
        .mushaf-wrapper { position: relative; display: inline-block; margin: 10px; }
        .mushaf-page-img { max-width: 100%; display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: crosshair; border: 1px solid #ddd; }
        .mistake-dot { position: absolute; width: 20px; height: 20px; background-color: rgba(231, 76, 60, 0.9); border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); cursor: pointer; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .entry-form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-group { flex: 1; }
        input, select { width: 100%; padding: 8px 10px; border: 1px solid #dcdcdc; border-radius: 5px; box-sizing: border-box; font-family: inherit; font-size: 14px;}
        .arabic-input { font-family: 'Amiri', serif; direction: rtl; }
        .section-box { padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 2px solid transparent; transition: 0.2s; }
        .section-new { background-color: #eafaf1; }
        .section-short { background-color: #ebf5fb; }
        .section-long { background-color: #fef9e7; }
        .section-box.active-section { border-color: var(--accent-color); box-shadow: 0 0 10px rgba(39, 174, 96, 0.15); background-color: white; border-left: 5px solid var(--accent-color); }
        .radio-label { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 20px; border: 1px solid #ddd; cursor: pointer; font-size: 14px; font-weight: bold; transition: 0.2s; }
        input[type="radio"] { accent-color: var(--accent-color); }
        input[type="radio"]:checked + span { color: var(--accent-color); }
        .mistake-wrapper { display: flex; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; }
        .mistake-btn { width: 30px; border: none; background: #eee; cursor: pointer; font-weight: bold; font-size: 14px;}
        .mistake-display { text-align: center; font-weight: bold; width: 40px; border: none; border-left: 1px solid #ddd; border-right: 1px solid #ddd; }
        .exam-header { font-size: 18px; font-weight: bold; color: #d35400; margin-bottom: 15px; border-bottom: 2px solid #f39c12; padding-bottom: 5px; display:flex; justify-content:space-between; align-items:center;}

        /* HISTORY & MODAL */
        .history-card { background: white; border-radius: 10px; box-shadow: var(--card-shadow); margin-bottom: 15px; padding: 15px; border-right: 5px solid var(--primary-color); position: relative; transition: transform 0.2s; }
        .history-card.exam-card { border-right-color: #f1c40f; background: #fffdf0; }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .card-date { font-weight: bold; color: var(--primary-color); font-size: 16px; }
        .card-teacher { font-size: 12px; color: #7f8c8d; background: #f0f0f0; padding: 2px 8px; border-radius: 10px;}
        .card-body { display: flex; gap: 10px; flex-wrap: wrap; }
        .card-section { flex: 1; min-width: 180px; padding: 10px; border-radius: 6px; font-size: 14px; }
        .card-section.new { background-color: #eafaf1; color: #27ae60; }
        .card-section.short { background-color: #ebf5fb; color: #2980b9; }
        .card-section.long { background-color: #fef9e7; color: #d35400; }
        .card-section.exam { background-color: #fff; border: 1px solid #f1c40f; color: #333; }
        .section-label { font-weight: bold; margin-bottom: 5px; display: block; font-size: 12px; text-transform: uppercase; }
        .surah-name { font-family: 'Amiri', serif; font-size: 15px; font-weight: bold;}
        .mistake-badge { background: white; padding: 2px 8px; border-radius: 10px; font-weight: bold; font-size: 12px; }
        .mistake-badge.red { color: #e74c3c; border: 1px solid #e74c3c; }
        .mistake-badge.green { color: #27ae60; border: 1px solid #27ae60; }
        .delete-card-btn { position: absolute; top: 10px; left: 10px; background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 18px; opacity: 0.6; }
        .hifz-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .hifz-table th { background: #eee; color: #333; padding: 10px; text-align: right; border-bottom: 2px solid #ccc; }
        .hifz-table td { border-bottom: 1px solid #eee; padding: 10px; vertical-align: top;}
        .hifz-table tr:hover { background-color: #f9f9f9; }

        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background-color: white; padding: 0; border-radius: 10px; width: 550px; max-width: 95%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border-top: 5px solid #3498db; overflow: hidden; display:flex; flex-direction:column; max-height:90vh;}
        .modal-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
        .modal-body { padding: 20px; overflow-y: auto; }
        .close-modal { font-size: 24px; cursor: pointer; color: #7f8c8d; }
        .tab-header { display: flex; background: #eee; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; font-size: 14px; color: #555; background:#eee; }
        .tab-btn.active { background: white; color: var(--primary-color); border-bottom: 3px solid #3498db; }
        .tab-content { display: none; padding-top: 15px; }
        .tab-content.active { display: block; }
        textarea { width: 100%; height: 120px; margin: 10px 0; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; font-family: monospace; font-size: 13px;}

        /* Modified Student List in Modal to show passwords */
        .modal-student-list { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; margin-top: 15px; }
        .modal-student-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f5f5f5; font-size: 14px; }
        .modal-student-item:last-child { border-bottom: none; }
        .modal-student-item:hover { background: #f9f9f9; }
        
        .student-details { display: flex; flex-direction: column; }
        .student-name-txt { font-weight: bold; color: #2c3e50; }
        .student-pass-txt { font-size: 12px; color: #e67e22; margin-top: 2px; }

        .btn { padding: 8px 16px; border: none; border-radius: 5px; color: white; cursor: pointer; font-family: inherit; font-weight: bold; display: inline-flex; align-items: center; gap: 5px;}
        .btn-green { background: var(--accent-color); }
        .btn-blue { background: #3498db; }
        .btn-red { background: #e74c3c; }
        .btn-grey { background: #95a5a6; color: white; }
        .btn-del-mini { background: #ffebee; color: #c0392b; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .filter-btn { background: #eee; color: #555; border:none; padding:6px 12px; border-radius:15px; cursor:pointer; font-weight:bold; font-size:13px; transition:0.2s; white-space: nowrap; margin-bottom: 5px; font-family: var(--font-body);}
        .filter-btn:hover { background: #ddd; }
        .filter-btn.active { background: var(--primary-color); color: white; }
        .loader-spin { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN WITH ID INPUT -->
    <div id="login-screen">
        <div class="login-box">
            <h2 class="login-title" style="color:var(--primary-color); margin-top:0;">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞</h2>
            
            <div class="login-tab">
                <button class="login-tab-btn active" id="tabStudent" onclick="switchLoginTab('student')">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</button>
                <button class="login-tab-btn" id="tabTeacher" onclick="switchLoginTab('teacher')">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
            </div>

            <!-- Student Login Form -->
            <div id="login-form-student">
                <select id="loginClassSelect" class="login-input">
                    <option value="">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁÇﬁ¶ﬁéﬁß...</option>
                </select>
                
                <input type="text" id="loginStudentId" class="login-input" placeholder="ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© (ﬁâﬁ®ﬁêﬁßﬁçﬁ™: IUM123)" style="text-transform: uppercase;">
                
                <input type="password" id="studentPassword" class="login-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ (ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁäﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁÆﬁÅﬁ∞)">
                
                <button class="login-btn btn-student-login" onclick="handleStudentLogin()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
                
                <p style="font-size:11px; color:#666; margin-top:10px;">
                    ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁäﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ ﬁàﬁ¶ﬁÇﬁ∞ﬁÇﬁ¶ﬁáﬁ®ﬁÉﬁ™ÿå ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁñﬁ¨ﬁÄﬁ™ﬁâﬁ¶ﬁÅﬁ∞ﬁäﬁ¶ﬁÄﬁ™ ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁÑﬁ¶ﬁÄﬁ¶ﬁáﬁ∞ﬁìﬁßﬁäﬁ¶ﬁáﬁ® ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞ﬁáﬁ¶ﬁÅﬁ∞ ﬁäﬁ®ﬁåﬁßﬁçﬁß.
                </p>
            </div>

            <!-- Teacher Login Form -->
            <div id="login-form-teacher" style="display:none;">
                <p style="font-size:14px; margin-bottom:15px;">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁöﬁßﬁáﬁ∞ﬁûﬁ¶ ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß</p>
                <input type="password" id="teacherPassword" class="login-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
                <button class="login-btn btn-teacher-login" onclick="handleTeacherLogin()">ﬁìﬁ©ﬁóﬁ¶ﬁÉ ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
        </div>
        <p style="margin-top:20px; opacity:0.7; font-size:12px;">¬© Quran Hifz Tracker v6.0 (Online)</p>
    </div>

    <!-- NEW PASSWORD SETUP MODAL -->
    <div id="passwordSetupModal" class="modal">
        <div class="modal-content" style="width:400px;">
            <div class="modal-header">
                <h3 style="margin:0; color:var(--primary-color);">ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁêﬁ¨ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</h3>
            </div>
            <div class="modal-body">
                <p style="font-size:14px; color:#555;">ﬁâﬁ® ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁßﬁáﬁ¶ﬁÅﬁ∞ ﬁáﬁ¶ﬁãﬁ® ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁÄﬁ¨ﬁãﬁ®ﬁäﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞. ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ﬁãﬁ®ﬁáﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁÄﬁ¶ﬁáﬁ∞ﬁãﬁ¶ﬁàﬁß.</p>
                
                <label>ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞:</label>
                <input type="password" id="newPass1" style="margin-bottom:10px;">
                
                <label>ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÜﬁ¶ﬁÅﬁ¶ﬁàﬁ¶ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ≠:</label>
                <input type="password" id="newPass2" style="margin-bottom:20px;">
                
                <button class="btn btn-green" style="width:100%; justify-content:center;" onclick="saveNewPassword()">ﬁêﬁ≠ﬁàﬁ∞ & ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
        </div>
    </div>

    <!-- APP CONTENT (Initially Hidden) -->
    <div id="app-container" style="display:none; width:100%; height:100%; display:flex;">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <h3 style="text-align:center; color:var(--primary-color); margin-top:0; border-bottom: 2px solid var(--accent-color); padding-bottom: 10px;">
                ﬁ§ﬁ™ﬁÉﬁ∞ﬁáﬁßﬁÇﬁ∞ ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞
            </h3>
            
            <div class="class-control-area">
                <label style="color:#7f8c8d; margin-bottom: 5px;">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                <select id="classSelect" class="class-select" onchange="switchClass(this.value)">
                    <!-- JS will fill this -->
                </select>
                <button class="manage-btn teacher-only" onclick="openModal()">
                    <span>‚öôÔ∏è</span> ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ / ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞
                </button>
            </div>
            
            <h4 style="margin: 10px 0; color:#555; border-bottom:1px solid #eee; padding-bottom:5px;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</h4>
            <div id="studentListContainer" class="student-list-container">
                <!-- JS will fill this -->
            </div>
            <button class="btn btn-grey" onclick="logout()" style="margin-top:10px; width:100%; justify-content:center; font-size:14px;">üö™ Logout</button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- Header -->
            <div style="background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <small style="color:#7f8c8d; font-weight:bold; display:block;" id="currentClassDisplay">Class: -</small>
                    <div style="display:flex; align-items:baseline; gap:10px;">
                        <h2 id="studentHeader" style="margin:0; color:var(--primary-color); font-size: 26px;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</h2>
                        <span id="classTeacherDisplay" style="font-size:14px; color:#27ae60; background:#eafaf1; padding:2px 8px; border-radius:10px; display:none;"></span>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-green teacher-only" onclick="exportExcel()">üì• Excel</button>
                    <button class="btn btn-blue" style="background:#8e44ad;" onclick="openProgressModal()">üìà ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁ¨ﬁêﬁ∞</button>
                    <button class="btn btn-blue" onclick="toggleMushaf()">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ∞</button>
                </div>
            </div>

            <!-- Entry Form (TEACHER ONLY) -->
            <div class="entry-form teacher-only">
                <div class="form-row">
                    <div class="form-group" style="flex:0.5"><label>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="entryDate"></div>
                    <div class="form-group"><label>ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</label><input type="text" id="teacherName" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞ ﬁçﬁ®ﬁîﬁ™ﬁáﬁ∞ﬁàﬁß"></div>
                    <div class="form-group" style="flex:0.5">
                        <label>ﬁàﬁ¶ﬁáﬁ∞ﬁåﬁ¶ﬁÉﬁ™</label>
                        <select id="lessonType" onchange="toggleFormSection(this.value)">
                            <option value="daily">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ﬁåﬁ¶ﬁáﬁ∞</option>
                            <option value="exam">ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</option>
                        </select>
                    </div>
                </div>

                <!-- DAILY LESSONS CONTAINER -->
                <div id="container-daily">
                    <!-- New Lesson -->
                    <div id="box-new" class="section-box section-new active-section">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#27ae60; font-size:16px;">ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ <span id="loader-new" style="display:none;" class="loader-spin"></span></label>
                            <label class="radio-label">
                                <input type="radio" name="activeSec" value="new" checked onchange="setActiveSection('new')">
                                <span>ﬁâﬁ®ﬁÑﬁ¶ﬁîﬁ¶ﬁÅﬁ∞ ﬁÜﬁ™ﬁÅﬁ∞ﬁñﬁ¨ﬁÄﬁ™ﬁÇﬁ∞</span>
                            </label>
                        </div>
                        <div class="form-row">
                            <div style="flex:0.6"><input type="number" id="newPage" placeholder="ﬁû: ﬁáﬁÆﬁìﬁØ" onchange="autoLoadPage('new')" style="background:#fffde7; border-color:#f1c40f; text-align:center;"></div>
                            <div style="flex:2"><select id="newSurah" class="arabic-input"><option value="">ﬁäﬁ¨ﬁÅﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:0.8"><input type="number" id="newStart" placeholder="ﬁäﬁ¨ﬁÅﬁ® ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞"></div>
                        </div>
                        <div class="form-row">
                            <div style="flex:2.6"><select id="newEndSurah" class="arabic-input"><option value="">ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:0.8"><input type="number" id="newEnd" placeholder="ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁ® ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞"></div>
                            <div>
                                <div class="mistake-wrapper">
                                    <button class="mistake-btn plus" onclick="adjustMistake('newMistakes', 1)">+</button>
                                    <input id="newMistakes" class="mistake-display" value="0" readonly>
                                    <button class="mistake-btn minus" onclick="adjustMistake('newMistakes', -1)">-</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Short Revision -->
                    <div id="box-short" class="section-box section-short">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#2980b9; font-size:16px;">ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß <span id="loader-short" style="display:none;" class="loader-spin"></span></label>
                            <label class="radio-label">
                                <input type="radio" name="activeSec" value="short" onchange="setActiveSection('short')">
                                <span>ﬁâﬁ®ﬁÑﬁ¶ﬁîﬁ¶ﬁÅﬁ∞ ﬁÜﬁ™ﬁÅﬁ∞ﬁñﬁ¨ﬁÄﬁ™ﬁÇﬁ∞</span>
                            </label>
                        </div>
                        <div class="form-row">
                            <div style="flex:0.6"><input type="number" id="shortPage" placeholder="ﬁû: ﬁáﬁÆﬁìﬁØ" onchange="autoLoadPage('short')" style="background:#fffde7; border-color:#f1c40f; text-align:center;"></div>
                            <div style="flex:2"><select id="shortSurah" class="arabic-input"><option value="">ﬁäﬁ¨ﬁÅﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:0.8"><input type="number" id="shortStart" placeholder="ﬁäﬁ¨ﬁÅﬁ® ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞"></div>
                        </div>
                        <div class="form-row">
                            <div style="flex:2.6"><select id="shortEndSurah" class="arabic-input"><option value="">ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:0.8"><input type="number" id="shortEnd" placeholder="ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁ® ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞"></div>
                            <div>
                                <div class="mistake-wrapper">
                                    <button class="mistake-btn plus" onclick="adjustMistake('shortMistakes', 1)">+</button>
                                    <input id="shortMistakes" class="mistake-display" value="0" readonly>
                                    <button class="mistake-btn minus" onclick="adjustMistake('shortMistakes', -1)">-</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Long Revision -->
                    <div id="box-long" class="section-box section-long">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#d35400; font-size:16px;">ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß <span id="loader-long" style="display:none;" class="loader-spin"></span></label>
                            <label class="radio-label">
                                <input type="radio" name="activeSec" value="long" onchange="setActiveSection('long')">
                                <span>ﬁâﬁ®ﬁÑﬁ¶ﬁîﬁ¶ﬁÅﬁ∞ ﬁÜﬁ™ﬁÅﬁ∞ﬁñﬁ¨ﬁÄﬁ™ﬁÇﬁ∞</span>
                            </label>
                        </div>
                        <div class="form-row">
                            <div style="flex:0.6"><input type="number" id="longPage" placeholder="ﬁû: ﬁáﬁÆﬁìﬁØ" onchange="autoLoadPage('long')" style="background:#fffde7; border-color:#f1c40f; text-align:center;"></div>
                            <div style="flex:2"><select id="longSurah" class="arabic-input"><option value="">ﬁäﬁ¨ﬁÅﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:0.8"><input type="number" id="longStart" placeholder="ﬁäﬁ¨ﬁÅﬁ® ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞"></div>
                        </div>
                        <div class="form-row">
                            <div style="flex:2.6"><select id="longEndSurah" class="arabic-input"><option value="">ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞...</option></select></div>
                            <div style="flex:0.8"><input type="number" id="longEnd" placeholder="ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁ® ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞"></div>
                            <div>
                                <div class="mistake-wrapper">
                                    <button class="mistake-btn plus" onclick="adjustMistake('longMistakes', 1)">+</button>
                                    <input id="longMistakes" class="mistake-display" value="0" readonly>
                                    <button class="mistake-btn minus" onclick="adjustMistake('longMistakes', -1)">-</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EXAM CONTAINER -->
                <div id="container-exam" style="display:none;">
                    <div id="box-exam" class="section-box section-exam active-section">
                        <div class="exam-header">
                            <span>üèÜ ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</span>
                            <span id="totalExamScore" style="font-size:24px; color:#2c3e50;">100%</span>
                        </div>

                        <div class="form-row">
                            <div style="flex:2">
                                <label>ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ≠ ﬁÑﬁ¶ﬁáﬁ® (ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™/ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞):</label>
                                <input type="text" id="examJuzu" placeholder="ﬁâﬁ®ﬁêﬁßﬁçﬁ™: 30 ﬁàﬁ¶ﬁÇﬁ¶ ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™">
                            </div>
                            <div style="flex:2">
                                <label>ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞ ﬁÜﬁ™ﬁÉﬁ® ﬁäﬁ¶ﬁÉﬁßﬁåﬁ∞:</label>
                                <input type="text" id="examExaminer" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞">
                            </div>
                        </div>
                        <div class="form-row" style="background:white; padding:10px; border-radius:6px; border:1px solid #ddd;">
                            <div style="flex:1">
                                <label>ﬁäﬁ¶ﬁÅﬁß ﬁéﬁ¶ﬁëﬁ®:</label>
                                <input type="time" id="examStartTime" onchange="calculateDuration()">
                            </div>
                            <div style="flex:1">
                                <label>ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁß ﬁéﬁ¶ﬁëﬁ®:</label>
                                <input type="time" id="examEndTime" onchange="calculateDuration()">
                            </div>
                            <div style="flex:0.5; text-align:center;">
                                <label>ﬁâﬁ®ﬁÇﬁ¨ﬁìﬁ∞</label>
                                <span id="examDuration" style="font-weight:bold; color:blue; font-size:18px;">0</span>
                            </div>
                        </div>

                        <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                            <h5 style="margin:5px 0;">ﬁÄﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁÜﬁ™ﬁÅﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ 80 ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞)</h5>
                            <div style="display:flex; gap:15px; margin-bottom:15px;">
                                <div style="flex:1; background:#ffebee; padding:10px; border-radius:5px;">
                                    <label style="color:#c0392b;">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ ﬁÉﬁ¶ﬁÇﬁéﬁ¶ﬁÖﬁ™ﬁÜﬁ™ﬁÉﬁ® (-2)</label>
                                    <div class="mistake-wrapper">
                                        <button class="mistake-btn" onclick="updateExamMistake('teacher', 1)">+</button>
                                        <input id="examTeacherMistakes" class="mistake-display" value="0" readonly>
                                        <button class="mistake-btn" onclick="updateExamMistake('teacher', -1)">-</button>
                                    </div>
                                </div>
                                <div style="flex:1; background:#fff8e1; padding:10px; border-radius:5px;">
                                    <label style="color:#d35400;">ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ﬁáﬁ¶ﬁÅﬁ∞ ﬁÉﬁ¶ﬁÇﬁéﬁ¶ﬁÖﬁ™ﬁÜﬁ™ﬁÉﬁ® (-1)</label>
                                    <div class="mistake-wrapper">
                                        <button class="mistake-btn" onclick="updateExamMistake('self', 1)">+</button>
                                        <input id="examSelfMistakes" class="mistake-display" value="0" readonly>
                                        <button class="mistake-btn" onclick="updateExamMistake('self', -1)">-</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞ 1 (2.5)</label>
                                <input type="number" id="markMutha1" step="0.5" max="2.5" value="2.5" onchange="calculateExamScore()">
                            </div>
                            <div class="form-group">
                                <label>ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞ 2 (2.5)</label>
                                <input type="number" id="markMutha2" step="0.5" max="2.5" value="2.5" onchange="calculateExamScore()">
                            </div>
                            <div class="form-group">
                                <label>ﬁåﬁ¶ﬁñﬁ∞ﬁàﬁ©ﬁãﬁ™ (10)</label>
                                <input type="number" id="markTajweed" step="0.5" max="10" value="10" onchange="calculateExamScore()">
                            </div>
                            <div class="form-group">
                                <label>ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞ (5)</label>
                                <input type="number" id="markFluency" step="0.5" max="5" value="5" onchange="calculateExamScore()">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-green" style="flex:1; justify-content: center; font-size:16px;" onclick="saveRecord()">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</button>
                    <button class="btn btn-red" style="width:auto; justify-content: center;" onclick="clearForm()">ﬁäﬁØﬁâﬁ™ ﬁêﬁßﬁäﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                </div>
            </div>

            <!-- HISTORY SECTION -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0 10px 0; border-bottom: 2px solid #eee; padding-bottom:8px; flex-wrap:wrap; gap:5px;">
                <h4 style="margin:0; color:#555;">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁåﬁßﬁàﬁ¶ﬁçﬁ∞ (History)</h4>
                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="filter-btn active" id="btnFilterAll" onclick="setHistoryFilter('all')">ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß</button>
                    <button class="filter-btn" id="btnFilterNew" onclick="setHistoryFilter('new')">ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</button>
                    <button class="filter-btn" id="btnFilterShort" onclick="setHistoryFilter('short')">ﬁÜﬁ™ﬁÉﬁ™</button>
                    <button class="filter-btn" id="btnFilterLong" onclick="setHistoryFilter('long')">ﬁãﬁ®ﬁéﬁ™</button>
                    <button class="filter-btn" id="btnFilterExam" onclick="setHistoryFilter('exam')">ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</button>
                </div>
            </div>
            
            <div id="historyContainer" class="history-container">
                <!-- Content injected here -->
            </div>
        </div>

        <!-- MUSHAF PANEL -->
        <div class="mushaf-panel" id="mushafPanel">
            <div class="mushaf-header">
                <span id="pageIndicator" style="font-weight:bold; font-size:16px;">Page 1</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn" style="background:#555; padding:0 10px;" onclick="changePage(1)">ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ &gt;</button>
                    <input type="number" id="navPage" style="width:60px; text-align:center; color:black; padding:5px; border-radius:4px; border:none;" min="1" max="604" onchange="loadMushaf(this.value)">
                    <button class="btn" style="background:#555; padding:0 10px;" onclick="changePage(-1)">&lt; ﬁäﬁ¶ﬁÄﬁ¶ﬁåﬁ¶ﬁÅﬁ∞</button>
                </div>
            </div>
            <div class="mushaf-container">
                <div class="mushaf-wrapper" id="mushafWrapper" onclick="onImageClick(event)">
                    <img id="mushafImg" class="mushaf-page-img" src="" alt="Quran Page">
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:var(--primary-color);">‚öôÔ∏è ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ & ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            
            <div class="tab-header">
                <div class="tab-btn active" onclick="switchTab('tab-students')">ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ (Students)</div>
                <div class="tab-btn" onclick="switchTab('tab-class')">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ (Class)</div>
                <div class="tab-btn" onclick="switchTab('tab-data')">ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞ (Backup)</div>
            </div>

            <div class="modal-body">
                <!-- TAB 1: Add/Edit Students -->
                <div id="tab-students" class="tab-content active">
                    <label>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß:</label>
                    <select id="modalClassSelect" class="class-select" style="margin-bottom:15px;" onchange="renderModalStudentList()"></select>
                    
                    <div style="background:#f9f9f9; padding:10px; border:1px solid #eee; border-radius:5px;">
                        <label style="color:#2c3e50; font-weight:bold;">ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞:</label>
                        <p style="font-size:11px; color:#555; margin:5px 0 8px 0;">
                            <b>ﬁäﬁØﬁâﬁ¨ﬁìﬁ∞:</b> <code>IUM-ID (ﬁÇﬁ¶ﬁÇﬁ∞)</code> ﬁÇﬁ™ﬁàﬁ¶ﬁåﬁ¶ <code>IUM-ID - ﬁÇﬁ¶ﬁÇﬁ∞</code>
                        </p>
                        <textarea id="bulkStudents" placeholder="IUM202301 (Ali Ahmed)&#10;IUM202302 (Fathimath)"></textarea>
                        <button class="btn btn-green" style="width:100%; justify-content: center;" onclick="importStudents()">‚ûï ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁáﬁ¨ﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ≠</button>
                    </div>

                    <label style="margin-top:15px; font-weight:bold;">ﬁâﬁ® ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ™ﬁéﬁ¨ ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ (ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁßﬁáﬁ¨ﬁÜﬁ™):</label>
                    <div id="modalStudentList" class="modal-student-list"></div>
                </div>

                <!-- TAB 2: Class Management -->
                <div id="tab-class" class="tab-content">
                    <div style="background:#eafaf1; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #27ae60;">
                        <label style="font-size:14px; color:#27ae60;">ﬁáﬁß ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ¨ﬁáﬁ∞ ﬁÄﬁ¨ﬁãﬁ™ﬁÇﬁ∞:</label>
                        
                        <div style="margin-top:10px;">
                            <label>ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞:</label>
                            <input type="text" id="newClassName" placeholder="ﬁâﬁ®ﬁêﬁßﬁçﬁ™: Grade 1">
                        </div>
                        <div style="margin-top:10px;">
                            <label>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁìﬁ©ﬁóﬁ¶ﬁÉﬁ™:</label>
                            <input type="text" id="newClassTeacher" placeholder="ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞">
                        </div>

                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button class="btn btn-blue" style="flex:1; justify-content:center;" onclick="createClass()">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁÄﬁ¶ﬁãﬁß</button>
                        </div>
                    </div>
                    
                    <div class="danger-zone" style="margin-top:25px; padding: 15px; border: 1px dashed #e74c3c; border-radius: 8px; background: #fff5f5;">
                        <label style="color:#c0392b; font-weight:bold;">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ™ﬁÇﬁ∞:</label>
                        <select id="deleteClassSelect" class="class-select" style="margin-bottom:10px; border-color:#e74c3c; margin-top:5px;"></select>
                        <button class="btn btn-red" style="width:100%; justify-content: center;" onclick="deleteSelectedClass()">ﬁâﬁ® ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁß</button>
                    </div>
                </div>

                 <!-- TAB 3: Data Backup -->
                 <div id="tab-data" class="tab-content">
                    <div style="background:#f0f8ff; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #3498db;">
                        <h4 style="margin:0 0 10px 0;">ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞ (Download)</h4>
                        <button class="btn btn-blue" style="width:100%; justify-content:center;" onclick="downloadBackup()">üì• ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞ ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞</button>
                    </div>

                    <div style="background:#fff0f0; padding:15px; border-radius:8px; border:1px solid #e74c3c;">
                        <h4 style="margin:0 0 10px 0;">ﬁÉﬁ©ﬁêﬁ∞ﬁìﬁØﬁÉ (Restore)</h4>
                        <input type="file" id="restoreFile" style="margin-bottom:10px;">
                        <button class="btn btn-red" style="width:100%; justify-content:center;" onclick="restoreBackup()">üì§ ﬁëﬁ≠ﬁìﬁß ﬁáﬁ¶ﬁÖﬁßﬁçﬁß</button>
                    </div>

                    <div style="margin-top:20px; text-align:center; border-top:1px solid #eee; padding-top:10px;">
                        <button style="font-size:11px; color:red; border:none; background:none; cursor:pointer; text-decoration:underline;" onclick="hardReset()">‚ö†Ô∏è ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁëﬁ≠ﬁìﬁßﬁáﬁ¨ﬁáﬁ∞ ﬁÉﬁ®ﬁêﬁ¨ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ≠ (All Reset)</button>
                   </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PROGRESS MODAL -->
    <div id="progressModal" class="modal">
        <div class="modal-content" style="width:400px;">
            <div class="modal-header">
                <h3 style="margin:0; color:var(--primary-color);">ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁ¨ﬁêﬁ∞ ﬁìﬁ∞ﬁÉﬁ¨ﬁÜﬁ¶ﬁÉ</h3>
                <span class="close-modal" onclick="closeProgressModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:15px;">
                    <label>ﬁäﬁ¨ﬁÅﬁ≠ ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞:</label>
                    <input type="date" id="progStartDate">
                </div>
                <div style="margin-bottom:15px;">
                    <label>ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁß ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞:</label>
                    <input type="date" id="progEndDate">
                </div>
                <button class="btn btn-blue" style="width:100%; justify-content:center;" onclick="calculateProgress()">ﬁÑﬁ¶ﬁçﬁßﬁçﬁ™ﬁâﬁ¶ﬁÅﬁ∞</button>
                
                <div id="progressResult" style="margin-top:20px; padding:15px; background:#f0f8ff; border-radius:8px; text-align:center; display:none;">
                    <div style="font-size:14px; color:#555;">ﬁâﬁ® ﬁâﬁ™ﬁáﬁ∞ﬁãﬁ¶ﬁåﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁßﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß:</div>
                    <div style="font-size:36px; font-weight:bold; color:#2c3e50; margin:10px 0;" id="progCount">0</div>
                    <div style="font-size:12px; color:#7f8c8d;">(ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ﬁåﬁ¶ﬁáﬁ∞)</div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
     apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
  authDomain: "hifz-cde3b.firebaseapp.com",
  databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
  projectId: "hifz-cde3b",
  storageBucket: "hifz-cde3b.firebasestorage.app",
  messagingSenderId: "566754658580",
  appId: "1:566754658580:web:d63d0f167960f53bab9a01"

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const surahNames = ["ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©","ÿßŸÑÿ®ŸÇÿ±ÿ©","ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ","ÿßŸÑŸÜÿ≥ÿßÿ°","ÿßŸÑŸÖÿßÿ¶ÿØÿ©","ÿßŸÑÿ£ŸÜÿπÿßŸÖ","ÿßŸÑÿ£ÿπÿ±ÿßŸÅ","ÿßŸÑÿ£ŸÜŸÅÿßŸÑ","ÿßŸÑÿ™Ÿàÿ®ÿ©","ŸäŸàŸÜÿ≥","ŸáŸàÿØ","ŸäŸàÿ≥ŸÅ","ÿßŸÑÿ±ÿπÿØ","ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ","ÿßŸÑÿ≠ÿ¨ÿ±","ÿßŸÑŸÜÿ≠ŸÑ","ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°","ÿßŸÑŸÉŸáŸÅ","ŸÖÿ±ŸäŸÖ","ÿ∑Ÿá","ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°","ÿßŸÑÿ≠ÿ¨","ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ","ÿßŸÑŸÜŸàÿ±","ÿßŸÑŸÅÿ±ŸÇÿßŸÜ","ÿßŸÑÿ¥ÿπÿ±ÿßÿ°","ÿßŸÑŸÜŸÖŸÑ","ÿßŸÑŸÇÿµÿµ","ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™","ÿßŸÑÿ±ŸàŸÖ","ŸÑŸÇŸÖÿßŸÜ","ÿßŸÑÿ≥ÿ¨ÿØÿ©","ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®","ÿ≥ÿ®ÿ£","ŸÅÿßÿ∑ÿ±","Ÿäÿ≥","ÿßŸÑÿµÿßŸÅÿßÿ™","ÿµ","ÿßŸÑÿ≤ŸÖÿ±","ÿ∫ÿßŸÅÿ±","ŸÅÿµŸÑÿ™","ÿßŸÑÿ¥Ÿàÿ±Ÿâ","ÿßŸÑÿ≤ÿÆÿ±ŸÅ","ÿßŸÑÿØÿÆÿßŸÜ","ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©","ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ","ŸÖÿ≠ŸÖÿØ","ÿßŸÑŸÅÿ™ÿ≠","ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™","ŸÇ","ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™","ÿßŸÑÿ∑Ÿàÿ±","ÿßŸÑŸÜÿ¨ŸÖ","ÿßŸÑŸÇŸÖÿ±","ÿßŸÑÿ±ÿ≠ŸÖŸÜ","ÿßŸÑŸàÿßŸÇÿπÿ©","ÿßŸÑÿ≠ÿØŸäÿØ","ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©","ÿßŸÑÿÆÿ¥ÿ±","ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©","ÿßŸÑÿ∂ŸÅ","ÿßŸÑÿ¨ŸÖÿπÿ©","ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ","ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ","ÿßŸÑÿ∑ŸÑÿßŸÇ","ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ","ÿßŸÑŸÖŸÑŸÉ","ÿßŸÑŸÇŸÑŸÖ","ÿßŸÑÿÆÿßŸÇÿ©","ÿßŸÑŸÖÿπÿßÿ±ÿ¨","ŸÜŸàÿ≠","ÿßŸÑÿ¨ŸÜ","ÿßŸÑŸÖÿ≤ŸÖŸÑ","ÿßŸÑŸÖÿØÿ´ÿ±","ÿßŸÑŸÇŸäÿßŸÖÿ©","ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ","ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™","ÿßŸÑŸÜÿ®ÿ£","ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™","ÿπÿ®ÿ≥","ÿßŸÑÿ™ŸÉŸàŸäÿ±","ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±","ÿßŸÑÿ∑ŸÅŸäŸÅŸäŸÜ","ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ","ÿßŸÑÿ®ÿ±Ÿàÿ¨","ÿßŸÑÿ∑ÿßÿ±ŸÇ","ÿßŸÑÿ£ÿπŸÑŸâ","ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©","ÿßŸÑŸÅÿ¨ÿ±","ÿßŸÑÿ®ŸÑÿØ","ÿßŸÑÿ¥ŸÖÿ≥","ÿßŸÑŸÑŸäŸÑ","ÿßŸÑÿ∂ÿ≠Ÿâ","ÿßŸÑÿ¥ÿ±ÿ≠","ÿßŸÑÿ™ŸäŸÜ","ÿßŸÑÿπŸÑŸÇ","ÿßŸÑŸÇÿØÿ±","ÿßŸÑÿ®ŸäŸÜÿ©","ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©","ÿßŸÑÿπÿßÿØŸäÿßÿ™","ÿßŸÑŸÇÿßÿ±ÿπÿ©","ÿßŸÑÿ™ŸÉÿßÿ´ÿ±","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸÅŸäŸÑ","ŸÇÿ±Ÿäÿ¥","ÿßŸÑŸÖÿßÿπŸàŸÜ","ÿßŸÑŸÉŸàÿ´ÿ±","ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ","ÿßŸÑŸÜÿµÿ±","ÿßŸÑŸÖÿ≥ÿØ","ÿßŸÑÿ•ÿÆŸÑÿßÿµ","ÿßŸÑŸÅŸÑŸÇ","ÿßŸÑŸÜÿßÿ≥"];
    const TEACHER_PASSWORD = "1234"; 

    // Global variables
    let classes = {}; 
    let records = [];
    let currentClass = "";
    let currentStudent = null; 
    let currentActiveSection = 'new';
    let currentPage = 1;
    let historyFilter = 'all'; 
    let tempLoginClass = "";
    let tempLoginStudentIdx = -1;

    // Load data from Firebase
    const dbRef = ref(db, 'hifz_data');
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            classes = data.classes || { "Default Class": { teacher: "", students: [] } };
            records = data.records || [];
            
            // Re-render UI based on current state
            if(document.getElementById('login-screen').style.display !== 'none') {
                populateLoginClasses();
            }
            if(currentClass) {
                refreshClassDropdowns();
                if(currentStudent) renderHistory();
            }
        } else {
            classes = { "Default Class": { teacher: "", students: [] } };
            records = [];
            saveData();
        }
    });

    function saveData() {
        set(ref(db, 'hifz_data'), {
            classes: classes,
            records: records
        }).catch(err => {
            console.error(err);
            alert("Error saving to cloud. Check internet.");
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        populateSurahSelects();
        document.getElementById('entryDate').valueAsDate = new Date();
        loadMushaf(1);
    });

    // --- LOGIN SYSTEM FIXED FOR ID (NAME) FORMAT ---
    window.switchLoginTab = function(type) {
        document.querySelectorAll('.login-tab-btn').forEach(b => b.classList.remove('active'));
        if(type === 'student') {
            document.getElementById('tabStudent').classList.add('active');
            document.getElementById('login-form-student').style.display = 'block';
            document.getElementById('login-form-teacher').style.display = 'none';
        } else {
            document.getElementById('tabTeacher').classList.add('active');
            document.getElementById('login-form-student').style.display = 'none';
            document.getElementById('login-form-teacher').style.display = 'block';
        }
    }

    window.populateLoginClasses = function() {
        const sel = document.getElementById('loginClassSelect');
        sel.innerHTML = '<option value="">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁÇﬁ¶ﬁéﬁß...</option>';
        Object.keys(classes).forEach(k => {
            let opt = document.createElement('option');
            opt.value = k; opt.innerText = k;
            sel.appendChild(opt);
        });
    }
    // Make it global for onValue callback
    window.populateLoginClasses = populateLoginClasses;

    window.handleStudentLogin = function() {
        const clsName = document.getElementById('loginClassSelect').value;
        const inputId = document.getElementById('loginStudentId').value.trim();
        const pass = document.getElementById('studentPassword').value;

        if(!clsName) return alert("ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß");
        if(!inputId) return alert("ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß");

        // Find student by ID (Supports "ID (Name)" AND "Name (ID)")
        const students = classes[clsName].students;
        const studentIdx = students.findIndex(s => {
            const storedName = s.name.trim();
            const input = inputId.trim().toLowerCase();

            // Check if name STARTS with ID (e.g., "IUM123 (Ali)") - Most common based on your data
            // We split by space or '(' to extract the first part
            const firstPart = storedName.split(/[\s\(]+/)[0].toLowerCase();
            if (firstPart === input) return true;

            // Check if ID is inside brackets (e.g., "Ali (IUM123)") - Old format
            const match = storedName.match(/\(([^)]+)\)/);
            if (match && match[1]) {
                return match[1].trim().toLowerCase() === input;
            }

            return false;
        });

        if(studentIdx === -1) {
            return alert("ﬁåﬁ®ﬁîﬁ¶ ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁáﬁßﬁáﬁ® ﬁãﬁ®ﬁâﬁßﬁàﬁß ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁâﬁ® ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ∞");
        }

        const studentObj = students[studentIdx];

        // Scenario 1: First time login (No password set)
        if ((!studentObj.password || studentObj.password === "") && pass === "") {
            tempLoginClass = clsName;
            tempLoginStudentIdx = studentIdx;
            document.getElementById('passwordSetupModal').style.display = 'flex';
            return;
        }

        // Scenario 2: Password Verification
        if (pass === studentObj.password) {
            loginSuccess(clsName, studentObj.name, 'student');
        } else {
            if(!studentObj.password || studentObj.password === "") {
                alert("ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁäﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ ﬁàﬁ©ﬁâﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁÑﬁ¶ﬁÄﬁ¶ﬁáﬁ∞ﬁìﬁ¶ﬁàﬁß!");
            } else {
                alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®!");
            }
        }
    }

    window.saveNewPassword = function() {
        const p1 = document.getElementById('newPass1').value;
        const p2 = document.getElementById('newPass2').value;

        if(!p1) return alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁñﬁ¶ﬁÄﬁß");
        if(p1 !== p2) return alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁãﬁ®ﬁâﬁßﬁÇﬁ™ﬁàﬁ≠");

        classes[tempLoginClass].students[tempLoginStudentIdx].password = p1;
        saveData();

        const sName = classes[tempLoginClass].students[tempLoginStudentIdx].name;
        document.getElementById('passwordSetupModal').style.display = 'none';
        alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁêﬁ¨ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨. ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞ﬁàﬁ¶ﬁÇﬁ©...");
        loginSuccess(tempLoginClass, sName, 'student');
    }

    window.handleTeacherLogin = function() {
        const p = document.getElementById('teacherPassword').value;
        if(p === TEACHER_PASSWORD) {
            let startClass = "Default Class";
            if (classes && Object.keys(classes).length > 0) {
                startClass = Object.keys(classes)[0];
            }
            loginSuccess(startClass, null, 'teacher');
        } else {
            alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®");
        }
    }

    function loginSuccess(cls, studentName, mode) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        
        if (mode === 'student') {
            document.body.classList.add('student-mode');
            
            document.getElementById('classSelect').value = cls;
            switchClass(cls);
            
            setTimeout(() => {
                const btns = document.querySelectorAll('.student-btn');
                btns.forEach(b => {
                    if(b.innerText === studentName) b.click();
                });
                document.getElementById('studentListContainer').style.display = 'none';
                document.querySelector('.class-control-area').style.display = 'none';
                
                // Display friendly name if format is "ID (Name)"
                let displayName = studentName;
                if(studentName.includes('(')) {
                    // Try to extract name inside brackets
                    const match = studentName.match(/\(([^)]+)\)/);
                    if(match && match[1]) displayName = match[1]; 
                    // If the ID was inside brackets (old format), this still works nicely
                }
                
                document.querySelector('.sidebar h4').innerText = "Logged in: " + displayName;
            }, 100);
        } else {
            document.body.classList.remove('student-mode');
            document.getElementById('studentListContainer').style.display = 'block';
            document.querySelector('.class-control-area').style.display = 'block';
            document.querySelector('.sidebar h4').innerText = "ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞";
            refreshClassDropdowns();
        }
    }

    window.logout = function() { location.reload(); }

    // --- APP LOGIC ---
    function populateSurahSelects() {
        const ids = ['newSurah', 'newEndSurah','shortSurah', 'shortEndSurah','longSurah', 'longEndSurah'];
        ids.forEach(id => {
            const sel = document.getElementById(id);
            if(!sel) return;
            sel.innerHTML = sel.innerHTML; 
            surahNames.forEach((s, i) => {
                let opt = document.createElement('option');
                opt.value = i + 1;
                opt.innerText = (i+1) + ". " + s;
                sel.appendChild(opt);
            });
        });
    }

    window.refreshClassDropdowns = function() {
        const mainSel = document.getElementById('classSelect');
        const modalSel = document.getElementById('modalClassSelect');
        const deleteSel = document.getElementById('deleteClassSelect');
        [mainSel, modalSel, deleteSel].forEach(sel => sel.innerHTML = '');

        const keys = Object.keys(classes);
        if(keys.length === 0) {
            classes = {"Default Class": { teacher: "", students: [] }};
            keys.push("Default Class");
            saveData();
        }

        keys.forEach(k => {
            [mainSel, modalSel, deleteSel].forEach(sel => {
                let opt = document.createElement('option');
                opt.value = k;
                opt.innerText = k;
                sel.appendChild(opt);
            });
        });

        if(keys.includes(currentClass)) mainSel.value = currentClass;
        else {
            mainSel.value = keys[0];
            currentClass = keys[0];
        }
        switchClass(mainSel.value);
    }

    window.switchClass = function(className) {
        currentClass = className;
        document.getElementById('currentClassDisplay').innerText = "Class: " + currentClass;
        
        const teacherDisplay = document.getElementById('classTeacherDisplay');
        const teacherName = classes[currentClass].teacher;
        if(teacherName) {
            teacherDisplay.style.display = 'inline-block';
            teacherDisplay.innerText = "Tr. " + teacherName;
            document.getElementById('teacherName').value = teacherName;
        } else {
            teacherDisplay.style.display = 'none';
        }

        const list = document.getElementById('studentListContainer');
        list.innerHTML = '';
        currentStudent = null;
        document.getElementById('studentHeader').innerText = "ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞";
        document.getElementById('historyContainer').innerHTML = ''; 

        const students = classes[currentClass].students || [];
        if(students.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:13px;">ﬁâﬁ® ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ∞</div>';
        } else {
            students.forEach(s => {
                const btn = document.createElement('button');
                btn.className = 'student-btn';
                btn.innerText = s.name;
                btn.onclick = () => selectStudent(s.name, btn);
                list.appendChild(btn);
            });
        }
    }

    function selectStudent(name, btnEl) {
        currentStudent = name;
        document.querySelectorAll('.student-btn').forEach(b => b.classList.remove('active'));
        if(btnEl) btnEl.classList.add('active');
        document.getElementById('studentHeader').innerText = name;
        autoFillNextLesson();
        renderHistory();
    }

    async function autoFillNextLesson() {
        if(!currentStudent) return;
        const studentRecords = records.filter(r => r.class === currentClass && r.student === currentStudent);
        studentRecords.sort((a,b) => new Date(b.date) - new Date(a.date)); 

        if(studentRecords.length === 0) return;
        const lastRecord = studentRecords[0];
        
        if(lastRecord.new && lastRecord.new.s && lastRecord.new.en) {
            const lastEndSurahName = lastRecord.new.es || lastRecord.new.s;
            const lastEndVerse = parseInt(lastRecord.new.en);
            if(!lastEndSurahName || !lastEndVerse) return;

            const surahIndex = surahNames.indexOf(lastEndSurahName) + 1;
            if(surahIndex === 0) return; 

            const nextVerse = lastEndVerse + 1;
            const loader = document.getElementById('loader-new');
            if(loader) loader.style.display = 'inline-block';

            try {
                const res = await fetch(`https://api.quran.com/api/v4/verses/by_key/${surahIndex}:${nextVerse}?fields=page_number`);
                if(res.ok) {
                    const data = await res.json();
                    if(data.verse) {
                        document.getElementById('newSurah').value = surahIndex;
                        document.getElementById('newStart').value = nextVerse;
                        if(data.verse.page_number) {
                            loadMushaf(data.verse.page_number);
                            document.getElementById('newPage').value = data.verse.page_number;
                        }
                    }
                } else {
                    if(surahIndex < 114) {
                        const nextSurahIndex = surahIndex + 1;
                        document.getElementById('newSurah').value = nextSurahIndex;
                        document.getElementById('newStart').value = 1;
                        const res2 = await fetch(`https://api.quran.com/api/v4/verses/by_key/${nextSurahIndex}:1?fields=page_number`);
                        const data2 = await res2.json();
                        if(data2.verse && data2.verse.page_number) {
                            loadMushaf(data2.verse.page_number);
                            document.getElementById('newPage').value = data2.verse.page_number;
                        }
                    }
                }
                setActiveSection('new');
                document.querySelector(`input[name="activeSec"][value="new"]`).checked = true;
            } catch(e) { } finally { if(loader) loader.style.display = 'none'; }
        }
    }

    // --- MODAL LOGIC ---
    window.openModal = function() { 
        document.getElementById('classModal').style.display = 'flex'; 
        document.getElementById('modalClassSelect').value = currentClass;
        renderModalStudentList();
    }
    window.closeModal = function() { document.getElementById('classModal').style.display = 'none'; }
    
    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(tabId === 'tab-students') document.querySelector('.tab-btn:first-child').classList.add('active');
        else if (tabId === 'tab-class') document.querySelectorAll('.tab-btn')[1].classList.add('active');
        else document.querySelector('.tab-btn:last-child').classList.add('active');
    }

    window.createClass = function() {
        const name = document.getElementById('newClassName').value.trim();
        const teacher = document.getElementById('newClassTeacher').value.trim();
        if(!name) return;
        if(classes[name]) return alert("ﬁâﬁ® ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁáﬁ¨ﬁÑﬁ¶ﬁáﬁ®ﬁÇﬁ∞");
        
        classes[name] = { teacher: teacher, students: [] };
        saveData();
        
        document.getElementById('newClassName').value = '';
        document.getElementById('newClassTeacher').value = '';
        refreshClassDropdowns();
        document.getElementById('classSelect').value = name;
        switchClass(name);
        alert("ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁÄﬁ¨ﬁãﬁ®ﬁáﬁ∞ﬁñﬁ¨: " + name);
        closeModal();
    }

    window.importStudents = function() {
        const cls = document.getElementById('modalClassSelect').value;
        const txt = document.getElementById('bulkStudents').value;
        if(!txt.trim()) return;
        
        const lines = txt.split('\n');
        let count = 0;

        lines.forEach(line => {
            if(!line.trim()) return;
            let parts = line.split(/[\t,]+/); 
            if(parts.length < 2 && line.includes('-')) parts = line.split('-');

            let name = parts[0].trim();
            // Remove trailing digits in brackets if auto-pasted, though regex below handles ID extraction
            name = name.replace(/\(\d+\)$/, '').trim();
            
            let id = "";
            // Extract ID if present in input string
            if(parts.length > 1) {
                // Assuming format "Name, ID" or "ID, Name" - we want consistent storage
                // If the second part looks like an ID
                id = parts[1].trim().toUpperCase();
            }
            
            // Store as "ID (Name)" to match your existing data preference
            // If the user pasted "Name, ID", we swap. If "ID, Name" we keep.
            // Simple heuristic: ID usually contains digits.
            let fullName = name;
            if (id) {
                // If name part has digits and ID part is letters, maybe swapped? 
                // Let's assume user input is relatively clean or follows the prompt "ID, Name"
                fullName = `${name} (${id})`; // Fallback format "Name (ID)"
                
                // But wait, your data is "ID (Name)". Let's try to stick to that if we can identify the ID.
                if (name.match(/\d/)) {
                     // Name part has digits, it might be the ID
                     fullName = `${name} (${parts[1].trim()})`; 
                } else if (id.match(/\d/)) {
                     // ID part has digits
                     fullName = `${id} (${name})`;
                }
            } else {
                // Single string input
                fullName = name;
            }

            const exists = classes[cls].students.find(s => s.name === fullName);

            if(!exists) {
                classes[cls].students.push({
                    name: fullName,
                    password: ""
                });
                count++;
            }
        });

        saveData();
        document.getElementById('bulkStudents').value = '';
        renderModalStudentList();
        if(currentClass === cls) switchClass(cls);
        alert(count + " ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨");
    }

    window.renderModalStudentList = function() {
        const cls = document.getElementById('modalClassSelect').value;
        const listDiv = document.getElementById('modalStudentList');
        listDiv.innerHTML = '';
        
        const students = classes[cls] ? classes[cls].students : [];
        if(students.length === 0) {
            listDiv.innerHTML = '<div style="padding:15px; text-align:center; color:#ccc;">ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ∞</div>';
        } else {
            students.forEach(s => {
                const item = document.createElement('div');
                item.className = 'modal-student-item';
                const passDisplay = s.password ? s.password : "<em>(Not Set)</em>";
                
                item.innerHTML = `
                    <div class="student-details">
                        <span class="student-name-txt">${s.name}</span>
                        <span class="student-pass-txt">üîë Pwd: ${passDisplay}</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-del-mini" style="background:#3498db; color:white;" onclick="resetPass('${s.name}')">Reset</button>
                        <button class="btn-del-mini" onclick="deleteStudent('${s.name}')">Delete</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        }
    }

    window.deleteStudent = function(studentName) {
        const cls = document.getElementById('modalClassSelect').value;
        if(confirm(`"${studentName}" ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁåﬁ¶ÿü`)) {
            classes[cls].students = classes[cls].students.filter(s => s.name !== studentName);
            saveData();
            renderModalStudentList();
            if(currentClass === cls) switchClass(cls);
        }
    }

    window.resetPass = function(studentName) {
        const cls = document.getElementById('modalClassSelect').value;
        if(confirm(`"${studentName}" ﬁéﬁ¨ ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ﬁàﬁ©ﬁåﬁ¶ÿü`)) {
             const stud = classes[cls].students.find(s => s.name === studentName);
             if(stud) stud.password = "";
             saveData();
             renderModalStudentList();
        }
    }

    window.deleteSelectedClass = function() {
        const cls = document.getElementById('deleteClassSelect').value;
        if(Object.keys(classes).length <= 1) return alert("ﬁâﬁ®ﬁáﬁ© ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁÜﬁ¶ﬁÇﬁ® ﬁáﬁ®ﬁÇﬁ∞ ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞. ﬁäﬁÆﬁÄﬁ¨ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁçﬁ¨ﬁàﬁ≠ﬁÇﬁ¨.");
        if(confirm(cls + " ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁåﬁ¶ÿü")) {
            delete classes[cls];
            saveData();
            refreshClassDropdowns();
            alert("ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨");
        }
    }

    window.hardReset = function() {
        if(confirm("ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁëﬁ≠ﬁìﬁßﬁáﬁ¨ﬁáﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁàﬁ≠ﬁÇﬁ¨! ﬁîﬁ¶ﬁéﬁ©ﬁÇﬁ∞ﬁåﬁ¶ÿü")) {
            set(ref(db, 'hifz_data'), null);
            location.reload();
        }
    }

    window.downloadBackup = function() {
        const backup = { classes: classes, records: records, version: "v5.0", date: new Date().toISOString() };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "hifz_backup_v5.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    window.restoreBackup = function() {
        const fileInput = document.getElementById('restoreFile');
        const file = fileInput.files[0];
        if (!file) { alert("ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁÇﬁ¶ﬁéﬁß"); return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = JSON.parse(e.target.result);
                if (content.classes && content.records) {
                    if(confirm("ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÄﬁ™ﬁÉﬁ® ﬁëﬁ≠ﬁìﬁß ﬁäﬁÆﬁÄﬁ¨ﬁàﬁ®ÿå ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞ ﬁëﬁ≠ﬁìﬁß ﬁáﬁ¨ﬁÖﬁ≠ﬁÇﬁ¨.")) {
                        classes = content.classes; records = content.records;
                        Object.keys(classes).forEach(k => {
                            if (classes[k].students.length > 0 && typeof classes[k].students[0] === 'string') {
                                classes[k].students = classes[k].students.map(s => ({name: s, password: ""}));
                            }
                        });
                        saveData(); location.reload();
                    }
                } else { alert("ﬁâﬁ®ﬁáﬁ© ﬁÉﬁ¶ﬁÇﬁéﬁ¶ﬁÖﬁ™ ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ´ﬁÇﬁ∞"); }
            } catch (err) { alert("ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁâﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁçﬁ¶ﬁáﬁ¨ﬁáﬁ∞: " + err); }
        };
        reader.readAsText(file);
    }

    // --- MUSHAF & RECORDING ---
    window.loadMushaf = function(p, sync = true) {
        if(p < 1 || p > 604) return;
        currentPage = parseInt(p);
        document.getElementById('navPage').value = currentPage;
        document.getElementById('pageIndicator').innerText = "Page " + currentPage;
        const img = document.getElementById('mushafImg');
        img.src = `https://android.quran.com/data/width_1260/page${currentPage.toString().padStart(3,'0')}.png`;
        clearDots();
        
        if (sync && document.getElementById('lessonType').value !== 'exam' && !document.body.classList.contains('student-mode')) {
            const pageInput = document.getElementById(currentActiveSection + 'Page');
            if(pageInput) {
                pageInput.value = currentPage;
                fillSurahFromPage(currentPage, currentActiveSection);
            }
        }
    }

    window.changePage = function(delta) { loadMushaf(currentPage + delta, false); }
    
    window.toggleMushaf = function() {
        const w = getComputedStyle(document.documentElement).getPropertyValue('--mushaf-width').trim();
        document.documentElement.style.setProperty('--mushaf-width', w === '0px' ? '35%' : '0px');
    }

    window.setActiveSection = function(sec) {
        currentActiveSection = sec;
        document.querySelectorAll('.section-box').forEach(b => b.classList.remove('active-section'));
        document.getElementById('box-'+sec).classList.add('active-section');
    }

    window.autoLoadPage = async function(sec) {
        const p = document.getElementById(sec+'Page').value;
        if(!p) return;
        loadMushaf(p, true);
        setActiveSection(sec);
        document.querySelector(`input[name="activeSec"][value="${sec}"]`).checked = true;
    }

    async function fillSurahFromPage(page, section) {
        const loader = document.getElementById('loader-' + section);
        if(loader) loader.style.display = 'inline-block';
        try {
            const res = await fetch(`https://api.quran.com/api/v4/verses/by_page/${page}?per_page=300`);
            const d = await res.json();
            if(d.verses && d.verses.length > 0) {
                const first = d.verses[0].verse_key.split(':');
                document.getElementById(section+'Surah').value = first[0];
                document.getElementById(section+'Start').value = first[1];

                const last = d.verses[d.verses.length - 1].verse_key.split(':');
                document.getElementById(section+'EndSurah').value = last[0];
                document.getElementById(section+'End').value = last[1];
            }
        } catch(e) { } finally { if(loader) loader.style.display = 'none'; }
    }

    window.onImageClick = function(e) {
        if (document.body.classList.contains('student-mode')) return; 
        if(e.target.classList.contains('mistake-dot')) return;
        
        const rect = document.getElementById('mushafWrapper').getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const dot = document.createElement('div');
        dot.className = 'mistake-dot';
        dot.style.left = x+'px'; dot.style.top = y+'px';
        
        const isExam = document.getElementById('lessonType').value === 'exam';
        const target = currentActiveSection + 'Mistakes';
        
        dot.onclick = (ev) => { ev.stopPropagation(); dot.remove(); 
            if(isExam) updateExamMistake('teacher', -1);
            else adjustMistake(target, -1); 
        };
        
        document.getElementById('mushafWrapper').appendChild(dot);
        if(isExam) updateExamMistake('teacher', 1);
        else adjustMistake(target, 1);
    }

    window.adjustMistake = function(id, delta) {
        const el = document.getElementById(id);
        let v = parseInt(el.value) || 0;
        v += delta; if(v < 0) v = 0;
        el.value = v;
    }
    
    window.updateExamMistake = function(type, delta) {
        const id = type === 'teacher' ? 'examTeacherMistakes' : 'examSelfMistakes';
        const el = document.getElementById(id);
        let v = parseInt(el.value) || 0;
        v += delta; if(v < 0) v = 0;
        el.value = v;
        calculateExamScore();
    }

    window.calculateDuration = function() {
        const start = document.getElementById('examStartTime').value;
        const end = document.getElementById('examEndTime').value;
        if(start && end) {
            const s = new Date("01/01/2000 " + start);
            const e = new Date("01/01/2000 " + end);
            const diff = (e - s) / 60000; 
            document.getElementById('examDuration').innerText = diff > 0 ? diff : 0;
        }
    }

    window.calculateExamScore = function() {
        const teacherMistakes = parseInt(document.getElementById('examTeacherMistakes').value) || 0;
        const selfMistakes = parseInt(document.getElementById('examSelfMistakes').value) || 0;
        let hifzScore = 80 - (teacherMistakes * 2) - (selfMistakes * 1);
        if(hifzScore < 0) hifzScore = 0;
        const m1 = parseFloat(document.getElementById('markMutha1').value) || 0;
        const m2 = parseFloat(document.getElementById('markMutha2').value) || 0;
        const tajweed = parseFloat(document.getElementById('markTajweed').value) || 0;
        const fluency = parseFloat(document.getElementById('markFluency').value) || 0;
        const total = hifzScore + m1 + m2 + tajweed + fluency;
        document.getElementById('totalExamScore').innerText = total + "%";
    }

    function clearDots() { document.querySelectorAll('.mistake-dot').forEach(d => d.remove()); }

    window.clearForm = function() {
        ['new','short','long'].forEach(s => {
            document.getElementById(s+'Mistakes').value = 0;
            document.getElementById(s+'Page').value = '';
            document.getElementById(s+'Start').value = '';
            document.getElementById(s+'End').value = '';
            document.getElementById(s+'Surah').value = '';
            document.getElementById(s+'EndSurah').value = '';
        });
        document.getElementById('examJuzu').value = '';
        document.getElementById('examExaminer').value = '';
        document.getElementById('examTeacherMistakes').value = 0;
        document.getElementById('examSelfMistakes').value = 0;
        calculateExamScore();
        clearDots();
    }

    // --- VIEW LOGIC ---
    window.toggleFormSection = function(val) {
        const dailyContainer = document.getElementById('container-daily');
        const examContainer = document.getElementById('container-exam');
        if (val === 'exam') {
            dailyContainer.style.display = 'none';
            examContainer.style.display = 'block';
            setActiveSection('exam');
        } else {
            dailyContainer.style.display = 'block';
            examContainer.style.display = 'none';
            setActiveSection('new');
        }
    }
    
    window.setHistoryFilter = function(type) {
        historyFilter = type;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        let id = 'btnFilterAll';
        if(type === 'new') id = 'btnFilterNew';
        if(type === 'short') id = 'btnFilterShort';
        if(type === 'long') id = 'btnFilterLong';
        if(type === 'exam') id = 'btnFilterExam';
        document.getElementById(id).classList.add('active');
        renderHistory();
    }

    window.saveRecord = function() {
        if(!currentStudent) return alert("ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ∞");
        const type = document.getElementById('lessonType').value;
        const getV = id => document.getElementById(id).value;
        const getS = id => {
            const el = document.getElementById(id);
            if(!el.value) return "";
            return el.options[el.selectedIndex].text.split('. ')[1] || "";
        };

        const base = {
            id: Date.now(),
            class: currentClass,
            student: currentStudent,
            date: getV('entryDate'),
            teacher: getV('teacherName')
        };
        
        let rec = {};

        if (type === 'exam') {
            rec = {
                ...base,
                type: 'exam',
                juzu: getV('examJuzu'),
                examiner: getV('examExaminer'),
                duration: document.getElementById('examDuration').innerText,
                mistakes: { teacher: getV('examTeacherMistakes'), self: getV('examSelfMistakes') },
                scores: { 
                    mutha1: getV('markMutha1'), 
                    mutha2: getV('markMutha2'), 
                    tajweed: getV('markTajweed'), 
                    fluency: getV('markFluency'),
                    total: document.getElementById('totalExamScore').innerText
                }
            };
        } else {
            rec = {
                ...base,
                type: 'daily',
                new: { s: getS('newSurah'), es: getS('newEndSurah'), st: getV('newStart'), en: getV('newEnd'), m: getV('newMistakes'), p: getV('newPage') },
                short: { s: getS('shortSurah'), es: getS('shortEndSurah'), st: getV('shortStart'), en: getV('shortEnd'), m: getV('shortMistakes') },
                long: { s: getS('longSurah'), es: getS('longEndSurah'), st: getV('longStart'), en: getV('longEnd'), m: getV('longMistakes') }
            };
        }

        records.push(rec);
        saveData();
        renderHistory();
        if(type === 'daily') autoFillNextLesson();
        alert("ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨");
    }

    function renderHistory() {
        const container = document.getElementById('historyContainer');
        container.innerHTML = '';
        const data = records.filter(r => r.class === currentClass && r.student === currentStudent);
        data.sort((a,b) => new Date(b.date) - new Date(a.date));

        let filteredData = data;
        if(historyFilter !== 'all') {
            filteredData = data.filter(r => {
                if(r.type === 'exam') return historyFilter === 'exam';
                if(historyFilter === 'new') return (r.new.s || r.new.st);
                if(historyFilter === 'short') return (r.short.s || r.short.st);
                if(historyFilter === 'long') return (r.long.s || r.long.st);
                return false;
            });
        }

        if (filteredData.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</div>';
            return;
        }

        if (['new', 'short', 'long'].includes(historyFilter)) {
            const table = document.createElement('table');
            table.className = 'hifz-table';
            let headerColor = '#27ae60';
            if(historyFilter === 'short') headerColor = '#2980b9';
            if(historyFilter === 'long') headerColor = '#d35400';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th style="background:${headerColor}; color:white;">ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</th>
                        <th style="background:${headerColor}; color:white;">ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞</th>
                        <th style="background:${headerColor}; color:white;">ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞</th>
                        <th style="background:${headerColor}; color:white;">ﬁÜﬁ™ﬁÅﬁ∞</th>
                        <th style="background:${headerColor}; color:white;"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            filteredData.forEach(r => {
                const tr = document.createElement('tr');
                const obj = r[historyFilter]; 
                let surahDisplay = obj.s || '-';
                if(obj.es && obj.es !== obj.s) { surahDisplay += " - " + obj.es; }
                const mistakeClass = obj.m > 0 ? 'color:red;font-weight:bold' : 'color:green';
                
                tr.innerHTML = `
                    <td>${r.date}</td>
                    <td style="font-family:'Amiri'">${surahDisplay}</td>
                    <td>${obj.st || '-'} - ${obj.en || '-'}</td>
                    <td style="${mistakeClass}">${obj.m}</td>
                    <td><button class="delete-card-btn" onclick="delRec(${r.id})" style="color:red;border:none;background:none;cursor:pointer;">&times;</button></td>
                `;
                table.querySelector('tbody').appendChild(tr);
            });
            container.appendChild(table);
        } else {
            filteredData.forEach(r => {
                const card = document.createElement('div');
                if (r.type === 'exam') {
                    card.className = 'history-card exam-card';
                    card.innerHTML = `
                        <button class="delete-card-btn" onclick="delRec(${r.id})">&times;</button>
                        <div class="card-header" style="border-color:#f1c40f;">
                            <span class="card-date">üèÜ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞ (${r.juzu}) - ${r.date}</span>
                            <span class="card-teacher" style="background:#fff8e1; color:#d35400;">${r.scores.total}</span>
                        </div>
                        <div class="card-body">
                            <div class="card-section exam">
                                <div style="font-size:14px;">
                                    <div>ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞ ﬁÜﬁ™ﬁÉﬁ©: ${r.examiner || '-'}</div>
                                    <div style="margin-top:5px; color:#e74c3c;">ﬁÜﬁ™ﬁÅﬁ∞: T(${r.mistakes.teacher}) S(${r.mistakes.self})</div>
                                </div>
                            </div>
                        </div>`;
                } else {
                    card.className = 'history-card';
                    const buildSec = (label, obj, typeClass) => {
                        if(!obj || (!obj.s && !obj.st && obj.m == 0)) return '';
                        const mistakeClass = obj.m > 0 ? 'red' : 'green';
                        let surahDisplay = obj.s || '-';
                        if(obj.es && obj.es !== obj.s) { surahDisplay += " - " + obj.es; }
    
                        return `
                            <div class="card-section ${typeClass}">
                                <span class="section-label">${label}</span>
                                <div class="section-content">
                                    <div class="surah-info">
                                        <span class="surah-name">${surahDisplay}</span>
                                        <span class="ayah-range">ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞: ${obj.st || '0'} - ${obj.en || '0'}</span>
                                    </div>
                                    <span class="mistake-badge ${mistakeClass}">${obj.m} ﬁÜﬁ™ﬁÅﬁ∞</span>
                                </div>
                            </div>`;
                    };
    
                    card.innerHTML = `
                        <button class="delete-card-btn" onclick="delRec(${r.id})">&times;</button>
                        <div class="card-header">
                            <span class="card-date">üìÖ ${r.date}</span>
                            <span class="card-teacher">üë®‚Äçüè´ ${r.teacher || '-'}</span>
                        </div>
                        <div class="card-body">
                            ${buildSec('ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™', r.new, 'new')}
                            ${buildSec('ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß', r.short, 'short')}
                            ${buildSec('ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß', r.long, 'long')}
                        </div>`;
                }
                container.appendChild(card);
            });
        }
    }

    window.delRec = function(id) {
        if(confirm("ﬁâﬁ® ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁåﬁ¶ÿü")) {
            records = records.filter(r => r.id !== id);
            saveData();
            renderHistory();
        }
    }

    window.exportExcel = function() {
        if(records.length === 0) return alert("ﬁÇﬁØ ﬁëﬁ≠ﬁìﬁß");
        const data = records.filter(r => r.class === currentClass).map(r => {
            if (r.type === 'exam') {
                 return {
                    "ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞": r.date, "ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™": r.student, "ﬁÑﬁßﬁàﬁ¶ﬁåﬁ∞": "ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞",
                    "ﬁÑﬁ¶ﬁáﬁ®": r.juzu, "ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞ ﬁÜﬁ™ﬁÉﬁ©": r.examiner, "ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶": r.scores.total, 
                    "ﬁåﬁ¶ﬁñﬁ∞ﬁàﬁ©ﬁãﬁ™": r.scores.tajweed, "ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞": r.scores.fluency,
                    "ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞": parseFloat(r.scores.mutha1)+parseFloat(r.scores.mutha2),
                    "ﬁàﬁ¶ﬁéﬁ™ﬁåﬁ™": r.duration
                };
            } else {
                const sText = (obj) => (obj.es && obj.es !== obj.s) ? `${obj.s} - ${obj.es}` : obj.s;
                return {
                    "ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞": r.date, "ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™": r.student, "ﬁÑﬁßﬁàﬁ¶ﬁåﬁ∞": "ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁáﬁ®ﬁãﬁ®ﬁÇﬁ™ﬁÇﬁ∞",
                    "ﬁáﬁß - ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞": sText(r.new), "ﬁáﬁß - ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞": `${r.new.st}-${r.new.en}`, "ﬁáﬁß - ﬁÜﬁ™ﬁÅﬁ∞": r.new.m,
                    "ﬁÜﬁ™ﬁÉﬁ™ - ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞": sText(r.short), "ﬁÜﬁ™ﬁÉﬁ™ - ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞": `${r.short.st}-${r.short.en}`, "ﬁÜﬁ™ﬁÉﬁ™ - ﬁÜﬁ™ﬁÅﬁ∞": r.short.m,
                    "ﬁãﬁ®ﬁéﬁ™ - ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞": sText(r.long), "ﬁãﬁ®ﬁéﬁ™ - ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞": `${r.long.st}-${r.long.en}`, "ﬁãﬁ®ﬁéﬁ™ - ﬁÜﬁ™ﬁÅﬁ∞": r.long.m
                };
            }
        });
        
        if(data.length === 0) return alert("ﬁâﬁ® ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ™ﬁéﬁ¨ ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞");
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, currentClass);
        XLSX.writeFile(wb, `Hifz_${currentClass}.xlsx`);
    }

    window.openProgressModal = function() { document.getElementById('progressModal').style.display = 'flex'; }
    window.closeProgressModal = function() { document.getElementById('progressModal').style.display = 'none'; }

    window.calculateProgress = function() {
        const start = new Date(document.getElementById('progStartDate').value);
        const end = new Date(document.getElementById('progEndDate').value);
        if (isNaN(start) || isNaN(end)) return alert("ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß");

        const studentRecords = records.filter(r => 
            r.class === currentClass && 
            r.student === currentStudent && 
            r.type === 'daily' && (r.new.s || r.new.st)
        );

        let count = 0;
        studentRecords.forEach(r => {
            const d = new Date(r.date);
            if (d >= start && d <= end) count++;
        });

        document.getElementById('progCount').innerText = count;
        document.getElementById('progressResult').style.display = 'block';
    }
</script>
</body>
</html>
