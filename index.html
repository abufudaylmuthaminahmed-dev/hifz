<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁ§ﬁ™ﬁÉﬁ∞ﬁáﬁßﬁÇﬁ∞ ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ - V11.0</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');
        @font-face { font-family: 'Faruma'; src: local('Faruma'), local('Faruma-Regular'); }
        @font-face { font-family: 'Mv Waheed'; src: local('Mv Waheed'), local('Mv Waheed-Regular'); }

        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --student-color: #e67e22;
            --bg: #f4f7f6;
            --sidebar-w: 260px;
            --mushaf-w: 35%;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Faruma', 'Noto Sans Thaana', sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            font-size: 14px;
        }

        /* --- LAYOUT --- */
        #app-container { display: flex; width: 100%; height: 100%; position: relative; }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-w); background: white; border-left: 1px solid #ddd;
            display: flex; flex-direction: column; z-index: 100;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); transition: transform 0.3s;
        }
        .sidebar-header { padding: 15px; background: var(--primary); color: white; text-align: center; }
        
        /* Main Content */
        .main-content { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        /* Mushaf Panel */
        .mushaf-panel {
            width: var(--mushaf-w); background: #34495e; display: flex; flex-direction: column;
            border-right: 1px solid #ccc; transition: all 0.3s ease;
        }
        .mushaf-header { background: #2c3e50; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .mushaf-container { flex: 1; overflow: auto; background: #fdfdfd; display: flex; justify-content: center; position: relative; }
        .mushaf-img { max-width: 100%; display: block; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; right: 0; height: 100%; transform: translateX(100%); }
            .sidebar.open { transform: translateX(0); }
            .mushaf-panel { position: fixed; top: 0; left: 0; width: 100% !important; height: 100%; z-index: 2000; transform: translateY(100%); }
            .mushaf-panel.open { transform: translateY(0); }
            .mobile-menu { display: block !important; }
        }
        .mobile-menu { display: none; font-size: 24px; cursor: pointer; }

        /* --- COMPONENTS --- */
        .btn { padding: 8px 15px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; font-family: inherit; }
        .bg-green { background: var(--accent); } .bg-blue { background: #3498db; } .bg-red { background: #e74c3c; } .bg-grey { background: #95a5a6; }
        
        .student-card {
            background: white; border-bottom: 1px solid #eee; padding: 10px; cursor: pointer;
            display: flex; align-items: center; gap: 10px;
        }
        .student-card:hover { background: #eafaf1; }
        .student-card.active { background: var(--accent); color: white; }
        .st-avatar { width: 30px; height: 30px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; }
        .id-badge { font-size: 10px; background: #eee; padding: 1px 5px; border-radius: 3px; color: #333; }

        /* --- FORMS --- */
        .entry-form { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 12px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }
        
        /* Sections */
        .section-box { padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 2px solid transparent; cursor: pointer; background: #f9f9f9; }
        .section-box.active-section { background: white; border-left: 5px solid; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #box-new.active-section { border-color: #27ae60; }
        #box-short.active-section { border-color: #2980b9; }
        #box-long.active-section { border-color: #d35400; }
        #box-exam.active-section { border-color: #f1c40f; }
        
        .mistake-dot {
            position: absolute; width: 20px; height: 20px; background: rgba(231,76,60,0.9);
            border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);
            cursor: pointer; z-index: 10;
        }

        /* --- LOGIN & MODAL --- */
        #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg, #2c3e50, #3498db); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 30px; border-radius: 10px; width: 300px; text-align: center; }
        .login-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; text-align: center; }
        
        .modal { display: none; position: fixed; z-index: 5000; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-box" id="role-view">
            <h2 style="color:#2c3e50;">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞</h2>
            <br>
            <button class="btn bg-grey w-full" style="width:100%; padding:12px; margin-bottom:10px; background:#e67e22;" onclick="showLogin('student')">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</button>
            <button class="btn bg-blue w-full" style="width:100%; padding:12px;" onclick="showLogin('teacher')">üë®‚Äçüè´ ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
        </div>
        <div class="login-box hidden" id="login-form">
            <h3 id="login-title">Login</h3>
            <input id="login-id" class="login-input" placeholder="ID / Username">
            <input id="login-pass" type="password" class="login-input" placeholder="Password (1234)">
            <button class="btn bg-green" style="width:100%; padding:10px;" onclick="processLogin()">Login</button>
            <button class="btn bg-grey" style="width:100%; margin-top:5px;" onclick="backToRole()">Back</button>
        </div>
    </div>

    <!-- APP -->
    <div id="app-container" class="hidden">
        
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">ﬁâﬁ¨ﬁÇﬁ´</h3>
                    <span onclick="toggleSidebar()" style="cursor:pointer; font-size:24px;">&times;</span>
                </div>
            </div>
            
            <div id="teacher-controls" style="padding:10px; background:#f9f9f9; border-bottom:1px solid #ddd;">
                <select id="classSelect" onchange="loadStudents(this.value)" style="width:100%; margin-bottom:5px;"></select>
                <input type="text" placeholder="üîç Search..." onkeyup="filterStudents(this.value)" style="width:100%; padding:5px; margin-bottom:5px;">
                <div style="display:flex; gap:5px;">
                    <button class="btn bg-blue" style="flex:1; font-size:12px;" onclick="openSettings()">Settings</button>
                    <button class="btn bg-red" onclick="location.reload()">Logout</button>
                </div>
            </div>

            <div id="student-controls" class="hidden" style="padding:15px; text-align:center;">
                <h4 id="stNameDisplay">Student</h4>
                <button class="btn bg-red" style="margin-top:10px;" onclick="location.reload()">Logout</button>
            </div>

            <div id="studentList" style="flex:1; overflow-y:auto;"></div>
        </aside>

        <!-- MAIN -->
        <main class="main-content">
            <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:10px; border-radius:8px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="mobile-menu" onclick="toggleSidebar()">‚ò∞</span>
                    <div>
                        <h3 id="mainHeader" style="margin:0; color:var(--primary);">Dashboard</h3>
                        <small id="subHeader" style="color:#777;">Welcome</small>
                    </div>
                </div>
                <div>
                    <button class="btn bg-green" onclick="exportExcel()">Excel</button>
                    <button class="btn bg-blue" onclick="toggleMushaf(true)">üìñ</button>
                </div>
            </div>

            <!-- TEACHER ENTRY FORM -->
            <div id="teacherEntry" class="hidden entry-form">
                <div class="form-row">
                    <div style="flex:1"><label>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="entryDate"></div>
                    <div style="flex:1"><label>ﬁàﬁ¶ﬁáﬁ∞ﬁåﬁ¶ﬁÉﬁ™</label>
                        <select id="lessonType" onchange="toggleForm(this.value)">
                            <option value="daily">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</option>
                            <option value="exam">ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</option>
                        </select>
                    </div>
                </div>

                <!-- Daily Sections -->
                <div id="daily-sections">
                    <!-- New -->
                    <div id="box-new" class="section-box active-section" onclick="setSection('new')">
                        <label style="color:#27ae60;">üå± ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ <input type="radio" name="sec" checked></label>
                        <div class="form-row">
                            <div style="flex:0.5"><input type="number" id="newPage" placeholder="Page" onchange="handlePage(this.value)" style="text-align:center;"></div>
                            <div style="flex:2"><select id="newSurah" class="arabic-input"><option>...</option></select></div>
                            <div style="flex:1"><input type="number" id="newStart" placeholder="Start"></div>
                            <div style="flex:1"><input type="number" id="newEnd" placeholder="End"></div>
                            <div style="flex:1"><input type="number" id="newMistakes" value="0" style="background:#eee; text-align:center;" readonly></div>
                        </div>
                    </div>
                    <!-- Short -->
                    <div id="box-short" class="section-box" onclick="setSection('short')">
                        <label style="color:#2980b9;">üîÑ ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß <input type="radio" name="sec"></label>
                        <div class="form-row">
                            <div style="flex:0.5"><input type="number" id="shortPage" placeholder="Page" onchange="handlePage(this.value)" style="text-align:center;"></div>
                            <div style="flex:2"><select id="shortSurah" class="arabic-input"><option>...</option></select></div>
                            <div style="flex:1"><input type="number" id="shortStart" placeholder="Start"></div>
                            <div style="flex:1"><input type="number" id="shortEnd" placeholder="End"></div>
                            <div style="flex:1"><input type="number" id="shortMistakes" value="0" style="background:#eee; text-align:center;" readonly></div>
                        </div>
                    </div>
                    <!-- Long -->
                    <div id="box-long" class="section-box" onclick="setSection('long')">
                        <label style="color:#d35400;">üìö ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß <input type="radio" name="sec"></label>
                        <div class="form-row">
                            <div style="flex:0.5"><input type="number" id="longPage" placeholder="Page" onchange="handlePage(this.value)" style="text-align:center;"></div>
                            <div style="flex:2"><select id="longSurah" class="arabic-input"><option>...</option></select></div>
                            <div style="flex:1"><input type="number" id="longStart" placeholder="Start"></div>
                            <div style="flex:1"><input type="number" id="longEnd" placeholder="End"></div>
                            <div style="flex:1"><input type="number" id="longMistakes" value="0" style="background:#eee; text-align:center;" readonly></div>
                        </div>
                    </div>
                </div>

                <!-- Exam Section -->
                <div id="exam-section" class="hidden">
                    <div class="section-box active-section" style="border-color:#f1c40f;">
                        <h3 style="color:#d35400; margin-bottom:10px;">üèÜ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</h3>
                        <div style="background:#34495e; padding:10px; border-radius:5px; color:white; display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                            <span id="timer" style="font-family:monospace; font-size:20px; color:#f1c40f;">00:00</span>
                            <button class="btn bg-green" onclick="startTimer()">Start</button>
                            <button class="btn bg-red" onclick="stopTimer()">Stop</button>
                            <input id="exTime" placeholder="Min" style="width:50px; text-align:center; color:black;">
                        </div>
                        <div class="form-row">
                            <input id="exJuzu" placeholder="Juzu">
                            <select id="exPortion" onchange="calcExam()">
                                <option value="whole">Whole</option>
                                <option value="half">1/2</option>
                            </select>
                            <h3 id="exMark" style="color:blue;">100%</h3>
                        </div>
                        <div class="form-row">
                            <input type="number" id="exTMistakes" placeholder="T (-2)" onchange="calcExam()">
                            <input type="number" id="exSMistakes" placeholder="S (-1)" onchange="calcExam()">
                            <input type="number" id="exTajweed" value="10" placeholder="Taj" onchange="calcExam()">
                            <input type="number" id="exFluency" value="5" placeholder="Flu" onchange="calcExam()">
                        </div>
                    </div>
                </div>

                <button class="btn bg-green" style="width:100%; padding:12px; margin-top:10px;" onclick="saveData()">üíæ SAVE RECORD</button>
            </div>

            <!-- HISTORY -->
            <div id="historyList"></div>
        </main>

        <!-- MUSHAF -->
        <aside class="mushaf-panel" id="mushafPanel">
            <div class="mushaf-header">
                <button class="btn bg-red" onclick="toggleMushaf(false)">Close</button>
                <span id="mushafTitle" style="color:white; font-weight:bold;">Page 1</span>
                <div>
                    <button class="btn bg-grey" onclick="changePage(1)">Next</button>
                    <button class="btn bg-grey" onclick="changePage(-1)">Prev</button>
                </div>
            </div>
            <div class="mushaf-container">
                <div style="position:relative; display:inline-block;" id="mushafWrapper" onclick="placeDot(event)">
                    <img id="mushafImg" class="mushaf-img" src="">
                </div>
            </div>
        </aside>

    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <span style="cursor:pointer; font-size:24px;" onclick="document.getElementById('settingsModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <label>Add Class:</label>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input id="newClassName" placeholder="Name">
                    <button class="btn bg-blue" onclick="createClass()">Add</button>
                </div>
                <label>Import Students (Name IUM123):</label>
                <textarea id="bulkData" style="width:100%; height:100px;"></textarea>
                <button class="btn bg-green" style="width:100%; margin-top:5px;" onclick="importStudents()">Import</button>
                <hr>
                <button class="btn bg-blue" style="width:100%;" onclick="downloadBackup()">Download Backup</button>
                <input type="file" id="restoreFile" style="margin-top:5px;">
                <button class="btn bg-red" style="width:100%; margin-top:5px;" onclick="restoreBackup()">Restore</button>
            </div>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    // *** PASTE YOUR CONFIG HERE ***
    const firebaseConfig = {
      apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
      authDomain: "hifz-cde3b.firebaseapp.com",
      databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
      projectId: "hifz-cde3b",
      storageBucket: "hifz-cde3b.firebasestorage.app",
      messagingSenderId: "566754658580",
      appId: "1:566754658580:web:d63d0f167960f53bab9a01"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch(e) { console.error(e); }

    // --- STATE ---
    let appState = { role: null, classes: {}, records: [], currClass: null, currStudent: null, activeSec: 'new', currPage: 1, dots: [], timer: null, startT: 0 };
    const surahNames = ["ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©","ÿßŸÑÿ®ŸÇÿ±ÿ©","ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ","ÿßŸÑŸÜÿ≥ÿßÿ°","ÿßŸÑŸÖÿßÿ¶ÿØÿ©","ÿßŸÑÿ£ŸÜÿπÿßŸÖ","ÿßŸÑÿ£ÿπÿ±ÿßŸÅ","ÿßŸÑÿ£ŸÜŸÅÿßŸÑ","ÿßŸÑÿ™Ÿàÿ®ÿ©","ŸäŸàŸÜÿ≥","ŸáŸàÿØ","ŸäŸàÿ≥ŸÅ","ÿßŸÑÿ±ÿπÿØ","ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ","ÿßŸÑÿ≠ÿ¨ÿ±","ÿßŸÑŸÜÿ≠ŸÑ","ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°","ÿßŸÑŸÉŸáŸÅ","ŸÖÿ±ŸäŸÖ","ÿ∑Ÿá","ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°","ÿßŸÑÿ≠ÿ¨","ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ","ÿßŸÑŸÜŸàÿ±","ÿßŸÑŸÅÿ±ŸÇÿßŸÜ","ÿßŸÑÿ¥ÿπÿ±ÿßÿ°","ÿßŸÑŸÜŸÖŸÑ","ÿßŸÑŸÇÿµÿµ","ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™","ÿßŸÑÿ±ŸàŸÖ","ŸÑŸÇŸÖÿßŸÜ","ÿßŸÑÿ≥ÿ¨ÿØÿ©","ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®","ÿ≥ÿ®ÿ£","ŸÅÿßÿ∑ÿ±","Ÿäÿ≥","ÿßŸÑÿµÿßŸÅÿßÿ™","ÿµ","ÿßŸÑÿ≤ŸÖÿ±","ÿ∫ÿßŸÅÿ±","ŸÅÿµŸÑÿ™","ÿßŸÑÿ¥Ÿàÿ±Ÿâ","ÿßŸÑÿ≤ÿÆÿ±ŸÅ","ÿßŸÑÿØÿÆÿßŸÜ","ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©","ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ","ŸÖÿ≠ŸÖÿØ","ÿßŸÑŸÅÿ™ÿ≠","ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™","ŸÇ","ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™","ÿßŸÑÿ∑Ÿàÿ±","ÿßŸÑŸÜÿ¨ŸÖ","ÿßŸÑŸÇŸÖÿ±","ÿßŸÑÿ±ÿ≠ŸÖŸÜ","ÿßŸÑŸàÿßŸÇÿπÿ©","ÿßŸÑÿ≠ÿØŸäÿØ","ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©","ÿßŸÑÿ≠ÿ¥ÿ±","ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©","ÿßŸÑÿ∂ŸÅ","ÿßŸÑÿ¨ŸÖÿπÿ©","ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ","ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ","ÿßŸÑÿ∑ŸÑÿßŸÇ","ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ","ÿßŸÑŸÖŸÑŸÉ","ÿßŸÑŸÇŸÑŸÖ","ÿßŸÑÿÆÿßŸÇÿ©","ÿßŸÑŸÖÿπÿßÿ±ÿ¨","ŸÜŸàÿ≠","ÿßŸÑÿ¨ŸÜ","ÿßŸÑŸÖÿ≤ŸÖŸÑ","ÿßŸÑŸÖÿØÿ´ÿ±","ÿßŸÑŸÇŸäÿßŸÖÿ©","ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ","ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™","ÿßŸÑŸÜÿ®ÿ£","ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™","ÿπÿ®ÿ≥","ÿßŸÑÿ™ŸÉŸàŸäÿ±","ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±","ÿßŸÑÿ∑ŸÅŸäŸÅŸäŸÜ","ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ","ÿßŸÑÿ®ÿ±Ÿàÿ¨","ÿßŸÑÿ∑ÿßÿ±ŸÇ","ÿßŸÑÿ£ÿπŸÑŸâ","ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©","ÿßŸÑŸÅÿ¨ÿ±","ÿßŸÑÿ®ŸÑÿØ","ÿßŸÑÿ¥ŸÖÿ≥","ÿßŸÑŸÑŸäŸÑ","ÿßŸÑÿ∂ÿ≠Ÿâ","ÿßŸÑÿ¥ÿ±ÿ≠","ÿßŸÑÿ™ŸäŸÜ","ÿßŸÑÿπŸÑŸÇ","ÿßŸÑŸÇÿØÿ±","ÿßŸÑÿ®ŸäŸÜÿ©","ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©","ÿßŸÑÿπÿßÿØŸäÿßÿ™","ÿßŸÑŸÇÿßÿ±ÿπÿ©","ÿßŸÑÿ™ŸÉÿßÿ´ÿ±","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸÅŸäŸÑ","ŸÇÿ±Ÿäÿ¥","ÿßŸÑŸÖÿßÿπŸàŸÜ","ÿßŸÑŸÉŸàÿ´ÿ±","ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ","ÿßŸÑŸÜÿµÿ±","ÿßŸÑŸÖÿ≥ÿØ","ÿßŸÑÿ•ÿÆŸÑÿßÿµ","ÿßŸÑŸÅŸÑŸÇ","ÿßŸÑŸÜÿßÿ≥"];

    // --- INIT ---
    window.onload = function() {
        populateSurah();
        document.getElementById('entryDate').valueAsDate = new Date();
        loadMushaf(1);
        if(db) {
            db.ref('/').on('value', snap => {
                const val = snap.val() || {};
                appState.classes = val.classes || {};
                appState.records = [];
                if(val.records) Object.keys(val.records).forEach(k => appState.records.push({...val.records[k], key:k}));
                
                if(appState.role === 'teacher') renderClasses();
                if(appState.currStudent) renderHistory();
                
                document.getElementById('login-screen').classList.remove('hidden'); // Ensure visible
            });
        }
    };

    function populateSurah() {
        ['new', 'short', 'long'].forEach(sec => {
            const sel = document.getElementById(sec+'Surah');
            sel.innerHTML = '<option>...</option>';
            surahNames.forEach((s,i) => sel.innerHTML += `<option value="${i+1}">${i+1}. ${s}</option>`);
        });
    }

    // --- AUTH ---
    function showLogin(role) {
        appState.tempRole = role;
        document.getElementById('role-view').classList.add('hidden');
        document.getElementById('login-form').classList.remove('hidden');
    }
    function backToRole() {
        document.getElementById('role-view').classList.remove('hidden');
        document.getElementById('login-form').classList.add('hidden');
    }
    function processLogin() {
        const id = document.getElementById('login-id').value.trim();
        const pass = document.getElementById('login-pass').value.trim();
        if(pass === '1234') {
            appState.role = appState.tempRole;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').classList.remove('hidden');
            
            if(appState.role === 'teacher') {
                document.getElementById('teacher-controls').classList.remove('hidden');
                renderClasses();
            } else {
                document.getElementById('teacher-controls').classList.add('hidden');
                document.getElementById('student-controls').classList.remove('hidden');
                // Find student logic...
                let found = null;
                Object.keys(appState.classes).forEach(c => {
                    (appState.classes[c].students || []).forEach(s => {
                        if(s.includes(id)) { found = s; appState.currClass = c; }
                    });
                });
                if(found) {
                    appState.currStudent = found;
                    document.getElementById('stNameDisplay').innerText = found;
                    renderHistory();
                } else {
                    alert('ID Not Found'); location.reload();
                }
            }
        } else alert('Wrong Password');
    }

    // --- TEACHER ---
    function renderClasses() {
        const sel = document.getElementById('classSelect');
        sel.innerHTML = '';
        Object.keys(appState.classes).forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
        if(Object.keys(appState.classes).length > 0 && !appState.currClass) loadStudents(Object.keys(appState.classes)[0]);
    }
    function loadStudents(cls) {
        appState.currClass = cls;
        const list = document.getElementById('studentList');
        list.innerHTML = '';
        (appState.classes[cls].students || []).forEach(s => {
            const div = document.createElement('div');
            div.className = 'student-card';
            div.innerHTML = `<div class="st-avatar">${s.charAt(0)}</div><div><b>${s.split('IUM')[0]}</b><br><span class="id-badge">${s.includes('IUM')?s.split('IUM')[1]:''}</span></div>`;
            div.onclick = () => selectStudent(s, div);
            list.appendChild(div);
        });
    }
    function selectStudent(name, el) {
        appState.currStudent = name;
        document.querySelectorAll('.student-card').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('mainHeader').innerText = name.split('IUM')[0];
        document.getElementById('subHeader').innerText = appState.currClass;
        document.getElementById('teacherEntry').classList.remove('hidden');
        if(window.innerWidth <= 768) toggleSidebar();
        clearInputs();
        appState.dots = [];
        autoFill();
        renderHistory();
    }

    // --- FORMS ---
    function setSection(sec) {
        appState.activeSec = sec;
        document.querySelectorAll('.section-box').forEach(b => b.classList.remove('active-section'));
        if(sec !== 'exam') {
            document.getElementById('box-'+sec).classList.add('active-section');
            document.querySelector(`input[name="sec"][value="${sec}"]`); 
            const p = document.getElementById(sec+'Page').value;
            if(p) loadMushaf(p);
        }
        appState.dots = [];
        clearDots();
    }
    function toggleForm(val) {
        document.getElementById('daily-sections').style.display = val === 'daily' ? 'block' : 'none';
        document.getElementById('exam-section').style.display = val === 'exam' ? 'block' : 'none';
        setSection(val === 'daily' ? 'new' : 'exam');
    }
    function autoFill() {
        if(!appState.currStudent) return;
        const recs = appState.records.filter(r => r.student === appState.currStudent && r.type === 'daily');
        recs.sort((a,b) => new Date(b.date) - new Date(a.date));
        if(recs.length > 0) {
            // Check last new lesson
            if(recs[0].new && recs[0].new.en) {
                 // Fetch logic (Simplified: +1 page)
                 // In real usage: fetch API
            }
        }
    }
    function saveData() {
        if(!appState.currStudent) return alert('Select Student');
        const type = document.getElementById('lessonType').value;
        const rec = {
            id: Date.now(),
            date: document.getElementById('entryDate').value,
            class: appState.currClass,
            student: appState.currStudent,
            type: type
        };
        
        if(type === 'daily') {
            const sec = appState.activeSec;
            rec[sec] = {
                s: surahNames[document.getElementById(sec+'Surah').value - 1] || '',
                st: document.getElementById(sec+'Start').value,
                en: document.getElementById(sec+'End').value,
                m: document.getElementById(sec+'Mistakes').value,
                dots: appState.dots
            };
        } else {
            rec.juzu = document.getElementById('exJuzu').value;
            rec.score = document.getElementById('exTotal').innerText;
        }
        
        db.ref('records').push(rec);
        alert('Saved');
        appState.dots = [];
        clearInputs();
        loadMushaf(appState.currPage);
    }

    function renderHistory() {
        const div = document.getElementById('historyList');
        div.innerHTML = '';
        const recs = appState.records.filter(r => r.student === appState.currStudent);
        recs.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        recs.forEach(r => {
            let html = `<div class="history-item ${r.type==='exam'?'h-exam':'h-'+Object.keys(r).find(k=>['new','short','long'].includes(k))}">
                <div style="display:flex; justify-content:space-between; font-weight:bold;">${r.date} ${appState.role==='teacher'?`<span onclick="delRec('${r.key}')" style="color:red; cursor:pointer;">√ó</span>`:''}</div>`;
            
            if(r.type === 'daily') {
                ['new','short','long'].forEach(s => {
                    if(r[s]) {
                        const d = encodeURIComponent(JSON.stringify(r[s].dots||[]));
                        html += `<div style="margin-top:5px; font-size:14px;"><b>${s.toUpperCase()}:</b> ${r[s].s} (${r[s].st}-${r[s].en}) <span style="color:red">(${r[s].m})</span> ${r[s].dots?`<button class="btn bg-blue" style="padding:2px 8px; font-size:10px;" onclick="viewDots('${d}')">üëÅÔ∏è</button>`:''}</div>`;
                    }
                });
            } else {
                html += `<div>Exam: ${r.juzu} - ${r.score}</div>`;
            }
            div.innerHTML += html + '</div>';
        });
    }

    // --- MUSHAF ---
    function loadMushaf(p) {
        if(!p) return;
        appState.currPage = parseInt(p);
        document.getElementById('mushafTitle').innerText = "Page " + p;
        document.getElementById('mushafImg').src = `https://android.quran.com/data/width_1260/page${p.toString().padStart(3,'0')}.png`;
        clearDots();
        appState.dots.forEach(d => { if(d.p == p) drawDot(d.x, d.y); });
    }
    function placeDot(e) {
        if(appState.role !== 'teacher') return;
        const rect = e.target.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        appState.dots.push({x, y, p: appState.currPage});
        adjM(appState.activeSec+'Mistakes', 1);
        drawDot(x, y);
    }
    function drawDot(x, y) {
        const d = document.createElement('div');
        d.className = 'mistake-dot';
        d.style.left = x + 'px'; d.style.top = y + 'px';
        document.getElementById('mushafWrapper').appendChild(d);
    }
    function clearDots() { document.querySelectorAll('.mistake-dot').forEach(e=>e.remove()); }
    function viewDots(data) {
        const dots = JSON.parse(decodeURIComponent(data));
        if(!dots || !dots.length) return alert('No mistakes');
        loadMushaf(dots[0].p);
        toggleMushaf(true);
        setTimeout(() => {
            dots.forEach(d => {
                const dot = document.createElement('div');
                dot.className = 'mistake-dot dot.ro';
                dot.style.background = 'gold';
                dot.style.left = d.x + 'px'; dot.style.top = d.y + 'px';
                document.getElementById('mushafWrapper').appendChild(dot);
            });
        }, 500);
    }
    
    // --- UTILS ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function toggleMushaf(s) { 
        const p = document.getElementById('mushafPanel');
        if(s) p.classList.add('open'); else p.classList.remove('open');
    }
    function changePage(d) { loadMushaf(appState.currPage + d); }
    function handlePage(v, sec) { loadMushaf(v); } // simplified
    function adjM(id, v) { 
        const el = document.getElementById(id); 
        el.value = Math.max(0, parseInt(el.value)+v); 
    }
    function clearInputs() {
        ['new','short','long'].forEach(s => {
            document.getElementById(s+'Page').value='';
            document.getElementById(s+'Start').value='';
            document.getElementById(s+'End').value='';
            document.getElementById(s+'Mistakes').value=0;
        });
    }
    function delRec(k) { if(confirm('Delete?')) db.ref('records/'+k).remove(); }
    
    // --- TIMER & EXAM ---
    function startTimer() {
        if(!appState.timer) {
            appState.startT = Date.now();
            appState.timer = setInterval(() => {
                const s = Math.floor((Date.now() - appState.startT)/1000);
                document.getElementById('timerDisplay').innerText = new Date(s*1000).toISOString().substr(14, 5);
            }, 1000);
        }
    }
    function stopTimer() { clearInterval(appState.timer); appState.timer=null; document.getElementById('examDuration').value = Math.ceil((Date.now()-appState.startT)/60000); }
    function calcExam() { 
        const t = parseInt(document.getElementById('exTMistakes').value)||0;
        const s = parseInt(document.getElementById('exSMistakes').value)||0;
        const base = document.getElementById('exPortion').value === 'whole' ? 100 : 50;
        document.getElementById('exTotal').innerText = (base - (t*2) - s) + "%";
    }

    // --- SETTINGS MOCK ---
    function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
    function createClass() { 
        const n = document.getElementById('newClassName').value;
        if(n) { db.ref('classes/'+n).set({students:[]}); document.getElementById('settingsModal').style.display='none'; }
    }
    function importStudents() {
        const c = appState.currClass;
        const list = document.getElementById('bulkData').value.split('\n').filter(s=>s.trim());
        const old = appState.classes[c]?.students || [];
        db.ref('classes/'+c+'/students').set([...new Set([...old, ...list])]);
        alert('Added');
    }
    function downloadBackup() {
        const d = { classes: appState.classes, records: appState.records };
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(d));
        a.download = "backup.json"; a.click();
    }
    function restoreBackup() {
        const f = document.getElementById('restoreFile').files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            const d = JSON.parse(e.target.result);
            if(confirm('Restore?')) { db.ref('/').set(d); location.reload(); }
        };
        r.readAsText(f);
    }
</script>
</body>
</html>
