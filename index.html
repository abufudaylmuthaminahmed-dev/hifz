<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥ØªÙ‚Ø§Ù† - Hifz Program (V42-Student Details)</title>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- FONTS FIX --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@700&display=swap');

        /* Font Loading Logic for Mobile */
        @font-face { 
            font-family: 'Faruma'; 
            src: local('Faruma'), 
                 url('faruma.ttf') format('truetype'); 
            font-weight: normal;
            font-style: normal;
        }
        @font-face { 
            font-family: 'MV Waheed'; 
            src: local('MV Waheed'), 
                 url('mvwaheed.ttf') format('truetype'); 
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --primary: #2c3e50; 
            --accent: #27ae60;
            --accent-rev: #e67e22;
            --mistake: #e74c3c;
            --bg-light: #f8f9fa;
            --mushaf-paper: #fffcf2;
            --st-primary: #117a65;
            
            --font-main: 'Faruma', 'Noto Sans Thaana', sans-serif;
            --font-heading: 'MV Waheed', 'Noto Sans Thaana', sans-serif; 
            --font-arabic: 'Amiri', serif;
        }

        * { box-sizing: border-box; }
        body { font-family: var(--font-main); margin: 0; min-height: 100vh; color: #333; background-color: var(--bg-light); overflow-x: hidden; transition: background 0.3s; }
        
        body.student-mode { background-color: #e8f6f3; }
        body.student-mode .app-header { border-bottom: 3px solid var(--st-primary); }
        body.student-mode .header-title { color: var(--st-primary); }

        .hidden { display: none !important; }
        .container { width: 100%; padding: 20px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.3s ease; }

        /* HEADER */
        .app-header { background: white; height: 65px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header-title { font-family: var(--font-heading); font-size: 24px; color: var(--primary); }
        .icon-btn { background: #f0f2f5; border: none; width: 42px; height: 42px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; color: #333; }
        .logout-btn { background: #fee2e2; color: #b91c1c; }

        /* LOGIN STYLE */
        .login-wrapper { display: flex; align-items: center; justify-content: center; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; background: #ecf0f1; z-index: 2000; }
        .login-card { background: white; padding: 50px 40px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; border-top: 5px solid var(--primary); }
        
        .logo-container { margin-bottom: 30px; }
        .logo-arabic { font-family: 'Amiri', 'Reem Kufi', serif; font-size: 80px; color: var(--primary); line-height: 1.1; margin-bottom: 5px; text-shadow: 2px 2px 0px #eee; font-weight: 700; }
        .logo-eng { font-family: sans-serif; font-size: 16px; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 10px; }
        .logo-dv { font-family: var(--font-heading); font-size: 22px; color: #7f8c8d; margin-top: 5px; }

        .tabs { display: flex; background: #eee; padding: 5px; border-radius: 50px; margin: 20px 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; font-family: var(--font-heading); font-size: 16px; border-radius: 40px; color: #777; transition:0.3s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; }
        .form-input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 10px; font-family: var(--font-main); font-size: 16px; margin-bottom: 15px; text-align: right; outline: none; transition: 0.3s; }
        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-family: var(--font-heading); font-size: 18px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* GRID & CARDS */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; justify-content: center; }
        .card-btn { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; min-height: 160px; position: relative; }
        .card-btn:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .card-icon { font-size: 40px; width: 70px; height: 70px; background: #f4f6f8; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .card-title { font-size: 18px; font-weight: bold; color: var(--primary); margin: 0; }
        .card-sub { font-size: 13px; color: #7f8c8d; }
        .dashboard-center { display: flex; gap: 20px; justify-content: center; margin-top: 40px; flex-wrap: wrap; }
        .dashboard-center .card-btn { width: 250px; }

        /* STUDENT DETAIL CARD (New for Management) */
        .student-detail-card {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee;
            position: relative; transition: 0.2s;
        }
        .student-detail-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .st-card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 10px; }
        .st-name { font-family: var(--font-heading); font-size: 18px; color: var(--primary); }
        .st-id { background: #ecf0f1; padding: 2px 8px; border-radius: 8px; font-size: 12px; color: #7f8c8d; font-weight: bold; }
        .st-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: #555; }
        .st-info-item { display: flex; justify-content: space-between; }
        .st-info-label { color: #999; }
        .st-remarks-box { margin-top: 10px; background: #fffcf2; padding: 8px; border-radius: 5px; font-size: 12px; border: 1px solid #fae5d3; color: #d35400; }
        .st-footer-actions { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* STUDENT STAT BAR (COMPACT) */
        .student-stat-container {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px;
            display: flex; justify-content: space-around; align-items: center;
            border: 1px solid #e0e0e0;
        }
        .st-stat-item { text-align: center; flex: 1; border-left: 1px solid #eee; }
        .st-stat-item:last-child { border-left: none; }
        .st-stat-val { font-size: 28px; font-weight: bold; line-height: 1; margin-bottom: 5px; font-family: var(--font-arabic); }
        .st-stat-lbl { font-size: 13px; color: #777; font-weight: 500; }
        .st-color-1 { color: var(--st-primary); }
        .st-color-2 { color: var(--accent-rev); }
        .st-color-3 { color: var(--primary); }

        /* BUTTONS */
        .big-btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-size: 16px; font-family: var(--font-heading); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 5px; transition:0.2s; }
        .big-btn:hover { transform: scale(1.05); }
        .btn-orange { background: #e67e22; } .btn-green { background: #27ae60; } .btn-red { background: #c0392b; }

        /* ACTION CARD */
        .action-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; }

        /* MENU GRID */
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        @media (min-width: 600px) { .menu-grid { grid-template-columns: repeat(3, 1fr); } }
        .menu-btn { background: white; padding: 25px; border-radius: 15px; border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; transition: 0.2s; }
        .menu-btn:hover { border-color: var(--primary); transform: translateY(-3px); }
        .menu-icon { font-size: 35px; width: 70px; height: 70px; background: #f4f6f8; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* HISTORY CARD */
        .hist-card { background: white; width: 100%; margin-bottom: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #e0e0e0; cursor: pointer; transition:0.2s; position: relative; }
        .hist-card:active { transform: scale(0.99); }
        .hist-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .hist-title { font-weight: bold; font-size: 20px; color: var(--primary); }
        .hist-date { font-family: sans-serif; font-size: 14px; color: #555; background: #e0e0e0; padding: 4px 10px; border-radius: 15px; font-weight: bold; }
        .hist-body { padding: 20px; }
        .hist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .hist-item { text-align: center; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #f0f0f0; }
        .hist-label { font-size: 12px; color: #7f8c8d; display: block; margin-bottom: 2px; }
        .hist-val { font-size: 16px; font-weight: bold; color: #333; font-family: var(--font-arabic); }
        .hist-footer { padding: 15px; background: #eafaf1; text-align: center; border-top: 1px solid #d5f5e3; font-size: 20px; font-weight: bold; color: var(--accent); position: relative; }
        .hist-footer.exam-score { background: #ebf5fb; border-top: 1px solid #d6eaf8; color: #2980b9; }

        .hist-card.type-new_lesson { border-right: 5px solid var(--accent); }
        .hist-card.type-juz_exam { border-right: 5px solid #2980b9; }
        .hist-card.type-final_exam { border-right: 5px solid #c0392b; }

        .btn-edit-hist, .btn-delete-hist, .btn-action-sm { 
            width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-delete-hist { background: #fee2e2; color: #c0392b; }
        .btn-edit-hist { background: #e3f2fd; color: #2980b9; }
        
        .btn-delete-hist.abs-pos { position:absolute; bottom:10px; left:10px; }
        .btn-edit-hist.abs-pos { position:absolute; bottom:10px; left:55px; }

        /* PROGRESS REPORT */
        .prog-card { background: white; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #eee; }
        .prog-header { padding: 15px; background: #fdfdfd; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .prog-name { font-weight: bold; font-size: 16px; color: var(--primary); }
        .prog-total { background: var(--accent); color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .prog-body { padding: 15px; display: flex; justify-content: space-between; gap: 10px; }
        .prog-section { flex: 1; text-align: center; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        .prog-lbl { font-size: 11px; color: #777; display: block; margin-bottom: 5px; }
        .prog-val { font-size: 14px; font-weight: bold; color: #333; font-family: var(--font-arabic); }

        /* APPROVAL CARD */
        .approval-card {
            background: white; border-radius: 12px; border: 1px solid #e0e0e0; border-right: 5px solid #e67e22;
            padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 10px;
        }
        .app-card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .app-stu-name { font-weight: bold; font-size: 16px; color: var(--primary); }
        .app-date { background: #f0f2f5; color: #555; font-size: 12px; padding: 3px 8px; border-radius: 10px; }
        .app-details { background: #fffcf2; padding: 10px; border-radius: 8px; font-family: var(--font-arabic); text-align: center; font-size: 18px; color: #333; }
        .app-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 5px; }
        .btn-approve { background: #d4efdf; color: #1e8449; padding: 8px 15px; border-radius: 20px; border:none; cursor: pointer; font-weight: bold; }
        .btn-reject { background: #fadbd8; color: #c0392b; padding: 8px 15px; border-radius: 20px; border:none; cursor: pointer; font-weight: bold; }

        /* LAYOUTS & MUSHAF */
        .layout-split { display: flex; height: calc(100vh - 65px); overflow: hidden; }
        .sidebar-panel { width: 400px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; z-index: 10; padding: 20px; box-shadow: -5px 0 20px rgba(0,0,0,0.05); }
        .main-panel { flex-grow: 1; background: var(--mushaf-paper); position: relative; display: flex; flex-direction: column; overflow-y: auto; padding: 20px; align-items: center; }

        .mushaf-top-bar { background: white; padding: 8px 20px; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 10px; font-family: var(--font-arabic); font-size: 18px; color: var(--primary); display: flex; justify-content: space-between; width: 100%; max-width: 900px; margin: 0 auto 10px auto; direction: rtl; flex-shrink: 0; }
        .mushaf-page { width: 100%; max-width: 900px; background: white; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-height: 80%; flex-grow: 1; direction: rtl; text-align: center; border-radius: 8px; margin: 0 auto; overflow-y: auto; }
        .quran-text { font-family: var(--font-arabic); font-size: 26px; line-height: 2.2; text-align: justify; text-align-last: center; }
        .word { cursor: pointer; border-radius: 4px; padding: 2px 1px; transition: background 0.1s; }
        .word:hover { background: rgba(0,0,0,0.05); }
        .word.mistake { background-color: var(--mistake); color: white; }
        .ayah-marker { color: #d4ac6e; font-weight: bold; }
        .mushaf-nav { display: flex; justify-content: space-between; margin-top: 10px; width: 100%; max-width: 900px; padding: 5px; flex-shrink: 0; }
        .nav-btn { background: #34495e; color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-size: 24px; font-weight: bold; font-family: var(--font-main) !important; }

        /* EXAM & RECORDER */
        .score-header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 15px; }
        .big-score { font-size: 40px; font-weight: bold; }
        .score-control { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #f8f9fa; padding: 10px; border-radius: 10px; }
        .ctrl-btn { width: 35px; height: 35px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-minus { background: #ffcdd2; color: #c62828; } .btn-plus { background: #c8e6c9; color: #2e7d32; }
        .stopwatch-box { font-family: monospace; font-size: 32px; text-align: center; color: #e67e22; font-weight: bold; background: #fffbf0; padding: 10px; border-radius: 10px; border: 1px solid #ffeeba; margin-bottom: 15px; }
        
        .form-sec { border: 1px solid #eee; padding: 10px; border-radius: 8px; position: relative; margin-top: 10px; }
        .sec-title { position: absolute; top: -10px; right: 10px; background: white; padding: 0 5px; font-size: 12px; font-weight: bold; color: #777; }
        .rec-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-family: var(--font-main); text-align: right; margin-bottom: 5px; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 550px; max-height: 95vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-span { grid-column: span 2; }
        .form-label { font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px; color: #555; }

        @media (max-width: 900px) {
            .layout-split { flex-direction: column; }
            .sidebar-panel { width: 100%; height: auto; max-height: 50vh; order: 1; border-bottom: 2px solid #ddd; }
            .main-panel { order: 2; height: 50vh; }
            .grid-container { grid-template-columns: 1fr; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="login-screen" class="login-wrapper">
        <div class="login-card">
            <div class="logo-container">
                <div class="logo-arabic">Ø¥ØªÙ‚Ø§Ù†</div>
                <div class="logo-eng">Hifz Program</div>
                <div class="logo-dv">Ş™Ş¨ŞŠŞ°Ş¡Ş° Ş•Ş°ŞƒŞ®ŞŞ°ŞƒŞ§Ş‰Ş°</div>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="window.switchLogin('teacher')">Ş‰ŞªŞ‹Ş¦Ş‡Ş°ŞƒŞ¨ŞŞ°</button>
                <button class="tab-btn" onclick="window.switchLogin('student')">Ş‹Ş¦ŞƒŞ¨ŞˆŞ¦ŞƒŞª</button>
            </div>
            <div id="teacher-login-form">
                <input type="text" id="teacherUsername" class="form-input" placeholder="Ş”Ş«ŞŞ¦Şƒ Ş‚Ş­Ş‰Ş°">
                <input type="password" id="teacherPassInput" class="form-input" placeholder="Ş•Ş§ŞŞ°ŞˆŞ¯Ş‘Ş°">
                <button class="btn-primary" onclick="window.loginTeacher()">ŞŞ®ŞŞ¨Ş‚Ş°</button>
            </div>
            <div id="student-login-form" class="hidden">
                <input type="text" id="stuIdInput" class="form-input" placeholder="Ş‡Ş¦Ş‡Ş¨Ş‘Ş© Ş‚Ş¦Ş‚Ş°Ş„Ş¦ŞƒŞª">
                <div id="stuPassField" class="hidden" style="margin-top:10px;">
                    <input type="password" id="stuPassInput" class="form-input" placeholder="Ş•Ş§ŞŞ°ŞˆŞ¯Ş‘Ş°">
                </div>
                <button class="btn-primary" style="background:var(--st-primary);" onclick="window.handleStudentLoginStep()">ŞŞ®ŞŞ¨Ş‚Ş°</button>
            </div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="hidden">
        
        <!-- TEACHER DASHBOARD -->
        <div id="teacher-dashboard" class="container hidden">
            <div class="app-header">
                <div class="header-title">Ş‰ŞªŞ‹Ş¦Ş‡Ş°ŞƒŞ¨ŞŞ° Ş•Ş¬Ş‚Ş¦ŞŞ°</div>
                <button class="icon-btn logout-btn" onclick="window.logout()">â»</button>
            </div>
            <div class="dashboard-center">
                <div class="card-btn" onclick="window.openPage('management-page')">
                    <span class="card-icon">âš™ï¸</span>
                    <h3 class="card-title">Ş†Ş°ŞŞ§ŞŞ° Ş‰Ş¬Ş‚Ş­Ş–Ş°Ş‰Ş¦Ş‚Ş°Ş“Ş°</h3>
                    <span class="card-sub">Ş†Ş°ŞŞ§ŞŞ° Ş€Ş¬Ş‹ŞªŞ‚Ş° / Ş‹Ş¦ŞƒŞ¨ŞˆŞ¦ŞƒŞªŞ‚Ş°</span>
                </div>
                <div class="card-btn" onclick="window.openGradingClassList()">
                    <span class="card-icon">ğŸ“š</span>
                    <h3 class="card-title">ŞŠŞ¨ŞŞ§ŞˆŞ¦Ş…Şª Ş‚Ş¬ŞŞªŞ‚Ş°</h3>
                    <span class="card-sub">ŞƒŞ¬Ş†Ş¯Ş‘Ş° Ş†ŞªŞƒŞªŞ‚Ş° / Ş„Ş¬ŞŞªŞ‚Ş°</span>
                </div>
                <div class="card-btn" onclick="window.openProgressPage()">
                    <span class="card-icon">ğŸ“ˆ</span>
                    <h3 class="card-title">Ş•Ş°ŞƒŞ®ŞŞ°ŞƒŞ¬ŞŞ°</h3>
                    <span class="card-sub">ŞƒŞ¨Ş•Ş¯Ş“Ş°ŞŒŞ¦Ş‡Ş°</span>
                </div>
                <!-- Admin Only -->
                <div id="admin-panel-btn" class="card-btn hidden" onclick="window.openTeacherManagement()">
                    <span class="card-icon">ğŸ‘¤</span>
                    <h3 class="card-title">Ş‰ŞªŞ‹Ş¦Ş‡Ş°ŞƒŞ¨ŞŞªŞ‚Ş°</h3>
                    <span class="card-sub">Ş‡Ş¬Ş‘Ş°Ş‰Ş¨Ş‚Ş° Ş•Ş¬Ş‚Ş¦ŞŞ°</span>
                </div>
            </div>
        </div>

        <!-- TEACHER MANAGEMENT PAGE (Admin Only) -->
        <div id="teacher-mgmt-page" class="container hidden">
            <div class="app-header"><div class="header-title">Ş‰ŞªŞ‹Ş¦Ş‡Ş°ŞƒŞ¨ŞŞªŞ‚Ş°ŞŞ¬ Ş‰Ş¦Ş¢ŞªŞŞ«Ş‰Ş§ŞŒŞª</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">â¬…</button></div>
            <div class="action-card" style="margin-top:20px;">
                <h4>Ş‰ŞªŞ‹Ş¦Ş‡Ş°ŞƒŞ¨ŞŞ° Ş‡Ş¨ŞŒŞªŞƒŞªŞ†ŞªŞƒŞªŞ‚Ş°</h4>
                <div style="display:flex; gap:10px; max-width:600px; margin:0 auto;">
                    <input type="text" id="newTeachName" class="form-input" placeholder="Ş‚Ş¦Ş‚Ş°" style="margin:0; flex:1;">
                    <input type="text" id="newTeachUser" class="form-input" placeholder="Ş”Ş«ŞŞ¦Şƒ Ş‚Ş­Ş‰Ş°" style="margin:0; flex:1;">
                    <input type="text" id="newTeachPass" class="form-input" placeholder="Ş•Ş§ŞŞ°ŞˆŞ¯Ş‘Ş°" style="margin:0; flex:1;">
                    <button class="big-btn" style="width:auto;" onclick="window.createTeacher()">Ş‡Ş¨ŞŒŞªŞƒŞªŞ†ŞªŞƒŞ­</button>
                </div>
            </div>
            <h4 style="margin-top:20px;">Ş‰ŞªŞ‹Ş¦Ş‡Ş°ŞƒŞ¨ŞŞªŞ‚Ş°ŞŞ¬ ŞŞ¨ŞŞ°Ş“Ş°</h4>
            <div id="teacherList" class="grid-container"></div>
        </div>

        <!-- PROGRESS REPORT PAGE (SEMESTER BASED) -->
        <div id="progress-page" class="container hidden">
            <div class="app-header"><div class="header-title">Ş•Ş°ŞƒŞ®ŞŞ°ŞƒŞ¬ŞŞ° ŞƒŞ¨Ş•Ş¯Ş“Ş°</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">â¬…</button></div>
            
            <div class="action-card" style="margin-top:20px; border-top: 5px solid var(--accent-rev);">
                <h4>Ş‡Ş§ ŞŞ¬Ş‰Ş¨ŞŞ°Ş“Ş¦Şƒ Ş€Ş¬Ş‹ŞªŞ‚Ş°</h4>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <input type="text" id="semName" class="form-input" placeholder="ŞŞ¬Ş‰Ş¨ŞŞ°Ş“Ş¦Şƒ Ş‚Ş¦Ş‚Ş°">
                    <input type="date" id="semStart" class="form-input">
                    <input type="date" id="semEnd" class="form-input">
                </div>
                <button class="big-btn" onclick="window.createSemester()">ŞŞ¬Ş‰Ş¨ŞŞ°Ş“Ş¦Şƒ Ş€Ş¦Ş‹Ş§</button>
            </div>
            
            <!-- Pending Approvals Section -->
            <div id="pendingApprovalsSection" style="margin-top:30px;">
                <h4 style="color:#e67e22;">Ş†ŞªŞƒŞ©ŞŞ¬ Ş‘Ş­Ş“Ş§ (Pending Approvals)</h4>
                <div id="pendingApprovalsList"></div>
            </div>

            <h4 style="margin-top:20px;">ŞŞ¬Ş‰Ş¨ŞŞ°Ş“Ş¦ŞƒŞŒŞ¦Ş‡Ş°</h4>
            <div id="semesterList" class="grid-container"></div>
            
            <!-- Hidden Results Container -->
            <div id="progressResults" style="margin-top:20px;"></div>
        </div>

        <!-- MANAGEMENT PAGES -->
        <div id="management-page" class="container hidden">
            <div class="app-header"><div class="header-title">Ş†Ş°ŞŞ§ŞŞ° Ş‰Ş¬Ş‚Ş­Ş–Ş°Ş‰Ş¦Ş‚Ş°Ş“Ş°</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">â¬…</button></div>
            <div class="action-card" style="margin-top:20px; text-align:right;">
                <h4>Ş‡Ş§ Ş†Ş°ŞŞ§Ş€Ş¬Ş‡Ş° Ş€Ş¬Ş‹ŞªŞ‚Ş°</h4>
                <div style="display:flex; gap:10px; justify-content:center; max-width:600px; margin:0 auto;">
                    <input type="text" id="newClassName" class="form-input" placeholder="Ş†Ş°ŞŞ§Ş€ŞªŞŞ¬ Ş‚Ş¦Ş‚Ş°" style="margin:0; flex:1;">
                    <input type="text" id="newTeacherName" class="form-input" placeholder="Ş‡ŞªŞŞ°ŞŒŞ§Ş›Ş°" style="margin:0; flex:1;">
                    <button class="btn-primary" style="width:auto;" onclick="window.createClass()">Ş€Ş¦Ş‹Ş§</button>
                </div>
            </div>
            <h4 style="margin-top:20px;">Ş€Ş¬Ş‹Ş¨ŞŠŞ¦Ş‡Ş¨ŞˆŞ§ Ş†Ş°ŞŞ§ŞŞ°ŞŒŞ¦Ş‡Ş°</h4>
            <div id="manageClassList" class="grid-container"></div>
        </div>

        <div id="class-details-page" class="container hidden">
            <div class="app-header"><div class="header-title" id="manageHeaderName">Class</div><button class="icon-btn" onclick="window.openPage('management-page')">â¬…</button></div>
            <div class="grid-container">
                <div class="action-card">
                    <button class="big-btn" onclick="window.openAddStudentModal()"><span>â•</span> Ş‹Ş¦ŞƒŞ¨ŞˆŞ¦ŞƒŞªŞ‚Ş° Ş‡Ş¨ŞŒŞªŞƒŞªŞ†ŞªŞƒŞ­</button>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button class="big-btn btn-orange" onclick="window.downloadTemplate()"><span>ğŸ“¥</span> Ş“Ş¬Ş‰Ş°Ş•Ş°ŞŞ­Ş“Ş°</button>
                        <label class="big-btn btn-green" style="font-size:14px; margin:0; cursor:pointer;">ğŸ“‚ Ş‡Ş¦Ş•Ş°ŞŞ¯Ş‘Ş°<input type="file" hidden onchange="window.handleExcelUpload(this)"></label>
                    </div>
                </div>
            </div>
            <h4 style="margin-top:20px;">Ş‹Ş¦ŞƒŞ¨ŞˆŞ¦ŞƒŞªŞ‚Ş°ŞŞ¬ ŞŞ¨ŞŞ°Ş“Ş°</h4>
            <div id="studentManageList" class="grid-container"></div>
        </div>

        <!-- GRADING FLOW -->
        <div id="grading-class-page" class="container hidden">
            <div class="app-header"><div class="header-title">ŞŠŞ¨ŞŞ§ŞˆŞ¦Ş…Şª Ş‚Ş¬ŞŞªŞ‚Ş°</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">â¬…</button></div>
            <div id="gradingClassList" class="grid-container"></div>
        </div>
        <div id="grading-student-page" class="container hidden">
            <div class="app-header"><div class="header-title">Students</div><button class="icon-btn" onclick="window.openPage('grading-class-page')">â¬…</button></div>
            <div id="gradingStudentList" class="grid-container"></div>
        </div>
        <div id="grading-menu-page" class="container hidden">
            <div class="app-header"><div class="header-title" id="gradingStudentName">Student</div><button class="icon-btn" onclick="window.openPage('grading-student-page')">â¬…</button></div>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openCategoryPage('new_lesson')"><span class="menu-icon" style="color:var(--accent);">ğŸ“–</span><h4 class="card-title">Ş‡Ş§ ŞŠŞ¨ŞŞ§ŞˆŞ¦Ş…Şª</h4></div>
                <div class="menu-btn" onclick="window.openCategoryPage('short_rev')"><span class="menu-icon" style="color:var(--accent-rev);">ğŸ”„</span><h4 class="card-title">Ş†ŞªŞƒŞª Ş‰ŞªŞƒŞ§Ş–Ş¦Ş¢Ş§</h4></div>
                <div class="menu-btn" onclick="window.openCategoryPage('long_rev')"><span class="menu-icon" style="color:#8e44ad;">ğŸ“…</span><h4 class="card-title">Ş‹Ş¨ŞŞª Ş‰ŞªŞƒŞ§Ş–Ş¦Ş¢Ş§</h4></div>
                <div class="menu-btn" onclick="window.openJuzExamSetup()"><span class="menu-icon" style="color:#2980b9;">ğŸ“</span><h4 class="card-title">Ş–ŞªŞ’ŞªŞ‡Şª Ş‡Ş¨Ş‰Ş°ŞŒŞ¨Ş™Ş§Ş‚Ş°</h4></div>
                <div class="menu-btn" onclick="window.openCategoryPage('final_exam')"><span class="menu-icon" style="color:#c0392b;">ğŸ“</span><h4 class="card-title">ŞŠŞ¦Ş€Şª Ş‡Ş¨Ş‰Ş°ŞŒŞ¨Ş™Ş§Ş‚Ş°</h4></div>
            </div>
        </div>

        <!-- CATEGORY HISTORY PAGE -->
        <div id="category-page" class="container hidden">
            <div class="app-header">
                <div class="header-title" id="catPageTitle">Title</div>
                <button class="icon-btn" onclick="window.goBackFromCategory()">â¬…</button>
            </div>
            <div class="page-toolbar" style="background:white; padding:15px; border-radius:12px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:16px; font-weight:bold; color:var(--primary);">ŞƒŞ¬Ş†Ş¯Ş‘Ş°ŞŒŞ¦Ş‡Ş°</span>
                <button id="addRecordBtn" class="add-record-btn" onclick="window.handleAddButtonClick()">â•</button>
            </div>
            <div id="categoryHistoryList"></div>
        </div>

        <!-- UNIVERSAL RECORDER & VIEWER -->
        <div id="recorder-page" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000;">
            <div class="app-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="icon-btn" onclick="window.closeRecorder()">â¬…</button>
                    <span class="header-title" id="recorderTitle">ŞƒŞ¬Ş†Ş¯Ş‘Ş°</span>
                </div>
                <span id="viewModeBadge" style="background:#e74c3c; color:white; padding:2px 8px; border-radius:4px; font-size:12px; display:none;">View Mode</span>
            </div>
            <div class="layout-split">
                <div class="sidebar-panel">
                    <div style="margin-bottom:15px;"><label class="form-label">ŞŒŞ§ŞƒŞ©ŞšŞ°</label><input type="date" id="recDate" class="rec-input" style="text-align:center;"></div>
                    <div class="form-sec" style="border-top:3px solid var(--accent);">
                        <span class="sec-title">ŞŠŞ¦ŞŞ§ Ş€Ş¨ŞŞ§Ş„Şª</span>
                        <label>ŞŞ¦ŞŠŞ°Ş™Ş§</label><input type="number" id="startPage" class="rec-input" placeholder="Page (1-604)" onchange="window.handleStartPageChange()">
                        <div style="display:flex; gap:5px;"><div style="flex:1"><label>ŞŞ«ŞƒŞ¦ŞŒŞ°</label><select id="startSurah" class="rec-input"></select></div><div style="width:60px"><label>Ş‡Ş§Ş”Ş¦ŞŒŞ°</label><select id="startAyah" class="rec-input"></select></div></div>
                    </div>
                    <div class="form-sec" style="border-top:3px solid #e74c3c;">
                        <span class="sec-title">Ş‚Ş¨Ş‰Ş­ Ş€Ş¨ŞŞ§Ş„Şª</span>
                        <label>ŞŞ¦ŞŠŞ°Ş™Ş§</label><input type="number" id="endPage" class="rec-input" placeholder="Page">
                        <div style="display:flex; gap:5px;"><div style="flex:1"><label>ŞŞ«ŞƒŞ¦ŞŒŞ°</label><select id="endSurah" class="rec-input"></select></div><div style="width:60px"><label>Ş‡Ş§Ş”Ş¦ŞŒŞ°</label><select id="endAyah" class="rec-input"></select></div></div>
                    </div>
                    <div style="background:#fff5f5; padding:15px; border-radius:8px; text-align:center; margin-top:auto; border:1px solid #ffcccc;">
                        <span style="font-size:14px; color:red;">Ş†ŞªŞŞªŞŞ¬ Ş¢Ş¦Ş‹Ş¦Ş‹Şª</span><strong id="mistakeCountDisplay" style="font-size:32px; color:red; display:block;">0</strong>
                    </div>
                    <button id="recSaveBtn" class="big-btn" onclick="window.saveRecord()">ğŸ’¾ ŞŞ­ŞˆŞ°</button>
                </div>
                <div class="main-panel">
                    <div class="mushaf-top-bar" id="recMushafTopBar"><span id="recMushafJuz">Juz</span><span id="recMushafSurah">Surah</span></div>
                    <div class="mushaf-page"><div id="mushafContent" class="quran-text"><p style="color:#999; margin-top:100px;">ŞŞ¦ŞŠŞ°Ş™Ş§ Ş–Ş¦Ş‡Ş°ŞŞ¦ŞˆŞ§</p></div></div>
                    <div class="mushaf-nav">
                        <!-- Left Arrow (Next Page) moves forward, Right Arrow (Prev Page) moves back -->
                        <button class="nav-btn" onclick="window.changeRecPage(-1)">â¡</button>
                        <span id="recPageDisplay">Page</span>
                        <button class="nav-btn" onclick="window.changeRecPage(1)">â¬…</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- JUZ EXAM PAGE -->
        <div id="juz-exam-page" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000;">
            <div class="app-header">
                <div style="display:flex; align-items:center; gap:10px;"><button class="icon-btn" onclick="window.closeJuzExam()">â¬…</button><span class="header-title" id="juzExamTitle">Ş–ŞªŞ’ŞªŞ‡Şª Ş‡Ş¨Ş‰Ş°ŞŒŞ¨Ş™Ş§Ş‚Ş°</span></div>
                <div id="partBadge" style="background:#2c3e50; color:white; padding:5px 15px; border-radius:20px; font-size:12px;"></div>
            </div>
            <div class="layout-split">
                <div class="sidebar-panel">
                    <div class="score-header"><div class="big-score" id="liveScore">100%</div></div>
                    <div class="exam-section">
                        <div class="stopwatch-box"><span id="stopwatchDisplay">00:00:00</span><div style="font-size:12px;"><button onclick="window.startTimer()" style="border:none; color:green; background:none;">â–¶</button> <button onclick="window.stopTimer()" style="border:none; color:red; background:none;">â¹</button></div></div>
                    </div>
                    <div class="exam-section">
                        <div class="score-control"><span>Ş‡ŞªŞŞ°ŞŒŞ§Ş›Ş° (-2)</span><strong id="countTeacher" class="ctrl-val" style="color:var(--mistake);">0</strong></div>
                        <div class="score-control"><span>Ş‡Ş¦Ş‰Ş¨Ş‡Ş°ŞŞ¦Ş‡Ş¦ŞŞ° (-1)</span><div style="display:flex;gap:5px;"><button class="ctrl-btn btn-minus" onclick="window.updateScore('self',1)">+</button><span id="countSelf" class="ctrl-val">0</span><button class="ctrl-btn btn-plus" onclick="window.updateScore('self',-1)">-</button></div></div>
                        <div class="score-control"><span>ŞŒŞ¦Ş–ŞªŞˆŞ©Ş‹Şª (10)</span><input type="number" id="scoreTajweed" class="form-input" style="width:60px;" value="10" max="10" onchange="window.calcScore()"></div>
                        <div class="score-control"><span>ŞŠŞ¦ŞƒŞ¨ŞŒŞ¦Ş†Ş¦Ş‚Ş° (5)</span><input type="number" id="scoreFluency" class="form-input" style="width:60px;" value="5" max="5" onchange="window.calcScore()"></div>
                    </div>
                    <div class="exam-section" id="mutashabihSection">
                        <button class="big-btn btn-orange" style="padding:10px; font-size:14px;" onclick="window.generateQuestions()">ğŸ² Ş‰ŞªŞŒŞ¦ŞŞ§Ş„Ş¨Ş€Ş° ŞŞªŞˆŞ§ŞŞª</button>
                        <div id="questionList" style="margin:10px 0;"></div>
                        <div style="display:flex; justify-content:space-between;"><label>Q1 <input type="number" id="q1_score" value="2.5" max="2.5" style="width:50px;" onchange="window.calcScore()"></label><label>Q2 <input type="number" id="q2_score" value="2.5" max="2.5" style="width:50px;" onchange="window.calcScore()"></label></div>
                    </div>
                    <div style="padding:20px;"><button id="saveExamBtn" class="big-btn" onclick="window.saveJuzExamPart()">ğŸ’¾ ŞŞ­ŞˆŞ°</button></div>
                </div>
                <div class="main-panel">
                    <div class="mushaf-top-bar" id="mushafTopBar"><span id="mushafJuzInfo"></span><span id="mushafSurahInfo"></span></div>
                    <div class="mushaf-page"><div id="examMushafContent" class="quran-text"><p style="color:#999; margin-top:100px;">...</p></div></div>
                    <div class="mushaf-nav">
                        <button class="nav-btn" onclick="window.changeExamPage(-1)">â¡</button>
                        <span id="currentPageDisplay">Page</span>
                        <button class="nav-btn" onclick="window.changeExamPage(1)">â¬…</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FINAL EXAM PAGE -->
        <div id="final-exam-page" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000;">
            <div class="app-header"><button class="icon-btn" onclick="window.closeFinalExam()">â¬…</button><span class="header-title">ŞŠŞ¦Ş€Şª Ş‡Ş¨Ş‰Ş°ŞŒŞ¨Ş™Ş§Ş‚Ş°</span></div>
            <div class="layout-split">
                <div class="sidebar-panel">
                    <div class="score-header"><div class="big-score" id="finalExamScore">100%</div></div>
                    <div style="text-align:center; margin:10px 0; font-weight:bold;" id="questionIndicator">ŞŞªŞˆŞ§ŞŞª 1 / 3</div>
                    <label class="form-label">Ş–ŞªŞ’ŞªŞ‡Şª Ş‚Ş¦Ş‚Ş°ŞŞ¦ŞˆŞ§</label><select id="finalJuzSelect" class="form-input"></select>
                    <button class="big-btn btn-orange" style="padding:10px; font-size:14px; margin-top:5px;" onclick="window.loadFinalQuestion()">ŞŞªŞˆŞ§ŞŞª ŞŠŞ¦ŞŞ§</button>
                    <div style="margin-top:20px;">
                        <div class="score-control"><span>ŞƒŞ¦Ş‚ŞŞ¦Ş…ŞªŞ†Ş®ŞŞ°Ş‹Ş¨Ş‚Ş° (-5)</span><strong id="finalTeacherCount" style="color:var(--mistake);">0</strong></div>
                        <div class="score-control"><span>Ş‡Ş¦Ş‰Ş¨Ş‡Ş°ŞŞ¦Ş‡Ş¦ŞŞ° (-2)</span><div style="display:flex;gap:5px;"><button class="ctrl-btn btn-minus" onclick="window.updateFinalScore('self',1)">+</button><span id="finalSelfCount" class="ctrl-val">0</span><button class="ctrl-btn btn-plus" onclick="window.updateFinalScore('self',-1)">-</button></div></div>
                    </div>
                    <div style="padding:20px; margin-top:auto;"><button id="nextQBtn" class="big-btn" onclick="window.nextFinalQuestion()">Ş‹Ş¬Ş‚Ş°Ş–Ş¬Ş€Ş­ ŞŞªŞˆŞ§ŞŞª â¡</button><button id="finishExamBtn" class="big-btn btn-green hidden" onclick="window.saveFinalExam()">Ş‚Ş¨Ş‚Ş°Ş‰Ş§ ğŸ’¾</button></div>
                </div>
                <div class="main-panel"><div class="mushaf-page"><div id="finalMushafContent" class="quran-text">...</div></div></div>
            </div>
        </div>

        <!-- STUDENT DASHBOARD -->
        <div id="student-dashboard" class="container hidden">
            <div class="app-header"><div class="header-title">Ş‹Ş¦ŞƒŞ¨ŞˆŞ¦ŞƒŞª Ş•Ş¬Ş‚Ş¦ŞŞ°</div><button class="icon-btn logout-btn" onclick="window.logout()">â»</button></div>
            <div style="background:white; padding:30px; border-radius:15px; text-align:center; margin-bottom:20px;">
                <h2 style="color:var(--st-primary);">Ş‰Ş¦ŞƒŞªŞ™Ş¦Ş„Ş§!</h2>
                <h3 id="studentDashName"></h3>
            </div>
            
            <!-- PROGRESS STAT BAR -->
            <div class="student-stat-container">
                <div class="st-stat-item">
                    <div class="st-stat-val st-color-1" id="studentSemPages">0</div>
                    <div class="st-stat-lbl">Ş‰Ş¨ ŞŞ¬Ş‰Ş¨ŞŞ°Ş“Ş¦Şƒ<br>(ŞŞ¦ŞŠŞ°Ş™Ş§)</div>
                </div>
                <div class="st-stat-item">
                    <div class="st-stat-val st-color-2" id="studentSemJuz">0</div>
                    <div class="st-stat-lbl">Ş‰Ş¨ ŞŞ¬Ş‰Ş¨ŞŞ°Ş“Ş¦Şƒ<br>(Ş–ŞªŞ’ŞªŞ‡Şª)</div>
                </div>
                <div class="st-stat-item">
                    <div class="st-stat-val st-color-3" id="studentTotalJuz">0</div>
                    <div class="st-stat-lbl">Ş–ŞªŞ‰Ş°ŞŞ¦ Ş™Ş¨ŞŠŞ°Ş¡Ş°<br>(Ş–ŞªŞ’ŞªŞ‡Şª)</div>
                </div>
            </div>

            <button class="big-btn" onclick="window.openBulkEntryModal()" style="margin-bottom:20px; background:var(--st-primary);">ğŸ“œ Ş†ŞªŞƒŞ©ŞŞ¬ Ş‘Ş­Ş“Ş§ Ş‡Ş¬Ş‚Ş°Ş“Ş¦ŞƒŞ†ŞªŞƒŞªŞ‚Ş°</button>

            <div class="grid-container">
                <div class="card-btn" onclick="window.openCategoryPage('new_lesson')"><span class="card-icon" style="color:var(--accent);">ğŸ“–</span><h4 class="card-title">Ş‡Ş§ ŞŠŞ¨ŞŞ§ŞˆŞ¦Ş…Şª</h4></div>
                <div class="card-btn" onclick="window.openCategoryPage('short_rev')"><span class="card-icon" style="color:var(--accent-rev);">ğŸ”„</span><h4 class="card-title">Ş†ŞªŞƒŞª Ş‰ŞªŞƒŞ§Ş–Ş¦Ş¢Ş§</h4></div>
                <div class="card-btn" onclick="window.openCategoryPage('long_rev')"><span class="card-icon" style="color:#8e44ad;">ğŸ“…</span><h4 class="card-title">Ş‹Ş¨ŞŞª Ş‰ŞªŞƒŞ§Ş–Ş¦Ş¢Ş§</h4></div>
                <div class="card-btn" onclick="window.openCategoryPage('juz_exam')"><span class="card-icon" style="color:#2980b9;">ğŸ“</span><h4 class="card-title">Ş–ŞªŞ’ŞªŞ‡Şª Ş‡Ş¨Ş‰Ş°ŞŒŞ¨Ş™Ş§Ş‚Ş°</h4></div>
                <div class="card-btn" onclick="window.openCategoryPage('final_exam')"><span class="card-icon" style="color:#c0392b;">ğŸ“</span><h4 class="card-title">ŞŠŞ¦Ş€Şª Ş‡Ş¨Ş‰Ş°ŞŒŞ¨Ş™Ş§Ş‚Ş°</h4></div>
            </div>
        </div>

    </div>

    <!-- MODALS -->
    <!-- PASSWORD CREATION MODAL (SHARED) -->
    <div id="createPassModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3 style="color:var(--primary);">Ş•Ş§ŞŞ°ŞˆŞ¯Ş‘Ş° Ş€Ş¦Ş‡Ş°Ş‹Ş¦ŞˆŞ§</h3>
            <p id="passModalUserText" style="color:#777; margin-bottom:10px;"></p>
            <input type="password" id="newStuPass" class="form-input" placeholder="Ş‡Ş§ Ş•Ş§ŞŞ°ŞˆŞ¯Ş‘Ş°">
            <button class="big-btn" onclick="window.saveNewPassword()">ŞŞ­ŞˆŞ° & ŞŞ®ŞŞ¨Ş‚Ş°</button>
        </div>
    </div>
    
    <!-- ADD/EDIT STUDENT MODAL -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:20px; color:var(--primary);">Ş‹Ş¦ŞƒŞ¨ŞˆŞ¦ŞƒŞ¦Ş†Şª Ş‡Ş¨ŞŒŞªŞƒŞªŞ†ŞªŞƒŞªŞ‚Ş°/Ş‡Ş¬Ş‘Ş¨Ş“Ş°Ş†ŞªŞƒŞªŞ‚Ş°</h3>
            <div class="form-grid">
                <div class="full-span"><label class="form-label">Ş†Ş¯ŞŞ° Ş‰Ş®Ş‘Ş¨Ş‡ŞªŞŞ°</label><input type="text" id="m_module" class="form-input"></div>
                <div><label class="form-label">Ş‡Ş¦Ş‡Ş¨Ş‘Ş©</label><input type="text" id="m_id" class="form-input"></div>
                <div><label class="form-label">Ş‚Ş¦Ş‚Ş°</label><input type="text" id="m_name" class="form-input"></div>
                <div><label class="form-label">ŞŞ¬ŞˆŞ¬ŞŞ°</label><select id="m_level" class="form-input"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
                <div><label class="form-label">Ş†Ş¨Ş”Ş¦ŞˆŞ§ ŞŞ®ŞŒŞ°</label><select id="m_direction" class="form-input"><option value="top_down">Ş‰Ş¦ŞŒŞ¨Ş‚Ş° ŞŒŞ¨ŞƒŞ¨Ş‡Ş¦ŞŞ°</option><option value="bottom_up">ŞŒŞ¨ŞƒŞ¨Ş‚Ş° Ş‰Ş¦ŞŒŞ¨Ş‡Ş¦ŞŞ°</option></select></div>
                <div class="full-span"><label class="form-label">Ş‹Ş¦ŞŞ°ŞˆŞ¬ŞŠŞ¦Ş‡Ş¨ŞˆŞ§ Ş–ŞªŞ’ŞªŞ‡Şª</label><input type="text" id="m_juz_count" class="form-input"></div>
                <div class="full-span"><label class="form-label">Ş‡Ş¨ŞŒŞªŞƒŞª Ş‰Ş¦Ş¢ŞªŞŞ«Ş‰Ş§ŞŒŞª</label><input type="text" id="m_remarks" class="form-input"></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button id="btnSaveStudent" class="big-btn" onclick="window.confirmAddStudent()">ŞŞ­ŞˆŞ°</button>
                <button class="big-btn btn-orange" onclick="document.getElementById('addStudentModal').style.display='none'">Ş†Ş¬Ş‚Ş°ŞŞ¦ŞŞ°</button>
            </div>
        </div>
    </div>
    
    <div id="juzSetupModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3>Ş–ŞªŞ’ŞªŞ‡Şª Ş‡Ş¨Ş‰Ş°ŞŒŞ¨Ş™Ş§Ş‚Ş°</h3>
            <select id="examJuzSelect" class="form-input"></select>
            <div style="text-align:right; margin:15px 0;"><label><input type="radio" name="examPart" value="full" checked> ŞŠŞ®ŞŒŞ° Ş‡Ş¬Ş‡Ş°Ş†Ş®ŞŞ°</label><br><label><input type="radio" name="examPart" value="part1"> ŞŠŞªŞƒŞ¦ŞŒŞ¦Ş‰Ş¦ Ş„Ş¦Ş‡Ş¨ (1/2)</label><br><label><input type="radio" name="examPart" value="part2"> ŞŠŞ¦Ş€Şª Ş„Ş¦Ş‡Ş¨ (2/2)</label></div>
            <button class="big-btn" onclick="window.startJuzExam()">ŞŠŞ¦ŞŞ§</button>
        </div>
    </div>

    <!-- BULK ENTRY MODAL -->
    <div id="bulkEntryModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary); text-align:center;">Ş†ŞªŞƒŞ©ŞŞ¬ Ş‘Ş­Ş“Ş§ Ş‡Ş¬Ş‚Ş°Ş“Ş¦ŞƒŞ†ŞªŞƒŞªŞ‚Ş°</h3>
            <div class="form-grid">
                <div class="full-span">
                    <label class="form-label" style="color:var(--accent);">Ş†ŞªŞƒŞ© ŞŞ¬Ş‰Ş¨ŞŞ°Ş“Ş¦ŞƒŞŞ¦Ş‡Ş¨ Ş†Ş¨Ş”Ş¬ŞˆŞ¨ Ş–ŞªŞ’ŞªŞ‡Şª Ş‡Ş¦Ş‹Ş¦Ş‹Şª</label>
                    <input type="number" id="prevSemJuz" class="form-input" placeholder="Ş‰Ş¨ŞŞ§ŞŞª: 2">
                </div>
            </div>
            <p style="text-align:center; color:#777; font-size:12px; margin-top:10px;">Ş‰Ş¨ ŞŞ¬Ş‰Ş¨ŞŞ°Ş“Ş¦ŞƒŞŞ¦Ş‡Ş¨ Ş†Ş¨Ş”Ş¦ŞˆŞ¦Ş‡Ş¨Ş‹Ş¬ŞˆŞªŞ‚Şª Ş„Ş¦Ş‡Ş¨ŞŒŞ¦Ş‡Ş°</p>
            <div id="bulkEntriesList" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
            
            <button class="big-btn btn-orange" onclick="window.addBulkRow()">+ Ş‡Ş§ ŞƒŞ¯Ş‡Ş¬Ş‡Ş° Ş‡Ş¨ŞŒŞªŞƒŞªŞ†ŞªŞƒŞ­</button>
            <div style="display:flex; gap:10px;">
                <button class="big-btn" onclick="window.saveBulkData()">ŞŠŞ®Ş‚ŞªŞˆŞ§</button>
                <button class="big-btn btn-red" onclick="document.getElementById('bulkEntryModal').style.display='none'">Ş†Ş¬Ş‚Ş°ŞŞ¦ŞŞ°</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
            authDomain: "hifz-cde3b.firebaseapp.com",
            databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
            projectId: "hifz-cde3b",
            storageBucket: "hifz-cde3b.firebasestorage.app",
            messagingSenderId: "566754658580",
            appId: "1:566754658580:web:d63d0f167960f53bab9a01"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // GLOBALS
        const SURAH_NAMES_AR = ["Ø§Ù„ÙØ§ØªØ­Ø©", "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", "Ø§Ù„Ø£Ø¹Ø±Ø§Ù", "Ø§Ù„Ø£Ù†ÙØ§Ù„", "Ø§Ù„ØªÙˆØ¨Ø©", "ÙŠÙˆÙ†Ø³", "Ù‡ÙˆØ¯", "ÙŠÙˆØ³Ù", "Ø§Ù„Ø±Ø¹Ø¯", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ø§Ù„Ø­Ø¬Ø±", "Ø§Ù„Ù†Ø­Ù„", "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", "Ø§Ù„ÙƒÙ‡Ù", "Ù…Ø±ÙŠÙ…", "Ø·Ù‡", "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", "Ø§Ù„Ø­Ø¬", "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", "Ø§Ù„Ù†ÙˆØ±", "Ø§Ù„ÙØ±Ù‚Ø§Ù†", "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", "Ø§Ù„Ù†Ù…Ù„", "Ø§Ù„Ù‚ØµØµ", "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", "Ø§Ù„Ø±ÙˆÙ…", "Ù„Ù‚Ù…Ø§Ù†", "Ø§Ù„Ø³Ø¬Ø¯Ø©", "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", "Ø³Ø¨Ø£", "ÙØ§Ø·Ø±", "ÙŠØ³", "Ø§Ù„ØµØ§ÙØ§Øª", "Øµ", "Ø§Ù„Ø²Ù…Ø±", "ØºØ§ÙØ±", "ÙØµÙ„Øª", "Ø§Ù„Ø´ÙˆØ±Ù‰", "Ø§Ù„Ø²Ø®Ø±Ù", "Ø§Ù„Ø¯Ø®Ø§Ù†", "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", "Ø§Ù„Ø£Ø­Ù‚Ø§Ù", "Ù…Ø­Ù…Ø¯", "Ø§Ù„ÙØªØ­", "Ø§Ù„Ø­Ø¬Ø±Ø§Øª", "Ù‚", "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", "Ø§Ù„Ø·ÙˆØ±", "Ø§Ù„Ù†Ø¬Ù…", "Ø§Ù„Ù‚Ù…Ø±", "Ø§Ù„Ø±Ø­Ù…Ù†", "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", "Ø§Ù„Ø­Ø¯ÙŠØ¯", "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", "Ø§Ù„Ø­Ø´Ø±", "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", "Ø§Ù„ØµÙ", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", "Ø§Ù„ØªØºØ§Ø¨Ù†", "Ø§Ù„Ø·Ù„Ø§Ù‚", "Ø§Ù„ØªØ­Ø±ÙŠÙ…", "Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ù‚Ù„Ù…", "Ø§Ù„Ø­Ø§Ù‚Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", "Ù†ÙˆØ­", "Ø§Ù„Ø¬Ù†", "Ø§Ù„Ù…Ø²Ù…Ù„", "Ø§Ù„Ù…Ø¯Ø«Ø±", "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", "Ø§Ù„Ù†Ø¨Ø£", "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", "Ø¹Ø¨Ø³", "Ø§Ù„ØªÙƒÙˆÙŠØ±", "Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø±", "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", "Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚", "Ø§Ù„Ø¨Ø±ÙˆØ¬", "Ø§Ù„Ø·Ø§Ø±Ù‚", "Ø§Ù„Ø£Ø¹Ù„Ù‰", "Ø§Ù„ØºØ§Ø´ÙŠØ©", "Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¨Ù„Ø¯", "Ø§Ù„Ø´Ù…Ø³", "Ø§Ù„Ù„ÙŠÙ„", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„Ø´Ø±Ø­", "Ø§Ù„ØªÙŠÙ†", "Ø§Ù„Ø¹Ù„Ù‚", "Ø§Ù„Ù‚Ø¯Ø±", "Ø§Ù„Ø¨ÙŠÙ†Ø©", "Ø§Ù„Ø²Ù„Ø²Ù„Ø©", "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", "Ø§Ù„ØªÙƒØ§Ø«Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù‡Ù…Ø²Ø©", "Ø§Ù„ÙÙŠÙ„", "Ù‚Ø±ÙŠØ´", "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", "Ø§Ù„ÙƒÙˆØ«Ø±", "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", "Ø§Ù„Ù†ØµØ±", "Ø§Ù„Ù…Ø³Ø¯", "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", "Ø§Ù„ÙÙ„Ù‚", "Ø§Ù„Ù†Ø§Ø³"];
        
        // Ayah Counts
        const AYAH_COUNTS = [7, 286, 200, 176, 120, 165, 206, 75, 129, 109, 123, 111, 43, 52, 99, 128, 111, 110, 98, 135, 112, 78, 118, 64, 77, 227, 93, 88, 69, 60, 34, 30, 73, 54, 45, 83, 182, 88, 75, 85, 54, 53, 89, 59, 37, 35, 38, 29, 18, 45, 60, 49, 62, 55, 78, 96, 29, 22, 24, 13, 14, 11, 11, 18, 12, 12, 30, 52, 52, 44, 28, 28, 20, 56, 40, 31, 50, 40, 46, 42, 29, 19, 36, 25, 22, 17, 19, 26, 30, 20, 15, 21, 11, 8, 8, 19, 5, 8, 8, 11, 11, 8, 3, 9, 5, 4, 7, 3, 6, 3, 5, 4, 5, 6];

        let classesData = [];
        let hifzUsers = [];
        let semesters = [];
        let currentClassIdx = -1, currentStudentIdx = -1;
        let currentUserType = 'teacher';
        let currentUserRole = 'teacher';
        let currentStudentObj = null;
        let currentSessionType = '';
        let examState = {}, finalExamState = {};
        let currentMistakes = [];
        let isViewMode = false;
        let editingRecordIndex = -1;
        let editingStudentIndex = -1;
        
        let currentRecViewPage = 1; // Tracks what page is SHOWN in recorder

        let pendingUserIndex = -1; // For teacher pass reset

        // LOAD DATA
        const dbRef = ref(db, 'hifz_system_v1');
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            classesData = data && data.classes ? data.classes : [];
            hifzUsers = data && data.users ? data.users : [];
            semesters = data && data.semesters ? data.semesters : [];
            
            if(hifzUsers.length === 0) {
                hifzUsers.push({username:'admin', password:'1234', role:'admin', name:'Administrator'});
                updateFirebase();
            }

            if(document.getElementById('management-page').classList.contains('hidden') === false) window.renderManageClassList();
            if(document.getElementById('teacher-mgmt-page').classList.contains('hidden') === false) window.renderTeacherList();
            if(document.getElementById('progress-page').classList.contains('hidden') === false) window.renderSemesterList();
            if(document.getElementById('progress-page').classList.contains('hidden') === false) window.renderPendingApprovals();
            if(document.getElementById('class-details-page').classList.contains('hidden') === false) window.renderStudentList();
        });

        function updateFirebase() { 
            set(ref(db, 'hifz_system_v1'), { classes: classesData, users: hifzUsers, semesters: semesters }); 
        }

        // --- GLOBAL FUNCTIONS ---
        window.switchLogin = (type) => {
            document.getElementById('teacher-login-form').classList.toggle('hidden', type !== 'teacher');
            document.getElementById('student-login-form').classList.toggle('hidden', type !== 'student');
            document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', (type==='teacher' && i===0) || (type==='student' && i===1)));
        };
        
        window.loginTeacher = () => {
            const u = document.getElementById('teacherUsername').value;
            const p = document.getElementById('teacherPassInput').value;
            
            // Hardcoded fallback for first run
            if(p === '1234' && (u === 'admin' || u === '')) {
                 currentUserType = 'teacher'; currentUserRole = 'admin';
                 document.body.classList.remove('student-mode');
                 document.getElementById('login-screen').classList.add('hidden');
                 document.getElementById('app-container').classList.remove('hidden');
                 document.getElementById('admin-panel-btn').classList.remove('hidden');
                 window.openPage('teacher-dashboard');
                 return;
            }

            const userIndex = hifzUsers.findIndex(user => user.username === u);
            const user = hifzUsers[userIndex];
            
            if(user) {
                // Check if password reset is needed (empty string)
                if(user.password === "" || (!user.password && user.role !=='admin')) {
                    pendingUserIndex = userIndex;
                    currentUserType = 'teacher';
                    document.getElementById('passModalUserText').innerText = `Ş‰ŞªŞ‹Ş¦Ş‡Ş°ŞƒŞ¨ŞŞ°: ${user.name}`;
                    document.getElementById('createPassModal').style.display = 'flex';
                    return;
                }

                if(user.password === p) {
                    currentUserType = 'teacher';
                    currentUserRole = user.role;
                    document.body.classList.remove('student-mode');
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    if(currentUserRole === 'admin') document.getElementById('admin-panel-btn').classList.remove('hidden');
                    else document.getElementById('admin-panel-btn').classList.add('hidden');
                    window.openPage('teacher-dashboard');
                } else {
                    alert('Ş•Ş§ŞŞ°ŞˆŞ¯Ş‘Ş° Ş‚ŞªŞ„Ş¦Ş‡Ş¨');
                }
            } else {
                alert('Ş‚Ş¦Ş‰Ş§Ş‡Ş¨ Ş•Ş§ŞŞ°ŞˆŞ¯Ş‘Ş° Ş‹Ş¨Ş‰Ş¦Ş‡Ş¬Ş‡Ş°Ş‚ŞªŞˆŞ­');
            }
        };

        window.handleStudentLoginStep = () => {
            const id = document.getElementById('stuIdInput').value.trim();
            if(!id) return alert("ID Required");
            let found = null, cIdx = -1, sIdx = -1;
            if(classesData) classesData.forEach((c, ci) => { if(c.students) c.students.forEach((s, si) => { if(s.id === id) { found=s; cIdx=ci; sIdx=si; } }); });
            if(!found) return alert("Not Found");
            currentClassIdx = cIdx; currentStudentIdx = sIdx; currentStudentObj = found;
            
            // Check for empty password for reset/first-time
            if(!found.password || found.password === "") {
                currentUserType = 'student';
                document.getElementById('passModalUserText').innerText = `Ş‹Ş¦ŞƒŞ¨ŞˆŞ¦ŞƒŞª: ${found.name}`;
                document.getElementById('createPassModal').style.display = 'flex';
            } else {
                const passField = document.getElementById('stuPassField');
                if(passField.classList.contains('hidden')) passField.classList.remove('hidden');
                else {
                    if(document.getElementById('stuPassInput').value === found.password) window.loginSuccessStudent();
                    else alert("Wrong Password");
                }
            }
        };

        window.saveNewPassword = () => {
            const pass = document.getElementById('newStuPass').value;
            if(!pass) return alert("Enter a password");
            
            if(currentUserType === 'student') {
                classesData[currentClassIdx].students[currentStudentIdx].password = pass; 
                updateFirebase(); 
                document.getElementById('createPassModal').style.display='none'; 
                window.loginSuccessStudent();
            } else if (currentUserType === 'teacher') {
                if(pendingUserIndex > -1) {
                    hifzUsers[pendingUserIndex].password = pass;
                    updateFirebase();
                    document.getElementById('createPassModal').style.display='none';
                    // Auto login after set
                    document.getElementById('teacherPassInput').value = pass;
                    window.loginTeacher();
                }
            }
        };

        window.loginSuccessStudent = () => {
            currentUserType = 'student';
            document.body.classList.add('student-mode');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('studentDashName').innerText = currentStudentObj.name;
            window.calculateStudentProgress(currentStudentObj);
            window.openPage('student-dashboard');
        };
        window.logout = () => location.reload();
        
        window.openPage = (id) => {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            ['juz-exam-page', 'final-exam-page', 'recorder-page', 'teacher-mgmt-page'].forEach(p => {
                const el = document.getElementById(p);
                if(el) el.classList.add('hidden');
            });
            const p = document.getElementById(id);
            if(p) {
                p.classList.remove('hidden');
                if(id === 'management-page') window.renderManageClassList();
                if(id === 'teacher-mgmt-page') window.renderTeacherList();
                if(id === 'progress-page') { window.renderSemesterList(); window.renderPendingApprovals(); }
            }
        };
        window.goBackFromCategory = () => { if(currentUserType === 'student') window.openPage('student-dashboard'); else window.openPage('grading-menu-page'); };

        // --- TEACHER MANAGEMENT ---
        window.openTeacherManagement = () => window.openPage('teacher-mgmt-page');
        window.createTeacher = () => {
            const name = document.getElementById('newTeachName').value;
            const user = document.getElementById('newTeachUser').value;
            const pass = document.getElementById('newTeachPass').value;
            if(name && user && pass) {
                hifzUsers.push({name:name, username:user, password:pass, role:'teacher'});
                updateFirebase(); window.renderTeacherList();
                document.getElementById('newTeachName').value=''; document.getElementById('newTeachUser').value=''; document.getElementById('newTeachPass').value='';
            }
        };
        window.renderTeacherList = () => {
            const div = document.getElementById('teacherList'); div.innerHTML='';
            hifzUsers.forEach((u, i) => {
                if(u.role !== 'admin') {
                    div.innerHTML += `
                        <div class="card-btn" style="min-height:100px; position:relative;">
                            <h4>${u.name}</h4>
                            <span style="font-size:12px;color:#777;">User: ${u.username}</span>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="btn-action-sm" onclick="window.resetTeacherPass(${i})" style="position:static; background:#fff3cd; color:#856404;" title="Reset Password">ğŸ”‘</button>
                                <button class="btn-action-sm btn-delete-hist" onclick="window.deleteTeacher(${i})" style="position:static;">ğŸ—‘</button>
                            </div>
                        </div>`;
                }
            });
        };
        window.resetTeacherPass = (i) => {
            if(confirm("Reset this teacher's password? They will set a new one on next login.")) {
                hifzUsers[i].password = "";
                updateFirebase();
                alert("Password reset. Teacher must create new password on login.");
            }
        };
        window.deleteTeacher = (i) => { if(confirm("Delete?")) { hifzUsers.splice(i, 1); updateFirebase(); window.renderTeacherList(); } };

        // --- MGMT ---
        window.createClass = () => {
            let name = document.getElementById('newClassName').value;
            let teacher = document.getElementById('newTeacherName').value;
            if(name) { classesData.push({name:name, teacher:teacher, students:[]}); updateFirebase(); window.renderManageClassList(); }
        };
        window.renderManageClassList = () => {
            const div = document.getElementById('manageClassList'); div.innerHTML='';
            if(classesData) classesData.forEach((c, i) => {
                div.innerHTML += `
                <div class="card-btn" onclick="window.openClass(${i})" style="position:relative;">
                    <span class="card-icon">ğŸ«</span><h4 class="card-title">${c.name}</h4><span class="card-sub">${c.teacher||''}</span>
                    <div class="class-actions">
                        <button class="cls-act-btn btn-edit-cls" onclick="event.stopPropagation(); window.editClass(${i})">âœï¸</button>
                        <button class="cls-act-btn btn-del-cls" onclick="event.stopPropagation(); window.deleteClass(${i})">ğŸ—‘</button>
                    </div>
                </div>`;
            });
        };
        window.editClass = (i) => {
            let name = prompt("New Name:", classesData[i].name);
            let teach = prompt("New Teacher:", classesData[i].teacher);
            if(name) { classesData[i].name = name; classesData[i].teacher = teach; updateFirebase(); window.renderManageClassList(); }
        };
        window.deleteClass = (i) => {
            if(confirm("Delete?")) { classesData.splice(i, 1); updateFirebase(); window.renderManageClassList(); }
        };
        window.openClass = (i) => { currentClassIdx = i; window.renderStudentList(); window.openPage('class-details-page'); };
        
        window.renderStudentList = () => {
            const div = document.getElementById('studentManageList'); div.innerHTML='';
            const students = classesData[currentClassIdx].students || [];
            if(students.length === 0) div.innerHTML = "<p style='text-align:center; color:#999'>No students yet.</p>";
            
            students.forEach((s, idx) => {
                let pass = (s.password && s.password.length > 0) ? `<span style="color:green">Pass Set</span>` : `<span style="color:red; font-weight:bold;">No Pass</span>`;
                let dirText = s.direction === 'bottom_up' ? 'ŞŒŞ¨ŞƒŞ¨Ş‚Ş° Ş‰Ş¦ŞŒŞ¨Ş‡Ş¦ŞŞ°' : 'Ş‰Ş¦ŞŒŞ¨Ş‚Ş° ŞŒŞ¨ŞƒŞ¨Ş‡Ş¦ŞŞ°';
                
                div.innerHTML += `
                    <div class="student-detail-card">
                        <div class="st-card-header">
                            <div class="st-name">${s.name}</div>
                            <div class="st-id">${s.id}</div>
                        </div>
                        <div class="st-info-grid">
                            <div class="st-info-item"><span class="st-info-label">Module:</span> <b>${s.module || '-'}</b></div>
                            <div class="st-info-item"><span class="st-info-label">Level:</span> <b>${s.level || '-'}</b></div>
                            <div class="st-info-item"><span class="st-info-label">Direction:</span> <b>${dirText}</b></div>
                            <div class="st-info-item"><span class="st-info-label">Hifz Juz:</span> <b>${s.juzCount || '-'}</b></div>
                        </div>
                        <div class="st-remarks-box">${s.remarks || 'No remarks'}</div>
                        <div class="st-footer-actions">
                            <div style="font-size:12px;">${pass}</div>
                            <div class="student-actions" style="position:static;">
                                 <button class="btn-action-sm btn-edit" style="background:#fff3cd; color:#856404;" title="Reset Password" onclick="event.stopPropagation(); window.resetPass(${idx})">ğŸ”‘</button>
                                <button class="btn-action-sm btn-edit" onclick="event.stopPropagation(); window.openEditStudentModal(${idx})">âœï¸</button>
                                <button class="btn-action-sm btn-del" onclick="event.stopPropagation(); window.deleteStudent(${idx})">ğŸ—‘</button>
                            </div>
                        </div>
                    </div>`;
            });
        };
        
        window.resetPass = (idx) => {
            if(confirm("Reset password? Student will need to create new one on next login.")) {
                classesData[currentClassIdx].students[idx].password = "";
                updateFirebase(); 
                window.renderStudentList();
            }
        }

        // STUDENT EDITING
        window.openAddStudentModal = () => { 
            editingStudentIndex = -1;
            ['m_module','m_id','m_name','m_juz_count','m_remarks'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('btnSaveStudent').innerText = "ŞŞ­ŞˆŞ°";
            document.getElementById('addStudentModal').style.display='flex'; 
        }
        window.openEditStudentModal = (idx) => {
            editingStudentIndex = idx;
            const s = classesData[currentClassIdx].students[idx];
            document.getElementById('m_module').value = s.module || '';
            document.getElementById('m_id').value = s.id;
            document.getElementById('m_name').value = s.name;
            document.getElementById('m_level').value = s.level || '1';
            document.getElementById('m_direction').value = s.direction || 'top_down';
            document.getElementById('m_juz_count').value = s.juzCount || '';
            document.getElementById('m_remarks').value = s.remarks || '';
            document.getElementById('btnSaveStudent').innerText = "Ş‡Ş¦Ş•Ş°Ş‘Ş­Ş“Ş°";
            document.getElementById('addStudentModal').style.display='flex';
        }
        
        window.confirmAddStudent = () => {
            const name = document.getElementById('m_name').value;
            const id = document.getElementById('m_id').value;
            if(!name || !id) return alert("Name & ID Required");

            if(!classesData[currentClassIdx].students) classesData[currentClassIdx].students = [];

            if(editingStudentIndex > -1) {
                // UPDATE EXISTING STUDENT - PRESERVE DATA
                let s = classesData[currentClassIdx].students[editingStudentIndex];
                s.name = name;
                s.id = id;
                s.module = document.getElementById('m_module').value;
                s.level = document.getElementById('m_level').value;
                s.direction = document.getElementById('m_direction').value;
                s.juzCount = document.getElementById('m_juz_count').value;
                s.remarks = document.getElementById('m_remarks').value;
                // history, password, pendingData are NOT touched, so they are preserved
            } else {
                // CREATE NEW STUDENT
                const studentObj = {
                    name: name, id: id,
                    module: document.getElementById('m_module').value,
                    level: document.getElementById('m_level').value,
                    direction: document.getElementById('m_direction').value,
                    juzCount: document.getElementById('m_juz_count').value,
                    remarks: document.getElementById('m_remarks').value,
                    history: [],
                    juzExams: {},
                    pendingData: [],
                    password: "" // Start with empty password
                };
                classesData[currentClassIdx].students.push(studentObj);
            }

            updateFirebase(); 
            document.getElementById('addStudentModal').style.display='none'; 
            window.renderStudentList();
        }
        window.deleteStudent = (idx) => {
            if(confirm("Delete Student?")) {
                classesData[currentClassIdx].students.splice(idx, 1);
                updateFirebase(); window.renderStudentList();
            }
        }
        window.downloadTemplate = () => {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([["Name", "ID", "Module", "Level", "Direction", "Juz Count", "Remarks"]]);
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "Student_Template.xlsx");
        };
        window.handleExcelUpload = (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if(!classesData[currentClassIdx].students) classesData[currentClassIdx].students = [];
                jsonData.forEach(row => {
                    const name = row['Name'] || row['Student Name'];
                    const id = row['ID'] || row['Student ID'];
                    if(name && id) {
                        classesData[currentClassIdx].students.push({
                            name: name, id: id,
                            module: row['Module']||'', level: row['Level']||'1', direction: row['Direction']||'top_down',
                            juzCount: row['Juz Count']||'', remarks: row['Remarks']||'', history: [], juzExams: {}, pendingData: []
                        });
                    }
                });
                updateFirebase(); window.renderStudentList(); alert("Uploaded!");
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        };

        // --- GRADING ---
        window.openGradingClassList = () => {
            const div = document.getElementById('gradingClassList'); div.innerHTML='';
            if(classesData) classesData.forEach((c, i) => div.innerHTML += `<div class="card-btn" onclick="window.openGradingStudentList(${i})"><h4 class="card-title">${c.name}</h4></div>`);
            window.openPage('grading-class-page');
        }
        window.openGradingStudentList = (i) => {
            currentClassIdx = i;
            const div = document.getElementById('gradingStudentList'); div.innerHTML='';
            const students = classesData[i].students || [];
            students.forEach((s, idx) => div.innerHTML += `<div class="card-btn" onclick="window.openStudentMenu(${idx})"><h4 class="card-title">${s.name}</h4></div>`);
            window.openPage('grading-student-page');
        }
        window.openStudentMenu = (i) => {
            currentStudentIdx = i;
            document.getElementById('gradingStudentName').innerText = classesData[currentClassIdx].students[i].name;
            window.openPage('grading-menu-page');
        }

        window.openCategoryPage = (type) => {
            currentSessionType = type;
            let title = type === 'juz_exam' ? "Ş–ŞªŞ’ŞªŞ‡Şª Ş‡Ş¨Ş‰Ş°ŞŒŞ¨Ş™Ş§Ş‚Ş°" : (type === 'new_lesson' ? "Ş‡Ş§ ŞŠŞ¨ŞŞ§ŞˆŞ¦Ş…Şª" : (type==='final_exam'?"ŞŠŞ¦Ş€Şª Ş‡Ş¨Ş‰Ş°ŞŒŞ¨Ş™Ş§Ş‚Ş°":"Ş‰ŞªŞƒŞ§Ş–Ş¦Ş¢Ş§"));
            document.getElementById('catPageTitle').innerText = title;
            const s = currentUserType==='student'?currentStudentObj:classesData[currentClassIdx].students[currentStudentIdx];
            window.renderHistory(s, 'categoryHistoryList', type);
            document.getElementById('addRecordBtn').style.display = (currentUserType==='student')?'none':'block';
            window.openPage('category-page');
        }
        window.handleAddButtonClick = () => {
            if(currentSessionType==='juz_exam') window.openJuzExamSetup();
            else if(currentSessionType==='final_exam') window.openFinalExam();
            else window.openRecorder(currentSessionType);
        }

        // --- PROGRESS ---
        window.openProgressPage = () => {
            const select = document.getElementById('progClassSelect');
            if(select) {
                select.innerHTML = '';
                if(classesData) classesData.forEach((c, i) => select.add(new Option(c.name, i)));
            }
            window.renderSemesterList();
            window.renderPendingApprovals(); // Show approvals
            window.openPage('progress-page');
        }
        
        window.createSemester = () => {
            const name = document.getElementById('semName').value;
            const start = document.getElementById('semStart').value;
            const end = document.getElementById('semEnd').value;
            if(name && start && end) {
                semesters.push({ name: name, startDate: start, endDate: end });
                updateFirebase();
                window.renderSemesterList();
                document.getElementById('semName').value = '';
                document.getElementById('semStart').value = '';
                document.getElementById('semEnd').value = '';
            } else alert("Fill all fields");
        }

        window.renderSemesterList = () => {
            const list = document.getElementById('semesterList'); list.innerHTML = '';
            semesters.forEach((sem, i) => {
                list.innerHTML += `<div class="card-btn" onclick="window.viewSemesterReport(${i})"><h4>${sem.name}</h4><span>${sem.startDate} - ${sem.endDate}</span></div>`;
            });
        }

        window.viewSemesterReport = (semIdx) => {
            const sem = semesters[semIdx];
            const startDate = new Date(sem.startDate);
            const endDate = new Date(sem.endDate);
            const resultsDiv = document.getElementById('progressResults');
            resultsDiv.innerHTML = `<h3 style="text-align:center; color:var(--primary); margin-bottom:20px;">${sem.name} Report</h3>`;
            
            classesData.forEach(c => {
                let classHtml = `<div style="margin-bottom:30px;"><h4 style="border-bottom:2px solid var(--accent); padding-bottom:5px;">${c.name}</h4>`;
                
                c.students.forEach(s => {
                     const records = (s.history || []).filter(r => r.type === 'new_lesson');
                     const validRecords = records.filter(r => {
                        const d = new Date(r.date);
                        return d >= startDate && d <= endDate;
                     }).sort((a,b) => new Date(a.date) - new Date(b.date));
                     
                     // Passed Juz exams in this semester
                     const passedJuz = (s.history || []).filter(r => r.type === 'juz_exam' && parseFloat(r.score) >= 60 && new Date(r.date) >= startDate && new Date(r.date) <= endDate).length;
                     
                     // Total Juz
                     let totalJuz = parseFloat(s.juzCount || 0);
                     let passedExams = new Set();
                     if(s.history) s.history.forEach(h => { if(h.type === 'juz_exam' && parseFloat(h.score) >= 60) passedExams.add(h.juz); });
                     let grandTotal = totalJuz + passedExams.size;

                     if(validRecords.length > 0 || passedJuz > 0) {
                        const first = validRecords.length > 0 ? validRecords[0] : null;
                        const last = validRecords.length > 0 ? validRecords[validRecords.length-1] : null;
                        const totalPages = validRecords.length; 
                        
                        let startInfo = '-', endInfo = '-';
                        if(first) startInfo = first.startDetails ? `${first.startDetails.surah}:${first.startDetails.ayah}` : '-';
                        if(last) endInfo = last.endDetails ? `${last.endDetails.surah}:${last.endDetails.ayah}` : '-';

                        classHtml += `
                        <div class="prog-card">
                            <div class="prog-header">
                                <span class="prog-name">${s.name}</span> 
                                <span class="prog-total">${totalPages} Pgs | ${passedJuz} Juz (Sem) | Total: ${grandTotal}</span>
                            </div>
                            <div class="prog-body">
                                <div class="prog-section"><span class="prog-lbl">Started</span><span class="prog-val">${startInfo}</span></div>
                                <div class="prog-section"><span class="prog-lbl">Ended</span><span class="prog-val">${endInfo}</span></div>
                            </div>
                        </div>`;
                     }
                });
                
                classHtml += `</div>`;
                resultsDiv.innerHTML += classHtml;
            });
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        window.calculateStudentProgress = (student) => {
            if(!semesters.length) return;
            const latestSem = semesters[semesters.length - 1];
            const startDate = new Date(latestSem.startDate);
            const endDate = new Date(latestSem.endDate);
            
            // Calc Pages
            const newLessonRecs = (student.history || []).filter(r => r.type === 'new_lesson');
            const validRecs = newLessonRecs.filter(r => { const d = new Date(r.date); return d >= startDate && d <= endDate; });
            document.getElementById('studentSemPages').innerText = validRecs.length;
            
            // Calc Juz
            let semJuz = 0;
            if(student.history) student.history.forEach(h => { if(h.type === 'juz_exam' && parseFloat(h.score) >= 60) { const d = new Date(h.date); if(d >= startDate && d <= endDate) semJuz++; } });
            document.getElementById('studentSemJuz').innerText = semJuz;
            
            // Total Juz
            let totalJuz = parseFloat(student.juzCount || 0);
            let passedExams = new Set();
            if(student.history) student.history.forEach(h => { if(h.type === 'juz_exam' && parseFloat(h.score) >= 60) passedExams.add(h.juz); });
            document.getElementById('studentTotalJuz').innerText = totalJuz + passedExams.size;
        }

        // --- BULK ENTRY & APPROVALS ---
        window.openBulkEntryModal = () => {
            document.getElementById('bulkEntriesList').innerHTML = '';
            document.getElementById('prevSemJuz').value = '';
            window.addBulkRow();
            document.getElementById('bulkEntryModal').style.display='flex';
        }
        window.addBulkRow = () => {
            const div = document.createElement('div');
            div.className = 'form-grid';
            div.style.marginBottom = '10px'; div.style.borderBottom = '1px solid #eee'; div.style.paddingBottom = '10px';
            div.innerHTML = `
                <input type="date" class="form-input b-date">
                <select class="form-input b-type">
                    <option value="new_lesson">Ş‡Ş§ ŞŠŞ¨ŞŞ§ŞˆŞ¦Ş…Şª</option>
                    <option value="short_rev">Ş†ŞªŞƒŞª Ş‰ŞªŞƒŞ§Ş–Ş¦Ş¢Ş§</option>
                    <option value="long_rev">Ş‹Ş¨ŞŞª Ş‰ŞªŞƒŞ§Ş–Ş¦Ş¢Ş§</option>
                </select>
                <input type="number" class="form-input b-page" placeholder="Page">
            `;
            document.getElementById('bulkEntriesList').appendChild(div);
        }
        
        window.saveBulkData = async () => {
            const rows = document.querySelectorAll('#bulkEntriesList .form-grid');
            const prevJuz = document.getElementById('prevSemJuz').value;
            const student = currentStudentObj; // Only student calls this

            let pendingEntries = [];

            // Add Juz Count request
            if(prevJuz && prevJuz !== "") {
                pendingEntries.push({ type: 'juz_update', value: prevJuz, date: new Date().toLocaleDateString() });
            }

            for (let row of rows) {
                const date = row.querySelector('.b-date').value;
                const type = row.querySelector('.b-type').value;
                const page = row.querySelector('.b-page').value;
                
                if(date && page) {
                    try {
                        // Create Pending Entry
                        pendingEntries.push({
                            type: type, date: date, page: page, status: 'pending', timestamp: new Date().getTime()
                        });
                    } catch(e) {}
                }
            }
            
            // Find student in structure and update pendingData
            classesData.forEach(c => {
                let sIdx = c.students.findIndex(s => s.id === student.id);
                if(sIdx > -1) {
                    if(!c.students[sIdx].pendingData) c.students[sIdx].pendingData = [];
                    c.students[sIdx].pendingData.push(...pendingEntries);
                }
            });
            
            updateFirebase();
            alert("Sent for approval!");
            document.getElementById('bulkEntryModal').style.display='none';
        }

        // TEACHER APPROVAL LOGIC (UPDATED UI)
        window.renderPendingApprovals = () => {
            const list = document.getElementById('pendingApprovalsList');
            list.innerHTML = '';
            
            let hasPending = false;
            classesData.forEach((c, cIdx) => {
                c.students.forEach((s, sIdx) => {
                    if(s.pendingData && s.pendingData.length > 0) {
                        s.pendingData.forEach((p, pIdx) => {
                            hasPending = true;
                            // Distinct Style for Juz Update vs Normal Record
                            let isJuzUpdate = p.type === 'juz_update';
                            let typeLabel = "";
                            if(p.type === 'new_lesson') typeLabel = "Ş‡Ş§ ŞŠŞ¨ŞŞ§ŞˆŞ¦Ş…Şª";
                            else if(p.type === 'short_rev') typeLabel = "Ş†ŞªŞƒŞª Ş‰ŞªŞƒŞ§Ş–Ş¦Ş¢Ş§";
                            else if(p.type === 'long_rev') typeLabel = "Ş‹Ş¨ŞŞª Ş‰ŞªŞƒŞ§Ş–Ş¦Ş¢Ş§";

                            let detailsHtml = isJuzUpdate 
                                ? `<strong style="color:var(--accent);">Update Total Juz to: ${p.value}</strong>` 
                                : `<span>${typeLabel}</span><br><strong>Page ${p.page}</strong>`;
                            
                            list.innerHTML += `
                                <div class="approval-card" style="${isJuzUpdate ? 'border-right-color:#2ecc71;' : ''}">
                                    <div class="app-card-header">
                                        <div class="app-stu-name">${s.name} <span style="font-size:12px; font-weight:normal; color:#777;">(${c.name})</span></div>
                                        <div class="app-date">${p.date}</div>
                                    </div>
                                    <div class="app-details">${detailsHtml}</div>
                                    <div class="app-actions">
                                        <button class="btn-approve" onclick="window.approveEntry(${cIdx}, ${sIdx}, ${pIdx})">âœ“ Approve</button>
                                        <button class="btn-reject" onclick="window.rejectEntry(${cIdx}, ${sIdx}, ${pIdx})">âœ• Reject</button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
            });
            
            if(!hasPending) list.innerHTML = '<p style="text-align:center; color:#999;">No pending approvals</p>';
        }

        window.approveEntry = async (cIdx, sIdx, pIdx) => {
            const student = classesData[cIdx].students[sIdx];
            const entry = student.pendingData[pIdx];
            
            if(entry.type === 'juz_update') {
                student.juzCount = entry.value;
            } else {
                // Fetch details for page
                 try {
                    const res = await fetch(`https://api.alquran.cloud/v1/page/${entry.page}/quran-uthmani`);
                    const data = await res.json();
                    if(data.code === 200 && data.data.ayahs.length > 0) {
                        const first = data.data.ayahs[0];
                        const last = data.data.ayahs[data.data.ayahs.length-1];
                        
                        student.history.push({
                            type: entry.type, date: entry.date, page: entry.page, endPage: entry.page,
                            startDetails: { surah: first.surah.name, ayah: first.numberInSurah },
                            endDetails: { surah: last.surah.name, ayah: last.numberInSurah },
                            mistakesCount: 0, mistakeDetails: []
                        });
                    }
                } catch(e) {}
            }
            
            // Remove from pending
            student.pendingData.splice(pIdx, 1);
            updateFirebase();
            window.renderPendingApprovals();
        }
        
        window.rejectEntry = (cIdx, sIdx, pIdx) => {
             classesData[cIdx].students[sIdx].pendingData.splice(pIdx, 1);
             updateFirebase(); window.renderPendingApprovals();
        }

        window.renderHistory = (student, listId, filterType) => {
            const list = document.getElementById(listId); list.innerHTML = '';
            if(!student.history) student.history = [];
            const records = filterType ? student.history.filter(r => r.type === filterType) : student.history;
            if(!records.length) list.innerHTML = '<p style="text-align:center;color:#999;">No Records</p>';
            
            records.slice().reverse().forEach(rec => {
                const realIndex = student.history.indexOf(rec);
                let html = '';
                let deleteBtn = currentUserType === 'teacher' ? `<button class="btn-delete-hist abs-pos" onclick="event.stopPropagation(); window.deleteHistoryRecord(${realIndex})">ğŸ—‘</button>` : '';
                let editBtn = currentUserType === 'teacher' ? `<button class="btn-edit-hist abs-pos" onclick="event.stopPropagation(); window.editRecord(${realIndex}, '${rec.type}')">âœï¸</button>` : '';

                if(rec.type === 'juz_exam') {
                    let status = rec.status === 'partial' ? '<span class="hist-badge bg-pending">ŞŠŞ¦Ş€ŞªŞ„Ş¦Ş‡Ş¨ Ş‚ŞªŞ‚Ş¨Ş‰Ş­</span>' : '<span class="hist-badge bg-complete">ŞŠŞªŞƒŞ¨Ş€Ş¦Ş‰Ş¦</span>';
                    html = `
                        <div class="hist-card type-juz_exam" onclick='window.viewJuzRecord(${JSON.stringify(rec)})'>
                            <div class="hist-header"><span class="hist-title">Juz ${rec.juz} Exam</span>${status}</div>
                            <div class="hist-body">
                                <div class="hist-grid">
                                    <div class="hist-item"><span class="hist-label">ŞŒŞ§ŞƒŞ©ŞšŞ°</span><span class="hist-val">${rec.date}</span></div>
                                    <div class="hist-item"><span class="hist-label">ŞˆŞ¦ŞŞªŞŒŞª</span><span class="hist-val">${rec.duration}</span></div>
                                    <div class="hist-item"><span class="hist-label">Ş‰ŞªŞ‹Ş¦Ş‡Ş°ŞƒŞ¨ŞŞ° Ş†ŞªŞŞ°</span><span class="hist-val" style="color:red">${rec.details.teacherMistakes}</span></div>
                                    <div class="hist-item"><span class="hist-label">Ş‡Ş¦Ş‰Ş¨Ş‡Ş°ŞŞ¦ Ş†ŞªŞŞ°</span><span class="hist-val">${rec.details.selfMistakes}</span></div>
                                </div>
                            </div>
                            <div class="hist-footer exam-score">${rec.score}%</div>
                            ${deleteBtn}
                        </div>`;
                } else if(rec.type === 'final_exam') {
                    html = `<div class="hist-card type-final_exam"><div class="hist-header"><span class="hist-title">Final Exam</span></div><div class="hist-footer">${rec.score}%</div>${deleteBtn}</div>`;
                } else {
                    const sInfo = rec.startDetails ? `${rec.startDetails.surah}:${rec.startDetails.ayah}` : '-';
                    const eInfo = rec.endDetails ? `${rec.endDetails.surah}:${rec.endDetails.ayah}` : '-';
                    html = `
                        <div class="hist-card type-${rec.type}" onclick='window.viewLessonRecord(${JSON.stringify(rec)})'>
                            <div class="hist-header"><span class="hist-title">Page ${rec.page}</span><span class="hist-date">${rec.date}</span></div>
                            <div class="hist-body">
                                <div class="hist-grid">
                                    <div class="hist-box"><span class="hist-label">ŞŠŞ¬ŞŞªŞ‚Ş©</span><span class="hist-val">${sInfo}</span></div>
                                    <div class="hist-box"><span class="hist-label">Ş‚Ş¨Ş‰ŞªŞ‚Ş©</span><span class="hist-val">${eInfo} (Ş ${rec.endPage})</span></div>
                                </div>
                            </div>
                            <div class="hist-footer" style="color:var(--mistake);">Ş†ŞªŞŞ°: ${rec.mistakesCount}</div>
                            ${deleteBtn} ${editBtn}
                        </div>`;
                }
                list.innerHTML += html;
            });
        };

        window.deleteHistoryRecord = (index) => {
            if(confirm("Ş‰Ş¨ ŞƒŞ¬Ş†Ş¯Ş‘Ş° ŞŠŞ®Ş€Ş¬ŞŞ¦Ş‚Ş° Ş„Ş­Ş‚ŞªŞ‚Ş°ŞˆŞ­ŞŒŞ¦ØŸ")) {
                const s = currentUserType==='student' ? currentStudentObj : classesData[currentClassIdx].students[currentStudentIdx];
                s.history.splice(index, 1);
                updateFirebase();
                window.renderHistory(s, currentUserType==='student'?'studentDashHistory':'categoryHistoryList', currentSessionType);
            }
        }

        window.editRecord = (index, type) => {
            const student = currentUserType==='student'?currentStudentObj:classesData[currentClassIdx].students[currentStudentIdx];
            const rec = student.history[index];
            isViewMode = false; editingRecordIndex = index;
            
            if(type === 'new_lesson' || type === 'short_rev' || type === 'long_rev') {
                currentMistakes = rec.mistakeDetails || [];
                currentSessionType = rec.type;
                document.getElementById('recorderTitle').innerText = "Edit Record";
                document.getElementById('recSaveBtn').innerText = "Update";
                document.getElementById('recSaveBtn').style.display = 'block';
                document.getElementById('recDate').value = rec.date;
                document.getElementById('startPage').value = rec.page;
                
                // When editing, start view at page 1
                currentRecViewPage = parseInt(rec.page);
                
                // Load page to trigger API and then set values
                window.loadSmartPage(true).then(() => {
                    document.getElementById('endPage').value = rec.endPage;
                    document.getElementById('startSurah').value = SURAH_NAMES_AR.indexOf(rec.startDetails.surah) + 1;
                    document.getElementById('endSurah').value = SURAH_NAMES_AR.indexOf(rec.endDetails.surah) + 1;
                    
                    // Manually populate and set ayah options since API overwrites them initially
                    window.updateAyahOptions('startAyah', SURAH_NAMES_AR.indexOf(rec.startDetails.surah), rec.startDetails.ayah);
                    window.updateAyahOptions('endAyah', SURAH_NAMES_AR.indexOf(rec.endDetails.surah), rec.endDetails.ayah);
                });

                document.getElementById('mistakeCountDisplay').innerText = rec.mistakesCount;
                document.getElementById('recorder-page').classList.remove('hidden');
            }
        }

        // RECORDER LOGIC (FIXED)
        window.openRecorder = (type) => {
            editingRecordIndex = -1; isViewMode = false; currentMistakes = [];
            currentSessionType = type;
            document.getElementById('recorderTitle').innerText = "ŞƒŞ¬Ş†Ş¯Ş‘Ş°";
            document.getElementById('recSaveBtn').innerText = "Save";
            document.getElementById('recSaveBtn').style.display = 'block';
            document.getElementById('viewModeBadge').style.display = 'none';
            document.getElementById('recDate').valueAsDate = new Date();
            document.getElementById('mistakeCountDisplay').innerText = 0;
            document.getElementById('mushafContent').innerHTML = '<p style="color:#999; margin-top:100px;">...</p>';
            populateSurahSelects(); // Ensure lists are populated
            
            // Auto fill
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            let initialPage = 1;

            if(s.history) {
                const recs = s.history.filter(r => r.type === type);
                if(recs.length > 0) {
                    const last = recs[recs.length-1];
                    const nextP = parseInt(last.endPage || last.page) + 1;
                    if(nextP <= 604) initialPage = nextP;
                }
            }
            
            document.getElementById('startPage').value = initialPage;
            currentRecViewPage = initialPage;
            window.loadSmartPage();
            
            document.getElementById('recorder-page').classList.remove('hidden');
        };

        window.closeRecorder = () => {
            document.getElementById('recorder-page').classList.add('hidden');
            if(currentUserType === 'student') window.renderHistory(currentStudentObj, 'studentDashHistory', null);
            else if(currentStudentIdx !== -1) window.renderHistory(classesData[currentClassIdx].students[currentStudentIdx], 'categoryHistoryList', currentSessionType);
        };
        
        // This is called when User manually types in Start Page
        window.handleStartPageChange = () => {
            let val = parseInt(document.getElementById('startPage').value);
            if(val) {
                currentRecViewPage = val;
                window.loadSmartPage();
            }
        }

        window.loadSmartPage = async (applyHighlights=false) => {
            const page = currentRecViewPage; // Use view page
            if(!page) return;
            const res = await fetch(`https://api.alquran.cloud/v1/page/${page}/quran-uthmani`);
            const data = await res.json();
            window.renderMushafText(data.data.ayahs, 'mushafContent', currentMistakes, false);
            
            // Logic: Start Page stays static unless manually changed. 
            // End Page updates to match the current view page.
            // If it's a new record, update endPage input automatically.
            if(!isViewMode && editingRecordIndex === -1 && data.data.ayahs.length > 0) {
                document.getElementById('endPage').value = page; // Update End Page Input

                const last = data.data.ayahs[data.data.ayahs.length-1];
                
                // Only auto-populate start details if we are on the very first page of session
                if(page == document.getElementById('startPage').value) {
                    const first = data.data.ayahs[0];
                    populateSurahSelects();
                    document.getElementById('startSurah').value = first.surah.number;
                    window.updateAyahOptions('startAyah', first.surah.number-1, first.numberInSurah); 
                }

                // Always update end details
                document.getElementById('endSurah').value = last.surah.number;
                window.updateAyahOptions('endAyah', last.surah.number-1, last.numberInSurah);
            }
        };
        
        // Navigation: Moves view only, Updates End Page
        window.changeRecPage = (dir) => {
            let p = currentRecViewPage + dir;
            if(p>0 && p<=604) { 
                currentRecViewPage = p; 
                window.loadSmartPage(); 
            }
        }

        window.renderMushafText = (ayahs, target, highlights, isExam) => {
            let html = '';
            // Update Header
            const f = ayahs[0];
            const headerTarget = isExam ? 'mushafTopBar' : 'recMushafTopBar';
            const juzTarget = isExam ? 'mushafJuzInfo' : 'recMushafJuz';
            const surahTarget = isExam ? 'mushafSurahInfo' : 'recMushafSurah';
            
            if(document.getElementById(juzTarget)) document.getElementById(juzTarget).innerText = `Juz ${f.juz}`;
            if(document.getElementById(surahTarget)) document.getElementById(surahTarget).innerText = `Ø³ÙˆØ±Ø© ${f.surah.name}`;

            ayahs.forEach(a => {
                const words = a.text.split(' ');
                words.forEach((w, i) => {
                    const id = `p${a.page}_s${a.surah.number}_a${a.numberInSurah}_w${i}`;
                    let cls = highlights.includes(id) ? 'word mistake' : 'word';
                    let fn = isExam ? `window.clickExamWord('${id}')` : `window.clickRecWord('${id}')`;
                    html += `<span id="${id}" class="${cls}" onclick="${fn}">${w}</span> `;
                });
                html += `<span class="ayah-marker">(${a.numberInSurah})</span> `;
            });
            document.getElementById(target).innerHTML = html;
        };
        window.clickRecWord = (id) => {
            if(isViewMode) return;
            const el = document.getElementById(id);
            if(el.classList.contains('mistake')) { el.classList.remove('mistake'); currentMistakes = currentMistakes.filter(x=>x!==id); }
            else { el.classList.add('mistake'); currentMistakes.push(id); }
            document.getElementById('mistakeCountDisplay').innerText = currentMistakes.length;
        };
        window.saveRecord = () => {
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            if(!s.history) s.history = [];
            
            const ssIdx = document.getElementById('startSurah').selectedIndex;
            const esIdx = document.getElementById('endSurah').selectedIndex;
            const startObj = { surah: SURAH_NAMES_AR[ssIdx], ayah: document.getElementById('startAyah').value };
            const endObj = { surah: SURAH_NAMES_AR[esIdx], ayah: document.getElementById('endAyah').value };

            const record = {
                type: currentSessionType, date: document.getElementById('recDate').value,
                page: document.getElementById('startPage').value, endPage: document.getElementById('endPage').value,
                startDetails: startObj, endDetails: endObj,
                mistakesCount: currentMistakes.length, mistakeDetails: currentMistakes
            };

            if(editingRecordIndex > -1) { s.history[editingRecordIndex] = record; } 
            else { s.history.push(record); }
            updateFirebase(); 
            alert("ŞŞ­ŞˆŞ° Ş†ŞªŞƒŞ¬ŞˆŞ¨Ş‡Ş°Ş–Ş¬");
            window.closeRecorder();
        };
        window.viewLessonRecord = (rec) => {
            isViewMode = true; currentMistakes = rec.mistakeDetails || [];
            document.getElementById('recorderTitle').innerText = "View Record";
            document.getElementById('recSaveBtn').style.display = 'none';
            document.getElementById('viewModeBadge').style.display = 'block';
            document.getElementById('recDate').value = rec.date;
            document.getElementById('startPage').value = rec.page;
            document.getElementById('endPage').value = rec.endPage;
            document.getElementById('mistakeCountDisplay').innerText = rec.mistakesCount;
            document.getElementById('recorder-page').classList.remove('hidden');
            
            currentRecViewPage = parseInt(rec.page);
            window.loadSmartPage(true);
        };
        window.viewJuzRecord = (rec) => {
            document.getElementById('juzExamTitle').innerText = "View Exam";
            document.getElementById('juz-exam-page').classList.remove('hidden');
            document.getElementById('liveScore').innerText = rec.score + "%";
            document.getElementById('saveExamBtn').style.display = 'none';
            document.getElementById('stopwatchDisplay').innerText = rec.duration || "00:00:00";
            document.getElementById('countTeacher').innerText = rec.details.teacherMistakes;
            document.getElementById('countSelf').innerText = rec.details.selfMistakes;
            document.getElementById('scoreTajweed').value = rec.details.tajweed;
            document.getElementById('scoreFluency').value = rec.details.fluency;
            isViewMode = true; examState.mistakesList = rec.mistakeDetails || [];
            let startP = ((rec.juz-1)*20)+2; 
            window.loadExamPage(startP);
        };

        // JUZ EXAM
        window.openJuzExamSetup = () => { 
            const juzSel = document.getElementById('examJuzSelect'); juzSel.innerHTML = '';
            for(let i=1; i<=30; i++) juzSel.add(new Option(`Ş–ŞªŞ’ŞªŞ‡Şª ${i}`, i));
            document.getElementById('juzSetupModal').style.display='flex'; 
        };
        window.startJuzExam = () => {
            const juz = parseInt(document.getElementById('examJuzSelect').value);
            const mode = document.querySelector('input[name="examPart"]:checked').value;
            let startPage = ((juz-1)*20)+2; if(mode === 'part2') startPage += 10;
            examState = { juz: juz, mode: mode, mistakesTeacher: 0, mistakesSelf: 0, currentPage: startPage, mistakesList: [], isMutashabih: false, timer: null, seconds: 0 };
            document.getElementById('juzSetupModal').style.display='none';
            document.getElementById('juzExamTitle').innerText = `Ş–ŞªŞ’ŞªŞ‡Şª ${juz}`;
            document.getElementById('partBadge').innerText = mode==='full'?'Full':(mode==='part1'?'Part 1':'Part 2');
            document.getElementById('liveScore').innerText = "100%";
            document.getElementById('countTeacher').innerText = "0"; document.getElementById('countSelf').innerText = "0";
            document.getElementById('mutashabihSection').style.display = (mode==='part1')?'none':'block';
            document.getElementById('saveExamBtn').style.display = 'block';
            isViewMode = false;
            window.loadExamPage(startPage);
            document.getElementById('juz-exam-page').classList.remove('hidden');
        };
        window.closeJuzExam = () => { window.stopTimer(); document.getElementById('juz-exam-page').classList.add('hidden'); };
        window.loadExamPage = async (page) => {
            document.getElementById('currentPageDisplay').innerText = `Page ${page}`;
            const res = await fetch(`https://api.alquran.cloud/v1/page/${page}/quran-uthmani`);
            const data = await res.json();
            const first = data.data.ayahs[0];
            document.getElementById('mushafJuzInfo').innerText = `Juz ${first.juz}`; document.getElementById('mushafSurahInfo').innerText = `Ø³ÙˆØ±Ø© ${first.surah.name}`;
            window.renderMushafText(data.data.ayahs, 'examMushafContent', examState.mistakesList, true);
        };
        window.changeExamPage = (dir) => {
            let newPage = examState.currentPage + dir;
            if(newPage < 1 || newPage > 604) return;
            examState.currentPage = newPage; window.loadExamPage(newPage);
        };
        window.clickExamWord = (id) => {
            if(isViewMode) return;
            const el = document.getElementById(id);
            if(el.classList.contains('mistake')) {
                el.classList.remove('mistake'); examState.mistakesList = examState.mistakesList.filter(x=>x!==id);
                if(!examState.isMutashabih) window.updateScore('teacher', -1);
            } else {
                el.classList.add('mistake'); examState.mistakesList.push(id);
                if(!examState.isMutashabih) window.updateScore('teacher', 1);
            }
        };
        window.updateScore = (type, delta) => {
            if(type==='teacher') examState.mistakesTeacher = Math.max(0, examState.mistakesTeacher+delta);
            else examState.mistakesSelf = Math.max(0, examState.mistakesSelf+delta);
            document.getElementById('countTeacher').innerText = examState.mistakesTeacher;
            document.getElementById('countSelf').innerText = examState.mistakesSelf;
            window.calcScore();
        };
        window.calcScore = () => {
            let deduct = (examState.mistakesTeacher*2) + (examState.mistakesSelf*1) + (10 - document.getElementById('scoreTajweed').value) + (5 - document.getElementById('scoreFluency').value);
            if(examState.mode !== 'part1') deduct += (2.5 - document.getElementById('q1_score').value) + (2.5 - document.getElementById('q2_score').value);
            let final = Math.max(0, 100 - deduct);
            document.getElementById('liveScore').innerText = final + "%";
            return final;
        };
        window.setTimerMode = (mode) => {
            document.getElementById('stopwatchMode').classList.toggle('hidden', mode !== 'stopwatch');
            document.getElementById('manualMode').classList.toggle('hidden', mode !== 'manual');
        };
        window.startTimer = () => {
            if(examState.timer) return;
            examState.timer = setInterval(() => { examState.seconds++; let d = new Date(0); d.setSeconds(examState.seconds); document.getElementById('stopwatchDisplay').innerText = d.toISOString().substr(11,8); }, 1000);
        };
        window.stopTimer = () => { clearInterval(examState.timer); examState.timer = null; };
        window.generateQuestions = () => {
            examState.isMutashabih = true;
            const list = document.getElementById('questionList'); list.innerHTML = '';
            let base = ((examState.juz-1)*20)+2; if(examState.mode === 'part2') base+=10;
            for(let i=0; i<3; i++) {
                let p = base + Math.floor(Math.random()*10);
                list.innerHTML += `<button style="display:block;width:100%;margin-bottom:5px;padding:5px;" onclick="window.loadExamPage(${p})">Q${i+1} - Page ${p}</button>`;
            }
        };
        window.saveJuzExamPart = () => {
            const score = window.calcScore();
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            let duration = document.getElementById('stopwatchDisplay').innerText;
            if(!s.juzExams) s.juzExams={}; if(!s.juzExams[examState.juz]) s.juzExams[examState.juz]={};
            
            let details = {
                teacherMistakes: examState.mistakesTeacher,
                selfMistakes: examState.mistakesSelf,
                tajweed: document.getElementById('scoreTajweed').value,
                fluency: document.getElementById('scoreFluency').value,
                mutashabihMarks: (examState.mode!=='part1') ? (parseFloat(document.getElementById('q1_score').value) + parseFloat(document.getElementById('q2_score').value)) : 0
            };

            if(examState.mode === 'part1') {
                s.juzExams[examState.juz].part1 = score;
                s.history.push({
                    type:'juz_exam', status:'partial', date:new Date().toLocaleDateString(), 
                    juz:examState.juz, score:score, duration:duration, 
                    details: details, mistakeDetails: examState.mistakesList
                });
            } else {
                let p1 = s.juzExams[examState.juz].part1 || 0;
                let final = (examState.mode === 'full') ? score : (p1 + score) / 2;
                s.history.push({
                    type:'juz_exam', status:'completed', date:new Date().toLocaleDateString(), 
                    juz:examState.juz, score:final, duration:duration, 
                    details: details, mistakeDetails: examState.mistakesList
                });
            }
            updateFirebase(); 
            alert("Ş‡Ş¨Ş‰Ş°ŞŒŞ¨Ş™Ş§Ş‚Ş° ŞŞ­ŞˆŞ° Ş†ŞªŞƒŞ¬ŞˆŞ¨Ş‡Ş°Ş–Ş¬!");
            window.closeJuzExam(); window.openStudentMenu(currentStudentIdx);
        };

        // FINAL EXAM
        window.openFinalExam = () => {
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            finalExamState = { currentQ: 1, maxQ: (s.level >= 3 ? 3 : 2), totalMistakesT: 0, totalMistakesS: 0 };
            document.getElementById('finalExamScore').innerText = "100%";
            document.getElementById('questionIndicator').innerText = `ŞŞªŞˆŞ§ŞŞª 1 / ${finalExamState.maxQ}`;
            document.getElementById('finalTeacherCount').innerText = 0; document.getElementById('finalSelfCount').innerText = 0;
            const finalJuzSel = document.getElementById('finalJuzSelect'); finalJuzSel.innerHTML = '';
            for(let i=1; i<=30; i++) finalJuzSel.add(new Option(`Ş–ŞªŞ’ŞªŞ‡Şª ${i}`, i));
            document.getElementById('final-exam-page').classList.remove('hidden');
        };
        window.closeFinalExam = () => { document.getElementById('final-exam-page').classList.add('hidden'); };
        window.loadFinalQuestion = async () => {
            const juz = document.getElementById('finalJuzSelect').value;
            const startP = ((juz-1)*20)+2; const randomP = startP + Math.floor(Math.random()*18);
            const res = await fetch(`https://api.alquran.cloud/v1/page/${randomP}/quran-uthmani`);
            const data = await res.json();
            window.renderMushafText(data.data.ayahs, 'finalMushafContent', [], true);
        };
        window.updateFinalScore = (type, delta) => {
            if(type==='teacher') finalExamState.totalMistakesT = Math.max(0, finalExamState.totalMistakesT+delta);
            else finalExamState.totalMistakesS = Math.max(0, finalExamState.totalMistakesS+delta);
            document.getElementById('finalTeacherCount').innerText = finalExamState.totalMistakesT;
            document.getElementById('finalSelfCount').innerText = finalExamState.totalMistakesS;
            window.calcFinalScore();
        };
        window.calcFinalScore = () => {
            let deduct = (finalExamState.totalMistakesT*5) + (finalExamState.totalMistakesS*2);
            let score = Math.max(0, 100 - deduct);
            document.getElementById('finalExamScore').innerText = score + "%";
            return score;
        };
        window.nextFinalQuestion = () => {
            if(finalExamState.currentQ < finalExamState.maxQ) {
                finalExamState.currentQ++;
                document.getElementById('questionIndicator').innerText = `ŞŞªŞˆŞ§ŞŞª ${finalExamState.currentQ} / ${finalExamState.maxQ}`;
                if(finalExamState.currentQ === finalExamState.maxQ) {
                    document.getElementById('nextQBtn').classList.add('hidden');
                    document.getElementById('finishExamBtn').classList.remove('hidden');
                }
            }
        };
        window.saveFinalExam = () => {
            const score = window.calcFinalScore();
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            s.history.push({type:'final_exam', date:new Date().toLocaleDateString(), score:score, mistakesCount:(finalExamState.totalMistakesT+finalExamState.totalMistakesS)});
            updateFirebase(); window.closeFinalExam(); window.openStudentMenu(currentStudentIdx);
        };

        // HELPERS
        function populateSurahSelects() {
            const s1 = document.getElementById('startSurah'), s2 = document.getElementById('endSurah');
            if(s1 && s2) { 
                s1.innerHTML=''; s2.innerHTML=''; 
                SURAH_NAMES_AR.forEach((n,i) => { 
                    s1.add(new Option(n, i+1)); 
                    s2.add(new Option(n, i+1)); 
                }); 
                s1.onchange = function() { window.updateAyahOptions('startAyah', this.value - 1); };
                s2.onchange = function() { window.updateAyahOptions('endAyah', this.value - 1); };
            }
        }
        
        window.updateAyahOptions = (selectId, surahIndex, selectedValue) => {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            const total = AYAH_COUNTS[surahIndex];
            for(let i=1; i<=total; i++) {
                select.add(new Option(i, i));
            }
            if(selectedValue && selectedValue <= total) select.value = selectedValue;
            else select.value = 1;
        }
        window.updateAyahSelect = (id, val) => {
             let sId = id === 'startAyah' ? 'startSurah' : 'endSurah';
             let sIdx = document.getElementById(sId).value - 1;
             window.updateAyahOptions(id, sIdx, val);
        }
    </script>
</body>
</html>
