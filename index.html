<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁ§ﬁ™ﬁÉﬁ∞ﬁáﬁßﬁÇﬁ∞ ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ - V9.1 (Redesigned)</title>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');
        @font-face { font-family: 'Faruma'; src: local('Faruma'), local('Faruma-Regular'); }
        @font-face { font-family: 'Mv Waheed'; src: local('Mv Waheed'), local('Mv Waheed-Regular'); }
        
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #2a5298;
            --accent-color: #00b894;
            --bg-color: #f4f6f9;
            --sidebar-width: 300px;
            --text-color: #2d3436;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Faruma', 'Noto Sans Thaana', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
            color: var(--text-color);
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white;
        }
        .login-box {
            background: rgba(255,255,255,0.95); padding: 40px; border-radius: 20px; width: 90%; max-width: 380px;
            text-align: center; color: #333; box-shadow: 0 20px 50px rgba(0,0,0,0.3); backdrop-filter: blur(10px);
        }
        .login-btn {
            width: 100%; padding: 14px; margin: 10px 0; border: none; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .login-btn:active { transform: scale(0.98); }
        .btn-student { background: linear-gradient(to right, #f6d365, #fda085); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .btn-teacher { background: linear-gradient(to right, #1e3c72, #2a5298); color: white; }
        
        .login-input {
            width: 100%; padding: 12px 15px; margin: 8px 0; border: 2px solid #eee;
            border-radius: 10px; font-size: 16px; text-align: center; transition: 0.3s;
        }
        .login-input:focus { border-color: var(--primary-color); outline: none; background: #fff; }

        /* --- DASHBOARDS --- */
        #teacher-dashboard, #student-dashboard { display: none; width: 100%; height: 100%; }
        .dashboard-active { display: flex !important; }

        /* --- SIDEBAR (Redesigned) --- */
        .sidebar {
            width: var(--sidebar-width); background: white; border-left: 1px solid #e1e4e8;
            display: flex; flex-direction: column; z-index: 100;
            box-shadow: 4px 0 15px rgba(0,0,0,0.05); transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 20px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; text-align: center;
        }
        
        .class-filter-area { padding: 15px; border-bottom: 1px solid #eee; background: #f8f9fa; }
        .search-box {
            width: 100%; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd;
            margin-top: 10px; font-size: 14px; background: white;
        }

        .student-list-container { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* New Student Card Style */
        .student-card {
            background: white; border: 1px solid #edf2f7; border-radius: 12px;
            padding: 12px 15px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .student-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-color: var(--accent-color); }
        .student-card.active { background: #e6fffa; border-color: var(--accent-color); border-right: 4px solid var(--accent-color); }
        
        .st-avatar {
            width: 40px; height: 40px; background: #e2e8f0; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: var(--primary-color); font-size: 18px;
        }
        .st-info { flex: 1; display: flex; flex-direction: column; }
        .st-name { font-weight: bold; font-size: 15px; color: #2d3748; }
        .st-id { font-size: 12px; color: #718096; background: #edf2f7; padding: 1px 6px; border-radius: 4px; width: fit-content; margin-top: 2px; }

        /* --- MAIN CONTENT --- */
        .main-content { 
            flex: 1; padding: 20px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 20px; position: relative;
        }

        /* --- WELCOME STATS (New) --- */
        .stats-grid { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card {
            flex: 1; background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; min-width: 150px;
        }
        .stat-num { font-size: 28px; font-weight: bold; color: var(--primary-color); display: block; }
        .stat-label { font-size: 14px; color: #718096; }

        /* --- FORMS & SECTIONS --- */
        .entry-form { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: none; }
        .form-active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .form-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .form-group { flex: 1; }
        
        input, select { 
            width: 100%; padding: 10px 15px; border: 1px solid #e2e8f0; border-radius: 8px; 
            font-family: inherit; font-size: 16px; height: 45px; background: #fff;
        }
        .arabic-input { font-family: 'Amiri', serif; direction: rtl; font-size: 18px; }

        /* Color-coded Sections */
        .section-header { 
            padding: 15px; border-radius: 10px; margin-bottom: 15px; 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            border: 2px solid transparent; transition: 0.2s;
        }
        .sec-new { background: #f0fff4; border-color: #c6f6d5; color: #276749; }
        .sec-short { background: #ebf8ff; border-color: #bee3f8; color: #2c5282; }
        .sec-long { background: #fffaf0; border-color: #feebc8; color: #7b341e; }
        .sec-active { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left-width: 6px; }

        .mistake-input-group { display: flex; align-items: center; border: 1px solid #cbd5e0; border-radius: 8px; overflow: hidden; }
        .mistake-btn { width: 40px; height: 43px; border: none; background: #edf2f7; font-size: 20px; cursor: pointer; }
        .mistake-val { width: 50px; text-align: center; border: none; font-weight: bold; font-size: 18px; height: 43px; }

        /* --- MUSHAF --- */
        .mushaf-panel { 
            width: 35%; background: #2d3748; display: flex; flex-direction: column; 
            border-right: 1px solid #cbd5e0; transition: all 0.3s;
        }
        .mushaf-header { background: #1a202c; color: white; padding: 15px; text-align: center; }
        .mushaf-container { flex: 1; overflow: auto; background: #f7fafc; display: flex; justify-content: center; }
        .mushaf-page-img { max-width: 100%; display: block; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        
        .mistake-dot {
            position: absolute; width: 24px; height: 24px; background: rgba(231, 76, 60, 0.9);
            border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);
            cursor: pointer; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { 
                position: fixed; top: 0; right: 0; height: 100%; width: 280px; 
                transform: translateX(100%); box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            }
            .sidebar.open { transform: translateX(0); }
            .mushaf-panel { 
                position: fixed; top: 0; left: 0; height: 100%; width: 100% !important; z-index: 1500;
                transform: translateY(100%);
            }
            .mushaf-panel.open { transform: translateY(0); }
            .menu-toggle { display: block !important; }
            
            .form-row { flex-direction: column; gap: 10px; }
            .form-row > div { width: 100%; }
        }
        
        @media (min-width: 769px) {
            .menu-toggle { display: none; }
        }

        /* Utils */
        .btn { border-radius: 8px; }
        .btn-green { background: #48bb78; } .btn-blue { background: #4299e1; }
        .btn-red { background: #f56565; } .btn-grey { background: #a0aec0; }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay">
        <div style="width:50px; height:50px; border:5px solid #eee; border-top-color:var(--primary-color); border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:15px; font-weight:bold; color:var(--primary-color);">ﬁêﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁçﬁØﬁëﬁ™ﬁàﬁ¶ﬁÇﬁ©...</p>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" style="display:none;">
        <div class="login-box" id="roleSelection">
            <h2 style="color:var(--primary-color); margin-top:0;">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞</h2>
            <p style="font-size:14px; margin-bottom:20px; color:#666;">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞ ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁöﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</p>
            <button class="login-btn btn-student" onclick="showStudentLogin()">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</button>
            <button class="login-btn btn-teacher" onclick="loginTeacher()">üë®‚Äçüè´ ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
        </div>

        <div class="login-box" id="studentLoginForm" style="display:none;">
            <h3 style="color:var(--primary-color);">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</h3>
            <div style="text-align:right; font-size:13px; color:#666; margin-bottom:5px;">ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ (ﬁâﬁ®ﬁêﬁßﬁçﬁ™: IUM123):</div>
            <input type="text" id="stLoginId" class="login-input" placeholder="ID">
            <div style="text-align:right; font-size:13px; color:#666; margin-bottom:5px;">ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞:</div>
            <input type="password" id="stLoginPass" class="login-input" placeholder="Password">
            <button class="login-btn btn-green" onclick="processStudentLogin()">ﬁàﬁ¶ﬁÇﬁ∞ﬁÇﬁ¶ﬁàﬁß</button>
            <button class="login-btn btn-grey" style="padding:10px; font-size:14px;" onclick="document.getElementById('studentLoginForm').style.display='none'; document.getElementById('roleSelection').style.display='block';">ﬁäﬁ¶ﬁÄﬁ¶ﬁåﬁ¶ﬁÅﬁ∞</button>
        </div>
    </div>

    <!-- TEACHER DASHBOARD -->
    <div id="teacher-dashboard">
        <!-- SIDEBAR -->
        <div class="sidebar" id="teacherSidebar">
            <div class="sidebar-header">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</h3>
                    <span style="font-size:24px; cursor:pointer; opacity:0.8;" onclick="toggleSidebar()">√ó</span>
                </div>
            </div>
            
            <div class="class-filter-area">
                <label style="font-size:12px; color:#666;">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                <select id="classSelect" class="class-select" onchange="switchClass(this.value)" style="width:100%; border-radius:20px;"></select>
                <input type="text" id="searchStudent" class="search-box" placeholder="üîç ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÄﬁØﬁãﬁ™ﬁâﬁ¶ﬁÅﬁ∞..." onkeyup="filterStudents(this.value)">
                
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="btn btn-blue" style="flex:1; font-size:12px; padding:8px;" onclick="openModal()">‚öôÔ∏è ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞</button>
                    <button class="btn btn-grey" style="font-size:12px; padding:8px;" onclick="logout()">üö™</button>
                </div>
            </div>
            
            <div id="studentListContainer" class="student-list-container">
                <!-- Students will be loaded here as cards -->
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- Top Bar -->
            <div style="background:white; padding:15px; border-radius:15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 6px rgba(0,0,0,0.03);">
                <div style="display:flex; align-items:center; gap:15px;">
                    <span class="menu-toggle" onclick="toggleSidebar()" style="color:var(--primary-color);">‚ò∞</span>
                    <div>
                        <h2 id="studentHeader" style="margin:0; color:var(--primary-color); font-size:22px;">ﬁëﬁ≠ﬁùﬁ∞ﬁÑﬁØﬁëﬁ∞</h2>
                        <div id="studentHeaderId" style="font-size:13px; color:#666;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁöﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</div>
                    </div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-green" onclick="exportExcel()">Excel</button>
                    <button class="btn btn-blue" onclick="toggleMushaf(true)">üìñ</button>
                </div>
            </div>

            <!-- DASHBOARD STATS (Shown when no student selected) -->
            <div id="dashboardStats" class="stats-grid">
                <div class="stat-card">
                    <span class="stat-num" id="statTotalStudents">0</span>
                    <span class="stat-label">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</span>
                </div>
                <div class="stat-card">
                    <span class="stat-num" id="statTodayCount">0</span>
                    <span class="stat-label">ﬁâﬁ®ﬁáﬁ¶ﬁãﬁ™ ﬁÜﬁ®ﬁîﬁ¶ﬁáﬁ®ﬁãﬁ®ﬁÇﬁ∞</span>
                </div>
                <div class="stat-card">
                    <span class="stat-num" id="statTotalClasses">0</span>
                    <span class="stat-label">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞</span>
                </div>
            </div>

            <!-- ENTRY FORM (Hidden initially) -->
            <div id="entryFormArea" class="entry-form">
                <div class="form-row">
                    <div style="flex:1"><label>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="entryDate"></div>
                    <div style="flex:1"><label>ﬁàﬁ¶ﬁáﬁ∞ﬁåﬁ¶ﬁÉﬁ™</label>
                        <select id="lessonType" onchange="toggleFormSection(this.value)">
                            <option value="daily">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ﬁåﬁ¶ﬁáﬁ∞</option>
                            <option value="exam">ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</option>
                        </select>
                    </div>
                </div>

                <!-- DAILY -->
                <div id="container-daily">
                    <!-- New -->
                    <div id="sec-new" class="section-header sec-new sec-active" onclick="setActiveSection('new')">
                        <span>üå± ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</span>
                        <input type="radio" name="activeSec" value="new" checked>
                    </div>
                    <div id="form-new" class="form-active">
                        <div class="form-row">
                            <div style="flex:1"><label>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="newPage" placeholder="#" onchange="handlePageChange(this.value, 'new')" style="text-align:center; font-weight:bold;"></div>
                            <div style="flex:2"><label>ﬁäﬁ¨ﬁÅﬁ≠</label><div style="display:flex; gap:5px;"><select id="newSurah" class="arabic-input" style="flex:1"><option>...</option></select><input type="number" id="newStart" placeholder="ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞" style="width:60px;"></div></div>
                            <div style="flex:2"><label>ﬁÇﬁ®ﬁâﬁ≠</label><div style="display:flex; gap:5px;"><select id="newEndSurah" class="arabic-input" style="flex:1"><option>...</option></select><input type="number" id="newEnd" placeholder="ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞" style="width:60px;"></div></div>
                            <div style="flex:1"><label>ﬁÜﬁ™ﬁÅﬁ∞</label>
                                <div class="mistake-input-group">
                                    <button class="mistake-btn" onclick="adjM('newMistakes',1)">+</button>
                                    <input id="newMistakes" class="mistake-val" value="0" readonly>
                                    <button class="mistake-btn" onclick="adjM('newMistakes',-1)">-</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Short -->
                    <div id="sec-short" class="section-header sec-short" onclick="setActiveSection('short')">
                        <span>üîÑ ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</span>
                        <input type="radio" name="activeSec" value="short">
                    </div>
                    
                    <!-- Long -->
                    <div id="sec-long" class="section-header sec-long" onclick="setActiveSection('long')">
                        <span>üìö ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</span>
                        <input type="radio" name="activeSec" value="long">
                    </div>
                    
                    <!-- (Hidden inputs for Short/Long to save space, logic handles visibility) -->
                    <!-- Note: In full implementation, similar form rows for Short/Long would be here, managed by JS visibility -->
                    <div id="extra-forms-container"></div> 
                </div>
                
                <!-- EXAM -->
                <div id="container-exam" style="display:none;">
                   <div class="section-header" style="background:#fffaf0; border-color:gold;">üèÜ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</div>
                   <div class="form-row">
                       <div style="flex:1"><label>ﬁÑﬁ¶ﬁáﬁ®</label><input type="text" id="examJuzu" placeholder="Juzu 30"></div>
                       <div style="flex:1"><label>ﬁïﬁ≠ﬁñﬁ∞</label><input type="number" id="examPage" onchange="loadMushaf(this.value)"></div>
                       <div style="flex:1"><label>ﬁâﬁ®ﬁÇﬁ∞ﬁàﬁ¶ﬁÉﬁ™</label>
                           <select id="examPortion" onchange="calcExam()">
                               <option value="whole">ﬁâﬁ™ﬁÖﬁ®</option>
                               <option value="half">1/2</option>
                           </select>
                       </div>
                   </div>
                   <div style="display:flex; justify-content:space-between; align-items:center; background:#eee; padding:10px; border-radius:8px; margin-bottom:10px;">
                       <h2 id="examTotal" style="margin:0; color:blue;">0%</h2>
                       <button class="btn btn-green" onclick="calcExam()">Calculate</button>
                   </div>
                </div>

                <button class="btn btn-green" style="width:100%; margin-top:15px; padding:12px;" onclick="saveRecord()">üíæ ﬁêﬁ≠ﬁàﬁ∞</button>
            </div>

            <!-- HISTORY -->
            <div id="historyArea" style="margin-top:10px; display:none;">
                <h4 style="color:#555;">ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨ ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ﬁåﬁ¶ﬁáﬁ∞</h4>
                <div id="historyContainer"></div>
            </div>
        </div>

        <!-- MUSHAF -->
        <div class="mushaf-panel" id="mushafPanel">
            <div class="mushaf-header">
                <button class="btn btn-red" style="position:absolute; left:10px; padding:5px 10px;" onclick="toggleMushaf(false)">√ó</button>
                <div id="mushafInfoDisplay" style="margin-top:10px; font-weight:bold; color:#f1c40f;">---</div>
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <button class="btn btn-grey" onclick="changePage(1)">></button>
                    <input type="number" id="navPage" style="width:50px; text-align:center;" onchange="loadMushaf(this.value)">
                    <button class="btn btn-grey" onclick="changePage(-1)"><</button>
                </div>
            </div>
            <div class="mushaf-container">
                <div class="mushaf-wrapper" id="mushafWrapper" onclick="onImageClick(event)">
                    <img id="mushafImg" class="mushaf-page-img" src="">
                </div>
            </div>
        </div>
    </div>

    <!-- STUDENT DASHBOARD -->
    <div id="student-dashboard">
        <div style="padding:20px; max-width:800px; margin:0 auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color:var(--primary-color);">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</h2>
                <button class="btn btn-red" onclick="logout()">Logout</button>
            </div>
            
            <div class="student-header-banner">
                <h2 id="stWelcomeName" style="margin:0;">Welcome</h2>
                <div id="stWelcomeID" style="background:rgba(255,255,255,0.2); display:inline-block; padding:2px 8px; border-radius:4px; margin-top:5px;"></div>
            </div>

            <div id="stHistoryContainer" style="margin-top:20px;"></div>
        </div>

        <!-- Student Mushaf Modal -->
        <div id="stMushafModal" class="modal">
            <div class="modal-content" style="width:100%; height:100%; max-width:100%; border-radius:0;">
                <div class="modal-header" style="background:#2c3e50; color:white;">
                    <h3>ﬁÜﬁ™ﬁÅﬁ∞ ﬁäﬁßﬁÄﬁ¶ﬁéﬁ¶ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁéﬁÆﬁåﬁ∞</h3>
                    <button class="btn btn-red" onclick="document.getElementById('stMushafModal').style.display='none'">ﬁÑﬁ¶ﬁÇﬁ∞ﬁãﬁ™</button>
                </div>
                <div class="modal-body" style="background:#333; display:flex; justify-content:center; align-items:center; padding:0;">
                    <div style="position:relative; display:inline-block;" id="stMushafWrapper">
                        <img id="stMushafImg" style="max-width:100%; max-height:90vh;">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SETTINGS MODAL -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Simple Tabs -->
                <div style="display:flex; margin-bottom:15px; border-bottom:1px solid #eee;">
                    <div style="flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:bold; border-bottom:3px solid var(--primary-color);" onclick="alert('Student Import Tab')">ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</div>
                    <div style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#999;" onclick="alert('Class Tab')">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞</div>
                    <div style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#999;" onclick="alert('Backup Tab')">ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞</div>
                </div>
                
                <label>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                <select id="modalClassSelect" class="class-select" style="width:100%; margin-bottom:10px;"></select>
                <textarea id="bulkStudents" placeholder="Name IUM123 (New line each)" style="width:100%; height:100px; padding:10px; border:1px solid #ddd; border-radius:8px;"></textarea>
                <button class="btn btn-green" style="width:100%; margin-top:10px;" onclick="importStudents()">Add Students</button>
            </div>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    // *** IMPORTANT: PASTE YOUR CONFIG HERE ***
    const firebaseConfig = {
      apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
      authDomain: "hifz-cde3b.firebaseapp.com",
      databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
      projectId: "hifz-cde3b",
      storageBucket: "hifz-cde3b.firebasestorage.app",
      messagingSenderId: "566754658580",
      appId: "1:566754658580:web:d63d0f167960f53bab9a01"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch(e) { console.error(e); }

    // --- GLOBALS ---
    const surahNames = ["ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©","ÿßŸÑÿ®ŸÇÿ±ÿ©","ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ","ÿßŸÑŸÜÿ≥ÿßÿ°","ÿßŸÑŸÖÿßÿ¶ÿØÿ©","ÿßŸÑÿ£ŸÜÿπÿßŸÖ","ÿßŸÑÿ£ÿπÿ±ÿßŸÅ","ÿßŸÑÿ£ŸÜŸÅÿßŸÑ","ÿßŸÑÿ™Ÿàÿ®ÿ©","ŸäŸàŸÜÿ≥","ŸáŸàÿØ","ŸäŸàÿ≥ŸÅ","ÿßŸÑÿ±ÿπÿØ","ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ","ÿßŸÑÿ≠ÿ¨ÿ±","ÿßŸÑŸÜÿ≠ŸÑ","ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°","ÿßŸÑŸÉŸáŸÅ","ŸÖÿ±ŸäŸÖ","ÿ∑Ÿá","ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°","ÿßŸÑÿ≠ÿ¨","ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ","ÿßŸÑŸÜŸàÿ±","ÿßŸÑŸÅÿ±ŸÇÿßŸÜ","ÿßŸÑÿ¥ÿπÿ±ÿßÿ°","ÿßŸÑŸÜŸÖŸÑ","ÿßŸÑŸÇÿµÿµ","ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™","ÿßŸÑÿ±ŸàŸÖ","ŸÑŸÇŸÖÿßŸÜ","ÿßŸÑÿ≥ÿ¨ÿØÿ©","ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®","ÿ≥ÿ®ÿ£","ŸÅÿßÿ∑ÿ±","Ÿäÿ≥","ÿßŸÑÿµÿßŸÅÿßÿ™","ÿµ","ÿßŸÑÿ≤ŸÖÿ±","ÿ∫ÿßŸÅÿ±","ŸÅÿµŸÑÿ™","ÿßŸÑÿ¥Ÿàÿ±Ÿâ","ÿßŸÑÿ≤ÿÆÿ±ŸÅ","ÿßŸÑÿØÿÆÿßŸÜ","ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©","ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ","ŸÖÿ≠ŸÖÿØ","ÿßŸÑŸÅÿ™ÿ≠","ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™","ŸÇ","ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™","ÿßŸÑÿ∑Ÿàÿ±","ÿßŸÑŸÜÿ¨ŸÖ","ÿßŸÑŸÇŸÖÿ±","ÿßŸÑÿ±ÿ≠ŸÖŸÜ","ÿßŸÑŸàÿßŸÇÿπÿ©","ÿßŸÑÿ≠ÿØŸäÿØ","ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©","ÿßŸÑÿ≠ÿ¥ÿ±","ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©","ÿßŸÑÿ∂ŸÅ","ÿßŸÑÿ¨ŸÖÿπÿ©","ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ","ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ","ÿßŸÑÿ∑ŸÑÿßŸÇ","ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ","ÿßŸÑŸÖŸÑŸÉ","ÿßŸÑŸÇŸÑŸÖ","ÿßŸÑÿÆÿßŸÇÿ©","ÿßŸÑŸÖÿπÿßÿ±ÿ¨","ŸÜŸàÿ≠","ÿßŸÑÿ¨ŸÜ","ÿßŸÑŸÖÿ≤ŸÖŸÑ","ÿßŸÑŸÖÿØÿ´ÿ±","ÿßŸÑŸÇŸäÿßŸÖÿ©","ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ","ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™","ÿßŸÑŸÜÿ®ÿ£","ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™","ÿπÿ®ÿ≥","ÿßŸÑÿ™ŸÉŸàŸäÿ±","ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±","ÿßŸÑÿ∑ŸÅŸäŸÅŸäŸÜ","ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ","ÿßŸÑÿ®ÿ±Ÿàÿ¨","ÿßŸÑÿ∑ÿßÿ±ŸÇ","ÿßŸÑÿ£ÿπŸÑŸâ","ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©","ÿßŸÑŸÅÿ¨ÿ±","ÿßŸÑÿ®ŸÑÿØ","ÿßŸÑÿ¥ŸÖÿ≥","ÿßŸÑŸÑŸäŸÑ","ÿßŸÑÿ∂ÿ≠Ÿâ","ÿßŸÑÿ¥ÿ±ÿ≠","ÿßŸÑÿ™ŸäŸÜ","ÿßŸÑÿπŸÑŸÇ","ÿßŸÑŸÇÿØÿ±","ÿßŸÑÿ®ŸäŸÜÿ©","ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©","ÿßŸÑÿπÿßÿØŸäÿßÿ™","ÿßŸÑŸÇÿßÿ±ÿπÿ©","ÿßŸÑÿ™ŸÉÿßÿ´ÿ±","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸÅŸäŸÑ","ŸÇÿ±Ÿäÿ¥","ÿßŸÑŸÖÿßÿπŸàŸÜ","ÿßŸÑŸÉŸàÿ´ÿ±","ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ","ÿßŸÑŸÜÿµÿ±","ÿßŸÑŸÖÿ≥ÿØ","ÿßŸÑÿ•ÿÆŸÑÿßÿµ","ÿßŸÑŸÅŸÑŸÇ","ÿßŸÑŸÜÿßÿ≥"];
    let classes = {};
    let records = [];
    let users = {};
    
    let currentClass = "";
    let currentStudent = null;
    let currentActiveSection = 'new';
    let currentPage = 1;
    let sessionDots = [];
    
    // --- HELPER: Parse ID ---
    function parseStudentInfo(fullString) {
        let name = fullString;
        let id = "";
        
        // Handle IUM pattern
        if(fullString && fullString.toUpperCase().includes("IUM")) {
            const parts = fullString.split(/IUM/i);
            name = parts[0].trim().replace(/[-‚Äì,]/g, '');
            id = "IUM" + parts[1].trim();
        } else if (fullString && fullString.includes('(')) {
            const parts = fullString.split('(');
            name = parts[0].trim();
            id = parts[1].replace(')', '').trim();
        }
        return { name, id };
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        populateSurahSelects();
        document.getElementById('entryDate').valueAsDate = new Date();
        
        // Dynamic Form generation for Short/Long
        generateExtraForms();

        if(db) {
            db.ref('classes').on('value', snap => {
                classes = snap.val() || {};
                refreshDropdowns();
                updateDashboardStats();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            });
            db.ref('records').on('value', snap => {
                records = [];
                const data = snap.val();
                if(data) Object.keys(data).forEach(k => records.push({...data[k], key: k}));
                if(currentStudent) {
                    if(document.getElementById('teacher-dashboard').style.display === 'flex') renderTeacherHistory();
                    if(document.getElementById('student-dashboard').style.display === 'flex') stFilterHistory('all');
                }
                updateDashboardStats();
            });
            db.ref('users').on('value', snap => { users = snap.val() || {}; });
        }
    });

    // Helper to generate HTML for Short/Long to reduce code duplication
    function generateExtraForms() {
        const container = document.getElementById('extra-forms-container');
        ['short', 'long'].forEach(sec => {
            const label = sec === 'short' ? 'üîÑ ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß' : 'üìö ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß';
            const colorClass = 'sec-' + sec;
            
            const html = `
            <div id="form-${sec}" style="display:none; margin-top:10px;">
                <div class="form-row">
                    <div style="flex:1"><label>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="${sec}Page" placeholder="#" onchange="handlePageChange(this.value, '${sec}')" style="text-align:center; font-weight:bold;"></div>
                    <div style="flex:2"><label>ﬁäﬁ¨ﬁÅﬁ≠</label><div style="display:flex; gap:2px;"><select id="${sec}Surah" class="arabic-input" style="flex:1"><option>...</option></select><input type="number" id="${sec}Start" placeholder="ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞" style="flex:0.6"></div></div>
                    <div style="flex:2"><label>ﬁÇﬁ®ﬁâﬁ≠</label><div style="display:flex; gap:2px;"><select id="${sec}EndSurah" class="arabic-input" style="flex:1"><option>...</option></select><input type="number" id="${sec}End" placeholder="ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞" style="flex:0.6"></div></div>
                    <div style="flex:1"><label>ﬁÜﬁ™ﬁÅﬁ∞</label>
                        <div class="mistake-input-group">
                            <button class="mistake-btn" onclick="adjM('${sec}Mistakes',1)">+</button>
                            <input id="${sec}Mistakes" class="mistake-val" value="0" readonly>
                            <button class="mistake-btn" onclick="adjM('${sec}Mistakes',-1)">-</button>
                        </div>
                    </div>
                </div>
            </div>`;
            container.innerHTML += html;
        });
        populateSurahSelects(); // Re-run to populate new selects
    }

    function populateSurahSelects() {
        ['new', 'short', 'long'].forEach(sec => {
            ['Surah', 'EndSurah'].forEach(pos => {
                const sel = document.getElementById(sec + pos);
                if(sel && sel.options.length <= 1) {
                    surahNames.forEach((s, i) => {
                        let opt = document.createElement('option');
                        opt.value = i+1; opt.innerText = (i+1)+". "+s;
                        sel.appendChild(opt);
                    });
                }
            });
        });
    }

    // --- LOGIN LOGIC ---
    function loginTeacher() {
        if(prompt("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞:") === "1234") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('teacher-dashboard').classList.add('dashboard-active');
            updateDashboardStats();
        } else { alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®"); }
    }

    function showStudentLogin() {
        document.getElementById('roleSelection').style.display = 'none';
        document.getElementById('studentLoginForm').style.display = 'block';
    }

    function processStudentLogin() {
        const idInput = document.getElementById('stLoginId').value.trim().toUpperCase();
        let pass = document.getElementById('stLoginPass').value.trim();
        
        if(!idInput) return alert("ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁñﬁ¶ﬁÄﬁß");

        // 1. Find ID in classes
        let foundStudentName = "";
        let foundClass = "";
        
        Object.keys(classes).forEach(cls => {
            (classes[cls].students || []).forEach(s => {
                const info = parseStudentInfo(s);
                // Flexible matching: check if input matches parsed ID OR matches full string if no ID parsed
                if((info.id && info.id.toUpperCase() === idInput) || s.toUpperCase() === idInput) {
                    foundStudentName = s;
                    foundClass = cls;
                }
            });
        });

        if(!foundStudentName) return alert("ﬁâﬁ® ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÉﬁ¶ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©ﬁàﬁ¨ﬁäﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞");

        // 2. Auth Logic
        if(!users[idInput]) {
            // First time login with default password
            if(pass === "1234") {
                db.ref('users/' + idInput).set("1234");
            } else {
                return alert("ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁäﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ ﬁàﬁ¶ﬁÇﬁ∞ﬁÇﬁ¶ﬁáﬁ®ﬁÉﬁ™ ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ¶ﬁÜﬁ©: 1234");
            }
        } else {
            if(users[idInput] !== pass) return alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®");
        }

        currentStudent = foundStudentName;
        currentClass = foundClass;
        
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('student-dashboard').classList.add('dashboard-active');
        initStudentDashboard();
    }

    function logout() { location.reload(); }
    function toggleSidebar() { document.getElementById('teacherSidebar').classList.toggle('open'); }

    // --- DASHBOARD LOGIC ---
    function refreshDropdowns() {
        const sel = document.getElementById('classSelect');
        const modalSel = document.getElementById('modalClassSelect');
        [sel, modalSel].forEach(s => s.innerHTML = '');
        
        Object.keys(classes).forEach(c => {
            [sel, modalSel].forEach(s => s.innerHTML += `<option value="${c}">${c}</option>`);
        });
        
        if(Object.keys(classes).length > 0 && !currentClass) switchClass(Object.keys(classes)[0]);
    }

    function switchClass(cls) {
        currentClass = cls;
        document.getElementById('currentClassDisplay').innerText = "Class: " + cls;
        
        const list = document.getElementById('studentListContainer');
        list.innerHTML = '';
        currentStudent = null;
        document.getElementById('entryFormArea').style.display = 'none';
        document.getElementById('historyArea').style.display = 'none';
        document.getElementById('dashboardStats').style.display = 'flex';
        document.getElementById('studentHeader').innerText = "ﬁëﬁ≠ﬁùﬁ∞ﬁÑﬁØﬁëﬁ∞";
        document.getElementById('studentHeaderId').innerHTML = "";

        // Render Student List with Cards
        (classes[cls]?.students || []).forEach(s => {
            const info = parseStudentInfo(s);
            let div = document.createElement('div');
            div.className = 'student-card';
            // Initials for avatar
            const initials = info.name.substring(0,2).toUpperCase();
            
            div.innerHTML = `
                <div class="st-avatar">${initials}</div>
                <div class="st-info">
                    <span class="st-name">${info.name}</span>
                    ${info.id ? `<span class="st-id">${info.id}</span>` : ''}
                </div>
            `;
            div.onclick = () => selectTeacherStudent(s, div);
            list.appendChild(div);
        });
    }

    function selectTeacherStudent(fullString, cardEl) {
        currentStudent = fullString;
        const info = parseStudentInfo(fullString);
        
        document.querySelectorAll('.student-card').forEach(b => b.classList.remove('active'));
        if(cardEl) cardEl.classList.add('active');
        
        document.getElementById('studentHeader').innerText = info.name;
        document.getElementById('studentHeaderId').innerHTML = info.id ? `<span class="id-badge" style="background:#eafaf1; color:#27ae60;">${info.id}</span>` : "";
        
        document.getElementById('dashboardStats').style.display = 'none';
        document.getElementById('entryFormArea').style.display = 'block';
        document.getElementById('historyArea').style.display = 'block';

        if(window.innerWidth <= 768) document.getElementById('teacherSidebar').classList.remove('open');

        clearForm();
        sessionDots = [];
        // Auto fill would go here
        renderTeacherHistory();
    }

    function updateDashboardStats() {
        let totalStudents = 0;
        Object.values(classes).forEach(c => totalStudents += (c.students || []).length);
        document.getElementById('statTotalStudents').innerText = totalStudents;
        document.getElementById('statTotalClasses').innerText = Object.keys(classes).length;
        
        // Count today's records
        const today = new Date().toISOString().split('T')[0];
        const todayCount = records.filter(r => r.date === today).length;
        document.getElementById('statTodayCount').innerText = todayCount;
    }

    function filterStudents(query) {
        const term = query.toLowerCase();
        document.querySelectorAll('.student-card').forEach(card => {
            const text = card.innerText.toLowerCase();
            card.style.display = text.includes(term) ? 'flex' : 'none';
        });
    }

    // --- FORM INTERACTION ---
    function setActiveSection(sec) {
        currentActiveSection = sec;
        
        // Highlight Headers
        document.querySelectorAll('.section-header').forEach(h => h.classList.remove('sec-active'));
        if(document.getElementById('sec-'+sec)) document.getElementById('sec-'+sec).classList.add('sec-active');
        
        // Show/Hide Forms
        document.querySelectorAll('.form-active').forEach(f => f.style.display = 'none');
        if(document.getElementById('form-'+sec)) document.getElementById('form-'+sec).style.display = 'block';
        
        // Radio Sync
        const rad = document.querySelector(`input[name="activeSec"][value="${sec}"]`);
        if(rad) rad.checked = true;

        sessionDots = [];
        clearDots();
    }

    function toggleFormSection(val) {
        document.getElementById('container-daily').style.display = val === 'daily' ? 'block' : 'none';
        document.getElementById('container-exam').style.display = val === 'exam' ? 'block' : 'none';
        setActiveSection(val === 'daily' ? 'new' : 'exam');
    }

    // --- MUSHAF & MISTAKES ---
    function loadMushaf(p) {
        if(!p) return;
        currentPage = parseInt(p);
        document.getElementById('navPage').value = currentPage;
        document.getElementById('mushafImg').src = `https://android.quran.com/data/width_1260/page${currentPage.toString().padStart(3,'0')}.png`;
        clearDots();
        sessionDots.forEach(d => { if(d.page == p) drawDot(d.x, d.y, true); });
    }
    
    function changePage(d) { loadMushaf(parseInt(currentPage) + d); }
    function toggleMushaf(show) { 
        const p = document.getElementById('mushafPanel');
        if(show === undefined) p.classList.toggle('open');
        else if(show) p.classList.add('open');
        else p.classList.remove('open');
        
        // Desktop toggle width
        if(window.innerWidth > 768) {
             p.style.width = (p.style.width === '35%') ? '0px' : '35%';
        }
    }

    function onImageClick(e) {
        if(document.body.classList.contains('parent-mode')) return; 
        const rect = document.getElementById('mushafWrapper').getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        sessionDots.push({x, y, page: currentPage});
        adjM(currentActiveSection + 'Mistakes', 1);
        drawDot(x, y, true);
    }

    function drawDot(x, y, isClickable) {
        const dot = document.createElement('div');
        dot.className = 'mistake-dot';
        dot.style.left = x + 'px'; dot.style.top = y + 'px';
        if(isClickable) {
            dot.onclick = (e) => {
                e.stopPropagation();
                dot.remove();
                sessionDots = sessionDots.filter(d => d.x !== x && d.y !== y);
                adjM(currentActiveSection + 'Mistakes', -1);
            };
        }
        document.getElementById('mushafWrapper').appendChild(dot);
    }

    function clearDots() { document.querySelectorAll('#mushafWrapper .mistake-dot').forEach(d => d.remove()); }
    function adjM(id, val) {
        const el = document.getElementById(id);
        if(el) el.value = Math.max(0, parseInt(el.value || 0) + val);
    }

    function handlePageChange(page, section) {
        if(!page) return;
        loadMushaf(page);
        // Here you would add API fetch for verses
    }

    // --- SAVE & HISTORY ---
    function saveRecord() {
        if(!currentStudent) return alert("Select a student");
        const type = document.getElementById('lessonType').value;
        
        let record = {
            id: Date.now(),
            date: document.getElementById('entryDate').value,
            class: currentClass,
            student: currentStudent,
            type: type
        };

        if(type === 'daily') {
            const sec = currentActiveSection; 
            const sVal = document.getElementById(sec+'Surah').value;
            if(sVal === "..." || !sVal) return alert("Select Surah");

            record[sec] = {
                s: surahNames[parseInt(sVal)-1],
                st: document.getElementById(sec+'Start').value,
                en: document.getElementById(sec+'End').value,
                m: document.getElementById(sec+'Mistakes').value,
                dots: sessionDots 
            };
        } else {
            // Exam saving logic...
            record.juzu = document.getElementById('examJuzu').value;
            record.scores = { total: document.getElementById('examTotal').innerText };
        }

        db.ref('records').push(record);
        alert("Saved!");
        sessionDots = [];
        clearDots();
        if(type === 'daily') document.getElementById(currentActiveSection+'Mistakes').value = 0;
    }

    function renderTeacherHistory() {
        const div = document.getElementById('historyContainer');
        div.innerHTML = '';
        const myRecs = records.filter(r => r.class === currentClass && r.student === currentStudent);
        myRecs.sort((a,b) => new Date(b.date) - new Date(a.date));

        myRecs.forEach(r => {
            let html = `<div class="history-card ${r.type==='exam'?'card-exam':'card-new'}">
                <div class="card-header">
                    <span>üìÖ ${r.date}</span>
                    <button onclick="if(confirm('Delete?')) db.ref('records/${r.key}').remove()" style="color:red;border:none;">&times;</button>
                </div>`;
            
            if(r.type === 'daily') {
                ['new', 'short', 'long'].forEach(sec => {
                    if(r[sec]) {
                         const secName = sec === 'new' ? 'ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™' : sec === 'short' ? 'ﬁÜﬁ™ﬁÉﬁ™' : 'ﬁãﬁ®ﬁéﬁ™';
                         html += `<div style="font-size:14px; margin-top:5px;">
                            <strong>${secName}:</strong> ${r[sec].s} ${r[sec].st}-${r[sec].en} 
                            <span style="color:red">(${r[sec].m} mistakes)</span>
                         </div>`;
                    }
                });
            } else {
                html += `<div>Exam: ${r.juzu} - ${r.scores.total}</div>`;
            }
            html += `</div>`;
            div.innerHTML += html;
        });
    }

    // --- STUDENT VIEW ---
    function initStudentDashboard() {
        const info = parseStudentInfo(currentStudent);
        document.getElementById('stWelcomeName').innerText = info.name;
        document.getElementById('stWelcomeID').innerHTML = info.id;
        
        const div = document.getElementById('stHistoryContainer');
        div.innerHTML = '';
        const myRecs = records.filter(r => r.class === currentClass && r.student === currentStudent);
        myRecs.sort((a,b) => new Date(b.date) - new Date(a.date));

        myRecs.forEach(r => {
             let content = '';
             if(r.type === 'daily') {
                 ['new', 'short', 'long'].forEach(sec => {
                     if(r[sec]) {
                         const dotsData = encodeURIComponent(JSON.stringify(r[sec].dots || []));
                         const secName = sec === 'new' ? 'ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™' : sec === 'short' ? 'ﬁÜﬁ™ﬁÉﬁ™' : 'ﬁãﬁ®ﬁéﬁ™';
                         content += `
                         <div style="background:#f9f9f9; padding:10px; margin-top:5px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                             <div>${secName}: ${r[sec].s} <span style="color:red;">(${r[sec].m})</span></div>
                             ${r[sec].dots ? `<button class="btn btn-blue" style="padding:5px 10px; font-size:12px;" onclick="stOpenMushaf('${dotsData}')">üëÅÔ∏è</button>` : ''}
                         </div>`;
                     }
                 });
             } else {
                 content = `<div style="padding:10px;">üèÜ ${r.juzu} - ${r.scores.total}</div>`;
             }
             if(content) {
                 div.innerHTML += `<div class="history-card"><div class="card-header">${r.date}</div>${content}</div>`;
             }
        });
    }

    window.stOpenMushaf = function(dataStr) {
        const dots = JSON.parse(decodeURIComponent(dataStr));
        if(!dots || dots.length === 0) return alert("ﬁÜﬁ™ﬁÅﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞");
        const page = dots[0].page;
        document.getElementById('stMushafImg').src = `https://android.quran.com/data/width_1260/page${page.toString().padStart(3,'0')}.png`;
        const wrapper = document.getElementById('stMushafWrapper');
        while(wrapper.children.length > 1) { wrapper.removeChild(wrapper.lastChild); }
        dots.forEach(d => {
            if(d.page == page) {
                let dot = document.createElement('div');
                dot.className = 'mistake-dot readonly';
                dot.style.left = d.x + 'px'; dot.style.top = d.y + 'px';
                wrapper.appendChild(dot);
            }
        });
        document.getElementById('stMushafModal').style.display = 'flex';
    }

    // --- MODAL FUNCS (Simplified for brevity) ---
    function openModal() { document.getElementById('classModal').style.display='flex'; document.getElementById('modalClassSelect').innerHTML = document.getElementById('classSelect').innerHTML; }
    function closeModal() { document.getElementById('classModal').style.display='none'; }
    function importStudents() {
        const c = document.getElementById('modalClassSelect').value;
        const txt = document.getElementById('bulkStudents').value;
        const list = txt.split('\n').filter(x=>x.trim());
        const old = classes[c]?.students || [];
        db.ref('classes/'+c+'/students').set([...new Set([...old, ...list])]);
        alert('Added');
    }

    // Calculator & Timer functions would go here (same as V8)
    function startTimer() { /*...*/ }
    function stopTimer() { /*...*/ }
    function calcExam() { 
        // Simplified Logic for Demo
        let score = 100 - (parseInt(document.getElementById('examTMistakes').value||0)*2);
        document.getElementById('examTotal').innerText = score + "%";
    }

</script>
</body>
</html>
