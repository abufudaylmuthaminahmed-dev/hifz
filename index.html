<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ•ÿ™ŸÇÿßŸÜ - Hifz Program (Final V3)</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@700&display=swap');

        @font-face { font-family: 'Faruma'; src: local('Faruma'), url('faruma.ttf') format('truetype'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'MV Waheed'; src: local('MV Waheed'), url('mvwaheed.ttf') format('truetype'); font-weight: normal; font-style: normal; }

        :root {
            --primary: #2c3e50; 
            --accent: #27ae60;
            --accent-rev: #e67e22;
            --mistake: #e74c3c;
            --bg-light: #f8f9fa;
            --mushaf-paper: #fffcf2;
            --st-primary: #117a65;
            
            --font-main: 'Faruma', 'Noto Sans Thaana', sans-serif;
            --font-heading: 'MV Waheed', 'Noto Sans Thaana', sans-serif; 
            --font-arabic: 'Amiri', serif;
        }

        * { box-sizing: border-box; }
        body { font-family: var(--font-main); margin: 0; height: 100vh; color: #333; background-color: var(--bg-light); overflow: hidden; transition: background 0.3s; }
        
        body.student-mode { background-color: #e8f6f3; }
        body.student-mode .app-header { border-bottom: 3px solid var(--st-primary); }
        body.student-mode .header-title { color: var(--st-primary); }

        .hidden { display: none !important; }
        .container { width: 100%; padding: 20px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.3s ease; height: calc(100vh - 65px); overflow-y: auto; }

        .app-header { background: white; height: 65px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header-title { font-family: var(--font-heading); font-size: 24px; color: var(--primary); }
        .icon-btn { background: #f0f2f5; border: none; width: 42px; height: 42px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; color: #333; }
        .logout-btn { background: #fee2e2; color: #b91c1c; }

        .login-wrapper { display: flex; align-items: center; justify-content: center; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; background: #ecf0f1; z-index: 2000; overflow-y: auto; }
        .login-card { background: white; padding: 50px 40px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; border-top: 5px solid var(--primary); }
        
        .logo-container { margin-bottom: 30px; }
        .logo-arabic { font-family: 'Amiri', 'Reem Kufi', serif; font-size: 80px; color: var(--primary); line-height: 1.1; margin-bottom: 5px; text-shadow: 2px 2px 0px #eee; font-weight: 700; }
        .logo-eng { font-family: sans-serif; font-size: 16px; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 10px; }
        .logo-dv { font-family: var(--font-heading); font-size: 22px; color: #7f8c8d; margin-top: 5px; }

        .tabs { display: flex; background: #eee; padding: 5px; border-radius: 50px; margin: 20px 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; font-family: var(--font-heading); font-size: 16px; border-radius: 40px; color: #777; transition:0.3s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; }
        .form-input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 10px; font-family: var(--font-main); font-size: 16px; margin-bottom: 15px; text-align: right; outline: none; transition: 0.3s; }
        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-family: var(--font-heading); font-size: 18px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; justify-content: center; }
        .card-btn { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; min-height: 160px; position: relative; }
        .card-btn:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .card-icon { font-size: 40px; width: 70px; height: 70px; background: #f4f6f8; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .card-title { font-size: 18px; font-weight: bold; color: var(--primary); margin: 0; }
        .card-sub { font-size: 13px; color: #7f8c8d; }
        .dashboard-center { display: flex; gap: 20px; justify-content: center; margin-top: 40px; flex-wrap: wrap; }
        .dashboard-center .card-btn { width: 250px; }

        .student-detail-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; transition: 0.2s; }
        .student-detail-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .st-card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 10px; }
        .st-name { font-family: var(--font-heading); font-size: 18px; color: var(--primary); }
        .st-id { background: #ecf0f1; padding: 2px 8px; border-radius: 8px; font-size: 12px; color: #7f8c8d; font-weight: bold; }
        .st-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: #555; }
        .st-info-item { display: flex; justify-content: space-between; }
        .st-info-label { color: #999; }
        .st-remarks-box { margin-top: 10px; background: #fffcf2; padding: 8px; border-radius: 5px; font-size: 12px; border: 1px solid #fae5d3; color: #d35400; }
        .st-footer-actions { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* Updated Student Stats & Target */
        .student-stat-container { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e0e0e0; }
        .st-stats-grid { display: flex; justify-content: space-around; align-items: center; margin-bottom: 15px; }
        .st-stat-item { text-align: center; flex: 1; border-left: 1px solid #eee; }
        .st-stat-item:last-child { border-left: none; }
        .st-stat-val { font-size: 28px; font-weight: bold; line-height: 1; margin-bottom: 5px; font-family: var(--font-arabic); }
        .st-stat-lbl { font-size: 13px; color: #777; font-weight: 500; }
        
        .target-box { background: #fdfefe; border-top: 1px solid #eee; padding-top: 15px; }
        .target-header { display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px; font-weight:bold; color:#555; }
        .progress-bar-bg { background:#eee; height:15px; border-radius:10px; overflow:hidden; }
        .progress-bar-fill { height:100%; background: linear-gradient(90deg, #f1c40f, #2ecc71); width:0%; transition: width 1s ease-in-out; border-radius:10px; }
        .target-msg { font-size:12px; color:#777; text-align:center; margin-top:5px; }

        .big-btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-size: 16px; font-family: var(--font-heading); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 5px; transition:0.2s; }
        .big-btn:hover { transform: scale(1.05); }
        .btn-orange { background: #e67e22; } .btn-green { background: #27ae60; } .btn-red { background: #c0392b; }

        .action-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        @media (min-width: 600px) { .menu-grid { grid-template-columns: repeat(3, 1fr); } }
        .menu-btn { background: white; padding: 25px; border-radius: 15px; border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; transition: 0.2s; }
        .menu-btn:hover { border-color: var(--primary); transform: translateY(-3px); }
        .menu-icon { font-size: 35px; width: 70px; height: 70px; background: #f4f6f8; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .hist-card { background: white; width: 100%; margin-bottom: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #e0e0e0; cursor: pointer; transition:0.2s; position: relative; }
        .hist-card:active { transform: scale(0.99); }
        .hist-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .hist-title { font-weight: bold; font-size: 20px; color: var(--primary); }
        .hist-date { font-family: sans-serif; font-size: 14px; color: #555; background: #e0e0e0; padding: 4px 10px; border-radius: 15px; font-weight: bold; }
        .hist-body { padding: 20px; }
        
        .hist-detail-row { display:flex; justify-content:space-between; background:#f4f6f8; padding:10px; border-radius:8px; margin-bottom:10px; align-items: center;}
        .hist-detail-lbl { font-size:14px; font-weight:bold; color:var(--primary); min-width: 60px;}
        .hist-detail-val { font-family: var(--font-arabic); font-size:18px; color:#333; text-align:left; direction:rtl; flex:1;}
        .hist-detail-pg { font-size:16px; font-weight:bold; background:var(--accent); color:white; padding:3px 10px; border-radius:15px; margin-right:10px;}
        .hist-badge-external { background: #8e44ad; color: white; padding: 5px 15px; border-radius: 20px; font-size: 13px; text-align: center; margin-bottom: 15px; font-weight:bold;}

        .hist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .hist-item { text-align: center; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #f0f0f0; }
        .hist-label { font-size: 12px; color: #7f8c8d; display: block; margin-bottom: 2px; }
        .hist-val { font-size: 16px; font-weight: bold; color: #333; font-family: var(--font-arabic); }

        .hist-footer { padding: 15px; background: #eafaf1; text-align: center; border-top: 1px solid #d5f5e3; font-size: 20px; font-weight: bold; color: var(--accent); position: relative; }
        .hist-footer.exam-score { background: #ebf5fb; border-top: 1px solid #d6eaf8; color: #2980b9; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px;}
        .hist-card.type-new_lesson { border-right: 5px solid var(--accent); }
        .hist-card.type-juz_exam { border-right: 5px solid #2980b9; }
        .hist-card.type-final_exam { border-right: 5px solid #c0392b; }

        .btn-edit-hist, .btn-delete-hist, .btn-action-sm { width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-delete-hist { background: #fee2e2; color: #c0392b; } .btn-edit-hist { background: #e3f2fd; color: #2980b9; }
        .btn-delete-hist.abs-pos { position:absolute; top:15px; left:15px; }
        .btn-edit-hist.abs-pos { position:absolute; top:15px; left:60px; }

        .approval-card { background: white; border-radius: 12px; border: 1px solid #e0e0e0; border-right: 5px solid #e67e22; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; }
        .app-card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .app-stu-name { font-weight: bold; font-size: 16px; color: var(--primary); }
        .app-date { background: #f0f2f5; color: #555; font-size: 12px; padding: 3px 8px; border-radius: 10px; }
        .app-details { background: #fffcf2; padding: 10px; border-radius: 8px; text-align: center; font-size: 15px; color: #333; line-height: 1.6;}
        .app-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 5px; }
        .btn-approve { background: #d4efdf; color: #1e8449; padding: 8px 15px; border-radius: 20px; border:none; cursor: pointer; font-weight: bold; }
        .btn-reject { background: #fadbd8; color: #c0392b; padding: 8px 15px; border-radius: 20px; border:none; cursor: pointer; font-weight: bold; }

        /* MUSHAF LAYOUT FIXES */
        .layout-split { display: flex; height: calc(100vh - 65px); overflow: hidden; }
        .sidebar-panel { width: 350px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; z-index: 10; padding: 20px; box-shadow: -5px 0 20px rgba(0,0,0,0.05); flex-shrink: 0; }
        .main-panel { flex: 1; background: var(--mushaf-paper); position: relative; display: flex; flex-direction: column; overflow: hidden; padding: 10px; }

        .mushaf-top-bar { display: none !important; } /* Hide top bar as requested */
        
        .mushaf-page { 
            flex-grow: 1; 
            background: white; 
            padding: 10px 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            border-radius: 8px; 
            margin: 0 auto; 
            overflow-y: auto; /* Internal scrolling only */
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
        }

        .quran-text { 
            font-family: var(--font-arabic); 
            font-size: clamp(22px, 4vw, 30px); 
            line-height: 2.2; 
            text-align: justify; 
            text-align-last: center; 
            flex-grow: 1;
        }
        
        .quran-block { margin-bottom: 20px; }
        
        .surah-header-box {
            border: 2px solid #d4ac6e;
            background: #fffcf2;
            background-image: linear-gradient(to right, #fffcf2, #fdf2d0, #fffcf2);
            padding: 5px;
            margin: 20px 0 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .surah-title {
            font-family: 'Reem Kufi', var(--font-arabic);
            font-size: 28px;
            color: #5d4037;
            text-shadow: 1px 1px 0 #fff;
        }
        .bismillah-box {
            text-align: center;
            font-family: var(--font-arabic);
            font-size: 24px;
            margin: 10px 0 20px 0;
            color: #555;
        }

        .word { cursor: pointer; border-radius: 4px; padding: 2px 1px; transition: background 0.1s; }
        .word:hover { background: rgba(0,0,0,0.05); }
        .word.mistake { background-color: var(--mistake); color: white; }
        .ayah-marker { color: #d4ac6e; font-weight: bold; font-family: var(--font-arabic); display: inline-block; margin: 0 5px; }
        
        .mushaf-nav { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 10px; 
            width: 100%; 
            max-width: 800px; 
            padding: 5px; 
            flex-shrink: 0; 
            align-self: center;
        }
        .nav-btn { background: #34495e; color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-size: 24px; font-weight: bold; font-family: var(--font-main) !important; }

        .score-header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 15px; }
        .big-score { font-size: 40px; font-weight: bold; }
        .score-control { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #f8f9fa; padding: 10px; border-radius: 10px; }
        .ctrl-btn { width: 35px; height: 35px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-minus { background: #ffcdd2; color: #c62828; } .btn-plus { background: #c8e6c9; color: #2e7d32; }
        .stopwatch-box { font-family: monospace; font-size: 32px; text-align: center; color: #e67e22; font-weight: bold; background: #fffbf0; padding: 10px; border-radius: 10px; border: 1px solid #ffeeba; margin-bottom: 15px; }
        
        .form-sec { border: 1px solid #eee; padding: 10px; border-radius: 8px; position: relative; margin-top: 10px; }
        .sec-title { position: absolute; top: -10px; right: 10px; background: white; padding: 0 5px; font-size: 12px; font-weight: bold; color: #777; }
        .rec-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-family: var(--font-main); text-align: right; margin-bottom: 5px; }

        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 550px; max-height: 95vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-span { grid-column: span 2; }
        .form-label { font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px; color: #555; }

        .api-loader { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; align-items:center; justify-content:center; z-index:10; border-radius:5px;}

        /* MOBILE TOGGLE STYLES */
        .mobile-only-btn { display: none; }
        @media (max-width: 900px) {
            .mobile-only-btn { display: inline-flex; }
            .layout-split { flex-direction: column; }
            .layout-split:not(.show-mushaf-mobile) .sidebar-panel { display: flex; width: 100%; height: calc(100vh - 65px); max-height: none; order: 1; border-bottom: none; }
            .layout-split:not(.show-mushaf-mobile) .main-panel { display: none; }
            .layout-split.show-mushaf-mobile .sidebar-panel { display: none; }
            .layout-split.show-mushaf-mobile .main-panel { display: flex; width: 100%; height: calc(100vh - 65px); order: 1; border-top: none; }
            .mushaf-page { min-height: unset; flex-grow: 1; overflow-y: auto; }
        }

        /* Detailed Progress UI */
        .prog-stat-box { background:#f8f9fa; border:1px solid #e0e0e0; border-radius:10px; padding:15px; text-align:center; }
        .prog-stat-val { font-size:24px; font-weight:bold; color:var(--primary); font-family:var(--font-arabic);}
        .prog-stat-lbl { font-size:12px; color:#777; margin-top:5px; }
        .passed-juz-list { display:flex; flex-wrap:wrap; gap:5px; justify-content:center; margin-top:10px; }
        .passed-badge { background:#d4efdf; color:#1e8449; padding:5px 10px; border-radius:20px; font-size:12px; font-weight:bold; }
        
        /* New Table Styles */
        .styled-table { width: 100%; border-collapse: collapse; margin: 25px 0; font-size: 14px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.05); }
        .styled-table thead tr { background-color: var(--primary); color: #ffffff; text-align: right; font-family: var(--font-heading); }
        .styled-table th, .styled-table td { padding: 12px 15px; border: 1px solid #eee; }
        .styled-table tbody tr { border-bottom: 1px solid #dddddd; }
        .styled-table tbody tr:nth-of-type(even) { background-color: #f3f3f3; }
        .styled-table tbody tr:last-of-type { border-bottom: 2px solid var(--primary); }
        .styled-table .ar-txt { font-family: var(--font-arabic); font-size: 16px; }
        .styled-table td { font-family: var(--font-main); } 

        .sem-tag {
            padding: 8px 15px;
            background: #e0e0e0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 14px;
            transition: 0.2s;
        }
        .sem-tag.active {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        /* Checkbox Grid */
        .checkbox-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; direction: ltr; margin-bottom: 20px; }
        .checkbox-grid label { display: block; background: #f8f9fa; padding: 10px; border: 1px solid #eee; text-align: center; border-radius: 5px; cursor: pointer; user-select: none; }
        .checkbox-grid label:hover { background: #e2e6ea; }
        .checkbox-grid input[type="checkbox"] { display: none; }
        .checkbox-grid input[type="checkbox"]:checked + span { color: var(--accent); font-weight: bold; }
        .checkbox-grid input[type="checkbox"]:checked + span::before { content: '‚úî '; }
        .checkbox-grid label.checked { border-color: var(--accent); background: #d4efdf; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen" class="login-wrapper">
        <div class="login-card">
            <div class="logo-container">
                <div class="logo-arabic">ÿ•ÿ™ŸÇÿßŸÜ</div>
                <div class="logo-eng">Hifz Program</div>
                <div class="logo-dv">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞</div>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="window.switchLogin('teacher')">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
                <button class="tab-btn" onclick="window.switchLogin('student')">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™</button>
            </div>
            <div id="teacher-login-form">
                <input type="text" id="teacherUsername" class="form-input" placeholder="ﬁîﬁ´ﬁêﬁ¶ﬁÉ ﬁÇﬁ≠ﬁâﬁ∞">
                <input type="password" id="teacherPassInput" class="form-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
                <button class="btn-primary" onclick="window.loginTeacher()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
            <div id="student-login-form" class="hidden">
                <input type="text" id="stuIdInput" class="form-input" placeholder="ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™">
                <div id="stuPassField" class="hidden" style="margin-top:10px;">
                    <input type="password" id="stuPassInput" class="form-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
                </div>
                <button class="btn-primary" style="background:var(--st-primary);" onclick="window.handleStudentLoginStep()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="hidden">
        
        <!-- TEACHER DASHBOARD -->
        <div id="teacher-dashboard" class="container hidden">
            <div class="app-header">
                <div class="header-title">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞</div>
                <button class="icon-btn logout-btn" onclick="window.logout()">‚èª</button>
            </div>
            <div class="dashboard-center">
                <div class="card-btn" onclick="window.openPage('management-page')">
                    <span class="card-icon">‚öôÔ∏è</span><h3 class="card-title">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞</h3><span class="card-sub">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁÄﬁ¨ﬁãﬁ™ﬁÇﬁ∞ / ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</span>
                </div>
                <div class="card-btn" onclick="window.openGradingClassList()">
                    <span class="card-icon">üìö</span><h3 class="card-title">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞</h3><span class="card-sub">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ / ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞</span>
                </div>
                <div class="card-btn" onclick="window.openProgressPage()">
                    <span class="card-icon">üìà</span><h3 class="card-title">ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁ¨ﬁêﬁ∞</h3><span class="card-sub">ﬁÉﬁ®ﬁïﬁØﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁáﬁ¶ﬁãﬁ® ﬁáﬁ¨ﬁïﬁ∞ﬁÉﬁ´ﬁàﬁ¶ﬁçﬁ∞</span>
                </div>
                <div id="admin-panel-btn" class="card-btn hidden" onclick="window.openTeacherManagement()">
                    <span class="card-icon">üë§</span><h3 class="card-title">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞</h3><span class="card-sub">ﬁáﬁ¨ﬁëﬁ∞ﬁâﬁ®ﬁÇﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞</span>
                </div>
                <!-- BACKUP CARD -->
                <div class="card-btn" onclick="window.openBackupModal()">
                    <span class="card-icon">üíæ</span><h3 class="card-title">ﬁëﬁ≠ﬁìﬁß ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞</h3><span class="card-sub">ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞ / ﬁÉﬁ®ﬁêﬁ∞ﬁìﬁØ</span>
                </div>
            </div>
        </div>

        <!-- Admin Only -->
        <div id="teacher-mgmt-page" class="container hidden">
            <div class="app-header"><div class="header-title">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">‚¨Ö</button></div>
            <div class="action-card" style="margin-top:20px;">
                <h4>ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞</h4>
                <div style="display:flex; gap:10px; max-width:600px; margin:0 auto;">
                    <input type="text" id="newTeachName" class="form-input" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞" style="margin:0; flex:1;">
                    <input type="text" id="newTeachUser" class="form-input" placeholder="ﬁîﬁ´ﬁêﬁ¶ﬁÉ ﬁÇﬁ≠ﬁâﬁ∞" style="margin:0; flex:1;">
                    <input type="text" id="newTeachPass" class="form-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞" style="margin:0; flex:1;">
                    <button class="big-btn" style="width:auto;" onclick="window.createTeacher()">ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                </div>
            </div>
            <h4 style="margin-top:20px;">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ∞</h4>
            <div id="teacherList" class="grid-container"></div>
        </div>

        <!-- PROGRESS REPORT -->
        <div id="progress-page" class="container hidden">
            <div class="app-header"><div class="header-title">ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁ¨ﬁêﬁ∞ ﬁÉﬁ®ﬁïﬁØﬁìﬁ∞</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">‚¨Ö</button></div>
            
            <!-- NEW DETAILED PROGRESS TABLE SECTION -->
            <div class="action-card" style="margin-top:20px; background:#fff; border-top: 5px solid var(--st-primary); max-width:100%;">
                <h4 style="color:var(--primary); margin-bottom:15px; text-align:right;">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁ¨ﬁêﬁ∞ ﬁÉﬁ®ﬁïﬁØﬁìﬁ∞ (ﬁâﬁ® ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉ)</h4>
                
                <div style="display:flex; gap:10px; margin-bottom:20px; justify-content: space-between;">
                    <button id="btnDownloadExcel" class="big-btn btn-green" style="font-size:14px; padding:8px 15px; width:auto; display:none;" onclick="window.downloadProgressExcel()">üì• Excel ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞</button>
                    <select id="progClassSelect" class="form-input" style="margin-bottom:0; max-width:300px;" onchange="window.showClassProgressTable(this.value)">
                        <option value="">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁöﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</option>
                    </select>
                </div>

                <div id="classProgressTableContainer" style="overflow-x:auto;">
                    <!-- Table will be injected here -->
                    <p style="text-align:center; color:#999; padding:20px;">ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ¨ﬁáﬁ∞ ﬁöﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</p>
                </div>
            </div>

            <div class="action-card" style="margin-top:20px; border-top: 5px solid var(--accent-rev);">
                <h4>ﬁáﬁß ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁÄﬁ¨ﬁãﬁ™ﬁÇﬁ∞</h4>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <input type="text" id="semName" class="form-input" placeholder="ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁÇﬁ¶ﬁÇﬁ∞">
                    <input type="date" id="semStart" class="form-input">
                    <input type="date" id="semEnd" class="form-input">
                </div>
                <button class="big-btn" onclick="window.createSemester()">ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁÄﬁ¶ﬁãﬁß</button>
            </div>
            
            <div id="pendingApprovalsSection" style="margin-top:30px;">
                <h4 style="color:#e67e22; border-bottom: 2px solid #e67e22; padding-bottom:10px;">ﬁáﬁ¨ﬁïﬁ∞ﬁÉﬁ´ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ ﬁÄﬁ™ﬁÉﬁ® ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (Pending)</h4>
                <div id="pendingApprovalsList"></div>
            </div>

            <h4 style="margin-top:20px;">ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉﬁåﬁ¶ﬁáﬁ∞</h4>
            <div id="semesterList" class="grid-container"></div>
        </div>

        <!-- MANAGEMENT PAGES -->
        <div id="management-page" class="container hidden">
            <div class="app-header"><div class="header-title">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">‚¨Ö</button></div>
            <div class="action-card" style="margin-top:20px; text-align:right;">
                <h4>ﬁáﬁß ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ¨ﬁáﬁ∞ ﬁÄﬁ¨ﬁãﬁ™ﬁÇﬁ∞</h4>
                <div style="display:flex; gap:10px; justify-content:center; max-width:600px; margin:0 auto;">
                    <input type="text" id="newClassName" class="form-input" placeholder="ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞" style="margin:0; flex:1;">
                    <input type="text" id="newTeacherName" class="form-input" placeholder="ﬁáﬁ™ﬁêﬁ∞ﬁåﬁßﬁõﬁ∞" style="margin:0; flex:1;">
                    <button class="btn-primary" style="width:auto;" onclick="window.createClass()">ﬁÄﬁ¶ﬁãﬁß</button>
                </div>
            </div>
            <h4 style="margin-top:20px;">ﬁÄﬁ¨ﬁãﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞</h4>
            <div id="manageClassList" class="grid-container"></div>
        </div>

        <div id="class-details-page" class="container hidden">
            <div class="app-header"><div class="header-title" id="manageHeaderName">Class</div><button class="icon-btn" onclick="window.openPage('management-page')">‚¨Ö</button></div>
            <div class="grid-container">
                <div class="action-card">
                    <button class="big-btn" onclick="window.openAddStudentModal()"><span>‚ûï</span> ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button class="big-btn btn-orange" onclick="window.downloadTemplate()"><span>üì•</span> ﬁìﬁ¨ﬁâﬁ∞ﬁïﬁ∞ﬁçﬁ≠ﬁìﬁ∞</button>
                        <label class="big-btn btn-green" style="font-size:14px; margin:0; cursor:pointer;">üìÇ ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞<input type="file" hidden onchange="window.handleExcelUpload(this)"></label>
                    </div>
                </div>
            </div>
            <h4 style="margin-top:20px;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ∞</h4>
            <div id="studentManageList" class="grid-container"></div>
        </div>

        <!-- GRADING FLOW -->
        <div id="grading-class-page" class="container hidden">
            <div class="app-header"><div class="header-title">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">‚¨Ö</button></div>
            <div id="gradingClassList" class="grid-container"></div>
        </div>
        <div id="grading-student-page" class="container hidden">
            <div class="app-header"><div class="header-title">Students</div><button class="icon-btn" onclick="window.openPage('grading-class-page')">‚¨Ö</button></div>
            <div id="gradingStudentList" class="grid-container"></div>
        </div>
        <div id="grading-menu-page" class="container hidden">
            <div class="app-header"><div class="header-title" id="gradingStudentName">Student</div><button class="icon-btn" onclick="window.openPage('grading-student-page')">‚¨Ö</button></div>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openCategoryPage('new_lesson')"><span class="menu-icon" style="color:var(--accent);">üìñ</span><h4 class="card-title">ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</h4></div>
                <div class="menu-btn" onclick="window.openCategoryPage('short_rev')"><span class="menu-icon" style="color:var(--accent-rev);">üîÑ</span><h4 class="card-title">ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</h4></div>
                <div class="menu-btn" onclick="window.openCategoryPage('long_rev')"><span class="menu-icon" style="color:#8e44ad;">üìÖ</span><h4 class="card-title">ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</h4></div>
                <div class="menu-btn" onclick="window.openCategoryPage('juz_exam')"><span class="menu-icon" style="color:#2980b9;">üìù</span><h4 class="card-title">ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</h4></div>
                <div class="menu-btn" onclick="window.openCategoryPage('final_exam')"><span class="menu-icon" style="color:#c0392b;">üéì</span><h4 class="card-title">ﬁäﬁ¶ﬁÄﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</h4></div>
            </div>
        </div>

        <!-- CATEGORY HISTORY PAGE WITH SEMESTER TABS -->
        <div id="category-page" class="container hidden">
            <div class="app-header">
                <div class="header-title" id="catPageTitle">Title</div>
                <button class="icon-btn" onclick="window.goBackFromCategory()">‚¨Ö</button>
            </div>
            
            <!-- Semester Tags Container -->
            <div id="historySemesterTabs" style="overflow-x:auto; white-space:nowrap; margin-bottom:15px; padding:10px; text-align:right; border-bottom:1px solid #eee;">
                <!-- Tags will be injected here by JS -->
            </div>

            <div class="page-toolbar" style="background:white; padding:15px; border-radius:12px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:16px; font-weight:bold; color:var(--primary);">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ﬁåﬁ¶ﬁáﬁ∞</span>
                <div style="display:flex; gap:10px;">
                    <button id="pastJuzBtn" class="big-btn btn-orange" style="display:none; padding:8px 15px; font-size:14px; width:auto;" onclick="window.openPastJuzModal()">ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨ ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ﬁåﬁ¶ﬁáﬁ∞</button>
                    <button id="addRecordBtn" class="add-record-btn big-btn btn-green" style="border-radius:50%; width:45px; height:45px; padding:0;" onclick="window.handleAddButtonClick()">‚ûï</button>
                </div>
            </div>
            <div id="categoryHistoryList"></div>
        </div>

        <!-- UNIVERSAL RECORDER -->
        <div id="recorder-page" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000;">
            <div class="app-header">
                <div style="display:flex; align-items:center; gap:10px;"><button class="icon-btn" onclick="window.closeRecorder()">‚¨Ö</button><span class="header-title" id="recorderTitle">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞</span></div>
                <span id="viewModeBadge" style="background:#e74c3c; color:white; padding:2px 8px; border-radius:4px; font-size:12px; display:none;">View Mode</span>
            </div>
            <div class="layout-split" id="recorder-layout">
                <div class="sidebar-panel">
                    <button class="big-btn btn-orange mobile-only-btn" style="width:100%; margin-bottom:15px; font-size:14px;" onclick="window.toggleMobileMushaf('recorder-layout', true)">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ∞ ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁß</button>

                    <div style="margin-bottom:15px;"><label class="form-label">ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="recDate" class="rec-input" style="text-align:center;"></div>
                    <div class="form-sec" style="border-top:3px solid var(--accent);">
                        <span class="sec-title">ﬁäﬁ¶ﬁÅﬁß ﬁÄﬁ®ﬁêﬁßﬁÑﬁ™</span>
                        <label>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="startPage" class="rec-input" placeholder="Page (1-604)" onchange="window.handleStartPageChange()">
                        <div style="display:flex; gap:5px;"><div style="flex:1"><label>ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞</label><select id="startSurah" class="rec-input"></select></div><div style="width:60px"><label>ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞</label><select id="startAyah" class="rec-input"></select></div></div>
                    </div>
                    <div class="form-sec" style="border-top:3px solid #e74c3c;">
                        <span class="sec-title">ﬁÇﬁ®ﬁâﬁ≠ ﬁÄﬁ®ﬁêﬁßﬁÑﬁ™</span>
                        <label>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="endPage" class="rec-input" placeholder="Page" onchange="window.validateRecorderPages()">
                        <div style="display:flex; gap:5px;"><div style="flex:1"><label>ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞</label><select id="endSurah" class="rec-input"></select></div><div style="width:60px"><label>ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞</label><select id="endAyah" class="rec-input"></select></div></div>
                    </div>
                    <div style="background:#fff5f5; padding:15px; border-radius:8px; text-align:center; margin-top:auto; border:1px solid #ffcccc;">
                        <span style="font-size:14px; color:red;">ﬁÜﬁ™ﬁÅﬁ™ﬁéﬁ¨ ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™</span><strong id="mistakeCountDisplay" style="font-size:32px; color:red; display:block;">0</strong>
                    </div>
                    <button id="recSaveBtn" class="big-btn" onclick="window.saveRecord()">üíæ ﬁêﬁ≠ﬁàﬁ∞</button>
                </div>
                <div class="main-panel">
                    <button class="big-btn btn-red mobile-only-btn" style="width:100%; margin-bottom:15px; font-size:14px;" onclick="window.toggleMobileMushaf('recorder-layout', false)">‚¨á ﬁäﬁØﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ¨ﬁÇﬁÑﬁ™ﬁÉﬁ®ﬁãﬁ®ﬁáﬁ™ﬁÇﬁ∞</button>
                    <!-- Replaced top bar with internal logic -->
                    <div class="mushaf-page"><div id="mushafContent" class="quran-text"><p style="color:#999; margin-top:100px;">ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß</p></div></div>
                    <div class="mushaf-nav">
                        <button class="nav-btn" onclick="window.changeRecPage(-1)">‚û°</button>
                        <span id="recPageDisplay" style="font-size:18px; font-weight:bold;">Page</span>
                        <button class="nav-btn" onclick="window.changeRecPage(1)">‚¨Ö</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- JUZ EXAM PAGE -->
        <div id="juz-exam-page" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000;">
            <div class="app-header">
                <div style="display:flex; align-items:center; gap:10px;"><button class="icon-btn" onclick="window.closeJuzExam()">‚¨Ö</button><span class="header-title" id="juzExamTitle">ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</span></div>
                <div id="partBadge" style="background:#2c3e50; color:white; padding:5px 15px; border-radius:20px; font-size:12px;"></div>
            </div>
            <div class="layout-split" id="juz-layout">
                <div class="sidebar-panel">
                    <button class="big-btn btn-orange mobile-only-btn" style="width:100%; margin-bottom:15px; font-size:14px;" onclick="window.toggleMobileMushaf('juz-layout', true)">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ∞ ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁß</button>
                    <div class="score-header"><div class="big-score" id="liveScore">100%</div></div>
                    <div class="exam-section">
                        <div class="stopwatch-box"><span id="stopwatchDisplay">00:00:00</span><div style="font-size:12px;"><button onclick="window.startTimer()" style="border:none; color:green; background:none;">‚ñ∂</button> <button onclick="window.stopTimer()" style="border:none; color:red; background:none;">‚èπ</button></div></div>
                    </div>
                    <div class="exam-section">
                        <div class="score-control"><span>ﬁáﬁ™ﬁêﬁ∞ﬁåﬁßﬁõﬁ∞ (-2)</span><strong id="countTeacher" class="ctrl-val" style="color:var(--mistake);">0</strong></div>
                        <div class="score-control"><span>ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ﬁáﬁ¶ﬁÅﬁ∞ (-1)</span><div style="display:flex;gap:5px;"><button class="ctrl-btn btn-minus" onclick="window.updateScore('self',1)">+</button><span id="countSelf" class="ctrl-val">0</span><button class="ctrl-btn btn-plus" onclick="window.updateScore('self',-1)">-</button></div></div>
                        <div class="score-control"><span>ﬁåﬁ¶ﬁñﬁ™ﬁàﬁ©ﬁãﬁ™ (10)</span><input type="number" id="scoreTajweed" class="form-input" style="width:60px;" value="10" max="10" onchange="window.calcScore()"></div>
                        <div class="score-control"><span>ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞ (5)</span><input type="number" id="scoreFluency" class="form-input" style="width:60px;" value="5" max="5" onchange="window.calcScore()"></div>
                    </div>
                    <div class="exam-section" id="mutashabihSection">
                        <button class="big-btn btn-orange" style="padding:10px; font-size:14px;" onclick="window.generateQuestions()">üé≤ ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™</button>
                        <div id="questionList" style="margin:10px 0;"></div>
                        <div style="display:flex; justify-content:space-between;"><label>Q1 <input type="number" id="q1_score" value="2.5" max="2.5" step="0.5" style="width:50px;" onchange="window.calcScore()"></label><label>Q2 <input type="number" id="q2_score" value="2.5" max="2.5" step="0.5" style="width:50px;" onchange="window.calcScore()"></label></div>
                    </div>
                    <div style="padding:20px;"><button id="saveExamBtn" class="big-btn" onclick="window.saveJuzExamPart()">üíæ ﬁêﬁ≠ﬁàﬁ∞</button></div>
                </div>
                <div class="main-panel">
                    <button class="big-btn btn-red mobile-only-btn" style="width:100%; margin-bottom:15px; font-size:14px;" onclick="window.toggleMobileMushaf('juz-layout', false)">‚¨á ﬁäﬁØﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ¨ﬁÇﬁÑﬁ™ﬁÉﬁ®ﬁãﬁ®ﬁáﬁ™ﬁÇﬁ∞</button>
                    <!-- <div class="mushaf-top-bar" id="mushafTopBar"><span id="mushafJuzInfo"></span><span id="mushafSurahInfo"></span></div> -->
                    <div class="mushaf-page"><div id="examMushafContent" class="quran-text"><p style="color:#999; margin-top:100px;">...</p></div></div>
                    <div class="mushaf-nav">
                        <button class="nav-btn" onclick="window.changeExamPage(-1)">‚û°</button>
                        <span id="currentPageDisplay" style="font-size:18px; font-weight:bold;">Page</span>
                        <button class="nav-btn" onclick="window.changeExamPage(1)">‚¨Ö</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FINAL EXAM PAGE -->
        <div id="final-exam-page" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000;">
            <div class="app-header"><button class="icon-btn" onclick="window.closeFinalExam()">‚¨Ö</button><span class="header-title">ﬁäﬁ¶ﬁÄﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</span></div>
            <div class="layout-split" id="final-layout">
                <div class="sidebar-panel">
                    <button class="big-btn btn-orange mobile-only-btn" style="width:100%; margin-bottom:15px; font-size:14px;" onclick="window.toggleMobileMushaf('final-layout', true)">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ∞ ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁß</button>
                    <div class="score-header"><div class="big-score" id="finalExamScore">100%</div></div>
                    <div style="text-align:center; margin:10px 0; font-weight:bold;" id="questionIndicator">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ 1 / 3</div>
                    <label class="form-label">ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁéﬁ¶ﬁàﬁß</label><select id="finalJuzSelect" class="form-input"></select>
                    <button class="big-btn btn-orange" style="padding:10px; font-size:14px; margin-top:5px;" onclick="window.loadFinalQuestion()">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁäﬁ¶ﬁÅﬁß</button>
                    <div style="margin-top:20px;">
                        <div class="score-control"><span>ﬁÉﬁ¶ﬁÇﬁéﬁ¶ﬁÖﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁãﬁ®ﬁÇﬁ∞ (-5)</span><strong id="finalTeacherCount" style="color:var(--mistake);">0</strong></div>
                        <div class="score-control"><span>ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ﬁáﬁ¶ﬁÅﬁ∞ (-2)</span><div style="display:flex;gap:5px;"><button class="ctrl-btn btn-minus" onclick="window.updateFinalScore('self',1)">+</button><span id="finalSelfCount" class="ctrl-val">0</span><button class="ctrl-btn btn-plus" onclick="window.updateFinalScore('self',-1)">-</button></div></div>
                    </div>
                    <div style="padding:20px; margin-top:auto;"><button id="nextQBtn" class="big-btn" onclick="window.nextFinalQuestion()">ﬁãﬁ¨ﬁÇﬁ∞ﬁñﬁ¨ﬁÄﬁ≠ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ‚û°</button><button id="finishExamBtn" class="big-btn btn-green hidden" onclick="window.saveFinalExam()">ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁß üíæ</button></div>
                </div>
                <div class="main-panel">
                    <button class="big-btn btn-red mobile-only-btn" style="width:100%; margin-bottom:15px; font-size:14px;" onclick="window.toggleMobileMushaf('final-layout', false)">‚¨á ﬁäﬁØﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ¨ﬁÇﬁÑﬁ™ﬁÉﬁ®ﬁãﬁ®ﬁáﬁ™ﬁÇﬁ∞</button>
                    <div class="mushaf-page"><div id="finalMushafContent" class="quran-text">...</div></div>
                </div>
            </div>
        </div>

        <!-- STUDENT DASHBOARD -->
        <div id="student-dashboard" class="container hidden">
            <div class="app-header"><div class="header-title">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞</div><button class="icon-btn logout-btn" onclick="window.logout()">‚èª</button></div>
            <div style="background:white; padding:30px; border-radius:15px; text-align:center; margin-bottom:20px;">
                <h2 style="color:var(--st-primary);">ﬁâﬁ¶ﬁÉﬁ™ﬁôﬁ¶ﬁÑﬁß!</h2>
                <h3 id="studentDashName"></h3>
            </div>
            
            <div class="student-stat-container">
                <div class="target-box">
                    <div class="target-header">
                        <span id="targetLabel">ﬁâﬁ® ﬁìﬁßﬁâﬁ∞ﬁéﬁ¨ ﬁìﬁßﬁÉﬁéﬁ¨ﬁìﬁ∞: 0 ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™</span>
                        <span id="targetPercent">0%</span>
                    </div>
                    <div class="progress-bar-bg"><div id="targetProgress" class="progress-bar-fill"></div></div>
                    <div id="targetMsg" class="target-msg">ﬁÄﬁ®ﬁáﬁ∞ﬁàﬁ¶ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ≠!</div>
                </div>
                <br>
                <div class="st-stats-grid">
                    <div class="st-stat-item"><div class="st-stat-val st-color-1" id="studentSemPages">0</div><div class="st-stat-lbl">ﬁâﬁ® ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉ<br>(ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß)</div></div>
                    <div class="st-stat-item"><div class="st-stat-val st-color-2" id="studentSemJuz">0</div><div class="st-stat-lbl">ﬁâﬁ® ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉ<br>(ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™)</div></div>
                    <div class="st-stat-item"><div class="st-stat-val st-color-3" id="studentTotalJuz">0</div><div class="st-stat-lbl">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞<br>(ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™)</div></div>
                </div>
            </div>

            <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:20px;">
                <button class="big-btn" onclick="window.openBulkEntryModal()" style="background:var(--st-primary); font-size:14px;">üìú ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨ ﬁëﬁ≠ﬁìﬁß ﬁáﬁ¨ﬁÇﬁ∞ﬁìﬁ¶ﬁÉﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞</button>
                <button class="big-btn btn-orange" onclick="window.openExternalRecModal()" style="font-size:14px;">üó£ ﬁáﬁ¨ﬁÄﬁ¨ﬁÇﬁ∞ ﬁäﬁ¶ﬁÉﬁßﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁÜﬁ®ﬁîﬁ¶ﬁáﬁ®ﬁãﬁ®ﬁÇﬁ™ﬁÇﬁ∞</button>
            </div>

            <div class="grid-container">
                <div class="card-btn" onclick="window.openCategoryPage('new_lesson')"><span class="card-icon" style="color:var(--accent);">üìñ</span><h4 class="card-title">ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</h4></div>
                <div class="card-btn" onclick="window.openCategoryPage('short_rev')"><span class="card-icon" style="color:var(--accent-rev);">üîÑ</span><h4 class="card-title">ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</h4></div>
                <div class="card-btn" onclick="window.openCategoryPage('long_rev')"><span class="card-icon" style="color:#8e44ad;">üìÖ</span><h4 class="card-title">ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</h4></div>
                <div class="card-btn" onclick="window.openCategoryPage('juz_exam')"><span class="card-icon" style="color:#2980b9;">üìù</span><h4 class="card-title">ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</h4></div>
                <div class="card-btn" onclick="window.openCategoryPage('final_exam')"><span class="card-icon" style="color:#c0392b;">üéì</span><h4 class="card-title">ﬁäﬁ¶ﬁÄﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</h4></div>
            </div>
        </div>

    </div>

    <!-- MODALS -->
    <div id="createPassModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3 style="color:var(--primary);">ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÄﬁ¶ﬁáﬁ∞ﬁãﬁ¶ﬁàﬁß</h3>
            <p id="passModalUserText" style="color:#777; margin-bottom:10px;"></p>
            <input type="password" id="newStuPass" class="form-input" placeholder="ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
            <button class="big-btn" onclick="window.saveNewPassword()">ﬁêﬁ≠ﬁàﬁ∞ & ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
        </div>
    </div>
    
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:20px; color:var(--primary);">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞/ﬁáﬁ¨ﬁëﬁ®ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞</h3>
            <div class="form-grid">
                <div class="full-span"><label class="form-label">ﬁÜﬁØﬁêﬁ∞ ﬁâﬁÆﬁëﬁ®ﬁáﬁ™ﬁçﬁ∞</label><input type="text" id="m_module" class="form-input"></div>
                <div><label class="form-label">ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©</label><input type="text" id="m_id" class="form-input"></div>
                <div><label class="form-label">ﬁÇﬁ¶ﬁÇﬁ∞</label><input type="text" id="m_name" class="form-input"></div>
                <div><label class="form-label">ﬁçﬁ¨ﬁàﬁ¨ﬁçﬁ∞</label><select id="m_level" class="form-input"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
                <div><label class="form-label">ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁß ﬁéﬁÆﬁåﬁ∞</label><select id="m_direction" class="form-input"><option value="top_down">ﬁâﬁ¶ﬁåﬁ®ﬁÇﬁ∞ ﬁåﬁ®ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞</option><option value="bottom_up">ﬁåﬁ®ﬁÉﬁ®ﬁÇﬁ∞ ﬁâﬁ¶ﬁåﬁ®ﬁáﬁ¶ﬁÅﬁ∞</option></select></div>
                <!-- Removed Juz Count Field -->
                <div class="full-span"><label class="form-label">ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™</label><input type="text" id="m_remarks" class="form-input"></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button id="btnSaveStudent" class="big-btn" onclick="window.confirmAddStudent()">ﬁêﬁ≠ﬁàﬁ∞</button>
                <button class="big-btn btn-orange" onclick="document.getElementById('addStudentModal').style.display='none'">ﬁÜﬁ¨ﬁÇﬁ∞ﬁêﬁ¶ﬁçﬁ∞</button>
            </div>
        </div>
    </div>
    
    <!-- PAST JUZ MANAGEMENT MODAL -->
    <div id="pastJuzModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3 style="color:var(--primary); text-align:center; margin-bottom:20px;">ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁäﬁßﬁêﬁ∞ﬁàﬁ¨ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ﬁåﬁ¶ﬁáﬁ∞</h3>
            <p style="text-align:center; font-size:13px; color:#777; margin-bottom:15px;">ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨ ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁäﬁßﬁêﬁ∞ﬁàﬁ¨ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁäﬁßﬁÄﬁ¶ﬁéﬁ¶ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</p>
            <div id="pastJuzGrid" class="checkbox-grid">
                <!-- Checkboxes injected via JS -->
            </div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button class="big-btn" onclick="window.savePastJuz()">ﬁêﬁ≠ﬁàﬁ∞</button>
                <button class="big-btn btn-red" onclick="document.getElementById('pastJuzModal').style.display='none'">ﬁÜﬁ¨ﬁÇﬁ∞ﬁêﬁ¶ﬁçﬁ∞</button>
            </div>
        </div>
    </div>
    
    <div id="juzSetupModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3>ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</h3>
            <select id="examJuzSelect" class="form-input"></select>
            <div style="text-align:right; margin:15px 0;"><label><input type="radio" name="examPart" value="full" checked> ﬁäﬁÆﬁåﬁ∞ ﬁáﬁ¨ﬁáﬁ∞ﬁÜﬁÆﬁÅﬁ∞</label><br><label><input type="radio" name="examPart" value="part1"> ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁÑﬁ¶ﬁáﬁ® (1/2)</label><br><label><input type="radio" name="examPart" value="part2"> ﬁäﬁ¶ﬁÄﬁ™ ﬁÑﬁ¶ﬁáﬁ® (2/2)</label></div>
            <button class="big-btn" onclick="window.startJuzExam()">ﬁäﬁ¶ﬁÅﬁß</button>
            <button class="big-btn btn-red" onclick="document.getElementById('juzSetupModal').style.display='none'">ﬁÜﬁ¨ﬁÇﬁ∞ﬁêﬁ¶ﬁçﬁ∞</button>
        </div>
    </div>

    <div id="bulkEntryModal" class="modal">
        <div class="modal-content" style="position:relative;">
            <div id="bulkApiLoader" class="api-loader"><span>ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁÄﬁØﬁãﬁ¶ﬁÇﬁ©... ‚è≥</span></div>
            <h3 style="color:var(--primary); text-align:center;">ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨ ﬁëﬁ≠ﬁìﬁß ﬁáﬁ¨ﬁÇﬁ∞ﬁìﬁ¶ﬁÉﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞</h3>
            <!-- Removed Prev Sem Juz Count -->
            <p style="text-align:center; color:#777; font-size:13px; margin-top:10px;">ﬁâﬁ® ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉﬁéﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁáﬁ®ﬁãﬁ¨ﬁàﬁ™ﬁÇﬁ™ ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞</p>
            <div id="bulkEntriesList" style="max-height:40vh; overflow-y:auto; margin-bottom:15px; padding-right:5px;"></div>
            <button class="big-btn btn-orange" style="width:100%; font-size:14px;" onclick="window.addBulkRow()">+ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ¨ﬁáﬁ∞</button>
            <div style="display:flex; gap:10px; margin-top:15px;"><button class="big-btn" onclick="window.saveBulkData()">ﬁäﬁÆﬁÇﬁ™ﬁàﬁß</button><button class="big-btn btn-red" onclick="document.getElementById('bulkEntryModal').style.display='none'">ﬁÜﬁ¨ﬁÇﬁ∞ﬁêﬁ¶ﬁçﬁ∞</button></div>
        </div>
    </div>

    <div id="externalRecModal" class="modal">
        <div class="modal-content" style="position:relative;">
            <div id="extApiLoader" class="api-loader"><span>ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁÄﬁØﬁãﬁ¶ﬁÇﬁ©... ‚è≥</span></div>
            <h3 style="color:#8e44ad; text-align:center;">ﬁáﬁ¨ﬁÄﬁ¨ﬁÇﬁ∞ ﬁäﬁ¶ﬁÉﬁßﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁÜﬁ®ﬁîﬁ¶ﬁáﬁ®ﬁãﬁ®ﬁÇﬁ™ﬁÇﬁ∞</h3>
            <p style="text-align:center; color:#777; font-size:13px; margin-bottom:15px;">ﬁéﬁ≠ﬁéﬁ¶ﬁáﬁ® ﬁÇﬁ™ﬁàﬁ¶ﬁåﬁ¶ ﬁáﬁ¨ﬁÄﬁ¨ﬁÇﬁ∞ ﬁäﬁ¶ﬁÉﬁßﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ ﬁÜﬁ®ﬁîﬁ¶ﬁáﬁ®ﬁãﬁ®ﬁÇﬁ∞ﬁÜﬁ¶ﬁâﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™</p>
            <div class="form-grid ext-form-container">
                <div class="full-span"><label class="form-label">ﬁÜﬁ®ﬁîﬁ¶ﬁáﬁ®ﬁãﬁ®ﬁÇﬁ∞ ﬁäﬁ¶ﬁÉﬁßﬁåﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞</label><input type="text" id="extPerson" class="form-input" placeholder="ﬁâﬁ®ﬁêﬁßﬁçﬁ™: ﬁâﬁ¶ﬁÇﬁ∞ﬁâﬁ¶ / ﬁáﬁ™ﬁêﬁ∞ﬁåﬁßﬁõﬁ∞ ﬁ¢ﬁ¶ﬁçﬁ©"></div>
                <div><label class="form-label">ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="extDate" class="form-input"></div>
                <div><label class="form-label">ﬁÑﬁßﬁàﬁ¶ﬁåﬁ∞</label><select id="extType" class="form-input"><option value="short_rev">ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</option><option value="long_rev">ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</option></select></div>
                <div style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #e0e0e0;"><label class="form-label">ﬁäﬁ¨ﬁÅﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="extStartPage" class="form-input p-start" style="margin-bottom:5px;" onchange="window.fetchPageDetailsForInput(this, 'start')"><div style="display:flex; gap:5px;"><select class="form-input start-surah-sel" style="flex:1; padding:5px; margin:0; font-size:13px;" onchange="window.updateLocalAyahOptions(this, 'start-ayah-sel')"></select><select class="form-input start-ayah-sel" style="width:60px; padding:5px; margin:0; font-size:13px;"></select></div></div>
                <div style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #e0e0e0;"><label class="form-label">ﬁÇﬁ®ﬁâﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="extEndPage" class="form-input p-end" style="margin-bottom:5px;" onchange="window.fetchPageDetailsForInput(this, 'end')"><div style="display:flex; gap:5px;"><select class="form-input end-surah-sel" style="flex:1; padding:5px; margin:0; font-size:13px;" onchange="window.updateLocalAyahOptions(this, 'end-ayah-sel')"></select><select class="form-input end-ayah-sel" style="width:60px; padding:5px; margin:0; font-size:13px;"></select></div></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;"><button class="big-btn" style="background:#8e44ad;" onclick="window.saveExternalRecitation()">ﬁäﬁÆﬁÇﬁ™ﬁàﬁß</button><button class="big-btn btn-red" onclick="document.getElementById('externalRecModal').style.display='none'">ﬁÜﬁ¨ﬁÇﬁ∞ﬁêﬁ¶ﬁçﬁ∞</button></div>
        </div>
    </div>

    <!-- BACKUP MODAL -->
    <div id="backupModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3 style="color:var(--primary); margin-bottom:15px;">ﬁëﬁ≠ﬁìﬁß ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞ / ﬁÉﬁ®ﬁêﬁ∞ﬁìﬁØ</h3>
            <div style="border-bottom:1px solid #eee; padding-bottom:20px; margin-bottom:20px;">
                <p style="color:#555;">ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÄﬁ™ﬁÉﬁ® ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁëﬁ≠ﬁìﬁßﬁáﬁ¨ﬁáﬁ∞ (ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ÿå ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞ÿå ﬁÄﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©) ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ﬁáﬁ¨ﬁáﬁ∞ﬁéﬁ¨ ﬁéﬁÆﬁåﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß.</p>
                <button class="big-btn" style="width:100%;" onclick="window.backupData()">üì• ﬁëﬁ≠ﬁìﬁß ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞</button>
            </div>
            <div>
                <p style="color:#c0392b;">‚ö†Ô∏è ﬁêﬁ¶ﬁâﬁßﬁçﬁ™ﬁàﬁ≠: ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ﬁáﬁ¨ﬁáﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞ﬁÜﬁÆﬁÅﬁ∞ﬁäﬁ®ﬁÇﬁ¶ﬁâﬁ¶ÿå ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÄﬁ™ﬁÉﬁ® ﬁëﬁ≠ﬁìﬁß ﬁäﬁ™ﬁÄﬁ¨ﬁàﬁ≠ﬁÇﬁ¨.</p>
                <label class="big-btn btn-orange" style="width:100%; cursor:pointer;">
                    üìÇ ﬁëﬁ≠ﬁìﬁß ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞ (Restore)
                    <input type="file" id="backupFileInp" hidden onchange="window.restoreData(this)">
                </label>
            </div>
            <button class="btn-action-sm btn-delete-hist" style="position:absolute; top:15px; right:15px;" onclick="document.getElementById('backupModal').style.display='none'">‚úï</button>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU", authDomain: "hifz-cde3b.firebaseapp.com", databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com", projectId: "hifz-cde3b", storageBucket: "hifz-cde3b.firebasestorage.app", messagingSenderId: "566754658580", appId: "1:566754658580:web:d63d0f167960f53bab9a01" };
        const app = initializeApp(firebaseConfig); const db = getDatabase(app);

        const SURAH_NAMES_AR = ["ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©", "ÿßŸÑÿ®ŸÇÿ±ÿ©", "ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ", "ÿßŸÑŸÜÿ≥ÿßÿ°", "ÿßŸÑŸÖÿßÿ¶ÿØÿ©", "ÿßŸÑÿ£ŸÜÿπÿßŸÖ", "ÿßŸÑÿ£ÿπÿ±ÿßŸÅ", "ÿßŸÑÿ£ŸÜŸÅÿßŸÑ", "ÿßŸÑÿ™Ÿàÿ®ÿ©", "ŸäŸàŸÜÿ≥", "ŸáŸàÿØ", "ŸäŸàÿ≥ŸÅ", "ÿßŸÑÿ±ÿπÿØ", "ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ", "ÿßŸÑÿ≠ÿ¨ÿ±", "ÿßŸÑŸÜÿ≠ŸÑ", "ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°", "ÿßŸÑŸÉŸáŸÅ", "ŸÖÿ±ŸäŸÖ", "ÿ∑Ÿá", "ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°", "ÿßŸÑÿ≠ÿ¨", "ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ", "ÿßŸÑŸÜŸàÿ±", "ÿßŸÑŸÅÿ±ŸÇÿßŸÜ", "ÿßŸÑÿ¥ÿπÿ±ÿßÿ°", "ÿßŸÑŸÜŸÖŸÑ", "ÿßŸÑŸÇÿµÿµ", "ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™", "ÿßŸÑÿ±ŸàŸÖ", "ŸÑŸÇŸÖÿßŸÜ", "ÿßŸÑÿ≥ÿ¨ÿØÿ©", "ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®", "ÿ≥ÿ®ÿ£", "ŸÅÿßÿ∑ÿ±", "Ÿäÿ≥", "ÿßŸÑÿµÿßŸÅÿßÿ™", "ÿµ", "ÿßŸÑÿ≤ŸÖÿ±", "ÿ∫ÿßŸÅÿ±", "ŸÅÿµŸÑÿ™", "ÿßŸÑÿ¥Ÿàÿ±Ÿâ", "ÿßŸÑÿ≤ÿÆÿ±ŸÅ", "ÿßŸÑÿØÿÆÿßŸÜ", "ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©", "ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ", "ŸÖÿ≠ŸÖÿØ", "ÿßŸÑŸÅÿ™ÿ≠", "ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™", "ŸÇ", "ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™", "ÿßŸÑÿ∑Ÿàÿ±", "ÿßŸÑŸÜÿ¨ŸÖ", "ÿßŸÑŸÇŸÖÿ±", "ÿßŸÑÿ±ÿ≠ŸÖŸÜ", "ÿßŸÑŸàÿßŸÇÿπÿ©", "ÿßŸÑÿ≠ÿØŸäÿØ", "ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©", "ÿßŸÑÿ≠ÿ¥ÿ±", "ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©", "ÿßŸÑÿµŸÅ", "ÿßŸÑÿ¨ŸÖÿπÿ©", "ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ", "ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ", "ÿßŸÑÿ∑ŸÑÿßŸÇ", "ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ", "ÿßŸÑŸÖŸÑŸÉ", "ÿßŸÑŸÇŸÑŸÖ", "ÿßŸÑÿ≠ÿßŸÇÿ©", "ÿßŸÑŸÖÿπÿßÿ±ÿ¨", "ŸÜŸàÿ≠", "ÿßŸÑÿ¨ŸÜ", "ÿßŸÑŸÖÿ≤ŸÖŸÑ", "ÿßŸÑŸÖÿØÿ´ÿ±", "ÿßŸÑŸÇŸäÿßŸÖÿ©", "ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ", "ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™", "ÿßŸÑŸÜÿ®ÿ£", "ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™", "ÿπÿ®ÿ≥", "ÿßŸÑÿ™ŸÉŸàŸäÿ±", "ÿßŸÑÿ•ŸÜŸÅÿ∑ÿßÿ±", "ÿßŸÑŸÖÿ∑ŸÅŸÅŸäŸÜ", "ÿßŸÑÿ•ŸÜÿ¥ŸÇÿßŸÇ", "ÿßŸÑÿ®ÿ±Ÿàÿ¨", "ÿßŸÑÿ∑ÿßÿ±ŸÇ", "ÿßŸÑÿ£ÿπŸÑŸâ", "ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©", "ÿßŸÑŸÅÿ¨ÿ±", "ÿßŸÑÿ®ŸÑÿØ", "ÿßŸÑÿ¥ŸÖÿ≥", "ÿßŸÑŸÑŸäŸÑ", "ÿßŸÑÿ∂ÿ≠Ÿâ", "ÿßŸÑÿ¥ÿ±ÿ≠", "ÿßŸÑÿ™ŸäŸÜ", "ÿßŸÑÿπŸÑŸÇ", "ÿßŸÑŸÇÿØÿ±", "ÿßŸÑÿ®ŸäŸÜÿ©", "ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©", "ÿßŸÑÿπÿßÿØŸäÿßÿ™", "ÿßŸÑŸÇÿßÿ±ÿπÿ©", "ÿßŸÑÿ™ŸÉÿßÿ´ÿ±", "ÿßŸÑÿπÿµÿ±", "ÿßŸÑŸáŸÖÿ≤ÿ©", "ÿßŸÑŸÅŸäŸÑ", "ŸÇÿ±Ÿäÿ¥", "ÿßŸÑŸÖÿßÿπŸàŸÜ", "ÿßŸÑŸÉŸàÿ´ÿ±", "ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ", "ÿßŸÑŸÜÿµÿ±", "ÿßŸÑŸÖÿ≥ÿØ", "ÿßŸÑÿ•ÿÆŸÑÿßÿµ", "ÿßŸÑŸÅŸÑŸÇ", "ÿßŸÑŸÜÿßÿ≥"];
        const AYAH_COUNTS = [7, 286, 200, 176, 120, 165, 206, 75, 129, 109, 123, 111, 43, 52, 99, 128, 111, 110, 98, 135, 112, 78, 118, 64, 77, 227, 93, 88, 69, 60, 34, 30, 73, 54, 45, 83, 182, 88, 75, 85, 54, 53, 89, 59, 37, 35, 38, 29, 18, 45, 60, 49, 62, 55, 78, 96, 29, 22, 24, 13, 14, 11, 11, 18, 12, 12, 30, 52, 52, 44, 28, 28, 20, 56, 40, 31, 50, 40, 46, 42, 29, 19, 36, 25, 22, 17, 19, 26, 30, 20, 15, 21, 11, 8, 8, 19, 5, 8, 8, 11, 11, 8, 3, 9, 5, 4, 7, 3, 6, 3, 5, 4, 5, 6];

        let classesData = []; let hifzUsers = []; let semesters = [];
        let currentClassIdx = -1, currentStudentIdx = -1;
        let currentUserType = 'teacher', currentUserRole = 'teacher';
        let currentStudentObj = null; let currentSessionType = '';
        let examState = {}, finalExamState = {};
        let currentMistakes = []; let isViewMode = false;
        let editingRecordIndex = -1, editingStudentIndex = -1;
        let currentRecViewPage = 1; let pendingUserIndex = -1;
        
        let activeHistorySemesterIdx = -1; 

        window.getFormattedDate = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const dbRef = ref(db, 'hifz_system_v1');
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            classesData = data?.classes || []; hifzUsers = data?.users || []; semesters = data?.semesters || [];
            if(!hifzUsers.length) { hifzUsers.push({username:'admin', password:'1234', role:'admin', name:'Administrator'}); updateFirebase(); }

            if(!document.getElementById('management-page').classList.contains('hidden')) window.renderManageClassList();
            if(!document.getElementById('teacher-mgmt-page').classList.contains('hidden')) window.renderTeacherList();
            if(!document.getElementById('progress-page').classList.contains('hidden')) { window.renderSemesterList(); window.renderPendingApprovals(); window.populateProgClassSelect(); }
            if(!document.getElementById('class-details-page').classList.contains('hidden')) window.renderStudentList();
            
            if(currentUserType === 'student' && currentStudentObj) {
                let sId = currentStudentObj.id;
                for(let c of classesData) { let found = c.students?.find(x=>x.id===sId); if(found) { currentStudentObj=found; break;} }
                window.calculateStudentProgress(currentStudentObj);
            }
        });

        function updateFirebase() { set(ref(db, 'hifz_system_v1'), { classes: classesData, users: hifzUsers, semesters: semesters }); }
        window.toggleMobileMushaf = (layoutId, show) => { const layout = document.getElementById(layoutId); if(layout) layout.classList.toggle('show-mushaf-mobile', show); };

        // BACKUP & RESTORE FUNCTIONS
        window.openBackupModal = () => document.getElementById('backupModal').style.display = 'flex';
        
        window.backupData = () => {
            const data = { classes: classesData, users: hifzUsers, semesters: semesters };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "hifz_backup_" + window.getFormattedDate() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        window.restoreData = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm("ﬁâﬁ® ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁÉﬁ®ﬁêﬁ∞ﬁìﬁØ ﬁÜﬁÆﬁÅﬁ∞ﬁäﬁ®ﬁÇﬁ¶ﬁâﬁ¶ÿå ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÄﬁ™ﬁÉﬁ® ﬁëﬁ≠ﬁìﬁß ﬁäﬁ™ﬁÄﬁ¨ﬁàﬁ≠ﬁÇﬁ¨. ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ﬁéﬁ¨ﬁÇﬁ∞ﬁãﬁ¶ﬁÇﬁ∞ﬁàﬁ©ﬁåﬁ¶ÿü")) {
                        classesData = data.classes || [];
                        hifzUsers = data.users || [];
                        semesters = data.semesters || [];
                        updateFirebase();
                        alert("ﬁëﬁ≠ﬁìﬁß ﬁÉﬁ®ﬁêﬁ∞ﬁìﬁØ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨!");
                        location.reload();
                    }
                } catch (err) {
                    alert("Invalid Backup File");
                }
            };
            reader.readAsText(file);
        };

        window.switchLogin = (type) => { document.getElementById('teacher-login-form').classList.toggle('hidden', type !== 'teacher'); document.getElementById('student-login-form').classList.toggle('hidden', type !== 'student'); document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', (type==='teacher' && i===0) || (type==='student' && i===1))); };
        window.loginTeacher = () => { const u = document.getElementById('teacherUsername').value; const p = document.getElementById('teacherPassInput').value; if(p === '1234' && (!u || u === 'admin')) { currentUserType = 'teacher'; currentUserRole = 'admin'; proceedLogin(); return; } const uIdx = hifzUsers.findIndex(x => x.username === u); const user = hifzUsers[uIdx]; if(user) { if(!user.password) { pendingUserIndex = uIdx; currentUserType = 'teacher'; document.getElementById('passModalUserText').innerText = `ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞: ${user.name}`; document.getElementById('createPassModal').style.display = 'flex'; return; } if(user.password === p) { currentUserType = 'teacher'; currentUserRole = user.role; proceedLogin(); } else alert('ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®'); } else alert('ﬁÇﬁ¶ﬁâﬁßﬁáﬁ® ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁãﬁ®ﬁâﬁ¶ﬁáﬁ¨ﬁáﬁ∞ﬁÇﬁ™ﬁàﬁ≠'); };
        window.handleStudentLoginStep = () => { const id = document.getElementById('stuIdInput').value.trim(); if(!id) return alert("ID Required"); let found = null, cIdx = -1, sIdx = -1; classesData.forEach((c, ci) => c.students?.forEach((s, si) => { if(s.id === id) { found=s; cIdx=ci; sIdx=si; } })); if(!found) return alert("Not Found"); currentClassIdx = cIdx; currentStudentIdx = sIdx; currentStudentObj = found; if(!found.password) { currentUserType = 'student'; document.getElementById('passModalUserText').innerText = `ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™: ${found.name}`; document.getElementById('createPassModal').style.display = 'flex'; } else { const passField = document.getElementById('stuPassField'); if(passField.classList.contains('hidden')) passField.classList.remove('hidden'); else { if(document.getElementById('stuPassInput').value === found.password) window.loginSuccessStudent(); else alert("Wrong Password"); } } };
        window.saveNewPassword = () => { const pass = document.getElementById('newStuPass').value; if(!pass) return alert("Enter a password"); if(currentUserType === 'student') { classesData[currentClassIdx].students[currentStudentIdx].password = pass; updateFirebase(); document.getElementById('createPassModal').style.display='none'; window.loginSuccessStudent(); } else { if(pendingUserIndex > -1) { hifzUsers[pendingUserIndex].password = pass; updateFirebase(); document.getElementById('createPassModal').style.display='none'; document.getElementById('teacherPassInput').value = pass; window.loginTeacher(); } } };
        function proceedLogin() { document.body.classList.remove('student-mode'); document.getElementById('login-screen').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); document.getElementById('admin-panel-btn').classList.toggle('hidden', currentUserRole !== 'admin'); window.openPage('teacher-dashboard'); }
        window.loginSuccessStudent = () => { currentUserType = 'student'; document.body.classList.add('student-mode'); document.getElementById('login-screen').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); document.getElementById('studentDashName').innerText = currentStudentObj.name; window.calculateStudentProgress(currentStudentObj); window.openPage('student-dashboard'); };
        window.logout = () => location.reload();
        
        window.openPage = (id) => { document.querySelectorAll('.container').forEach(c => c.classList.add('hidden')); ['juz-exam-page', 'final-exam-page', 'recorder-page', 'teacher-mgmt-page'].forEach(p => { const el = document.getElementById(p); if(el) el.classList.add('hidden'); }); const p = document.getElementById(id); if(p) { p.classList.remove('hidden'); if(id==='management-page') window.renderManageClassList(); if(id==='teacher-mgmt-page') window.renderTeacherList(); if(id==='progress-page') { window.populateProgClassSelect(); window.renderSemesterList(); window.renderPendingApprovals(); } } };
        window.goBackFromCategory = () => { if(currentUserType === 'student') window.openPage('student-dashboard'); else window.openPage('grading-menu-page'); };

        // TEACHER & CLASS MGMT
        window.openTeacherManagement = () => window.openPage('teacher-mgmt-page'); window.createTeacher = () => { const name = document.getElementById('newTeachName').value, user = document.getElementById('newTeachUser').value, pass = document.getElementById('newTeachPass').value; if(name&&user&&pass) { hifzUsers.push({name,username:user,password:pass,role:'teacher'}); updateFirebase(); window.renderTeacherList(); document.getElementById('newTeachName').value=''; document.getElementById('newTeachUser').value=''; document.getElementById('newTeachPass').value=''; } }; window.renderTeacherList = () => { const div = document.getElementById('teacherList'); div.innerHTML=''; hifzUsers.forEach((u, i) => { if(u.role !== 'admin') div.innerHTML += `<div class="card-btn" style="min-height:100px; position:relative;"><h4>${u.name}</h4><span style="font-size:12px;color:#777;">User: ${u.username}</span><div style="display:flex; gap:5px; margin-top:5px;"><button class="btn-action-sm" onclick="window.resetTeacherPass(${i})" style="position:static; background:#fff3cd; color:#856404;">üîë</button><button class="btn-action-sm btn-delete-hist" onclick="window.deleteTeacher(${i})" style="position:static;">üóë</button></div></div>`; }); }; window.resetTeacherPass = (i) => { if(confirm("Reset password?")) { hifzUsers[i].password = ""; updateFirebase(); alert("Password reset."); } }; window.deleteTeacher = (i) => { if(confirm("Delete?")) { hifzUsers.splice(i, 1); updateFirebase(); window.renderTeacherList(); } };
        window.createClass = () => { let name = document.getElementById('newClassName').value, teach = document.getElementById('newTeacherName').value; if(name) { classesData.push({name:name, teacher:teach, students:[]}); updateFirebase(); window.renderManageClassList(); } }; window.renderManageClassList = () => { const div = document.getElementById('manageClassList'); div.innerHTML=''; if(classesData) classesData.forEach((c, i) => { div.innerHTML += `<div class="card-btn" onclick="window.openClass(${i})" style="position:relative;"><span class="card-icon">üè´</span><h4 class="card-title">${c.name}</h4><span class="card-sub">${c.teacher||''}</span><div class="class-actions"><button class="cls-act-btn btn-edit-cls" onclick="event.stopPropagation(); window.editClass(${i})">‚úèÔ∏è</button><button class="cls-act-btn btn-del-cls" onclick="event.stopPropagation(); window.deleteClass(${i})">üóë</button></div></div>`; }); }; window.editClass = (i) => { let name = prompt("New Name:", classesData[i].name), teach = prompt("New Teacher:", classesData[i].teacher); if(name) { classesData[i].name = name; classesData[i].teacher = teach; updateFirebase(); window.renderManageClassList(); } }; window.deleteClass = (i) => { if(confirm("Delete?")) { classesData.splice(i, 1); updateFirebase(); window.renderManageClassList(); } }; window.openClass = (i) => { currentClassIdx = i; window.renderStudentList(); window.openPage('class-details-page'); };

        window.renderStudentList = () => { const div = document.getElementById('studentManageList'); div.innerHTML=''; const students = classesData[currentClassIdx].students || []; if(!students.length) div.innerHTML = "<p style='text-align:center; color:#999'>No students yet.</p>"; students.forEach((s, idx) => { let pass = (s.password) ? `<span style="color:green">Pass Set</span>` : `<span style="color:red; font-weight:bold;">No Pass</span>`; div.innerHTML += `<div class="student-detail-card"><div class="st-card-header"><div class="st-name">${s.name}</div><div class="st-id">${s.id}</div></div><div class="st-info-grid"><div class="st-info-item"><span class="st-info-label">Module:</span> <b>${s.module || '-'}</b></div><div class="st-info-item"><span class="st-info-label">Level:</span> <b>${s.level || '-'}</b></div><div class="st-info-item"><span class="st-info-label">Direction:</span> <b>${s.direction==='bottom_up'?'ﬁåﬁ®ﬁÉﬁ®ﬁÇﬁ∞ ﬁâﬁ¶ﬁåﬁ®ﬁáﬁ¶ﬁÅﬁ∞':'ﬁâﬁ¶ﬁåﬁ®ﬁÇﬁ∞ ﬁåﬁ®ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞'}</b></div></div><div class="st-remarks-box">${s.remarks || 'No remarks'}</div><div class="st-footer-actions"><div style="font-size:12px;">${pass}</div><div class="student-actions" style="position:static;"><button class="btn-action-sm" style="background:#fff3cd; color:#856404;" onclick="event.stopPropagation(); window.resetPass(${idx})">üîë</button><button class="btn-action-sm btn-edit-hist" onclick="event.stopPropagation(); window.openEditStudentModal(${idx})">‚úèÔ∏è</button><button class="btn-action-sm btn-delete-hist" onclick="event.stopPropagation(); window.deleteStudent(${idx})">üóë</button></div></div></div>`; }); }; window.resetPass = (idx) => { if(confirm("Reset password?")) { classesData[currentClassIdx].students[idx].password = ""; updateFirebase(); window.renderStudentList(); } }

        window.openAddStudentModal = () => { editingStudentIndex = -1; ['m_module','m_id','m_name','m_remarks'].forEach(id => document.getElementById(id).value = ''); document.getElementById('btnSaveStudent').innerText = "ﬁêﬁ≠ﬁàﬁ∞"; document.getElementById('addStudentModal').style.display='flex'; }
        window.openEditStudentModal = (idx) => { editingStudentIndex = idx; const s = classesData[currentClassIdx].students[idx]; document.getElementById('m_module').value=s.module||''; document.getElementById('m_id').value=s.id; document.getElementById('m_name').value=s.name; document.getElementById('m_level').value=s.level||'1'; document.getElementById('m_direction').value=s.direction||'top_down'; document.getElementById('m_remarks').value=s.remarks||''; document.getElementById('btnSaveStudent').innerText="ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞"; document.getElementById('addStudentModal').style.display='flex'; }
        window.confirmAddStudent = () => { const name = document.getElementById('m_name').value, id = document.getElementById('m_id').value; if(!name||!id) return alert("Name & ID Required"); if(!classesData[currentClassIdx].students) classesData[currentClassIdx].students = []; if(editingStudentIndex > -1) { let s=classesData[currentClassIdx].students[editingStudentIndex]; s.name=name; s.id=id; s.module=document.getElementById('m_module').value; s.level=document.getElementById('m_level').value; s.direction=document.getElementById('m_direction').value; s.remarks=document.getElementById('m_remarks').value; } else { classesData[currentClassIdx].students.push({name, id, module:document.getElementById('m_module').value, level:document.getElementById('m_level').value, direction:document.getElementById('m_direction').value, remarks:document.getElementById('m_remarks').value, history:[], juzExams:{}, pendingData:[], password:"" }); } updateFirebase(); document.getElementById('addStudentModal').style.display='none'; window.renderStudentList(); }
        window.deleteStudent = (idx) => { if(confirm("Delete Student?")) { classesData[currentClassIdx].students.splice(idx, 1); updateFirebase(); window.renderStudentList(); } }
        window.downloadTemplate = () => { const wb = XLSX.utils.book_new(), ws = XLSX.utils.aoa_to_sheet([["Name", "ID", "Module", "Level", "Direction", "Juz Count", "Remarks"]]); XLSX.utils.book_append_sheet(wb, ws, "Template"); XLSX.writeFile(wb, "Student_Template.xlsx"); };
        window.handleExcelUpload = (input) => { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { const data = new Uint8Array(e.target.result), workbook = XLSX.read(data, {type: 'array'}), jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); if(!classesData[currentClassIdx].students) classesData[currentClassIdx].students = []; jsonData.forEach(row => { const name = row['Name'] || row['Student Name'], id = row['ID'] || row['Student ID']; if(name && id) classesData[currentClassIdx].students.push({name, id, module:row['Module']||'', level:row['Level']||'1', direction:row['Direction']||'top_down', remarks:row['Remarks']||'', history:[], juzExams:{}, pendingData:[]}); }); updateFirebase(); window.renderStudentList(); alert("Uploaded!"); input.value = ""; }; reader.readAsArrayBuffer(file); };

        // GRADING
        window.openGradingClassList = () => { const div = document.getElementById('gradingClassList'); div.innerHTML=''; if(classesData) classesData.forEach((c, i) => div.innerHTML += `<div class="card-btn" onclick="window.openGradingStudentList(${i})"><h4 class="card-title">${c.name}</h4></div>`); window.openPage('grading-class-page'); }
        window.openGradingStudentList = (i) => { currentClassIdx = i; const div = document.getElementById('gradingStudentList'); div.innerHTML=''; const students = classesData[i].students || []; students.forEach((s, idx) => div.innerHTML += `<div class="card-btn" onclick="window.openStudentMenu(${idx})"><h4 class="card-title">${s.name}</h4></div>`); window.openPage('grading-student-page'); }
        window.openStudentMenu = (i) => { currentStudentIdx = i; document.getElementById('gradingStudentName').innerText = classesData[currentClassIdx].students[i].name; window.openPage('grading-menu-page'); }
        
        window.openCategoryPage = (type) => { 
            currentSessionType = type; 
            let title = type==='juz_exam'?"ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞":(type==='new_lesson'?"ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™":(type==='final_exam'?"ﬁäﬁ¶ﬁÄﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞":"ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß")); 
            document.getElementById('catPageTitle').innerText = title; 
            
            const s = currentUserType==='student'?currentStudentObj:classesData[currentClassIdx].students[currentStudentIdx]; 
            
            // Default to latest semester
            if(semesters.length > 0) {
                activeHistorySemesterIdx = semesters.length - 1;
            } else {
                activeHistorySemesterIdx = -1;
            }

            window.renderSemesterTabs(); 
            window.renderHistory(s, 'categoryHistoryList', type); 
            
            if(type === 'juz_exam' && currentUserType === 'teacher') {
                document.getElementById('pastJuzBtn').style.display = 'inline-block';
            } else {
                document.getElementById('pastJuzBtn').style.display = 'none';
            }

            document.getElementById('addRecordBtn').style.display = (currentUserType==='student')?'none':'flex'; 
            window.openPage('category-page'); 
        }

        window.renderSemesterTabs = () => {
            const container = document.getElementById('historySemesterTabs');
            container.innerHTML = '';
            
            if(semesters.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';
            
            semesters.forEach((sem, i) => {
                const isCurrent = (i === semesters.length - 1);
                const isActive = (i === activeHistorySemesterIdx);
                
                let btnClass = isActive ? 'sem-tag active' : 'sem-tag';
                let label = sem.name;
                if(isCurrent) label += " (Current)";

                const btn = document.createElement('button');
                btn.className = btnClass;
                btn.innerText = label;
                btn.onclick = () => {
                    activeHistorySemesterIdx = i;
                    window.renderSemesterTabs();
                    const s = currentUserType==='student'?currentStudentObj:classesData[currentClassIdx].students[currentStudentIdx]; 
                    window.renderHistory(s, 'categoryHistoryList', currentSessionType);
                };
                container.appendChild(btn);
            });
        }

        window.handleAddButtonClick = () => { if(currentSessionType==='juz_exam') window.openJuzExamSetup(); else if(currentSessionType==='final_exam') window.openFinalExam(); else window.openRecorder(currentSessionType); }

        window.openPastJuzModal = () => {
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            const grid = document.getElementById('pastJuzGrid');
            grid.innerHTML = '';
            
            let passedJuz = s.manualPassedJuz || [];
            
            for(let i=1; i<=30; i++) {
                const isChecked = passedJuz.includes(i);
                grid.innerHTML += `
                    <label class="${isChecked?'checked':''}">
                        <input type="checkbox" value="${i}" ${isChecked?'checked':''} onchange="this.parentElement.classList.toggle('checked', this.checked)">
                        <span>Juz ${i}</span>
                    </label>
                `;
            }
            document.getElementById('pastJuzModal').style.display = 'flex';
        }

        window.savePastJuz = () => {
            const checkboxes = document.querySelectorAll('#pastJuzGrid input[type="checkbox"]:checked');
            const selectedJuz = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            classesData[currentClassIdx].students[currentStudentIdx].manualPassedJuz = selectedJuz;
            updateFirebase();
            
            alert("ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨!");
            document.getElementById('pastJuzModal').style.display = 'none';
        }

        window.openProgressPage = () => { window.populateProgClassSelect(); window.renderSemesterList(); window.renderPendingApprovals(); window.openPage('progress-page'); }
        window.createSemester = () => { const n=document.getElementById('semName').value, s=document.getElementById('semStart').value, e=document.getElementById('semEnd').value; if(n&&s&&e) { semesters.push({name:n, startDate:s, endDate:e}); updateFirebase(); window.renderSemesterList(); } else alert("Fill all fields"); }
        window.renderSemesterList = () => { const list = document.getElementById('semesterList'); list.innerHTML=''; semesters.forEach((sem, i) => list.innerHTML += `<div class="card-btn" onclick="window.viewSemesterReport(${i})"><h4>${sem.name}</h4><span>${sem.startDate} - ${sem.endDate}</span></div>`); }
        
        window.populateProgClassSelect = () => {
            const sel = document.getElementById('progClassSelect'); sel.innerHTML = '<option value="">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁöﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</option>';
            classesData.forEach((c, i) => sel.add(new Option(c.name, i)));
        }

        window.showClassProgressTable = (cIdx) => {
            const container = document.getElementById('classProgressTableContainer');
            const dlBtn = document.getElementById('btnDownloadExcel');
            
            if(cIdx === "") {
                container.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ¨ﬁáﬁ∞ ﬁöﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</p>`;
                dlBtn.style.display = 'none';
                return;
            }

            if(semesters.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</p>`;
                dlBtn.style.display = 'none';
                return;
            }

            dlBtn.style.display = 'inline-block';
            
            const currentSem = semesters[semesters.length - 1]; // Use current semester
            const startDate = new Date(currentSem.startDate);
            const endDate = new Date(currentSem.endDate);
            endDate.setHours(23, 59, 59, 999);

            let tableHtml = `
            <table id="progressTable" class="styled-table">
                <thead>
                    <tr>
                        <th rowspan="2">ﬁÇﬁ¶ﬁÇﬁ∞</th>
                        <th rowspan="2">ﬁçﬁ¨ﬁàﬁ¨ﬁçﬁ∞</th>
                        <th colspan="2" style="text-align:center;">ﬁâﬁ® ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉ</th>
                        <th rowspan="2">ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™</th>
                        <th rowspan="2">ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™</th>
                        <th rowspan="2">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™</th>
                    </tr>
                    <tr>
                        <th>ﬁäﬁ¨ﬁÅﬁ® ﬁÄﬁ®ﬁêﬁßﬁÑﬁ™</th>
                        <th>ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁ® ﬁÄﬁ®ﬁêﬁßﬁÑﬁ™</th>
                    </tr>
                </thead>
                <tbody>
            `;

            const students = classesData[cIdx].students || [];
            
            if(students.length === 0) {
                tableHtml += `<tr><td colspan="7" style="text-align:center;">No students</td></tr>`;
            } else {
                students.forEach(s => {
                    const stats = window.calculateSemesterStats(s, startDate, endDate);
                    tableHtml += `
                        <tr>
                            <td style="font-weight:bold;">${s.name}</td>
                            <td>${s.level || '-'}</td>
                            <td class="ar-txt">${stats.startPoint}</td>
                            <td class="ar-txt">${stats.endPoint}</td>
                            <td style="font-weight:bold; color:var(--primary); text-align:center;">${stats.balancePages}</td>
                            <td style="text-align:center; color:#e67e22;">${stats.semJuzCount} <br><span style="font-size:11px; color:#777;">(${stats.semJuzDetails})</span></td>
                            <td style="text-align:center; color:#27ae60; font-weight:bold;">${stats.totalJuzCount} <br><span style="font-size:11px; color:#777;">(${stats.totalJuzDetails})</span></td>
                        </tr>
                    `;
                });
            }

            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
        }

        window.calculateSemesterStats = (student, startDate, endDate) => {
            let startPoint = "-";
            let endPoint = "-";
            let balancePages = 0;
            let semJuzCount = 0;
            let semJuzDetails = "";
            let passedJuzSet = new Set();
            let allTimePassedJuz = new Set();

            if(student.manualPassedJuz && Array.isArray(student.manualPassedJuz)) {
                student.manualPassedJuz.forEach(j => allTimePassedJuz.add(j));
            }

            if (student.history) {
                let lessonRecs = student.history.filter(h => {
                    const d = new Date(h.date);
                    return h.type === 'new_lesson' && d >= startDate && d <= endDate;
                }).sort((a,b) => new Date(a.date) - new Date(b.date));

                if (lessonRecs.length > 0) {
                    const first = lessonRecs[0];
                    startPoint = `ﬁû ${first.page} (${first.startDetails?.surah}:${first.startDetails?.ayah})`;
                    
                    const last = lessonRecs[lessonRecs.length - 1];
                    endPoint = `ﬁû ${last.endPage || last.page} (${last.endDetails?.surah}:${last.endDetails?.ayah})`;

                    let startPageNum = parseInt(first.page);
                    let endPageNum = parseInt(last.endPage || last.page);
                    if(endPageNum >= startPageNum) {
                        balancePages = (endPageNum - startPageNum) + 1;
                    }
                }

                student.history.forEach(h => {
                     const recDate = new Date(h.date);
                     const score = parseFloat(h.score || 0);
                     
                     if (h.type === 'juz_exam' && score >= 60 && h.status !== 'partial') {
                         allTimePassedJuz.add(h.juz);
                         if (recDate >= startDate && recDate <= endDate) {
                             passedJuzSet.add(h.juz);
                         }
                     }
                });
            }

            semJuzCount = passedJuzSet.size;
            semJuzDetails = Array.from(passedJuzSet).sort((a,b)=>a-b).join(', ');

            let totalJuzCount = allTimePassedJuz.size;
            let totalJuzDetails = Array.from(allTimePassedJuz).sort((a,b)=>a-b).join(', ');

            return { startPoint, endPoint, balancePages, semJuzCount, semJuzDetails, totalJuzCount, totalJuzDetails };
        }
        
        window.downloadProgressExcel = () => {
            const table = document.getElementById("progressTable");
            if(!table) return;
            const wb = XLSX.utils.table_to_book(table, {sheet: "Progress"});
            XLSX.writeFile(wb, "Hifz_Progress_Report.xlsx");
        }

        window.calculateStudentProgress = (student) => { 
            // Calculate Stats for Student Dashboard with Target Logic
            if(!semesters.length) return; 
            const latestSem = semesters[semesters.length - 1];
            const start = new Date(latestSem.startDate);
            const end = new Date(latestSem.endDate); 
            
            const stats = window.calculateSemesterStats(student, start, end);
            
            document.getElementById('studentSemPages').innerText = stats.balancePages; 
            document.getElementById('studentSemJuz').innerText = stats.semJuzCount; 
            document.getElementById('studentTotalJuz').innerText = stats.totalJuzCount; 

            // Target Logic
            let level = parseInt(student.level) || 1;
            let target = (level >= 3) ? 3 : 2;
            let achieved = stats.semJuzCount;
            let percent = Math.min(100, (achieved / target) * 100);

            document.getElementById('targetLabel').innerText = `ﬁâﬁ® ﬁìﬁßﬁâﬁ∞ﬁéﬁ¨ ﬁìﬁßﬁÉﬁéﬁ¨ﬁìﬁ∞: ${target} ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™`;
            document.getElementById('targetPercent').innerText = `${Math.round(percent)}%`;
            document.getElementById('targetProgress').style.width = `${percent}%`;
            
            let msg = "ﬁÄﬁ®ﬁáﬁ∞ﬁàﬁ¶ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ≠!";
            if(percent >= 100) msg = "ﬁâﬁßﬁùﬁßÔ∑≤! ﬁìﬁßﬁÉﬁéﬁ¨ﬁìﬁ∞ ﬁÄﬁßﬁêﬁ®ﬁçﬁ∞ﬁàﬁ¨ﬁáﬁ∞ﬁñﬁ¨!";
            else if(percent >= 50) msg = "ﬁàﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁÉﬁ¶ﬁÇﬁéﬁ¶ﬁÖﬁ™ÿå ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞!";
            document.getElementById('targetMsg').innerText = msg;
        }

        window.populateSurahSelects = () => {
            const sSel = document.getElementById('startSurah');
            const eSel = document.getElementById('endSurah');
            if(!sSel || !eSel) return;
            sSel.innerHTML = ''; eSel.innerHTML = '';
            SURAH_NAMES_AR.forEach((n, i) => {
                sSel.add(new Option(n, i + 1));
                eSel.add(new Option(n, i + 1));
            });
            sSel.onchange = () => window.updateAyahOptions('startAyah', sSel.selectedIndex);
            eSel.onchange = () => window.updateAyahOptions('endAyah', eSel.selectedIndex);
            window.updateAyahOptions('startAyah', 0);
            window.updateAyahOptions('endAyah', 0);
        }

        window.updateAyahOptions = (targetId, surahIndex) => {
            const target = document.getElementById(targetId);
            if(!target) return;
            target.innerHTML = '';
            if (surahIndex >= 0 && surahIndex < AYAH_COUNTS.length) {
                const count = AYAH_COUNTS[surahIndex];
                for(let i=1; i<=count; i++) target.add(new Option(i, i));
            }
        }

        window.fetchPageDetailsForInput = async (pageInput, prefix) => { const page = parseInt(pageInput.value); if(!page || page < 1 || page > 604) return; const container = pageInput.parentElement; if(prefix === 'end') { const startInp = container.parentElement.querySelector('.p-start'); if(startInp && startInp.value && parseInt(page) < parseInt(startInp.value)) { alert("ﬁÇﬁ®ﬁâﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß ﬁäﬁ¨ﬁÅﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁßﬁáﬁ¶ﬁÅﬁ∞ﬁàﬁ™ﬁÉﬁ¨ ﬁÜﬁ™ﬁëﬁ¶ ﬁÇﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ≠ﬁÇﬁ¨ﬁáﬁ¨ﬁàﬁ¨."); pageInput.value = startInp.value; return window.fetchPageDetailsForInput(pageInput, 'end'); } } if(prefix === 'start') { const endInp = container.parentElement.querySelector('.p-end'); if(endInp && endInp.value && parseInt(endInp.value) < parseInt(page)) { alert("ﬁäﬁ¨ﬁÅﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß ﬁÇﬁ®ﬁâﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁßﬁáﬁ¶ﬁÅﬁ∞ﬁàﬁ™ﬁÉﬁ¨ ﬁÑﬁÆﬁëﬁ™ ﬁÇﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ≠ﬁÇﬁ¨ﬁáﬁ¨ﬁàﬁ¨."); pageInput.value = endInp.value; return window.fetchPageDetailsForInput(pageInput, 'start'); } } try { const res = await fetch(`https://api.alquran.cloud/v1/page/${page}/quran-uthmani`); const data = await res.json(); if(data.code === 200 && data.data.ayahs.length > 0) { const targetAyah = prefix === 'start' ? data.data.ayahs[0] : data.data.ayahs[data.data.ayahs.length-1]; const surahSel = container.querySelector(`.${prefix}-surah-sel`); const ayahSel = container.querySelector(`.${prefix}-ayah-sel`); if(surahSel && ayahSel) { surahSel.value = targetAyah.surah.number; window.updateLocalAyahOptions(surahSel, `${prefix}-ayah-sel`); ayahSel.value = targetAyah.numberInSurah; } } } catch(e) {} }

        // --- FIXED HELPER FUNCTIONS FOR BULK/EXTERNAL ---
        window.populateSurahsForElement = (container) => {
            const surahSelects = container.querySelectorAll('.start-surah-sel, .end-surah-sel');
            surahSelects.forEach(sel => {
                sel.innerHTML = '';
                SURAH_NAMES_AR.forEach((n, i) => sel.add(new Option(n, i + 1)));
                // Trigger initial population
                const prefix = sel.classList.contains('start-surah-sel') ? 'start-ayah-sel' : 'end-ayah-sel';
                window.updateLocalAyahOptions(sel, prefix);
            });
        };

        window.updateLocalAyahOptions = (surahSel, targetClass) => {
            const parent = surahSel.closest('div'); 
            if(!parent) return;
            const ayahSel = parent.querySelector('.' + targetClass);
            if(!ayahSel) return;

            const surahIdx = surahSel.value - 1;
            ayahSel.innerHTML = '';
            if(surahIdx >= 0 && surahIdx < AYAH_COUNTS.length) {
                const count = AYAH_COUNTS[surahIdx];
                for(let i=1; i<=count; i++) ayahSel.add(new Option(i, i));
            }
        };
        // -----------------------------------------------------

        window.openBulkEntryModal = () => { document.getElementById('bulkEntriesList').innerHTML = ''; document.getElementById('prevSemJuz').value = ''; window.addBulkRow(); document.getElementById('bulkEntryModal').style.display='flex'; }
        
        window.addBulkRow = () => { 
            const div = document.createElement('div'); div.className = 'form-grid b-row'; div.style.marginBottom = '15px'; div.style.borderBottom = '1px solid #ddd'; div.style.paddingBottom = '15px'; div.innerHTML = ` <input type="date" class="form-input b-date" style="grid-column: span 2; margin-bottom:5px;"> <select class="form-input b-type" style="grid-column: span 2; margin-bottom:10px;"><option value="new_lesson">ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</option><option value="short_rev">ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</option><option value="long_rev">ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</option></select> <div style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee;"> <label class="form-label" style="font-size:12px;">ﬁäﬁ¨ﬁÅﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label> <input type="number" class="form-input p-start" style="margin-bottom:5px;" onchange="window.fetchPageDetailsForInput(this, 'start')"> <div style="display:flex; gap:5px;"><select class="form-input start-surah-sel" style="flex:1; padding:5px; font-size:12px; margin:0;" onchange="window.updateLocalAyahOptions(this, 'start-ayah-sel')"></select><select class="form-input start-ayah-sel" style="width:50px; padding:5px; font-size:12px; margin:0;"></select></div> </div> <div style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee;"> <label class="form-label" style="font-size:12px;">ﬁÇﬁ®ﬁâﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label> <input type="number" class="form-input p-end" style="margin-bottom:5px;" onchange="window.fetchPageDetailsForInput(this, 'end')"> <div style="display:flex; gap:5px;"><select class="form-input end-surah-sel" style="flex:1; padding:5px; font-size:12px; margin:0;" onchange="window.updateLocalAyahOptions(this, 'end-ayah-sel')"></select><select class="form-input end-ayah-sel" style="width:50px; padding:5px; font-size:12px; margin:0;"></select></div> </div> `; document.getElementById('bulkEntriesList').appendChild(div); 
            window.populateSurahsForElement(div); 
        }
        
        window.saveBulkData = async () => { 
            const rows = document.querySelectorAll('#bulkEntriesList .b-row'); 
            let pendingEntries = []; 
            for (let row of rows) { 
                const date = row.querySelector('.b-date').value; 
                const type = row.querySelector('.b-type').value; 
                const startP = row.querySelector('.p-start').value; 
                const endP = row.querySelector('.p-end').value; 
                const sSurahIdx = row.querySelector('.start-surah-sel').value - 1; 
                const sAyah = row.querySelector('.start-ayah-sel').value; 
                const eSurahIdx = row.querySelector('.end-surah-sel').value - 1; 
                const eAyah = row.querySelector('.end-ayah-sel').value; 
                if(date && startP && endP) { 
                    if(sSurahIdx < 0 || eSurahIdx < 0) { } 
                    if(parseInt(endP) < parseInt(startP)) { 
                        alert("ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®"); return; 
                    } 
                    pendingEntries.push({ 
                        type: type, 
                        date: date, 
                        page: startP, 
                        endPage: endP, 
                        status: 'pending', 
                        timestamp: new Date().getTime(), 
                        startDetails: { surah: SURAH_NAMES_AR[sSurahIdx] || "-", ayah: sAyah }, 
                        endDetails: { surah: SURAH_NAMES_AR[eSurahIdx] || "-", ayah: eAyah } 
                    }); 
                } 
            } 
            if(pendingEntries.length > 0) { 
                classesData.forEach(c => { 
                    let sIdx = c.students?.findIndex(s => s.id === currentStudentObj.id); 
                    if(sIdx > -1) { 
                        if(!c.students[sIdx].pendingData) c.students[sIdx].pendingData = []; 
                        c.students[sIdx].pendingData.push(...pendingEntries); 
                    } 
                }); 
                updateFirebase(); 
                alert("ﬁáﬁ¨ﬁïﬁ∞ﬁÉﬁ´ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ ﬁäﬁÆﬁÇﬁ™ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨!"); 
                document.getElementById('bulkEntryModal').style.display='none'; 
            } 
        }

        window.openExternalRecModal = () => { 
            document.getElementById('extPerson').value = ''; 
            document.getElementById('extDate').valueAsDate = new Date(); 
            document.getElementById('extStartPage').value = ''; 
            document.getElementById('extEndPage').value = ''; 
            window.populateSurahsForElement(document.querySelector('.ext-form-container')); 
            document.getElementById('externalRecModal').style.display='flex'; 
        }
        
        window.saveExternalRecitation = () => { 
            const container = document.querySelector('.ext-form-container'); 
            const person = document.getElementById('extPerson').value; 
            const date = document.getElementById('extDate').value; 
            const type = document.getElementById('extType').value; 
            const startP = document.getElementById('extStartPage').value; 
            const endP = document.getElementById('extEndPage').value; 
            if(!person || !startP || !endP) return alert("ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ¨ﬁáﬁ∞ ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß"); 
            const sSurahIdx = container.querySelector('.start-surah-sel').value - 1; 
            const sAyah = container.querySelector('.start-ayah-sel').value; 
            const eSurahIdx = container.querySelector('.end-surah-sel').value - 1; 
            const eAyah = container.querySelector('.end-ayah-sel').value; 
            if(parseInt(endP) < parseInt(startP)) return alert("ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®"); 
            const entry = { 
                type: type, 
                date: date, 
                page: startP, 
                endPage: endP, 
                status: 'pending', 
                recitedTo: person, 
                isExternal: true, 
                timestamp: new Date().getTime(), 
                startDetails: { surah: SURAH_NAMES_AR[sSurahIdx] || "-", ayah: sAyah }, 
                endDetails: { surah: SURAH_NAMES_AR[eSurahIdx] || "-", ayah: eAyah } 
            }; 
            classesData.forEach(c => { 
                let sIdx = c.students?.findIndex(s => s.id === currentStudentObj.id); 
                if(sIdx > -1) { 
                    if(!c.students[sIdx].pendingData) c.students[sIdx].pendingData = []; 
                    c.students[sIdx].pendingData.push(entry); 
                } 
            }); 
            updateFirebase(); 
            alert("ﬁáﬁ¨ﬁïﬁ∞ﬁÉﬁ´ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ ﬁäﬁÆﬁÇﬁ™ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨!"); 
            document.getElementById('externalRecModal').style.display='none'; 
        }

        // TEACHER APPROVAL
        window.renderPendingApprovals = () => { const list = document.getElementById('pendingApprovalsList'); list.innerHTML = ''; let hasPending = false; classesData.forEach((c, cIdx) => { c.students?.forEach((s, sIdx) => { if(s.pendingData && s.pendingData.length > 0) { s.pendingData.forEach((p, pIdx) => { hasPending = true; let isJuzUpdate = p.type === 'juz_update'; let typeLabel = p.type === 'new_lesson' ? "ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™" : (p.type === 'short_rev' ? "ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß" : "ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß"); let detailsHtml = ""; if(isJuzUpdate) detailsHtml = `<strong style="color:var(--accent);">Update Total Juz to: ${p.value}</strong>`; else { let extBadge = p.isExternal ? `<div style="background:#8e44ad; color:white; padding:3px 10px; border-radius:10px; font-size:12px; display:inline-block; margin-bottom:5px;">üë§ ﬁÜﬁ®ﬁîﬁ¶ﬁáﬁ®ﬁãﬁ®ﬁÇﬁ©: ${p.recitedTo}</div><br>` : ''; detailsHtml = `${extBadge}<strong style="color:var(--primary); font-size:16px;">${typeLabel}</strong><br><div style="font-size:13px; text-align:right; margin-top:5px; background:#fff; padding:8px; border-radius:5px; border:1px solid #eee;">ﬁäﬁ¨ﬁÅﬁ™ﬁÇﬁ©: ﬁû <b>${p.page}</b> (ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ ${p.startDetails?.surah} - ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ${p.startDetails?.ayah})<br>ﬁÇﬁ®ﬁâﬁ™ﬁÇﬁ©: ﬁû <b>${p.endPage}</b> (ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ ${p.endDetails?.surah} - ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ${p.endDetails?.ayah})</div>`; } list.innerHTML += `<div class="approval-card" style="${isJuzUpdate ? 'border-right-color:#2ecc71;' : (p.isExternal ? 'border-right-color:#8e44ad;' : '')}"><div class="app-card-header"><div class="app-stu-name">${s.name} <span style="font-size:12px; font-weight:normal; color:#777;">(${c.name})</span></div><div class="app-date">${p.date}</div></div><div class="app-details">${detailsHtml}</div><div class="app-actions"><button class="btn-approve" onclick="window.approveEntry(${cIdx}, ${sIdx}, ${pIdx})">‚úì Approve</button><button class="btn-reject" onclick="window.rejectEntry(${cIdx}, ${sIdx}, ${pIdx})">‚úï Reject</button></div></div>`; }); } }); }); if(!hasPending) list.innerHTML = '<p style="text-align:center; color:#999;">No pending approvals</p>'; }
        
        window.approveEntry = async (cIdx, sIdx, pIdx) => { 
            const student = classesData[cIdx].students[sIdx]; 
            const entry = student.pendingData[pIdx]; 
            
            if(entry.type === 'juz_update') {
                student.juzCount = entry.value; 
            } else { 
                if(!student.history) student.history = []; 
                student.history.push({ 
                    type: entry.type, 
                    date: entry.date, 
                    page: entry.page, 
                    endPage: entry.endPage, 
                    startDetails: entry.startDetails, 
                    endDetails: entry.endDetails, 
                    mistakesCount: 0, 
                    mistakeDetails: [], 
                    recitedTo: entry.recitedTo || null 
                }); 
            } 
            student.pendingData.splice(pIdx, 1); 
            updateFirebase(); 
            window.renderPendingApprovals(); 
        }

        window.rejectEntry = (cIdx, sIdx, pIdx) => { 
            classesData[cIdx].students[sIdx].pendingData.splice(pIdx, 1); 
            updateFirebase(); 
            window.renderPendingApprovals(); 
        }

        // HISTORY & SLIP DOWNLOAD WITH SEMESTER FILTER
        window.renderHistory = (student, listId, filterType) => {
            const list = document.getElementById(listId); 
            list.innerHTML = ''; 
            if(!student.history) student.history = [];
            
            let records = filterType ? student.history.filter(r => r.type === filterType) : student.history;

            if(activeHistorySemesterIdx !== -1 && semesters[activeHistorySemesterIdx]) {
                const currentSem = semesters[activeHistorySemesterIdx];
                const startDate = new Date(currentSem.startDate);
                const endDate = new Date(currentSem.endDate);
                endDate.setHours(23, 59, 59, 999);

                records = records.filter(rec => {
                    const rDate = new Date(rec.date);
                    return rDate >= startDate && rDate <= endDate;
                });
            }

            if(!records.length) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">
                    <div style="font-size:40px; margin-bottom:10px;">üì≠</div>
                    ﬁâﬁ® ﬁêﬁ¨ﬁâﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÉﬁéﬁ¶ﬁáﬁ® ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞
                </div>`;
                return;
            }

            records.slice().reverse().forEach(rec => {
                const realIndex = student.history.indexOf(rec); 
                let html = '';
                let deleteBtn = currentUserType === 'teacher' ? `<button class="btn-delete-hist abs-pos" onclick="event.stopPropagation(); window.deleteHistoryRecord(${realIndex})">üóë</button>` : ''; 
                let editBtn = currentUserType === 'teacher' ? `<button class="btn-edit-hist abs-pos" onclick="event.stopPropagation(); window.editRecord(${realIndex}, '${rec.type}')">‚úèÔ∏è</button>` : '';
                
                if(rec.type === 'juz_exam') { 
                    let status = rec.status === 'partial' ? '<span class="hist-badge bg-pending" style="background:#f1c40f;color:#fff;padding:3px 8px;border-radius:10px;font-size:12px;">ﬁäﬁ¶ﬁÄﬁ™ﬁÑﬁ¶ﬁáﬁ® ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠</span>' : '<span class="hist-badge bg-complete" style="background:#2ecc71;color:#fff;padding:3px 8px;border-radius:10px;font-size:12px;">ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶</span>'; 
                    let dlBtn = `<button style="background:none; border:none; cursor:pointer; font-size:20px;" title="Download Slip" onclick="event.stopPropagation(); window.downloadExamSlip('${encodeURIComponent(student.name)}', '${encodeURIComponent(JSON.stringify(rec))}')">üì•</button>`;
                    html = `
                        <div class="hist-card type-juz_exam" onclick='window.viewJuzRecord(${JSON.stringify(rec)})'>
                            <div class="hist-header"><span class="hist-title">Juz ${rec.juz} Exam</span>${status}</div>
                            <div class="hist-body">
                                <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                                    <div><span style="font-size:12px;color:#777;display:block;">ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</span><b>${rec.date}</b></div>
                                    <div style="text-align:left;"><span style="font-size:12px;color:#777;display:block;">ﬁàﬁ¶ﬁéﬁ™ﬁåﬁ™</span><b>${rec.duration}</b></div>
                                </div>
                                <div class="hist-grid" style="grid-template-columns: 1fr 1fr;">
                                    <div class="hist-item"><span class="hist-label">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ ﬁÜﬁ™ﬁÅﬁ∞</span><span class="hist-val" style="color:red">${rec.details?.teacherMistakes||0} <span style="font-size:12px;">(-${(rec.details?.teacherMistakes||0)*2})</span></span></div>
                                    <div class="hist-item"><span class="hist-label">ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ ﬁÜﬁ™ﬁÅﬁ∞</span><span class="hist-val" style="color:#e67e22">${rec.details?.selfMistakes||0} <span style="font-size:12px;">(-${(rec.details?.selfMistakes||0)*1})</span></span></div>
                                    <div class="hist-item"><span class="hist-label">ﬁåﬁ¶ﬁñﬁ™ﬁàﬁ©ﬁãﬁ™</span><span class="hist-val">${rec.details?.tajweed||10} / 10</span></div>
                                    <div class="hist-item"><span class="hist-label">ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞</span><span class="hist-val">${rec.details?.fluency||5} / 5</span></div>
                                    <div class="hist-item" style="grid-column: span 2;"><span class="hist-label">ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™</span><span class="hist-val">${rec.details?.mutashabihMarks||0} / 5</span></div>
                                </div>
                            </div>
                            <div class="hist-footer exam-score"><span>ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß: ${rec.score}%</span> ${dlBtn}</div>
                            ${deleteBtn}
                        </div>`; 
                } 
                else if(rec.type === 'final_exam') { 
                    html = `<div class="hist-card type-final_exam"><div class="hist-header"><span class="hist-title">Final Exam</span></div><div class="hist-body"><div style="text-align:center; padding:10px;"><span style="font-size:14px; color:#777;">ﬁÜﬁ™ﬁÅﬁ∞: ${rec.mistakesCount}</span></div></div><div class="hist-footer exam-score" style="justify-content:center;">${rec.score}%</div>${deleteBtn}</div>`; 
                } 
                else { 
                    const sInfo = rec.startDetails ? `ÿ≥Ÿàÿ±ÿ© ${rec.startDetails.surah}ÿå ÿ¢Ÿäÿ© ${rec.startDetails.ayah}` : '-'; 
                    const eInfo = rec.endDetails ? `ÿ≥Ÿàÿ±ÿ© ${rec.endDetails.surah}ÿå ÿ¢Ÿäÿ© ${rec.endDetails.ayah}` : '-'; 
                    const extBadge = rec.recitedTo ? `<div class="hist-badge-external">üë§ ﬁÜﬁ®ﬁîﬁ¶ﬁáﬁ®ﬁãﬁ®ﬁÇﬁ©: ${rec.recitedTo}</div>` : ''; 
                    
                    html = `<div class="hist-card type-${rec.type}" onclick='window.viewLessonRecord(${JSON.stringify(rec)})'>
                                <div class="hist-header"><span class="hist-title">Page ${rec.page} - ${rec.endPage||rec.page}</span><span class="hist-date">${rec.date}</span></div>
                                <div class="hist-body">${extBadge}
                                    <div class="hist-detail-row"><span class="hist-detail-lbl">ﬁäﬁ¨ﬁÅﬁ™ﬁÇﬁ©</span><span class="hist-detail-val">${sInfo}</span><span class="hist-detail-pg">ﬁû ${rec.page}</span></div>
                                    <div class="hist-detail-row"><span class="hist-detail-lbl">ﬁÇﬁ®ﬁâﬁ™ﬁÇﬁ©</span><span class="hist-detail-val">${eInfo}</span><span class="hist-detail-pg">ﬁû ${rec.endPage || rec.page}</span></div>
                                </div>
                                <div class="hist-footer" style="color:var(--mistake);">ﬁÜﬁ™ﬁÅﬁ∞: ${rec.mistakesCount||0}</div>
                                ${deleteBtn} ${editBtn}
                            </div>`; 
                }
                list.innerHTML += html;
            });
        };

        window.deleteHistoryRecord = (index) => { if(confirm("ﬁâﬁ® ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁàﬁ≠ﬁåﬁ¶ÿü")) { const s = currentUserType==='student' ? currentStudentObj : classesData[currentClassIdx].students[currentStudentIdx]; s.history.splice(index, 1); updateFirebase(); window.renderHistory(s, currentUserType==='student'?'studentDashHistory':'categoryHistoryList', currentSessionType); } }
        
        // --- FIXED EDIT RECORD FUNCTION ---
        window.editRecord = (index, type) => { 
            const student = currentUserType==='student'?currentStudentObj:classesData[currentClassIdx].students[currentStudentIdx]; 
            const rec = student.history[index]; 
            isViewMode = false; 
            editingRecordIndex = index; 
            
            if(type === 'new_lesson' || type === 'short_rev' || type === 'long_rev') { 
                currentMistakes = rec.mistakeDetails || []; 
                currentSessionType = rec.type; 
                document.getElementById('recorderTitle').innerText = "Edit Record"; 
                document.getElementById('recSaveBtn').innerText = "Update"; 
                document.getElementById('recSaveBtn').style.display = 'block'; 
                document.getElementById('recDate').value = rec.date; 
                document.getElementById('startPage').value = rec.page; 
                
                currentRecViewPage = parseInt(rec.page); 
                
                window.loadSmartPage(true).then(() => { 
                    document.getElementById('endPage').value = rec.endPage; 
                    
                    window.populateSurahSelects(); // Ensure selects are populated first

                    // Set Start Surah & Trigger Update
                    let sIndex = SURAH_NAMES_AR.indexOf(rec.startDetails.surah);
                    if(sIndex > -1) {
                        document.getElementById('startSurah').value = sIndex + 1;
                        window.updateAyahOptions('startAyah', sIndex);
                        document.getElementById('startAyah').value = rec.startDetails.ayah;
                    }

                    // Set End Surah & Trigger Update
                    let eIndex = SURAH_NAMES_AR.indexOf(rec.endDetails.surah);
                    if(eIndex > -1) {
                        document.getElementById('endSurah').value = eIndex + 1;
                        window.updateAyahOptions('endAyah', eIndex);
                        document.getElementById('endAyah').value = rec.endDetails.ayah;
                    }
                }); 
                
                document.getElementById('mistakeCountDisplay').innerText = rec.mistakesCount; 
                document.getElementById('recorder-page').classList.remove('hidden'); 
            } 
        }

        window.downloadExamSlip = (encName, encRec) => {
            const name = decodeURIComponent(encName);
            const rec = JSON.parse(decodeURIComponent(encRec));
            
            const slip = document.createElement('div');
            slip.style.cssText = "width:600px; padding:30px; background:white; font-family:'MV Waheed', sans-serif; direction:rtl; text-align:right; color:#333;";
            slip.innerHTML = `
                <div style="text-align:center; border-bottom:3px solid #2c3e50; padding-bottom:15px; margin-bottom:20px;">
                    <h1 style="margin:0; color:#2c3e50; font-size:32px;">ÿ•ÿ™ŸÇÿßŸÜ - ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞</h1>
                    <h2 style="margin:5px 0 0 0; color:#27ae60; font-size:24px;">ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞ ﬁÉﬁ®ﬁïﬁØﬁìﬁ∞</h2>
                </div>
                <div style="font-size:20px; margin-bottom:10px;"><strong>ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™:</strong> ${name}</div>
                <div style="font-size:20px; margin-bottom:20px;"><strong>ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™:</strong> ${rec.juz} (${rec.status === 'partial' ? 'ﬁäﬁ¶ﬁÄﬁ™ﬁÑﬁ¶ﬁáﬁ® ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠' : 'ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶'})</div>
                
                <table style="width:100%; border-collapse:collapse; margin-bottom:20px; font-size:18px;">
                    <tr><td style="padding:10px; border:1px solid #ddd; background:#f9f9f9; width:60%;">ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</td><td style="padding:10px; border:1px solid #ddd; text-align:center;">${rec.date}</td></tr>
                    <tr><td style="padding:10px; border:1px solid #ddd; background:#f9f9f9;">ﬁÄﬁ≠ﬁãﬁ¶ﬁàﬁ® ﬁàﬁ¶ﬁéﬁ™ﬁåﬁ™</td><td style="padding:10px; border:1px solid #ddd; text-align:center;">${rec.duration}</td></tr>
                    <tr><td style="padding:10px; border:1px solid #ddd; background:#f9f9f9;">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ ﬁÜﬁ™ﬁÅﬁ∞ (ﬁÜﬁÆﬁÇﬁ∞ﬁâﬁ¨ ﬁÜﬁ™ﬁÅﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ -2)</td><td style="padding:10px; border:1px solid #ddd; text-align:center;">${rec.details?.teacherMistakes||0}</td></tr>
                    <tr><td style="padding:10px; border:1px solid #ddd; background:#f9f9f9;">ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ ﬁÜﬁ™ﬁÅﬁ∞ (ﬁÜﬁÆﬁÇﬁ∞ﬁâﬁ¨ ﬁÜﬁ™ﬁÅﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ -1)</td><td style="padding:10px; border:1px solid #ddd; text-align:center;">${rec.details?.selfMistakes||0}</td></tr>
                    <tr><td style="padding:10px; border:1px solid #ddd; background:#f9f9f9;">ﬁåﬁ¶ﬁñﬁ™ﬁàﬁ©ﬁãﬁ™</td><td style="padding:10px; border:1px solid #ddd; text-align:center;">${rec.details?.tajweed||0} / 10</td></tr>
                    <tr><td style="padding:10px; border:1px solid #ddd; background:#f9f9f9;">ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞</td><td style="padding:10px; border:1px solid #ddd; text-align:center;">${rec.details?.fluency||0} / 5</td></tr>
                    <tr><td style="padding:10px; border:1px solid #ddd; background:#f9f9f9;">ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞</td><td style="padding:10px; border:1px solid #ddd; text-align:center;">${rec.details?.mutashabihMarks||0} / 5</td></tr>
                </table>
                <div style="background:#eafaf1; border:2px solid #27ae60; border-radius:10px; padding:15px; text-align:center;">
                    <span style="font-size:24px; font-weight:bold; color:#2c3e50;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß:</span>
                    <span style="font-size:32px; font-weight:bold; color:#27ae60; margin-right:15px;">${rec.score}%</span>
                </div>
            `;
            
            document.body.appendChild(slip);
            html2pdf().set({
                margin: 10, filename: `Juz_${rec.juz}_Slip_${name}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(slip).save().then(() => { document.body.removeChild(slip); });
        };

        window.openRecorder = (type) => { editingRecordIndex = -1; isViewMode = false; currentMistakes = []; currentSessionType = type; document.getElementById('recorderTitle').innerText = "ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞"; document.getElementById('recSaveBtn').innerText = "Save"; document.getElementById('recSaveBtn').style.display = 'block'; document.getElementById('viewModeBadge').style.display = 'none'; document.getElementById('recDate').valueAsDate = new Date(); document.getElementById('mistakeCountDisplay').innerText = 0; document.getElementById('mushafContent').innerHTML = '<p style="color:#999; margin-top:100px;">...</p>'; 
        window.populateSurahSelects(); 
        const s = classesData[currentClassIdx].students[currentStudentIdx]; let initialPage = 1; if(s.history) { const recs = s.history.filter(r => r.type === type); if(recs.length > 0) { const last = recs[recs.length-1]; const nextP = parseInt(last.endPage || last.page) + 1; if(nextP <= 604) initialPage = nextP; } } document.getElementById('startPage').value = initialPage; currentRecViewPage = initialPage; window.loadSmartPage(); document.getElementById('recorder-page').classList.remove('hidden'); };
        
        window.closeRecorder = () => { document.getElementById('recorder-page').classList.add('hidden'); if(currentUserType === 'student') window.renderHistory(currentStudentObj, 'studentDashHistory', null); else if(currentStudentIdx !== -1) window.renderHistory(classesData[currentClassIdx].students[currentStudentIdx], 'categoryHistoryList', currentSessionType); };
        window.handleStartPageChange = () => { let val = parseInt(document.getElementById('startPage').value); if(val) { currentRecViewPage = val; window.loadSmartPage(); window.validateRecorderPages(); } }
        window.validateRecorderPages = () => { const sp = parseInt(document.getElementById('startPage').value); const ep = parseInt(document.getElementById('endPage').value); if(sp && ep && ep < sp) { alert("ﬁÇﬁ®ﬁâﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß ﬁäﬁ¨ﬁÅﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁßﬁáﬁ¶ﬁÅﬁ∞ﬁàﬁ™ﬁÉﬁ¨ ﬁÜﬁ™ﬁëﬁ¶ ﬁÇﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ≠ﬁÇﬁ¨ﬁáﬁ¨ﬁàﬁ¨."); document.getElementById('endPage').value = sp; } }
        
        // --- FIXED MUSHAF RENDERER: NO DOUBLE BISMILLAH & PAGE NUM ---
        window.loadSmartPage = async (applyHighlights=false, isNavigating=false) => { const page = currentRecViewPage; if(!page) return; const res = await fetch(`https://api.alquran.cloud/v1/page/${page}/quran-uthmani`); const data = await res.json(); window.renderMushafText(data.data.ayahs, 'mushafContent', currentMistakes, false); if(!isViewMode && data.data.ayahs.length > 0) { if(editingRecordIndex === -1 && !isNavigating && page == document.getElementById('startPage').value) { document.getElementById('endPage').value = page; const first = data.data.ayahs[0]; window.populateSurahSelects(); document.getElementById('startSurah').value = first.surah.number; window.updateAyahOptions('startAyah', first.surah.number-1); document.getElementById('startAyah').value = first.numberInSurah; const last = data.data.ayahs[data.data.ayahs.length-1]; document.getElementById('endSurah').value = last.surah.number; window.updateAyahOptions('endAyah', last.surah.number-1); document.getElementById('endAyah').value = last.numberInSurah; } else if(isNavigating) { document.getElementById('endPage').value = page; const last = data.data.ayahs[data.data.ayahs.length-1]; document.getElementById('endSurah').value = last.surah.number; window.updateAyahOptions('endAyah', last.surah.number-1); document.getElementById('endAyah').value = last.numberInSurah; } } };
        window.changeRecPage = (dir) => { let p = currentRecViewPage + dir; if(p>0 && p<=604) { currentRecViewPage = p; window.loadSmartPage(false, true); } }
        
        window.renderMushafText = (ayahs, target, highlights, isExam) => { 
            const container = document.getElementById(target);
            container.innerHTML = '';
            
            if(ayahs.length === 0) return;

            const first = ayahs[0];
            const currentPageNum = first.page; 
            const juzTarget = isExam ? 'mushafJuzInfo' : 'recMushafJuz';
            const surahTarget = isExam ? 'mushafSurahInfo' : 'recMushafSurah';
            
            if(document.getElementById(juzTarget)) document.getElementById(juzTarget).innerText = `Juz ${first.juz}`;
            if(document.getElementById(surahTarget)) document.getElementById(surahTarget).innerText = `ÿ≥Ÿàÿ±ÿ© ${first.surah.name}`;

            let currentSurah = null;
            let html = '';
            const BISMILLAH = "ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸëŸéŸáŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê";

            ayahs.forEach(a => {
                if (currentSurah !== a.surah.number) {
                    if (currentSurah !== null) html += '</div>'; 
                    currentSurah = a.surah.number;
                    html += `<div class="surah-header-box"><div class="surah-title">ÿ≥Ÿàÿ±ÿ© ${a.surah.name}</div></div>`;
                    
                    // Add Bismillah Box except for Tawbah
                    if (a.numberInSurah === 1 && a.surah.number !== 9) {
                         html += `<div class="bismillah-box">${BISMILLAH}</div>`;
                    }
                    html += '<div class="quran-block" dir="rtl">';
                }

                // Remove Bismillah from text if it's the first Ayah
                let ayahText = a.text;
                if(a.numberInSurah === 1 && a.surah.number !== 9) {
                    ayahText = ayahText.replace(BISMILLAH, '').trim();
                }

                const words = ayahText.split(' ');
                words.forEach((w, i) => {
                    const id = `p${a.page}_s${a.surah.number}_a${a.numberInSurah}_w${i}`;
                    let cls = highlights.includes(id) ? 'word mistake' : 'word';
                    let fn = isExam ? `window.clickExamWord('${id}')` : `window.clickRecWord('${id}')`;
                    html += `<span id="${id}" class="${cls}" onclick="${fn}">${w}</span> `;
                });
                
                html += `<span class="ayah-marker">(${a.numberInSurah})</span> `;
            });

            html += '</div>'; 
            
            // Add Page Number at Bottom
            html += `<div class="page-footer-num" style="text-align:center; margin-top:20px; font-size:14px; color:#777; border-top:1px solid #eee; padding-top:5px;">Page ${currentPageNum}</div>`;

            container.innerHTML = html;
        };

        window.clickRecWord = (id) => { if(isViewMode) return; const el = document.getElementById(id); if(el.classList.contains('mistake')) { el.classList.remove('mistake'); currentMistakes = currentMistakes.filter(x=>x!==id); } else { el.classList.add('mistake'); currentMistakes.push(id); } document.getElementById('mistakeCountDisplay').innerText = currentMistakes.length; };
        
        window.saveRecord = () => { 
            const startP = document.getElementById('startPage').value; 
            const endP = document.getElementById('endPage').value; 
            if(parseInt(endP) < parseInt(startP)) { 
                alert("ﬁÇﬁ®ﬁâﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß ﬁäﬁ¨ﬁÅﬁ≠ ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁßﬁáﬁ¶ﬁÅﬁ∞ﬁàﬁ™ﬁÉﬁ¨ ﬁÜﬁ™ﬁëﬁ¶ ﬁÇﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ≠ﬁÇﬁ¨ﬁáﬁ¨ﬁàﬁ¨."); return; 
            } 
            const s = classesData[currentClassIdx].students[currentStudentIdx]; 
            if(!s.history) s.history = []; 
            const ssIdx = document.getElementById('startSurah').selectedIndex; 
            const esIdx = document.getElementById('endSurah').selectedIndex; 
            const startSurahName = SURAH_NAMES_AR[ssIdx] || "-";
            const endSurahName = SURAH_NAMES_AR[esIdx] || "-";
            const startObj = { surah: startSurahName, ayah: document.getElementById('startAyah').value }; 
            const endObj = { surah: endSurahName, ayah: document.getElementById('endAyah').value }; 
            const record = { 
                type: currentSessionType, 
                date: document.getElementById('recDate').value, 
                page: startP, 
                endPage: endP, 
                startDetails: startObj, 
                endDetails: endObj, 
                mistakesCount: currentMistakes.length, 
                mistakeDetails: currentMistakes 
            }; 
            if(editingRecordIndex > -1) { 
                s.history[editingRecordIndex] = record; 
            } else { 
                s.history.push(record); 
            } 
            updateFirebase(); 
            alert("ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨"); 
            window.closeRecorder(); 
        };

        window.viewLessonRecord = (rec) => { isViewMode = true; currentMistakes = rec.mistakeDetails || []; document.getElementById('recorderTitle').innerText = "View Record"; document.getElementById('recSaveBtn').style.display = 'none'; document.getElementById('viewModeBadge').style.display = 'block'; document.getElementById('recDate').value = rec.date; document.getElementById('startPage').value = rec.page; document.getElementById('endPage').value = rec.endPage; document.getElementById('mistakeCountDisplay').innerText = rec.mistakesCount; document.getElementById('recorder-page').classList.remove('hidden'); currentRecViewPage = parseInt(rec.page); window.loadSmartPage(true); };
        
        window.openJuzExamSetup = () => { const juzSel = document.getElementById('examJuzSelect'); juzSel.innerHTML = ''; for(let i=1; i<=30; i++) juzSel.add(new Option(`ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ${i}`, i)); document.getElementById('juzSetupModal').style.display='flex'; };
        window.startJuzExam = () => { const juz = parseInt(document.getElementById('examJuzSelect').value); const mode = document.querySelector('input[name="examPart"]:checked').value; let startPage = ((juz-1)*20)+2; if(mode === 'part2') startPage += 10; examState = { juz: juz, mode: mode, mistakesTeacher: 0, mistakesSelf: 0, currentPage: startPage, mistakesList: [], isMutashabih: false, timer: null, seconds: 0 }; document.getElementById('juzSetupModal').style.display='none'; document.getElementById('juzExamTitle').innerText = `ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ${juz}`; document.getElementById('partBadge').innerText = mode==='full'?'Full':(mode==='part1'?'Part 1':'Part 2'); document.getElementById('liveScore').innerText = "100%"; document.getElementById('countTeacher').innerText = "0"; document.getElementById('countSelf').innerText = "0"; document.getElementById('mutashabihSection').style.display = (mode==='part1')?'none':'block'; document.getElementById('saveExamBtn').style.display = 'block'; isViewMode = false; window.loadExamPage(startPage); document.getElementById('juz-exam-page').classList.remove('hidden'); };
        window.closeJuzExam = () => { window.stopTimer(); document.getElementById('juz-exam-page').classList.add('hidden'); };
        window.loadExamPage = async (page) => { document.getElementById('currentPageDisplay').innerText = `Page ${page}`; const res = await fetch(`https://api.alquran.cloud/v1/page/${page}/quran-uthmani`); const data = await res.json(); const first = data.data.ayahs[0]; document.getElementById('mushafJuzInfo').innerText = `Juz ${first.juz}`; document.getElementById('mushafSurahInfo').innerText = `ÿ≥Ÿàÿ±ÿ© ${first.surah.name}`; window.renderMushafText(data.data.ayahs, 'examMushafContent', examState.mistakesList, true); };
        window.changeExamPage = (dir) => { let newPage = examState.currentPage + dir; if(newPage < 1 || newPage > 604) return; examState.currentPage = newPage; window.loadExamPage(newPage); };
        window.clickExamWord = (id) => { if(isViewMode) return; const el = document.getElementById(id); if(el.classList.contains('mistake')) { el.classList.remove('mistake'); examState.mistakesList = examState.mistakesList.filter(x=>x!==id); if(!examState.isMutashabih) window.updateScore('teacher', -1); } else { el.classList.add('mistake'); examState.mistakesList.push(id); if(!examState.isMutashabih) window.updateScore('teacher', 1); } };
        window.updateScore = (type, delta) => { if(type==='teacher') examState.mistakesTeacher = Math.max(0, examState.mistakesTeacher+delta); else examState.mistakesSelf = Math.max(0, examState.mistakesSelf+delta); document.getElementById('countTeacher').innerText = examState.mistakesTeacher; document.getElementById('countSelf').innerText = examState.mistakesSelf; window.calcScore(); };
        window.calcScore = () => { let deduct = (examState.mistakesTeacher*2) + (examState.mistakesSelf*1) + (10 - document.getElementById('scoreTajweed').value) + (5 - document.getElementById('scoreFluency').value); if(examState.mode !== 'part1') deduct += (2.5 - parseFloat(document.getElementById('q1_score').value||0)) + (2.5 - parseFloat(document.getElementById('q2_score').value||0)); let final = Math.max(0, 100 - deduct); document.getElementById('liveScore').innerText = final + "%"; return final; };
        window.startTimer = () => { if(examState.timer) return; examState.timer = setInterval(() => { examState.seconds++; let d = new Date(0); d.setSeconds(examState.seconds); document.getElementById('stopwatchDisplay').innerText = d.toISOString().substr(11,8); }, 1000); };
        window.stopTimer = () => { clearInterval(examState.timer); examState.timer = null; };
        window.generateQuestions = () => { examState.isMutashabih = true; const list = document.getElementById('questionList'); list.innerHTML = ''; let base = ((examState.juz-1)*20)+2; if(examState.mode === 'part2') base+=10; for(let i=0; i<3; i++) { let p = base + Math.floor(Math.random()*10); list.innerHTML += `<button style="display:block;width:100%;margin-bottom:5px;padding:5px;" onclick="window.loadExamPage(${p})">Q${i+1} - Page ${p}</button>`; } };
        
        window.saveJuzExamPart = () => { 
            const score = window.calcScore(); 
            const s = classesData[currentClassIdx].students[currentStudentIdx]; 
            let duration = document.getElementById('stopwatchDisplay').innerText; 
            
            if(!s.history) s.history = [];
            if(!s.juzExams) s.juzExams={}; 
            if(!s.juzExams[examState.juz]) s.juzExams[examState.juz]={}; 
            
            let details = { 
                teacherMistakes: examState.mistakesTeacher, 
                selfMistakes: examState.mistakesSelf, 
                tajweed: parseFloat(document.getElementById('scoreTajweed').value || 10), 
                fluency: parseFloat(document.getElementById('scoreFluency').value || 5), 
                mutashabihMarks: (examState.mode!=='part1') ? (parseFloat(document.getElementById('q1_score').value || 0) + parseFloat(document.getElementById('q2_score').value || 0)) : 0 
            }; 
            
            const todayISO = window.getFormattedDate();

            if(examState.mode === 'part1') { 
                s.juzExams[examState.juz].part1 = score; 
                s.history.push({ type:'juz_exam', status:'partial', date:todayISO, juz:examState.juz, score:score, duration:duration, details: details, mistakeDetails: examState.mistakesList }); 
            } else { 
                let p1 = s.juzExams[examState.juz].part1 || 0; 
                let final = (examState.mode === 'full') ? score : (p1 + score) / 2; 
                s.history.push({ type:'juz_exam', status:'completed', date:todayISO, juz:examState.juz, score:final, duration:duration, details: details, mistakeDetails: examState.mistakesList }); 
            } 
            updateFirebase(); 
            alert("ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨!"); 
            window.closeJuzExam(); 
            window.openCategoryPage('juz_exam'); 
        };
        window.viewJuzRecord = (rec) => { document.getElementById('juzExamTitle').innerText = "View Exam"; document.getElementById('juz-exam-page').classList.remove('hidden'); document.getElementById('liveScore').innerText = rec.score + "%"; document.getElementById('saveExamBtn').style.display = 'none'; document.getElementById('stopwatchDisplay').innerText = rec.duration || "00:00:00"; document.getElementById('countTeacher').innerText = rec.details?.teacherMistakes||0; document.getElementById('countSelf').innerText = rec.details?.selfMistakes||0; document.getElementById('scoreTajweed').value = rec.details?.tajweed||10; document.getElementById('scoreFluency').value = rec.details?.fluency||5; isViewMode = true; examState.mistakesList = rec.mistakeDetails || []; let startP = ((rec.juz-1)*20)+2; window.loadExamPage(startP); };

        window.openFinalExam = () => { const s = classesData[currentClassIdx].students[currentStudentIdx]; finalExamState = { currentQ: 1, maxQ: (s.level >= 3 ? 3 : 2), totalMistakesT: 0, totalMistakesS: 0 }; document.getElementById('finalExamScore').innerText = "100%"; document.getElementById('questionIndicator').innerText = `ﬁêﬁ™ﬁàﬁßﬁçﬁ™ 1 / ${finalExamState.maxQ}`; document.getElementById('finalTeacherCount').innerText = 0; document.getElementById('finalSelfCount').innerText = 0; const finalJuzSel = document.getElementById('finalJuzSelect'); finalJuzSel.innerHTML = ''; for(let i=1; i<=30; i++) finalJuzSel.add(new Option(`ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ${i}`, i)); document.getElementById('final-exam-page').classList.remove('hidden'); };
        window.closeFinalExam = () => { document.getElementById('final-exam-page').classList.add('hidden'); };
        window.loadFinalQuestion = async () => { const juz = document.getElementById('finalJuzSelect').value; const startP = ((juz-1)*20)+2; const randomP = startP + Math.floor(Math.random()*18); const res = await fetch(`https://api.alquran.cloud/v1/page/${randomP}/quran-uthmani`); const data = await res.json(); window.renderMushafText(data.data.ayahs, 'finalMushafContent', [], true); };
        window.updateFinalScore = (type, delta) => { if(type==='teacher') finalExamState.totalMistakesT = Math.max(0, finalExamState.totalMistakesT+delta); else finalExamState.totalMistakesS = Math.max(0, finalExamState.totalMistakesS+delta); document.getElementById('finalTeacherCount').innerText = finalExamState.totalMistakesT; document.getElementById('finalSelfCount').innerText = finalExamState.totalMistakesS; window.calcFinalScore(); };
        window.calcFinalScore = () => { let deduct = (finalExamState.totalMistakesT*5) + (finalExamState.totalMistakesS*2); let score = Math.max(0, 100 - deduct); document.getElementById('finalExamScore').innerText = score + "%"; return score; };
        window.nextFinalQuestion = () => { if(finalExamState.currentQ < finalExamState.maxQ) { finalExamState.currentQ++; document.getElementById('questionIndicator').innerText = `ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ${finalExamState.currentQ} / ${finalExamState.maxQ}`; if(finalExamState.currentQ === finalExamState.maxQ) { document.getElementById('nextQBtn').classList.add('hidden'); document.getElementById('finishExamBtn').classList.remove('hidden'); } } };
        window.saveFinalExam = () => { const score = window.calcFinalScore(); const s = classesData[currentClassIdx].students[currentStudentIdx]; s.history.push({type:'final_exam', date:window.getFormattedDate(), score:score, mistakesCount:(finalExamState.totalMistakesT+finalExamState.totalMistakesS)}); updateFirebase(); window.closeFinalExam(); window.openStudentMenu(currentStudentIdx); };

    </script>
</body>
</html>
