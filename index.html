<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ - Fixed V27</title>
    
    <!-- SheetJS for Excel (Official CDN) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        /* --- FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

        @font-face { font-family: 'Faruma'; src: local('Faruma'), local('Faruma-Regular'); }
        @font-face { font-family: 'MV Waheed'; src: local('MV Waheed'), local('MV Waheed-Regular'); }

        :root {
            --primary: #2c3e50; 
            --accent: #27ae60;
            --accent-rev: #e67e22;
            --mistake: #e74c3c;
            --bg-light: #f4f6f8;
            --mushaf-paper: #fffcf2;
            --st-primary: #1e8449;
            
            --font-main: 'Faruma', 'Noto Sans Thaana', sans-serif;
            --font-heading: 'MV Waheed', 'Noto Sans Thaana', sans-serif; 
            --font-arabic: 'Amiri', serif;
        }

        * { box-sizing: border-box; }
        body { font-family: var(--font-main); margin: 0; min-height: 100vh; color: #333; background-color: var(--bg-light); overflow-x: hidden; transition: background 0.3s; }
        
        body.student-mode { background-color: #eafaf1; }
        body.student-mode .app-header { border-bottom: 3px solid var(--st-primary); }
        body.student-mode .header-title { color: var(--st-primary); }

        .hidden { display: none !important; }
        .container { width: 100%; padding: 20px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.3s ease; }

        /* HEADER */
        .app-header {
            background: white; height: 65px; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .header-title { font-family: var(--font-heading); font-size: 24px; color: var(--primary); }
        .icon-btn {
            background: #f0f2f5; border: none; width: 42px; height: 42px; border-radius: 50%; 
            font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; color: #333;
        }
        .logout-btn { background: #fee2e2; color: #b91c1c; }

        /* LOGIN */
        .login-wrapper { display: flex; align-items: center; justify-content: center; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; background: #ecf0f1; z-index: 2000; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; border-top: 5px solid var(--primary); }
        .tabs { display: flex; background: #eee; padding: 5px; border-radius: 50px; margin: 20px 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; font-family: var(--font-heading); font-size: 16px; border-radius: 40px; color: #777; transition:0.3s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; }
        .form-input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 10px; font-family: var(--font-main); font-size: 16px; margin-bottom: 15px; text-align: right; outline: none; transition: 0.3s; }
        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-family: var(--font-heading); font-size: 18px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* DASHBOARD & BUTTONS */
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .action-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .action-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        
        /* STUDENT BUTTON GRID */
        .student-action-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;
        }
        .action-btn-large {
            padding: 25px; border-radius: 15px; color: white; cursor: pointer;
            text-align: center; font-family: var(--font-heading); font-size: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: 0.2s; border: none; width: 100%;
        }
        .action-btn-large:hover { transform: scale(1.03); opacity: 0.95; }
        .btn-blue { background: var(--primary); }
        .btn-orange { background: #e67e22; }
        .btn-green { background: #27ae60; }
        .action-icon { font-size: 30px; margin-bottom: 5px; }

        @media (max-width: 600px) { .student-action-grid { grid-template-columns: 1fr; } }

        /* LISTS */
        .list-item { background: white; padding: 18px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-right: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        
        /* MENU & HISTORY */
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        @media (min-width: 600px) { .menu-grid { grid-template-columns: repeat(3, 1fr); } }
        .menu-btn { background: white; padding: 25px; border-radius: 15px; border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; transition: 0.2s; }
        .menu-icon { font-size: 35px; width: 70px; height: 70px; background: #f4f6f8; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .hist-card { background: white; width: 100%; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #eee; cursor: pointer; transition:0.2s; }
        .hist-header { padding: 12px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .hist-body { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .hist-item { text-align: center; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #f0f0f0; }
        .hist-val { font-size: 16px; font-weight: bold; color: #333; }
        
        /* MODAL */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 600px; max-height: 95vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-span { grid-column: span 2; }
        .form-label { font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .full-span { grid-column: span 1; } }

        /* General Big Button for other areas */
        .big-btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-family: var(--font-heading); cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen" class="login-wrapper">
        <div class="login-card">
            <h1 style="color:var(--primary); font-size:32px; margin-bottom:10px;">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞</h1>
            <div class="tabs">
                <button class="tab-btn active" onclick="window.switchLogin('teacher')">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
                <button class="tab-btn" onclick="window.switchLogin('student')">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™</button>
            </div>
            <div id="teacher-login-form">
                <input type="password" id="teacherPassInput" class="form-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ (1234)">
                <button class="btn-primary" onclick="window.loginTeacher()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
            <div id="student-login-form" class="hidden">
                <input type="text" id="stuIdInput" class="form-input" placeholder="ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™">
                <div id="stuPassField" class="hidden" style="margin-top:10px;">
                    <input type="password" id="stuPassInput" class="form-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
                </div>
                <button class="btn-primary" style="background:var(--st-primary);" onclick="window.handleStudentLoginStep()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="hidden">
        
        <!-- TEACHER DASHBOARD -->
        <div id="teacher-dashboard" class="container hidden">
            <div class="app-header">
                <div class="header-title">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞</div>
                <button class="icon-btn logout-btn" onclick="window.logout()">‚èª</button>
            </div>
            <div class="grid-layout">
                <div class="action-card" onclick="window.openPage('management-page')">
                    <span style="font-size:50px;">‚öôÔ∏è</span>
                    <h3>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞</h3>
                </div>
                <div class="action-card" onclick="window.openGradingClassList()">
                    <span style="font-size:50px;">üìö</span>
                    <h3>ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞</h3>
                </div>
            </div>
        </div>

        <!-- MANAGEMENT PAGES -->
        <div id="management-page" class="container hidden">
            <div class="app-header"><div class="header-title">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">‚¨Ö</button></div>
            <div class="action-card" style="margin-top:20px; text-align:right;">
                <h4>ﬁáﬁß ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ¨ﬁáﬁ∞ ﬁÄﬁ¨ﬁãﬁ™ﬁÇﬁ∞</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="newClassName" class="form-input" placeholder="ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞" style="margin:0;">
                    <input type="text" id="newTeacherName" class="form-input" placeholder="ﬁáﬁ™ﬁêﬁ∞ﬁåﬁßﬁõﬁ∞" style="margin:0;">
                    <button class="btn-primary" style="width:auto;" onclick="window.createClass()">ﬁÄﬁ¶ﬁãﬁß</button>
                </div>
            </div>
            <h4 style="margin-top:20px;">ﬁÄﬁ¨ﬁãﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞</h4>
            <div id="manageClassList"></div>
        </div>

        <div id="class-details-page" class="container hidden">
            <div class="app-header"><div class="header-title" id="manageHeaderName">Class</div><button class="icon-btn" onclick="window.openPage('management-page')">‚¨Ö</button></div>
            
            <!-- FIXED BUTTONS -->
            <div class="student-action-grid">
                <button class="action-btn-large btn-blue" onclick="window.openAddStudentModal()">
                    <span class="action-icon">‚ûï</span> ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞
                </button>
                <button class="action-btn-large btn-orange" onclick="window.downloadTemplate()">
                    <span class="action-icon">üì•</span> ﬁìﬁ¨ﬁâﬁ∞ﬁïﬁ∞ﬁçﬁ≠ﬁìﬁ∞
                </button>
                <label class="action-btn-large btn-green">
                    <span class="action-icon">üìÇ</span> ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞
                    <input type="file" hidden id="excelUpload" onchange="window.handleExcelUpload(this)" accept=".xlsx, .xls">
                </label>
            </div>

            <h4 style="margin-top:20px;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ∞</h4>
            <div id="studentManageList"></div>
        </div>

        <!-- OTHER PAGES (Grading, Student) -->
        <!-- Just simplified placeholders for context as they were correct before -->
        <div id="grading-class-page" class="container hidden"><div class="app-header"><div class="header-title">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">‚¨Ö</button></div><div id="gradingClassList"></div></div>
        <div id="grading-student-page" class="container hidden"><div class="app-header"><div class="header-title">Students</div><button class="icon-btn" onclick="window.openPage('grading-class-page')">‚¨Ö</button></div><div id="gradingStudentList"></div></div>
        <div id="student-dashboard" class="container hidden"><div class="app-header"><div class="header-title">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞</div><button class="icon-btn logout-btn" onclick="window.logout()">‚èª</button></div><div style="background:white;padding:20px;text-align:center;"><h2 style="color:var(--st-primary);">ﬁâﬁ¶ﬁÉﬁ™ﬁôﬁ¶ﬁÑﬁß!</h2><h3 id="studentDashName"></h3></div><h4 style="color:var(--st-primary);">ﬁÄﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</h4><div id="studentDashHistory"></div></div>

    </div>

    <!-- ADD STUDENT MODAL (UPDATED FIELDS) -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:20px; color:var(--primary); text-align:center;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞</h3>
            <div class="form-grid">
                <div class="full-span">
                    <label class="form-label">ﬁÜﬁØﬁêﬁ∞ ﬁâﬁÆﬁëﬁ®ﬁáﬁ™ﬁçﬁ∞</label>
                    <input type="text" id="m_module" class="form-input">
                </div>
                <div>
                    <label class="form-label">ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© (ID)</label>
                    <input type="text" id="m_id" class="form-input">
                </div>
                <div>
                    <label class="form-label">ﬁÇﬁ¶ﬁÇﬁ∞</label>
                    <input type="text" id="m_name" class="form-input">
                </div>
                <div>
                    <label class="form-label">ﬁçﬁ¨ﬁàﬁ¨ﬁçﬁ∞</label>
                    <select id="m_level" class="form-input">
                        <option value="1">ﬁçﬁ¨ﬁàﬁ¨ﬁçﬁ∞ 1</option><option value="2">ﬁçﬁ¨ﬁàﬁ¨ﬁçﬁ∞ 2</option><option value="3">ﬁçﬁ¨ﬁàﬁ¨ﬁçﬁ∞ 3</option>
                        <option value="4">ﬁçﬁ¨ﬁàﬁ¨ﬁçﬁ∞ 4</option><option value="5">ﬁçﬁ¨ﬁàﬁ¨ﬁçﬁ∞ 5</option><option value="6">ﬁçﬁ¨ﬁàﬁ¨ﬁçﬁ∞ 6</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁß ﬁâﬁ®ﬁêﬁ∞ﬁÉﬁßﬁÑﬁ™</label>
                    <select id="m_direction" class="form-input">
                        <option value="top_down">ﬁâﬁ¶ﬁåﬁ®ﬁÇﬁ∞ ﬁåﬁ®ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞</option>
                        <option value="bottom_up">ﬁåﬁ®ﬁÉﬁ®ﬁÇﬁ∞ ﬁâﬁ¶ﬁåﬁ®ﬁáﬁ¶ﬁÅﬁ∞</option>
                    </select>
                </div>
                <div class="full-span">
                    <label class="form-label">ﬁãﬁ¶ﬁêﬁ∞ﬁàﬁ¨ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™</label>
                    <input type="text" id="m_juz_count" class="form-input" placeholder="ﬁâﬁ®ﬁêﬁßﬁçﬁ™: 1, 2, 30">
                </div>
                <div class="full-span">
                    <label class="form-label">ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ (Remarks)</label>
                    <input type="text" id="m_remarks" class="form-input">
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="big-btn" onclick="window.confirmAddStudent()">ﬁêﬁ≠ﬁàﬁ∞</button>
                <button class="big-btn btn-orange" onclick="document.getElementById('addStudentModal').style.display='none'">ﬁÜﬁ¨ﬁÇﬁ∞ﬁêﬁ¶ﬁçﬁ∞</button>
            </div>
        </div>
    </div>

    <!-- CREATE PASS MODAL -->
    <div id="createPassModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3 style="color:var(--primary);">ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÄﬁ¶ﬁáﬁ∞ﬁãﬁ¶ﬁàﬁß</h3>
            <p>ﬁâﬁ®ﬁáﬁ© ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁäﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ ﬁÜﬁ¶ﬁâﬁ¶ﬁÅﬁ∞ﬁàﬁßﬁåﬁ© ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß</p>
            <input type="password" id="newStuPass" class="form-input" placeholder="ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
            <button class="big-btn" onclick="window.saveNewPassword()">ﬁêﬁ≠ﬁàﬁ∞ & ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
            authDomain: "hifz-cde3b.firebaseapp.com",
            databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
            projectId: "hifz-cde3b",
            storageBucket: "hifz-cde3b.firebasestorage.app",
            messagingSenderId: "566754658580",
            appId: "1:566754658580:web:d63d0f167960f53bab9a01"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // GLOBALS
        let classesData = [];
        let currentClassIdx = -1, currentStudentIdx = -1;
        let currentUserType = 'teacher';
        let currentStudentObj = null;

        // LOAD DATA
        const dbRef = ref(db, 'hifz_system_v1');
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            if(data) {
                classesData = data;
                const mgmtPage = document.getElementById('management-page');
                if(!mgmtPage.classList.contains('hidden')) window.renderManageClassList();
                const detailsPage = document.getElementById('class-details-page');
                if(!detailsPage.classList.contains('hidden')) window.renderStudentList();
            } else {
                classesData = [];
            }
        });

        function updateFirebase() {
            set(ref(db, 'hifz_system_v1'), classesData);
        }

        // Attach functions to window
        window.switchLogin = function(type) {
            document.getElementById('teacher-login-form').classList.toggle('hidden', type !== 'teacher');
            document.getElementById('student-login-form').classList.toggle('hidden', type !== 'student');
            document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', (type==='teacher' && i===0) || (type==='student' && i===1)));
        }
        window.loginTeacher = function() {
            if(document.getElementById('teacherPassInput').value === '1234') {
                currentUserType = 'teacher';
                document.body.classList.remove('student-mode');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                window.openPage('teacher-dashboard');
            } else alert('Password Error');
        }
        window.handleStudentLoginStep = function() {
            const id = document.getElementById('stuIdInput').value.trim();
            if(!id) return alert("ID ﬁñﬁ¶ﬁÄﬁß");
            
            let found = null; let cIdx=-1, sIdx=-1;
            if(classesData) {
                classesData.forEach((c, ci) => {
                    if(c.students) {
                        c.students.forEach((s, si) => { if(s.id === id) { found=s; cIdx=ci; sIdx=si; } });
                    }
                });
            }

            if(!found) return alert("ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™");
            currentClassIdx = cIdx; currentStudentIdx = sIdx; currentStudentObj = found;

            if(!found.password) document.getElementById('createPassModal').style.display = 'flex';
            else {
                const passField = document.getElementById('stuPassField');
                if(passField.classList.contains('hidden')) passField.classList.remove('hidden');
                else {
                    if(document.getElementById('stuPassInput').value === found.password) window.loginSuccessStudent();
                    else alert("Wrong Password");
                }
            }
        }
        window.saveNewPassword = function() {
            const pass = document.getElementById('newStuPass').value;
            if(pass) {
                classesData[currentClassIdx].students[currentStudentIdx].password = pass;
                updateFirebase(); document.getElementById('createPassModal').style.display='none'; window.loginSuccessStudent();
            }
        }
        window.loginSuccessStudent = function() {
            currentUserType = 'student';
            document.body.classList.add('student-mode');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('studentDashName').innerText = currentStudentObj.name;
            window.renderHistory(currentStudentObj, 'studentDashHistory', null);
            window.openPage('student-dashboard');
        }
        window.logout = function() { location.reload(); }

        window.openPage = function(id) {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            const p = document.getElementById(id);
            if(p) p.classList.remove('hidden');
            if(id === 'management-page') window.renderManageClassList();
        }

        // MGMT
        window.createClass = function() {
            let name = document.getElementById('newClassName').value;
            let teacher = document.getElementById('newTeacherName').value;
            if(name) { classesData.push({name:name, teacher:teacher, students:[]}); updateFirebase(); window.renderManageClassList(); }
        }
        window.renderManageClassList = function() {
            const div = document.getElementById('manageClassList'); div.innerHTML='';
            if(!classesData) return;
            classesData.forEach((c, i) => div.innerHTML += `<div class="list-item" onclick="window.openClass(${i})"><strong>${c.name}</strong><small>${c.teacher||''}</small></div>`);
        }
        window.openClass = function(i) { currentClassIdx = i; window.renderStudentList(); window.openPage('class-details-page'); }
        
        window.renderStudentList = function() {
            const div = document.getElementById('studentManageList'); div.innerHTML='';
            const students = classesData[currentClassIdx].students || [];
            if(students.length === 0) div.innerHTML = "<p style='text-align:center; color:#999'>No students yet.</p>";
            
            students.forEach(s => {
                let pass = s.password ? `(Pass: ${s.password})` : '(No Pass)';
                div.innerHTML += `
                    <div class="list-item">
                        <div><strong>${s.name}</strong> <small>(${s.id})</small></div>
                        <small style="color:${s.password?'green':'red'}">${pass}</small>
                    </div>`;
            });
        }

        // ADD STUDENT LOGIC (Correct Fields)
        window.openAddStudentModal = function() { 
            ['m_module','m_id','m_name','m_juz_count','m_remarks'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('addStudentModal').style.display='flex'; 
        }
        
        window.confirmAddStudent = function() {
            const name = document.getElementById('m_name').value;
            const id = document.getElementById('m_id').value;
            if(!name || !id) return alert("Name & ID Required");

            if(!classesData[currentClassIdx].students) classesData[currentClassIdx].students = [];
            
            classesData[currentClassIdx].students.push({
                name: name,
                id: id,
                module: document.getElementById('m_module').value,
                level: document.getElementById('m_level').value,
                direction: document.getElementById('m_direction').value,
                juzCount: document.getElementById('m_juz_count').value,
                remarks: document.getElementById('m_remarks').value,
                history: [], juzExams: {}
            });
            updateFirebase(); 
            document.getElementById('addStudentModal').style.display='none'; 
            window.renderStudentList();
        }

        // EXCEL DOWNLOAD (TEMPLATE)
        window.downloadTemplate = function() {
            // Define Header
            const data = [
                ["Module", "ID", "Name", "Level", "Direction", "Juz Count", "Remarks"]
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "Hifz_Student_Template.xlsx");
        }

        // EXCEL UPLOAD
        window.handleExcelUpload = function(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.SheetNames[0];
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

                if(!classesData[currentClassIdx].students) classesData[currentClassIdx].students = [];
                let count = 0;

                jsonData.forEach(row => {
                    // Map Excel Columns to Object
                    // Assuming columns: Module, ID, Name, Level, Direction, Juz Count, Remarks
                    const name = row['Name'] || row['Student Name'];
                    const id = row['ID'] || row['Student ID'];
                    
                    if(name && id) {
                        classesData[currentClassIdx].students.push({
                            name: name,
                            id: id,
                            module: row['Module'] || '',
                            level: row['Level'] || '1',
                            direction: row['Direction'] || 'top_down',
                            juzCount: row['Juz Count'] || '',
                            remarks: row['Remarks'] || '',
                            history: [], juzExams: {}
                        });
                        count++;
                    }
                });

                if(count > 0) {
                    updateFirebase();
                    window.renderStudentList();
                    alert(count + " students uploaded!");
                } else {
                    alert("No valid data found. Check template.");
                }
                input.value = ""; // Reset input
            };
            reader.readAsArrayBuffer(file);
        }

        // GRADING & HISTORY Placeholders for completeness
        window.openGradingClassList = function() { 
            const div = document.getElementById('gradingClassList'); div.innerHTML='';
            if(classesData) classesData.forEach((c, i) => div.innerHTML += `<div class="list-item" onclick="window.openGradingStudentList(${i})"><strong>${c.name}</strong></div>`);
            window.openPage('grading-class-page');
        }
        window.openGradingStudentList = function(i) {
            currentClassIdx = i;
            const div = document.getElementById('gradingStudentList'); div.innerHTML='';
            const students = classesData[i].students || [];
            students.forEach((s, idx) => div.innerHTML += `<div class="list-item" onclick="window.openStudentMenu(${idx})">${s.name}</div>`);
            window.openPage('grading-student-page');
        }
        window.renderHistory = function(student, listId, filterType) {
            const list = document.getElementById(listId); list.innerHTML = '';
            if(!student.history) student.history = [];
            if(!student.history.length) list.innerHTML = '<p style="text-align:center;color:#999;">No Records</p>';
            student.history.slice().reverse().forEach(h => {
                list.innerHTML += `<div class="hist-card"><div class="hist-header"><strong>${h.date}</strong></div><div class="hist-footer">${h.score || h.mistakesCount}</div></div>`;
            });
        }
        window.openStudentMenu = function(i) { /* ... Logic in full version ... */ }
    </script>
</body>
</html>
