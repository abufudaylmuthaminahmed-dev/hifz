<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁ§ﬁ™ﬁÉﬁ∞ﬁáﬁßﬁÇﬁ∞ ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ - V9.0</title>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');
        
        :root {
            --primary-color: #2c3e50;
            --accent-color: #27ae60;
            --student-color: #e67e22;
            --bg-color: #f4f7f6;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Faruma', 'MV Faseyha', 'Noto Sans Thaana', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
        }

        /* --- LAYOUT --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; padding: 20px;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 400px;
            text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .login-input {
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc;
            border-radius: 5px; font-family: inherit; font-size: 16px; text-align: center;
        }

        #teacher-dashboard, #student-dashboard { display: none; width: 100%; height: 100%; }
        .dashboard-active { display: flex !important; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); background: white; border-left: 1px solid #ddd;
            display: flex; flex-direction: column; padding: 15px; z-index: 100;
            transition: transform 0.3s ease;
        }
        
        .main-content { 
            flex: 1; padding: 20px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 20px; position: relative;
        }

        /* Mobile Responsive Sidebar */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed; top: 0; right: 0; height: 100%;
                transform: translateX(100%); box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            }
            .sidebar.open { transform: translateX(0); }
            .menu-toggle { display: block !important; cursor: pointer; font-size: 24px; }
            .main-content { padding: 10px; }
            .mushaf-panel { width: 100% !important; position: fixed; top: 0; left: 0; height: 100%; z-index: 2000; transform: translateY(100%); }
            .mushaf-panel.open { transform: translateY(0); }
        }
        @media (min-width: 769px) {
            .menu-toggle { display: none; }
            .mushaf-panel { width: 35%; border-right: 1px solid #ccc; position: relative; }
        }

        /* --- COMPONENTS --- */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; gap: 5px; font-family: inherit; font-size: 14px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-green { background: var(--accent-color); }
        .btn-blue { background: #3498db; }
        .btn-red { background: #e74c3c; }
        .btn-grey { background: #7f8c8d; }
        .btn-orange { background: var(--student-color); }

        .student-btn {
            background: #fff; border: 1px solid #eee; padding: 12px; text-align: right; width: 100%;
            cursor: pointer; border-radius: 8px; font-family: inherit; margin-bottom: 5px;
            display: flex; flex-direction: column; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .student-btn:hover, .student-btn.active { background: #e8f6ef; border-color: var(--accent-color); }
        .id-badge {
            display: inline-block; background: #eee; color: #555; padding: 2px 6px; 
            border-radius: 4px; font-size: 11px; font-weight: bold; width: fit-content; margin-top: 3px;
        }

        /* --- FORMS --- */
        .entry-form { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap; }
        .form-row > div { flex: 1; min-width: 120px; }
        
        input, select { 
            width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; 
            box-sizing: border-box; font-family: inherit; font-size: 15px; height: 40px;
        }
        .arabic-input { font-family: 'Amiri', serif; direction: rtl; font-size: 16px; }

        .section-box { 
            padding: 15px; border-radius: 10px; margin-bottom: 10px; 
            border: 2px solid transparent; cursor: pointer; position: relative; 
        }
        .section-new { background: #eafaf1; } .section-short { background: #ebf5fb; } .section-long { background: #fef9e7; }
        .section-box.active-section { background: white; border-left: 6px solid; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #box-new.active-section { border-color: #27ae60; }
        #box-short.active-section { border-color: #2980b9; }
        #box-long.active-section { border-color: #d35400; }
        #box-exam.active-section { border-color: #f1c40f; }

        .mistake-wrapper { display: flex; border: 1px solid #aaa; border-radius: 6px; overflow: hidden; height: 38px; }
        .mistake-btn { width: 40px; border: none; background: #eee; font-size: 18px; font-weight: bold; cursor: pointer; }
        .mistake-display { width: 50px; text-align: center; border: none; font-weight: bold; font-size: 18px; padding: 0; }

        /* --- MUSHAF --- */
        .mushaf-panel { background: #34495e; display: flex; flex-direction: column; transition: transform 0.3s; }
        .mushaf-header { background: #2c3e50; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .mushaf-container { flex: 1; overflow: auto; background: #fdfdfd; display: flex; justify-content: center; position: relative; }
        .mushaf-page-img { max-width: 100%; display: block; border: 1px solid #ddd; }
        .mistake-dot {
            position: absolute; width: 24px; height: 24px; background-color: rgba(231, 76, 60, 0.85);
            border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);
            z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.4); cursor: pointer;
        }
        .mistake-dot.readonly { cursor: default; background-color: rgba(231, 76, 60, 1); border-color: gold; }

        /* --- HISTORY --- */
        .history-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-right: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-new { border-color: #27ae60; } .card-short { border-color: #2980b9; } .card-long { border-color: #d35400; } .card-exam { border-color: #f1c40f; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 0; border-radius: 10px; width: 600px; max-width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }

        /* Student Manager Table */
        .student-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .student-table th { background: #eee; padding: 10px; text-align: right; }
        .student-table td { border-bottom: 1px solid #eee; padding: 10px; }

        .loader-spin { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay">
        <div class="loader-spin"></div>
        <p style="margin-top:10px;">ﬁëﬁ≠ﬁìﬁßﬁÑﬁ≠ﬁêﬁ∞ ﬁáﬁ¶ﬁÅﬁ∞ ﬁéﬁ™ﬁÖﬁ¶ﬁÇﬁ©...</p>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" style="display:none;">
        <div class="login-box" id="roleSelection">
            <h2>ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ V9.0</h2>
            <button class="btn btn-orange" style="width:100%; margin-bottom:10px; padding:15px; font-size:18px;" onclick="showStudentLogin()">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</button>
            <button class="btn btn-teacher" style="width:100%; padding:15px; font-size:18px;" onclick="loginTeacher()">üë®‚Äçüè´ ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
        </div>

        <div class="login-box" id="studentLoginForm" style="display:none;">
            <h3>ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</h3>
            <input type="text" id="stLoginId" class="login-input" placeholder="ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÜﬁßﬁëﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ (ID)">
            <input type="password" id="stLoginPass" class="login-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
            <button class="btn btn-green" style="width:100%; margin-top:10px;" onclick="processStudentLogin()">ﬁàﬁ¶ﬁÇﬁ∞ﬁÇﬁ¶ﬁàﬁß</button>
            <button class="btn btn-grey" style="width:100%; margin-top:5px;" onclick="document.getElementById('studentLoginForm').style.display='none'; document.getElementById('roleSelection').style.display='block';">ﬁäﬁ¶ﬁÄﬁ¶ﬁåﬁ¶ﬁÅﬁ∞</button>
        </div>
    </div>

    <!-- TEACHER DASHBOARD -->
    <div id="teacher-dashboard">
        <div class="sidebar" id="teacherSidebar">
            <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:var(--primary-color);">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</h3>
                <span style="cursor:pointer; font-size:24px; display:block; @media(min-width:769px){display:none;}" onclick="toggleSidebar()">√ó</span>
            </div>
            
            <div style="padding:15px;">
                <label>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                <select id="classSelect" class="class-select" onchange="switchClass(this.value)" style="width:100%; margin-bottom:10px;"></select>
                <div style="display:flex; gap:5px; flex-direction:column;">
                    <button class="btn btn-blue" style="width:100%; font-size:12px;" onclick="openModal()">‚öôÔ∏è ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞ / ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞</button>
                    <button class="btn btn-orange" style="width:100%; font-size:12px;" onclick="openStudentManager()">üë• ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™</button>
                </div>
            </div>
            
            <h4 style="padding:0 15px;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</h4>
            <div id="studentListContainer" class="student-list-container" style="padding:0 15px;"></div>
            <button class="btn btn-grey" onclick="logout()" style="margin:15px;">üö™ ﬁçﬁÆﬁéﬁ∞ﬁáﬁ¶ﬁáﬁ™ﬁìﬁ∞</button>
        </div>

        <div class="main-content">
            <!-- Header Bar -->
            <div style="background:white; padding:15px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="menu-toggle" onclick="toggleSidebar()">‚ò∞</span>
                    <div>
                        <small id="currentClassDisplay" style="color:#7f8c8d; font-weight:bold;">Class: -</small>
                        <h2 id="studentHeader" style="margin:0; color:var(--primary-color); font-size:20px;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</h2>
                        <div id="studentHeaderId"></div>
                    </div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-green" onclick="exportExcel()" style="padding:8px;"><span style="display:none; @media(min-width:600px){display:inline;}">Excel</span> üì•</button>
                    <button class="btn btn-blue" onclick="toggleMushaf(true)">üìñ</button>
                </div>
            </div>

            <!-- TEACHER FORM -->
            <div class="entry-form">
                <div class="form-row">
                    <div style="flex:1"><label>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="entryDate"></div>
                    <div style="flex:1"><label>ﬁàﬁ¶ﬁáﬁ∞ﬁåﬁ¶ﬁÉﬁ™</label>
                        <select id="lessonType" onchange="toggleFormSection(this.value)">
                            <option value="daily">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ﬁåﬁ¶ﬁáﬁ∞</option>
                            <option value="exam">ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</option>
                        </select>
                    </div>
                </div>

                <!-- DAILY SECTIONS -->
                <div id="container-daily">
                    <!-- New Lesson -->
                    <div id="box-new" class="section-box section-new active-section" onclick="setActiveSection('new')">
                        <label style="color:#27ae60; font-size:16px; font-weight:bold;">ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</label>
                        <label class="radio-label"><input type="radio" name="activeSec" value="new" checked> ﬁÜﬁ™ﬁÅﬁ∞ﬁñﬁ¨ﬁÄﬁ™ﬁÇﬁ∞</label>
                        <div class="form-row">
                            <div style="flex:1"><label>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="newPage" placeholder="#" onchange="handlePageChange(this.value, 'new')" style="text-align:center; font-weight:bold;"></div>
                            <div style="flex:2"><label>ﬁäﬁ¨ﬁÅﬁ≠</label><div style="display:flex; gap:2px;"><select id="newSurah" class="arabic-input" style="flex:1"><option>...</option></select><input type="number" id="newStart" placeholder="ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞" style="flex:0.6"></div></div>
                            <div style="flex:2"><label>ﬁÇﬁ®ﬁâﬁ≠</label><div style="display:flex; gap:2px;"><select id="newEndSurah" class="arabic-input" style="flex:1"><option>...</option></select><input type="number" id="newEnd" placeholder="ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞" style="flex:0.6"></div></div>
                            <div style="flex:1"><label>ﬁÜﬁ™ﬁÅﬁ∞</label><div class="mistake-wrapper"><button class="mistake-btn" onclick="adjM('newMistakes',1)">+</button><input id="newMistakes" class="mistake-display" value="0" readonly><button class="mistake-btn" onclick="adjM('newMistakes',-1)">-</button></div></div>
                        </div>
                    </div>

                    <!-- Short Revision -->
                    <div id="box-short" class="section-box section-short" onclick="setActiveSection('short')">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#2980b9; font-size:16px; font-weight:bold;">ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</label>
                            <label class="radio-label"><input type="radio" name="activeSec" value="short"> ﬁÜﬁ™ﬁÅﬁ∞ﬁñﬁ¨ﬁÄﬁ™ﬁÇﬁ∞</label>
                        </div>
                        <div class="form-row">
                            <div style="flex:1"><label>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="shortPage" placeholder="#" onchange="handlePageChange(this.value, 'short')" style="text-align:center; font-weight:bold;"></div>
                            <div style="flex:2"><label>ﬁäﬁ¨ﬁÅﬁ≠</label><div style="display:flex; gap:2px;"><select id="shortSurah" class="arabic-input" style="flex:1"><option>...</option></select><input type="number" id="shortStart" placeholder="ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞" style="flex:0.6"></div></div>
                            <div style="flex:2"><label>ﬁÇﬁ®ﬁâﬁ≠</label><div style="display:flex; gap:2px;"><select id="shortEndSurah" class="arabic-input" style="flex:1"><option>...</option></select><input type="number" id="shortEnd" placeholder="ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞" style="flex:0.6"></div></div>
                            <div style="flex:1"><label>ﬁÜﬁ™ﬁÅﬁ∞</label><div class="mistake-wrapper"><button class="mistake-btn" onclick="adjM('shortMistakes',1)">+</button><input id="shortMistakes" class="mistake-display" value="0" readonly><button class="mistake-btn" onclick="adjM('shortMistakes',-1)">-</button></div></div>
                        </div>
                    </div>

                    <!-- Long Revision -->
                    <div id="box-long" class="section-box section-long" onclick="setActiveSection('long')">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#d35400; font-size:16px; font-weight:bold;">ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</label>
                            <label class="radio-label"><input type="radio" name="activeSec" value="long"> ﬁÜﬁ™ﬁÅﬁ∞ﬁñﬁ¨ﬁÄﬁ™ﬁÇﬁ∞</label>
                        </div>
                        <div class="form-row">
                            <div style="flex:1"><label>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="longPage" placeholder="#" onchange="handlePageChange(this.value, 'long')" style="text-align:center; font-weight:bold;"></div>
                            <div style="flex:2"><label>ﬁäﬁ¨ﬁÅﬁ≠</label><div style="display:flex; gap:2px;"><select id="longSurah" class="arabic-input" style="flex:1"><option>...</option></select><input type="number" id="longStart" placeholder="ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞" style="flex:0.6"></div></div>
                            <div style="flex:2"><label>ﬁÇﬁ®ﬁâﬁ≠</label><div style="display:flex; gap:2px;"><select id="longEndSurah" class="arabic-input" style="flex:1"><option>...</option></select><input type="number" id="longEnd" placeholder="ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞" style="flex:0.6"></div></div>
                            <div style="flex:1"><label>ﬁÜﬁ™ﬁÅﬁ∞</label><div class="mistake-wrapper"><button class="mistake-btn" onclick="adjM('longMistakes',1)">+</button><input id="longMistakes" class="mistake-display" value="0" readonly><button class="mistake-btn" onclick="adjM('longMistakes',-1)">-</button></div></div>
                        </div>
                    </div>
                </div>

                <!-- EXAM SECTION -->
                <div id="container-exam" style="display:none;">
                    <div id="box-exam" class="section-box section-new active-section" style="border-color:#f1c40f;">
                        <h3 style="margin-top:0; color:#d35400;">üèÜ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</h3>
                        
                        <div class="stopwatch-container" style="background:#34495e; padding:15px; border-radius:5px; margin-bottom:15px; display:flex; align-items:center; gap:10px; color:white; flex-wrap:wrap;">
                            <div id="timerDisplay" style="font-family:monospace; font-size:28px; font-weight:bold; color:#f1c40f;">00:00</div>
                            <button class="btn btn-green" onclick="startTimer()">‚ñ∂ Start</button>
                            <button class="btn btn-red" onclick="stopTimer()">‚èπ Stop</button>
                            <input type="number" id="examDuration" placeholder="ﬁâﬁ®ﬁÇﬁ¨ﬁìﬁ∞" style="width:70px; text-align:center; margin-right:auto; font-size:16px;">
                        </div>

                        <div class="form-row">
                            <div style="flex:2"><label>ﬁÑﬁ¶ﬁáﬁ® / ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™</label><input type="text" id="examJuzu" placeholder="30"></div>
                            <div style="flex:1"><label>ﬁäﬁÆﬁåﬁ∞ (Page)</label><input type="number" id="examPage" placeholder="#" onchange="loadMushaf(this.value)"></div>
                            <div style="flex:1"><label>ﬁâﬁ®ﬁÇﬁ∞ﬁàﬁ¶ﬁÉﬁ™</label>
                                <select id="examPortion" onchange="calcExam()">
                                    <option value="whole">ﬁâﬁ™ﬁÖﬁ® (1)</option>
                                    <option value="half">1/2 (0.5)</option>
                                    <option value="third">1/3 (0.33)</option>
                                    <option value="quarter">1/4 (0.25)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="background:#fff3e0; padding:15px; border-radius:5px; margin:15px 0;">
                            <label>ﬁÜﬁ™ﬁÅﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ 80):</label>
                            <div style="display:flex; gap:15px; flex-wrap:wrap;">
                                <div style="flex:1">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ (-2): <input type="number" id="examTMistakes" value="0" onchange="calcExam()"></div>
                                <div style="flex:1">ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ (-1): <input type="number" id="examSMistakes" value="0" onchange="calcExam()"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div style="flex:1"><label>ﬁåﬁ¶ﬁñﬁ∞ﬁàﬁ©ﬁãﬁ™ (10)</label><input type="number" id="markTajweed" value="10" onchange="calcExam()"></div>
                            <div style="flex:1"><label>ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞ (5)</label><input type="number" id="markFluency" value="5" onchange="calcExam()"></div>
                            <div style="flex:1"><label>ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶:</label><h3 id="examTotal" style="margin:0; color:blue; font-size:24px;">100%</h3></div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-green" style="width:100%; justify-content:center; margin-top:10px; font-size:16px; padding:12px;" onclick="saveRecord()">üíæ ﬁêﬁ≠ﬁàﬁ∞ (ﬁöﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÑﬁ¶ﬁáﬁ®)</button>
            </div>

            <!-- HISTORY -->
            <div style="margin-top:20px; padding-bottom:50px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4>ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ﬁåﬁ¶ﬁáﬁ∞</h4>
                    <div class="filter-bar">
                        <button class="filter-btn active" id="btnAll" onclick="filterHistory('all')">All</button>
                        <button class="filter-btn" id="btnNew" onclick="filterHistory('new')">New</button>
                        <button class="filter-btn" id="btnShort" onclick="filterHistory('short')">Short</button>
                        <button class="filter-btn" id="btnLong" onclick="filterHistory('long')">Long</button>
                        <button class="filter-btn" id="btnExam" onclick="filterHistory('exam')">Exam</button>
                    </div>
                </div>
                <div id="historyContainer"></div>
            </div>
        </div>

        <!-- MUSHAF PANEL -->
        <div class="mushaf-panel" id="mushafPanel">
            <div class="mushaf-header">
                <button class="btn btn-red" onclick="toggleMushaf(false)" style="position:absolute; left:10px;">√ó</button>
                <div id="mushafInfoDisplay" class="mushaf-info" style="margin-top:20px;">---</div>
                <div style="display:flex; gap:10px; align-items:center; margin-top:5px;">
                    <button class="btn btn-grey" onclick="changePage(1)">></button>
                    <input type="number" id="navPage" style="width:60px; text-align:center; font-weight:bold;" onchange="loadMushaf(this.value)">
                    <button class="btn btn-grey" onclick="changePage(-1)"><</button>
                </div>
            </div>
            <div class="mushaf-container">
                <div class="mushaf-wrapper" id="mushafWrapper" onclick="onImageClick(event)">
                    <img id="mushafImg" class="mushaf-page-img" src="">
                </div>
            </div>
        </div>
    </div>

    <!-- STUDENT DASHBOARD -->
    <div id="student-dashboard">
        <div class="main-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="color:var(--student-color);">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁïﬁØﬁìﬁ¶ﬁçﬁ∞</h3>
                <button class="btn btn-red" onclick="logout()">Logout</button>
            </div>

            <div class="student-header-banner">
                <h2 id="stWelcomeName" style="margin:0;">ﬁâﬁ¶ﬁÉﬁ™ﬁôﬁ¶ﬁÑﬁß!</h2>
                <div id="stWelcomeID" style="color:#eee; font-weight:bold; margin-top:5px;"></div>
            </div>
            
            <div class="filter-bar">
                <button class="filter-btn active" id="stBtnAll" onclick="stFilterHistory('all')">All</button>
                <button class="filter-btn" id="stBtnNew" onclick="stFilterHistory('new')">New</button>
                <button class="filter-btn" id="stBtnExam" onclick="stFilterHistory('exam')">Exam</button>
            </div>

            <div id="stHistoryContainer" style="padding-bottom:50px;"></div>
        </div>
        
        <!-- Student Mushaf Modal -->
        <div id="stMushafModal" class="modal">
            <div class="modal-content" style="width:100%; height:100%; max-width:100%; border-radius:0;">
                <div class="modal-header" style="background:#2c3e50; color:white;">
                    <h3>ﬁäﬁßﬁÄﬁ¶ﬁéﬁ¶ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÜﬁ™ﬁÅﬁ∞ﬁåﬁ¶ﬁáﬁ∞</h3>
                    <button class="btn btn-red" onclick="document.getElementById('stMushafModal').style.display='none'">ﬁÑﬁ¶ﬁÇﬁ∞ﬁãﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                </div>
                <div class="modal-body" style="background:#333; display:flex; justify-content:center; align-items:center; padding:0;">
                    <div style="position:relative; display:inline-block;" id="stMushafWrapper">
                        <img id="stMushafImg" style="max-width:100%; max-height:90vh;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞ & ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div class="tab-header">
                <div class="tab-btn active" onclick="switchTab('tab-students')">ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</div>
                <div class="tab-btn" onclick="switchTab('tab-class')">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞</div>
                <div class="tab-btn" onclick="switchTab('tab-data')">ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞</div>
            </div>
            <div class="modal-body">
                <div id="tab-students" class="tab-content active">
                    <label>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                    <select id="modalClassSelect" class="class-select" onchange="renderModalStudentList()"></select>
                    <textarea id="bulkStudents" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞ IUM12345 (ﬁÜﬁÆﬁÇﬁ∞ﬁâﬁ¨ ﬁÇﬁ¶ﬁâﬁ¨ﬁáﬁ∞ ﬁáﬁ¶ﬁáﬁ™ ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ¨ﬁáﬁ∞ﬁéﬁ¶ﬁáﬁ®)" style="width:100%; height:100px; margin-top:10px;"></textarea>
                    <button class="btn btn-green" style="width:100%; margin-top:5px;" onclick="importStudents()">ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁáﬁ¨ﬁëﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</button>
                    <div id="modalStudentList" style="margin-top:15px; border:1px solid #eee; height:200px; overflow:auto;"></div>
                </div>
                <div id="tab-class" class="tab-content">
                    <label>ﬁáﬁ¶ﬁáﬁ™ ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞:</label> <input type="text" id="newClassName">
                    <label>ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞:</label> <input type="text" id="newClassTeacher">
                    <button class="btn btn-blue" style="width:100%; margin-top:10px;" onclick="createClass()">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁÄﬁ¶ﬁãﬁß</button>
                    <hr>
                    <label style="color:red;">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁäﬁ™ﬁÄﬁ¨ﬁçﬁ™ﬁÇﬁ∞:</label>
                    <select id="deleteClassSelect" class="class-select"></select>
                    <button class="btn btn-red" style="width:100%;" onclick="deleteSelectedClass()">ﬁäﬁ™ﬁÄﬁ¨ﬁçﬁß</button>
                </div>
                <div id="tab-data" class="tab-content">
                    <button class="btn btn-blue" style="width:100%; margin-bottom:10px;" onclick="downloadBackup()">üì• ﬁÑﬁ¨ﬁÜﬁ¶ﬁïﬁ∞ ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞</button>
                    <input type="file" id="restoreFile" style="margin-bottom:10px;">
                    <button class="btn btn-red" style="width:100%;" onclick="restoreBackup()">üì§ ﬁëﬁ≠ﬁìﬁß ﬁáﬁ¶ﬁÖﬁßﬁçﬁß</button>
                </div>
            </div>
        </div>
    </div>

    <!-- STUDENT MANAGER MODAL (New Feature) -->
    <div id="studentManagerModal" class="modal">
        <div class="modal-content" style="width:600px;">
            <div class="modal-header">
                <h3>üë• ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™</h3>
                <span class="close-modal" onclick="document.getElementById('studentManagerModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <label>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß:</label>
                <select id="manageClassSelect" class="class-select" onchange="renderStudentManagerTable()"></select>
                <div style="margin-top:15px;">
                    <table class="student-table">
                        <thead>
                            <tr>
                                <th>ﬁÇﬁ¶ﬁÇﬁ∞</th>
                                <th>ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© (ID)</th>
                                <th>ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞</th>
                            </tr>
                        </thead>
                        <tbody id="studentManagerBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIGURATION ---
    // *** IMPORTANT: PASTE YOUR CONFIG HERE ***
    const firebaseConfig = {
      apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
      authDomain: "hifz-cde3b.firebaseapp.com",
      databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
      projectId: "hifz-cde3b",
      storageBucket: "hifz-cde3b.firebasestorage.app",
      messagingSenderId: "566754658580",
      appId: "1:566754658580:web:d63d0f167960f53bab9a01"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch(e) { console.error(e); }

    // --- GLOBALS ---
    const surahNames = ["ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©","ÿßŸÑÿ®ŸÇÿ±ÿ©","ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ","ÿßŸÑŸÜÿ≥ÿßÿ°","ÿßŸÑŸÖÿßÿ¶ÿØÿ©","ÿßŸÑÿ£ŸÜÿπÿßŸÖ","ÿßŸÑÿ£ÿπÿ±ÿßŸÅ","ÿßŸÑÿ£ŸÜŸÅÿßŸÑ","ÿßŸÑÿ™Ÿàÿ®ÿ©","ŸäŸàŸÜÿ≥","ŸáŸàÿØ","ŸäŸàÿ≥ŸÅ","ÿßŸÑÿ±ÿπÿØ","ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ","ÿßŸÑÿ≠ÿ¨ÿ±","ÿßŸÑŸÜÿ≠ŸÑ","ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°","ÿßŸÑŸÉŸáŸÅ","ŸÖÿ±ŸäŸÖ","ÿ∑Ÿá","ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°","ÿßŸÑÿ≠ÿ¨","ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ","ÿßŸÑŸÜŸàÿ±","ÿßŸÑŸÅÿ±ŸÇÿßŸÜ","ÿßŸÑÿ¥ÿπÿ±ÿßÿ°","ÿßŸÑŸÜŸÖŸÑ","ÿßŸÑŸÇÿµÿµ","ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™","ÿßŸÑÿ±ŸàŸÖ","ŸÑŸÇŸÖÿßŸÜ","ÿßŸÑÿ≥ÿ¨ÿØÿ©","ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®","ÿ≥ÿ®ÿ£","ŸÅÿßÿ∑ÿ±","Ÿäÿ≥","ÿßŸÑÿµÿßŸÅÿßÿ™","ÿµ","ÿßŸÑÿ≤ŸÖÿ±","ÿ∫ÿßŸÅÿ±","ŸÅÿµŸÑÿ™","ÿßŸÑÿ¥Ÿàÿ±Ÿâ","ÿßŸÑÿ≤ÿÆÿ±ŸÅ","ÿßŸÑÿØÿÆÿßŸÜ","ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©","ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ","ŸÖÿ≠ŸÖÿØ","ÿßŸÑŸÅÿ™ÿ≠","ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™","ŸÇ","ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™","ÿßŸÑÿ∑Ÿàÿ±","ÿßŸÑŸÜÿ¨ŸÖ","ÿßŸÑŸÇŸÖÿ±","ÿßŸÑÿ±ÿ≠ŸÖŸÜ","ÿßŸÑŸàÿßŸÇÿπÿ©","ÿßŸÑÿ≠ÿØŸäÿØ","ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©","ÿßŸÑÿ≠ÿ¥ÿ±","ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©","ÿßŸÑÿ∂ŸÅ","ÿßŸÑÿ¨ŸÖÿπÿ©","ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ","ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ","ÿßŸÑÿ∑ŸÑÿßŸÇ","ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ","ÿßŸÑŸÖŸÑŸÉ","ÿßŸÑŸÇŸÑŸÖ","ÿßŸÑÿÆÿßŸÇÿ©","ÿßŸÑŸÖÿπÿßÿ±ÿ¨","ŸÜŸàÿ≠","ÿßŸÑÿ¨ŸÜ","ÿßŸÑŸÖÿ≤ŸÖŸÑ","ÿßŸÑŸÖÿØÿ´ÿ±","ÿßŸÑŸÇŸäÿßŸÖÿ©","ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ","ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™","ÿßŸÑŸÜÿ®ÿ£","ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™","ÿπÿ®ÿ≥","ÿßŸÑÿ™ŸÉŸàŸäÿ±","ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±","ÿßŸÑÿ∑ŸÅŸäŸÅŸäŸÜ","ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ","ÿßŸÑÿ®ÿ±Ÿàÿ¨","ÿßŸÑÿ∑ÿßÿ±ŸÇ","ÿßŸÑÿ£ÿπŸÑŸâ","ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©","ÿßŸÑŸÅÿ¨ÿ±","ÿßŸÑÿ®ŸÑÿØ","ÿßŸÑÿ¥ŸÖÿ≥","ÿßŸÑŸÑŸäŸÑ","ÿßŸÑÿ∂ÿ≠Ÿâ","ÿßŸÑÿ¥ÿ±ÿ≠","ÿßŸÑÿ™ŸäŸÜ","ÿßŸÑÿπŸÑŸÇ","ÿßŸÑŸÇÿØÿ±","ÿßŸÑÿ®ŸäŸÜÿ©","ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©","ÿßŸÑÿπÿßÿØŸäÿßÿ™","ÿßŸÑŸÇÿßÿ±ÿπÿ©","ÿßŸÑÿ™ŸÉÿßÿ´ÿ±","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸÅŸäŸÑ","ŸÇÿ±Ÿäÿ¥","ÿßŸÑŸÖÿßÿπŸàŸÜ","ÿßŸÑŸÉŸàÿ´ÿ±","ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ","ÿßŸÑŸÜÿµÿ±","ÿßŸÑŸÖÿ≥ÿØ","ÿßŸÑÿ•ÿÆŸÑÿßÿµ","ÿßŸÑŸÅŸÑŸÇ","ÿßŸÑŸÜÿßÿ≥"];
    let classes = {};
    let records = [];
    let users = {}; 
    let currentClass = "";
    let currentStudent = null;
    let currentActiveSection = 'new';
    let currentPage = 1;
    let sessionDots = []; 
    let timerInterval, startTime, elapsedTime = 0;
    let historyFilter = 'all';

    // --- HELPER: Parse Student Name & ID ---
    function parseStudentInfo(fullString) {
        let name = fullString;
        let id = "";
        
        if(fullString && fullString.toUpperCase().includes("IUM")) {
            const parts = fullString.split(/IUM/i);
            name = parts[0].trim().replace(/[-‚Äì,]/g, '');
            id = "IUM" + parts[1].trim();
        } else if (fullString && fullString.includes('(')) {
            const parts = fullString.split('(');
            name = parts[0].trim();
            id = parts[1].replace(')', '').trim();
        }
        return { name, id };
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        populateSurahSelects();
        document.getElementById('entryDate').valueAsDate = new Date();
        loadMushaf(1);

        if(db) {
            db.ref('classes').on('value', snap => {
                classes = snap.val() || {};
                refreshDropdowns();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            });
            db.ref('records').on('value', snap => {
                records = [];
                const data = snap.val();
                if(data) Object.keys(data).forEach(k => records.push({...data[k], key: k}));
                if(currentStudent) {
                    if(document.getElementById('teacher-dashboard').style.display === 'flex') renderTeacherHistory();
                    if(document.getElementById('student-dashboard').style.display === 'flex') stFilterHistory('all');
                }
            });
            db.ref('users').on('value', snap => { users = snap.val() || {}; });
        }
    });

    function populateSurahSelects() {
        ['newSurah', 'newEndSurah', 'shortSurah', 'shortEndSurah', 'longSurah', 'longEndSurah'].forEach(id => {
            const sel = document.getElementById(id);
            if(!sel) return;
            surahNames.forEach((s, i) => {
                let opt = document.createElement('option');
                opt.value = i+1; opt.innerText = (i+1)+". "+s;
                sel.appendChild(opt);
            });
        });
    }

    // --- NAVIGATION ---
    function loginTeacher() {
        if(prompt("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞:") === "1234") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('teacher-dashboard').classList.add('dashboard-active');
        } else { alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®"); }
    }

    function showStudentLogin() {
        document.getElementById('roleSelection').style.display = 'none';
        document.getElementById('studentLoginForm').style.display = 'block';
    }

    function processStudentLogin() {
        const id = document.getElementById('stLoginId').value.trim().toUpperCase();
        let pass = document.getElementById('stLoginPass').value.trim();
        
        if(!id) return alert("ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁñﬁ¶ﬁÄﬁß");

        // 1. Find if ID exists in classes
        let foundStudentName = "";
        let foundClass = "";
        Object.keys(classes).forEach(cls => {
            (classes[cls].students || []).forEach(s => {
                const info = parseStudentInfo(s);
                if(info.id && info.id.toUpperCase() === id) {
                    foundStudentName = s;
                    foundClass = cls;
                }
            });
        });

        if(!foundStudentName) return alert("ﬁâﬁ® ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÉﬁ¶ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©ﬁàﬁ¨ﬁäﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞");

        // 2. Check Password
        // If user doesn't exist in 'users' node yet, create with 1234 if entered 1234
        if(!users[id]) {
            if(pass === "1234") {
                db.ref('users/' + id).set("1234"); // Create user
            } else {
                return alert("ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁäﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ ﬁàﬁ¶ﬁÇﬁ∞ﬁÇﬁ¶ﬁáﬁ®ﬁÉﬁ™ ﬁñﬁ¶ﬁÄﬁ¶ﬁÇﬁ∞ﬁñﬁ¨ﬁÄﬁ≠ﬁÇﬁ© 1234");
            }
        } else {
            if(users[id] !== pass) return alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®");
        }

        currentStudent = foundStudentName;
        currentClass = foundClass;
        
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('student-dashboard').classList.add('dashboard-active');
        initStudentDashboard();
    }

    function logout() { location.reload(); }
    function toggleSidebar() { document.getElementById('teacherSidebar').classList.toggle('open'); }

    // --- TEACHER LOGIC ---
    function refreshDropdowns() {
        const sel = document.getElementById('classSelect');
        const modalSel = document.getElementById('modalClassSelect');
        const delSel = document.getElementById('deleteClassSelect');
        const manageSel = document.getElementById('manageClassSelect');
        
        [sel, modalSel, delSel, manageSel].forEach(s => s.innerHTML = '');
        
        Object.keys(classes).forEach(c => {
            [sel, modalSel, delSel, manageSel].forEach(s => s.innerHTML += `<option value="${c}">${c}</option>`);
        });
        
        if(Object.keys(classes).length > 0 && !currentClass) switchClass(Object.keys(classes)[0]);
    }

    function switchClass(cls) {
        currentClass = cls;
        document.getElementById('currentClassDisplay').innerText = "ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞: " + cls;
        const teacherName = classes[cls]?.teacher || "";
        if(teacherName) document.getElementById('classTeacherDisplay').innerText = "Tr. " + teacherName;
        
        const list = document.getElementById('studentListContainer');
        list.innerHTML = '';
        currentStudent = null;
        document.getElementById('studentHeader').innerText = "ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞";
        document.getElementById('studentHeaderId').innerHTML = "";
        
        (classes[cls]?.students || []).forEach(s => {
            const info = parseStudentInfo(s);
            let btn = document.createElement('button');
            btn.className = 'student-btn';
            btn.innerHTML = `<span>${info.name}</span>${info.id ? `<span class="id-badge">${info.id}</span>` : ''}`;
            btn.onclick = () => selectTeacherStudent(s, btn);
            list.appendChild(btn);
        });
    }

    function selectTeacherStudent(fullString, btnEl) {
        currentStudent = fullString;
        const info = parseStudentInfo(fullString);
        
        document.querySelectorAll('.student-btn').forEach(b => b.classList.remove('active'));
        if(btnEl) btnEl.classList.add('active');
        
        document.getElementById('studentHeader').innerText = info.name;
        document.getElementById('studentHeaderId').innerHTML = info.id ? `<span class="id-badge" style="background:#eafaf1; border-color:#27ae60; color:#27ae60;">${info.id}</span>` : "";
        
        if(window.innerWidth <= 768) document.getElementById('teacherSidebar').classList.remove('open');

        clearForm();
        sessionDots = [];
        autoFillAllSections();
        renderTeacherHistory();
    }

    // --- MUSHAF & DOTS ---
    function loadMushaf(p) {
        if(!p || p < 1 || p > 604) return;
        currentPage = parseInt(p);
        document.getElementById('navPage').value = currentPage;
        document.getElementById('mushafImg').src = `https://android.quran.com/data/width_1260/page${currentPage.toString().padStart(3,'0')}.png`;
        
        fetch(`https://api.quran.com/api/v4/verses/by_page/${currentPage}?per_page=1`)
        .then(r => r.json()).then(d => {
            if(d.verses && d.verses.length > 0) {
                const juzu = d.verses[0].juz_number;
                const surahId = d.verses[0].verse_key.split(':')[0];
                document.getElementById('mushafInfoDisplay').innerText = `ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ${juzu} - ${surahNames[surahId-1]}`;
            }
        });

        clearDots();
        sessionDots.forEach(d => { if(d.page == p) drawDot(d.x, d.y, true); });
    }
    
    function changePage(d) { loadMushaf(parseInt(currentPage) + d); }
    function toggleMushaf(show) { 
        const p = document.getElementById('mushafPanel');
        if(show === undefined) {
             p.classList.toggle('open');
             if(window.innerWidth > 768) p.style.width = p.style.width === '0px' ? '30%' : '0px';
        } else {
            if(show) {
                if(window.innerWidth <= 768) p.classList.add('open');
                else p.style.width = '30%';
            } else {
                if(window.innerWidth <= 768) p.classList.remove('open');
                else p.style.width = '0px';
            }
        }
    }

    function setActiveSection(sec) {
        currentActiveSection = sec;
        document.querySelectorAll('.section-box').forEach(b => b.classList.remove('active-section'));
        if(sec !== 'exam') {
            document.getElementById('box-'+sec).classList.add('active-section');
            document.querySelector(`input[name="activeSec"][value="${sec}"]`).checked = true;
            const pageVal = document.getElementById(sec+'Page').value;
            if(pageVal) loadMushaf(pageVal);
        }
        sessionDots = [];
        clearDots();
    }

    function onImageClick(e) {
        if(document.body.classList.contains('parent-mode')) return; 
        const rect = document.getElementById('mushafWrapper').getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        sessionDots.push({x, y, page: currentPage});
        adjM(currentActiveSection + 'Mistakes', 1);
        drawDot(x, y, true);
    }

    function drawDot(x, y, isClickable) {
        const dot = document.createElement('div');
        dot.className = 'mistake-dot';
        dot.style.left = x + 'px'; dot.style.top = y + 'px';
        if(isClickable) {
            dot.onclick = (e) => {
                e.stopPropagation();
                dot.remove();
                sessionDots = sessionDots.filter(d => d.x !== x && d.y !== y);
                adjM(currentActiveSection + 'Mistakes', -1);
            };
        }
        document.getElementById('mushafWrapper').appendChild(dot);
    }

    function clearDots() { document.querySelectorAll('#mushafWrapper .mistake-dot').forEach(d => d.remove()); }
    function adjM(id, val) {
        const el = document.getElementById(id);
        if(el) el.value = Math.max(0, parseInt(el.value || 0) + val);
    }

    // --- AUTO FILL LOGIC ---
    function handlePageChange(page, section) {
        if(!page) return;
        loadMushaf(page);
        fetch(`https://api.quran.com/api/v4/verses/by_page/${page}?per_page=300`)
        .then(r => r.json()).then(d => {
            if(d.verses && d.verses.length > 0) {
                const first = d.verses[0].verse_key.split(':');
                const last = d.verses[d.verses.length - 1].verse_key.split(':');
                document.getElementById(section+'Surah').value = first[0];
                document.getElementById(section+'Start').value = first[1];
                document.getElementById(section+'EndSurah').value = last[0];
                document.getElementById(section+'End').value = last[1];
            }
        });
    }

    function autoFillAllSections() {
        if(!currentStudent) return;
        const myRecs = records.filter(r => r.class === currentClass && r.student === currentStudent && r.type === 'daily');
        myRecs.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        if(myRecs.length > 0) {
            const lastRec = myRecs[0];
            if (lastRec.new && lastRec.new.en) {
                 const surahIdx = surahNames.indexOf(lastRec.new.s) + 1;
                 const lastVerse = parseInt(lastRec.new.en);
                 fetch(`https://api.quran.com/api/v4/verses/by_key/${surahIdx}:${lastVerse}?fields=page_number`)
                 .then(r => r.json()).then(d => {
                    if(d.verse) {
                        const nextPage = d.verse.page_number + 1;
                        if(nextPage <= 604) {
                            document.getElementById('newPage').value = nextPage;
                            handlePageChange(nextPage, 'new');
                            if(currentActiveSection === 'new') loadMushaf(nextPage);
                        }
                    }
                });
            }
            if (lastRec.short && lastRec.short.st) {
                 const surahIdx = surahNames.indexOf(lastRec.short.s) + 1;
                 const startVerse = parseInt(lastRec.short.st);
                 fetch(`https://api.quran.com/api/v4/verses/by_key/${surahIdx}:${startVerse}?fields=page_number`)
                 .then(r => r.json()).then(d => {
                     if(d.verse) {
                         document.getElementById('shortPage').value = d.verse.page_number;
                         handlePageChange(d.verse.page_number, 'short');
                     }
                 });
            }
             if (lastRec.long && lastRec.long.en) {
                 const surahIdx = surahNames.indexOf(lastRec.long.s) + 1;
                 const lastVerse = parseInt(lastRec.long.en);
                 fetch(`https://api.quran.com/api/v4/verses/by_key/${surahIdx}:${lastVerse}?fields=page_number`)
                 .then(r => r.json()).then(d => {
                     if(d.verse) {
                         const nextPage = d.verse.page_number + 1;
                         if(nextPage <= 604) {
                             document.getElementById('longPage').value = nextPage;
                             handlePageChange(nextPage, 'long');
                         }
                     }
                 });
            }
        }
    }

    // --- SAVE LOGIC ---
    function saveRecord() {
        if(!currentStudent) return alert("ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ∞");
        const type = document.getElementById('lessonType').value;
        
        let record = {
            id: Date.now(),
            date: document.getElementById('entryDate').value,
            class: currentClass,
            student: currentStudent,
            type: type
        };

        if(type === 'daily') {
            const sec = currentActiveSection; 
            const sVal = document.getElementById(sec+'Surah').value;
            if(sVal === "..." || !sVal) return alert("ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß");

            record[sec] = {
                s: surahNames[parseInt(sVal)-1],
                st: document.getElementById(sec+'Start').value,
                en: document.getElementById(sec+'End').value,
                endSurah: surahNames[parseInt(document.getElementById(sec+'EndSurah').value)-1] || surahNames[parseInt(sVal)-1],
                m: document.getElementById(sec+'Mistakes').value,
                dots: sessionDots 
            };
        } else {
            record.juzu = document.getElementById('examJuzu').value;
            record.portion = document.getElementById('examPortion').value;
            record.duration = document.getElementById('examDuration').value;
            record.scores = { total: document.getElementById('examTotal').innerText };
            record.mistakes = {
                teacher: document.getElementById('examTMistakes').value,
                self: document.getElementById('examSMistakes').value
            };
        }

        db.ref('records').push(record);
        alert("ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨!");
        
        sessionDots = [];
        clearDots();
        if(type === 'daily') document.getElementById(currentActiveSection+'Mistakes').value = 0;
        autoFillAllSections(); 
    }

    function toggleFormSection(val) {
        document.getElementById('container-daily').style.display = val === 'daily' ? 'block' : 'none';
        document.getElementById('container-exam').style.display = val === 'exam' ? 'block' : 'none';
        setActiveSection(val === 'daily' ? 'new' : 'exam');
    }

    function filterHistory(filter) {
        historyFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        let btnId = filter === 'all' ? 'btnAll' : filter === 'new' ? 'btnNew' : filter === 'short' ? 'btnShort' : filter === 'long' ? 'btnLong' : 'btnExam';
        document.getElementById(btnId).classList.add('active');
        renderTeacherHistory();
    }

    function renderTeacherHistory() {
        const div = document.getElementById('historyContainer');
        div.innerHTML = '';
        const myRecs = records.filter(r => r.class === currentClass && r.student === currentStudent);
        myRecs.sort((a,b) => new Date(b.date) - new Date(a.date));

        let displayRecs = myRecs;
        if(historyFilter !== 'all') {
            displayRecs = myRecs.filter(r => {
                if(r.type === 'exam') return historyFilter === 'exam';
                return r[historyFilter];
            });
        }

        displayRecs.forEach(r => {
            let html = `<div class="history-card ${r.type==='exam'?'card-exam':'card-new'}">
                <div class="card-header">
                    <span>üìÖ ${r.date}</span>
                    <button onclick="if(confirm('ﬁäﬁ™ﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁåﬁ¶ÿü')) db.ref('records/${r.key}').remove()" style="color:red;border:none;background:none;cursor:pointer;">&times;</button>
                </div>`;
            
            if(r.type === 'daily') {
                ['new', 'short', 'long'].forEach(sec => {
                    if(r[sec]) {
                        const secName = sec === 'new' ? 'ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™' : sec === 'short' ? 'ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß' : 'ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß';
                        const color = sec === 'new' ? 'green' : sec === 'short' ? 'blue' : 'orange';
                        html += `<div style="font-size:14px; margin-top:5px;">
                            <span style="font-weight:bold; color:${color}">${secName}:</span> 
                            ${r[sec].s} ${r[sec].st} - ${r[sec].endSurah || r[sec].s} ${r[sec].en}
                            <span style="color:red; font-weight:bold;">(${r[sec].m || 0} ﬁÜﬁ™ﬁÅﬁ∞)</span>
                        </div>`;
                    }
                });
            } else {
                html += `<div>ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ${r.juzu} (${r.portion}) - ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß: <b>${r.scores.total}</b></div>`;
            }
            html += `</div>`;
            div.innerHTML += html;
        });
    }

    // --- STUDENT VIEW LOGIC ---
    function initStudentDashboard() {
        const info = parseStudentInfo(currentStudent);
        document.getElementById('stWelcomeName').innerText = "ﬁâﬁ¶ﬁÉﬁ™ﬁôﬁ¶ﬁÑﬁß, " + info.name;
        document.getElementById('stWelcomeID').innerHTML = info.id ? `<span class="id-badge">${info.id}</span>` : "";
        stFilterHistory('all');
    }

    function stFilterHistory(filter) {
        const div = document.getElementById('stHistoryContainer');
        div.innerHTML = '';
        
        document.querySelectorAll('#student-dashboard .filter-btn').forEach(b => b.classList.remove('active'));
        let btnId = filter === 'all' ? 'stBtnAll' : filter === 'new' ? 'stBtnNew' : 'stBtnExam';
        document.getElementById(btnId).classList.add('active');

        const myRecs = records.filter(r => r.class === currentClass && r.student === currentStudent);
        myRecs.sort((a,b) => new Date(b.date) - new Date(a.date));

        myRecs.forEach(r => {
            let content = '';
            if(r.type === 'daily' && filter !== 'exam') {
                ['new', 'short', 'long'].forEach(sec => {
                    if(r[sec] && (filter === 'all' || (filter === 'new' && sec === 'new'))) {
                        const dotsData = encodeURIComponent(JSON.stringify(r[sec].dots || []));
                        const secName = sec === 'new' ? 'ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™' : sec === 'short' ? 'ﬁÜﬁ™ﬁÉﬁ™' : 'ﬁãﬁ®ﬁéﬁ™';
                        
                        content += `
                        <div style="background:#f9f9f9; padding:10px; margin-top:5px; border-radius:5px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <strong>${secName}</strong>: ${r[sec].s} ${r[sec].st} - ${r[sec].en}
                                <br><span style="color:red; font-size:12px;">${r[sec].m} ﬁÜﬁ™ﬁÅﬁ∞</span>
                            </div>
                            ${r[sec].dots && r[sec].dots.length > 0 ? `<button class="btn btn-blue" style="font-size:12px; padding:5px 10px;" onclick="stOpenMushaf('${dotsData}')">üëÅÔ∏è ﬁÑﬁ¶ﬁçﬁßﬁçﬁ™ﬁâﬁ¶ﬁÅﬁ∞</button>` : ''}
                        </div>`;
                    }
                });
            } else if (r.type === 'exam' && (filter === 'all' || filter === 'exam')) {
                content = `<div style="padding:10px; background:#fff8e1;">üèÜ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞: ${r.juzu} - ${r.scores.total}</div>`;
            }

            if(content) {
                div.innerHTML += `
                <div class="history-card" style="border-right-color:${r.type=='exam'?'gold':'green'};">
                    <div class="card-header"><b>${r.date}</b></div>
                    ${content}
                </div>`;
            }
        });
    }

    window.stOpenMushaf = function(dataStr) {
        const dots = JSON.parse(decodeURIComponent(dataStr));
        if(!dots || dots.length === 0) return alert("ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ®ﬁéﬁ¶ﬁáﬁ® ﬁÜﬁ™ﬁÅﬁ¨ﬁáﬁ∞ ﬁäﬁßﬁÄﬁ¶ﬁéﬁ¶ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞");
        const page = dots[0].page;
        document.getElementById('stMushafImg').src = `https://android.quran.com/data/width_1260/page${page.toString().padStart(3,'0')}.png`;
        const wrapper = document.getElementById('stMushafWrapper');
        while(wrapper.children.length > 1) { wrapper.removeChild(wrapper.lastChild); }
        dots.forEach(d => {
            if(d.page == page) {
                let dot = document.createElement('div');
                dot.className = 'mistake-dot readonly';
                dot.style.left = d.x + 'px'; dot.style.top = d.y + 'px';
                wrapper.appendChild(dot);
            }
        });
        document.getElementById('stMushafModal').style.display = 'flex';
    }

    // --- STUDENT MANAGER (Passwords) ---
    function openStudentManager() {
        document.getElementById('studentManagerModal').style.display = 'flex';
        document.getElementById('manageClassSelect').innerHTML = document.getElementById('classSelect').innerHTML;
        renderStudentManagerTable();
    }
    
    function renderStudentManagerTable() {
        const cls = document.getElementById('manageClassSelect').value;
        const tbody = document.getElementById('studentManagerBody');
        tbody.innerHTML = '';
        
        (classes[cls]?.students || []).forEach(s => {
            const info = parseStudentInfo(s);
            const pass = (info.id && users[info.id]) ? users[info.id] : "Not Set (1234)";
            
            tbody.innerHTML += `
                <tr>
                    <td>${info.name}</td>
                    <td><span class="id-badge">${info.id || '-'}</span></td>
                    <td style="color:#27ae60; font-weight:bold;">${pass}</td>
                </tr>
            `;
        });
    }

    // --- UTILS & SETTINGS ---
    function startTimer() {
        if(!timerInterval) {
            startTime = Date.now() - elapsedTime;
            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                let s = Math.floor(elapsedTime/1000);
                document.getElementById('timerDisplay').innerText = new Date(s*1000).toISOString().substr(14, 5);
            }, 1000);
        }
    }
    function stopTimer() {
        clearInterval(timerInterval); timerInterval = null;
        document.getElementById('examDuration').value = Math.ceil(elapsedTime/60000);
    }
    function calcExam() {
        const t = parseInt(document.getElementById('examTMistakes').value)||0;
        const s = parseInt(document.getElementById('examSMistakes').value)||0;
        const portion = document.getElementById('examPortion').value;
        
        let baseScore = 100;
        if(portion === 'half') baseScore = 50;
        if(portion === 'third') baseScore = 33;
        if(portion === 'quarter') baseScore = 25;
        
        let hifzLoss = (t*2) + s; 
        let hifzScore = 80 - hifzLoss;
        if(hifzScore < 0) hifzScore = 0;
        
        // Normalize Hifz score to portion if needed, but standard practice is 80% weight regardless of portion size relative to full marks.
        // Simplified Logic: Just deduct mistakes from 100% total
        
        let score = hifzScore + (parseFloat(document.getElementById('markTajweed').value)||0) + (parseFloat(document.getElementById('markFluency').value)||0) + 5; 
        
        // Adjust for portion max score
        if(portion !== 'whole') {
             score = (score / 100) * baseScore;
        }
        
        document.getElementById('examTotal').innerText = score.toFixed(1) + "%";
    }

    function clearForm() {
        ['new','short','long'].forEach(s => {
            document.getElementById(s+'Page').value='';
            document.getElementById(s+'Start').value='';
            document.getElementById(s+'End').value='';
            document.getElementById(s+'Mistakes').value='0';
        });
        document.getElementById('examJuzu').value = '';
        document.getElementById('examDuration').value = '';
        document.getElementById('timerDisplay').innerText = '00:00';
        stopTimer();
        elapsedTime = 0;
        clearDots();
    }

    function openModal() { document.getElementById('classModal').style.display='flex'; document.getElementById('modalClassSelect').innerHTML = document.getElementById('classSelect').innerHTML; renderModalStudentList(); }
    function closeModal() { document.getElementById('classModal').style.display='none'; }
    function createClass() { 
        const n = document.getElementById('newClassName').value; 
        const t = document.getElementById('newClassTeacher').value;
        if(n) { db.ref('classes/'+n).set({teacher:t, students:[]}); alert('ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁÄﬁ¨ﬁãﬁ®ﬁáﬁ∞ﬁñﬁ¨'); closeModal(); }
    }
    function importStudents() {
        const c = document.getElementById('modalClassSelect').value;
        const txt = document.getElementById('bulkStudents').value;
        const list = txt.split('\n').filter(x=>x.trim());
        const old = classes[c]?.students || [];
        
        // Auto-create user passwords for IDs
        list.forEach(s => {
            const info = parseStudentInfo(s);
            if(info.id && !users[info.id]) db.ref('users/'+info.id).set("1234");
        });
        
        db.ref('classes/'+c+'/students').set([...new Set([...old, ...list])]);
        alert('ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨');
        document.getElementById('bulkStudents').value = '';
    }
    
    function renderModalStudentList() {
        const c = document.getElementById('modalClassSelect').value;
        const div = document.getElementById('modalStudentList');
        div.innerHTML = '';
        (classes[c]?.students || []).forEach(s => {
            div.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                ${s} <button style="color:red; border:none; cursor:pointer;" onclick="deleteStudent('${c}','${s}')">X</button>
            </div>`;
        });
    }
    
    function deleteStudent(c, s) {
        if(confirm(s + ' ﬁäﬁ™ﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁåﬁ¶ÿü')) {
            const updated = classes[c].students.filter(st => st !== s);
            db.ref('classes/'+c+'/students').set(updated);
            renderModalStudentList();
        }
    }
    
    function deleteSelectedClass() {
        const cls = document.getElementById('deleteClassSelect').value;
        if(confirm(cls + " ﬁäﬁ™ﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁåﬁ¶ÿü")) {
            db.ref('classes/'+cls).remove();
            refreshDropdowns();
            alert("ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁäﬁ™ﬁÄﬁ¨ﬁçﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨");
        }
    }

    function downloadBackup() {
        let backupData = { classes: classes, records: {} };
        records.forEach(r => { backupData.records[r.key] = r; });
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
        a.download = "hifz_backup.json"; a.click();
    }
    
    function restoreBackup() {
        const file = document.getElementById('restoreFile').files[0];
        if(!file) return alert("ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁÇﬁ¶ﬁéﬁß");
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = JSON.parse(e.target.result);
            if(confirm("ﬁëﬁ≠ﬁìﬁß ﬁÉﬁ©ﬁêﬁ∞ﬁìﬁØ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ﬁàﬁ©ﬁåﬁ¶ÿü (ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÄﬁ™ﬁÉﬁ® ﬁëﬁ≠ﬁìﬁß ﬁéﬁ¨ﬁáﬁ∞ﬁçﬁ≠ﬁÇﬁ¨)")) {
                db.ref('/').set(data);
                alert("ﬁÉﬁ©ﬁêﬁ∞ﬁìﬁØ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨");
                location.reload();
            }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
