<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ - Final V31</title>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

        @font-face { font-family: 'Faruma'; src: local('Faruma'), local('Faruma-Regular'); }
        @font-face { font-family: 'MV Waheed'; src: local('MV Waheed'), local('MV Waheed-Regular'); }

        :root {
            --primary: #2c3e50; --accent: #27ae60; --accent-rev: #e67e22; --mistake: #e74c3c;
            --bg-light: #f4f6f8; --mushaf-paper: #fffcf2; --st-primary: #1e8449;
            --font-main: 'Faruma', 'Noto Sans Thaana', sans-serif;
            --font-heading: 'MV Waheed', 'Noto Sans Thaana', sans-serif; 
            --font-arabic: 'Amiri', serif;
        }

        * { box-sizing: border-box; }
        body { font-family: var(--font-main); margin: 0; min-height: 100vh; color: #333; background-color: var(--bg-light); overflow-x: hidden; transition: background 0.3s; }
        
        body.student-mode { background-color: #eafaf1; }
        body.student-mode .app-header { border-bottom: 3px solid var(--st-primary); }
        body.student-mode .header-title { color: var(--st-primary); }

        .hidden { display: none !important; }
        .container { width: 100%; padding: 20px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.3s ease; }

        /* HEADER */
        .app-header { background: white; height: 65px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header-title { font-family: var(--font-heading); font-size: 24px; color: var(--primary); }
        .icon-btn { background: #f0f2f5; border: none; width: 42px; height: 42px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; color: #333; }
        .logout-btn { background: #fee2e2; color: #b91c1c; }

        /* LOGIN */
        .login-wrapper { display: flex; align-items: center; justify-content: center; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; background: #ecf0f1; z-index: 2000; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; border-top: 5px solid var(--primary); }
        .tabs { display: flex; background: #eee; padding: 5px; border-radius: 50px; margin: 20px 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; font-family: var(--font-heading); font-size: 16px; border-radius: 40px; color: #777; transition:0.3s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; }
        .form-input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 10px; font-family: var(--font-main); font-size: 16px; margin-bottom: 15px; text-align: right; outline: none; transition: 0.3s; }
        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-family: var(--font-heading); font-size: 18px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* UI ELEMENTS */
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .action-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .action-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .list-item { background: white; padding: 18px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-right: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        
        .big-btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-family: var(--font-heading); cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-orange { background: #e67e22; } .btn-green { background: #27ae60; }

        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        @media (min-width: 600px) { .menu-grid { grid-template-columns: repeat(3, 1fr); } }
        .menu-btn { background: white; padding: 25px; border-radius: 15px; border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; transition: 0.2s; }
        .menu-icon { font-size: 35px; width: 70px; height: 70px; background: #f4f6f8; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* HISTORY CARD */
        .hist-card { background: white; width: 100%; margin-bottom: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #e0e0e0; cursor: pointer; transition:0.2s; position: relative; }
        .hist-card:active { transform: scale(0.99); }
        
        .hist-header { padding: 12px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .hist-title { font-weight: bold; font-size: 18px; color: var(--primary); }
        .hist-badge { font-size: 11px; padding: 3px 8px; border-radius: 15px; color: white; display: inline-block; }
        
        .hist-body { padding: 15px; }
        .hist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .hist-item { text-align: center; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #f0f0f0; }
        .hist-label { font-size: 11px; color: #7f8c8d; display: block; margin-bottom: 2px; }
        .hist-val { font-size: 14px; font-weight: bold; color: #333; font-family: var(--font-arabic); }
        
        .hist-footer { padding: 10px; background: #eafaf1; text-align: center; border-top: 1px solid #d5f5e3; font-size: 16px; font-weight: bold; color: var(--accent); }
        .hist-footer.exam-score { background: #ebf5fb; border-top: 1px solid #d6eaf8; color: #2980b9; }

        .btn-delete-hist { 
            position: absolute; bottom: 10px; left: 10px; background: #fee2e2; color: #c0392b; 
            width: 30px; height: 30px; border-radius: 50%; border: none; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; z-index: 5;
        }

        /* LAYOUTS */
        .layout-split { display: flex; height: calc(100vh - 65px); overflow: hidden; }
        .sidebar-panel { width: 400px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; z-index: 10; padding: 20px; box-shadow: -5px 0 20px rgba(0,0,0,0.05); }
        .main-panel { flex-grow: 1; background: var(--mushaf-paper); position: relative; display: flex; flex-direction: column; overflow-y: auto; padding: 20px; align-items: center; }

        /* MUSHAF */
        .mushaf-top-bar { background: white; padding: 8px 20px; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 10px; font-family: var(--font-arabic); font-size: 18px; color: var(--primary); display: flex; justify-content: space-between; width: 100%; max-width: 900px; margin: 0 auto 10px auto; direction: rtl; flex-shrink: 0; }
        .mushaf-page { width: 100%; max-width: 900px; background: white; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-height: 80%; flex-grow: 1; direction: rtl; text-align: center; border-radius: 8px; margin: 0 auto; overflow-y: auto; }
        .quran-text { font-family: var(--font-arabic); font-size: 26px; line-height: 2.3; text-align: justify; text-align-last: center; }
        .word { cursor: pointer; border-radius: 4px; padding: 2px 1px; transition: background 0.1s; }
        .word.mistake { background-color: var(--mistake); color: white; }
        .ayah-marker { color: #d4ac6e; font-weight: bold; }
        .mushaf-nav { display: flex; justify-content: space-between; margin-top: 10px; width: 100%; max-width: 900px; padding: 5px; flex-shrink: 0; }
        .nav-btn { background: #34495e; color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }

        /* EXAM & RECORDER */
        .score-header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 15px; }
        .big-score { font-size: 40px; font-weight: bold; }
        .score-control { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #f8f9fa; padding: 8px 12px; border-radius: 10px; }
        .ctrl-btn { width: 35px; height: 35px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-minus { background: #ffcdd2; color: #c62828; } .btn-plus { background: #c8e6c9; color: #2e7d32; }
        .stopwatch-box { font-family: monospace; font-size: 32px; text-align: center; color: #e67e22; font-weight: bold; background: #fffbf0; padding: 10px; border-radius: 10px; border: 1px solid #ffeeba; margin-bottom: 15px; }
        
        .form-sec { border: 1px solid #eee; padding: 10px; border-radius: 8px; position: relative; margin-top: 10px; }
        .sec-title { position: absolute; top: -10px; right: 10px; background: white; padding: 0 5px; font-size: 12px; font-weight: bold; color: #777; }
        .rec-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-family: var(--font-main); text-align: right; margin-bottom: 5px; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 550px; max-height: 95vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-span { grid-column: span 2; }
        .form-label { font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px; color: #555; }

        @media (max-width: 900px) {
            .layout-split { flex-direction: column; }
            .sidebar-panel { width: 100%; height: auto; max-height: 50vh; order: 1; border-bottom: 2px solid #ddd; }
            .main-panel { order: 2; height: 50vh; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen" class="login-wrapper">
        <div class="login-card">
            <h1 class="login-title">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞</h1>
            <div class="tabs">
                <button class="tab-btn active" onclick="window.switchLogin('teacher')">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
                <button class="tab-btn" onclick="window.switchLogin('student')">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™</button>
            </div>
            <div id="teacher-login-form">
                <input type="password" id="teacherPassInput" class="form-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
                <button class="btn-primary" onclick="window.loginTeacher()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
            <div id="student-login-form" class="hidden">
                <input type="text" id="stuIdInput" class="form-input" placeholder="ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™">
                <div id="stuPassField" class="hidden" style="margin-top:10px;">
                    <input type="password" id="stuPassInput" class="form-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞">
                </div>
                <button class="btn-primary" style="background:var(--st-primary);" onclick="window.handleStudentLoginStep()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="hidden">
        
        <!-- TEACHER DASHBOARD -->
        <div id="teacher-dashboard" class="container hidden">
            <div class="app-header">
                <div class="header-title">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞</div>
                <button class="icon-btn logout-btn" onclick="window.logout()">‚èª</button>
            </div>
            <div class="grid-layout">
                <div class="action-card" onclick="window.openPage('management-page')">
                    <span style="font-size:50px;">‚öôÔ∏è</span>
                    <h3>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞</h3>
                </div>
                <div class="action-card" onclick="window.openGradingClassList()">
                    <span style="font-size:50px;">üìö</span>
                    <h3>ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞</h3>
                </div>
            </div>
        </div>

        <!-- MANAGEMENT PAGES -->
        <div id="management-page" class="container hidden">
            <div class="app-header"><div class="header-title">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">‚¨Ö</button></div>
            <div class="action-card" style="margin-top:20px; text-align:right;">
                <h4>ﬁáﬁß ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ¨ﬁáﬁ∞ ﬁÄﬁ¨ﬁãﬁ™ﬁÇﬁ∞</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="newClassName" class="form-input" placeholder="ﬁÜﬁ∞ﬁçﬁßﬁÄﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞" style="margin:0;">
                    <input type="text" id="newTeacherName" class="form-input" placeholder="ﬁáﬁ™ﬁêﬁ∞ﬁåﬁßﬁõﬁ∞" style="margin:0;">
                    <button class="btn-primary" style="width:auto;" onclick="window.createClass()">ﬁÄﬁ¶ﬁãﬁß</button>
                </div>
            </div>
            <h4 style="margin-top:20px;">ﬁÄﬁ¨ﬁãﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞</h4>
            <div id="manageClassList"></div>
        </div>

        <div id="class-details-page" class="container hidden">
            <div class="app-header"><div class="header-title" id="manageHeaderName">Class</div><button class="icon-btn" onclick="window.openPage('management-page')">‚¨Ö</button></div>
            <div class="grid-layout">
                <div class="action-card">
                    <button class="big-btn" onclick="window.openAddStudentModal()"><span>‚ûï</span> ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                    <div style="display:flex; gap:10px;">
                        <button class="big-btn btn-orange" onclick="window.downloadTemplate()"><span>üì•</span> ﬁìﬁ¨ﬁâﬁ∞ﬁïﬁ∞ﬁçﬁ≠ﬁìﬁ∞</button>
                        <label class="big-btn btn-green" style="font-size:14px; margin:0; cursor:pointer;">üìÇ ﬁáﬁ¶ﬁïﬁ∞ﬁçﬁØﬁëﬁ∞<input type="file" hidden onchange="window.handleExcelUpload(this)"></label>
                    </div>
                </div>
            </div>
            <h4 style="margin-top:20px;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ∞</h4>
            <div id="studentManageList"></div>
        </div>

        <!-- GRADING FLOW -->
        <div id="grading-class-page" class="container hidden">
            <div class="app-header"><div class="header-title">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞</div><button class="icon-btn" onclick="window.openPage('teacher-dashboard')">‚¨Ö</button></div>
            <div id="gradingClassList"></div>
        </div>
        <div id="grading-student-page" class="container hidden">
            <div class="app-header"><div class="header-title">Students</div><button class="icon-btn" onclick="window.openPage('grading-class-page')">‚¨Ö</button></div>
            <div id="gradingStudentList"></div>
        </div>
        <div id="grading-menu-page" class="container hidden">
            <div class="app-header"><div class="header-title" id="gradingStudentName">Student</div><button class="icon-btn" onclick="window.openPage('grading-student-page')">‚¨Ö</button></div>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openCategoryPage('new_lesson')"><span class="menu-icon" style="color:var(--accent);">üìñ</span><strong>ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</strong></div>
                <div class="menu-btn" onclick="window.openCategoryPage('short_rev')"><span class="menu-icon" style="color:var(--accent-rev);">üîÑ</span><strong>ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</strong></div>
                <div class="menu-btn" onclick="window.openCategoryPage('long_rev')"><span class="menu-icon" style="color:#8e44ad;">üìÖ</span><strong>ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</strong></div>
                <div class="menu-btn" onclick="window.openJuzExamSetup()"><span class="menu-icon" style="color:#2980b9;">üìù</span><strong>ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</strong></div>
                <div class="menu-btn" onclick="window.openCategoryPage('final_exam')"><span class="menu-icon" style="color:#c0392b;">üéì</span><strong>ﬁäﬁ¶ﬁÄﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</strong></div>
            </div>
        </div>

        <!-- CATEGORY HISTORY PAGE -->
        <div id="category-page" class="container hidden">
            <div class="app-header">
                <div class="header-title" id="catPageTitle">Title</div>
                <button class="icon-btn" onclick="window.goBackFromCategory()">‚¨Ö</button>
            </div>
            <div class="page-toolbar" style="background:white; padding:15px; border-radius:12px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:16px; font-weight:bold; color:var(--primary);">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ﬁåﬁ¶ﬁáﬁ∞</span>
                <button id="addRecordBtn" class="add-record-btn" onclick="window.handleAddButtonClick()">‚ûï</button>
            </div>
            <div id="categoryHistoryList"></div>
        </div>

        <!-- UNIVERSAL RECORDER & VIEWER -->
        <div id="recorder-page" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000;">
            <div class="app-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="icon-btn" onclick="window.closeRecorder()">‚¨Ö</button>
                    <span class="header-title" id="recorderTitle">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞</span>
                </div>
                <span id="viewModeBadge" style="background:#e74c3c; color:white; padding:2px 8px; border-radius:4px; font-size:12px; display:none;">View Mode</span>
            </div>
            <div class="layout-split">
                <div class="sidebar-panel">
                    <div style="margin-bottom:15px;"><label class="form-label">ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="recDate" class="rec-input" style="text-align:center;"></div>
                    <div class="form-sec" style="border-top:3px solid var(--accent);">
                        <span class="sec-title">ﬁäﬁ¶ﬁÅﬁß ﬁÄﬁ®ﬁêﬁßﬁÑﬁ™</span>
                        <label>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="startPage" class="rec-input" placeholder="Page" onchange="window.loadSmartPage()">
                        <div style="display:flex; gap:5px;"><div style="flex:1"><label>ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞</label><select id="startSurah" class="rec-input"></select></div><div style="width:60px"><label>ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞</label><select id="startAyah" class="rec-input"></select></div></div>
                    </div>
                    <div class="form-sec" style="border-top:3px solid #e74c3c;">
                        <span class="sec-title">ﬁÇﬁ®ﬁâﬁ≠ ﬁÄﬁ®ﬁêﬁßﬁÑﬁ™</span>
                        <label>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="endPage" class="rec-input" placeholder="Page">
                        <div style="display:flex; gap:5px;"><div style="flex:1"><label>ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞</label><select id="endSurah" class="rec-input"></select></div><div style="width:60px"><label>ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞</label><select id="endAyah" class="rec-input"></select></div></div>
                    </div>
                    <div style="background:#fff5f5; padding:15px; border-radius:8px; text-align:center; margin-top:auto; border:1px solid #ffcccc;">
                        <span style="font-size:14px; color:red;">ﬁÜﬁ™ﬁÅﬁ™ﬁéﬁ¨ ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™</span><strong id="mistakeCountDisplay" style="font-size:32px; color:red; display:block;">0</strong>
                    </div>
                    <button id="recSaveBtn" class="big-btn" onclick="window.saveRecord()">üíæ ﬁêﬁ≠ﬁàﬁ∞</button>
                </div>
                <div class="main-panel">
                    <div class="mushaf-top-bar" id="recMushafTopBar"><span id="recMushafJuz"></span><span id="recMushafSurah"></span></div>
                    <div class="mushaf-page"><div id="mushafContent" class="quran-text"><p style="color:#999; margin-top:100px;">ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß</p></div></div>
                    <div class="mushaf-nav"><button class="nav-btn" onclick="window.changeRecPage(1)">‚û°</button><span id="recPageDisplay">Page</span><button class="nav-btn" onclick="window.changeRecPage(-1)">‚¨Ö</button></div>
                </div>
            </div>
        </div>

        <!-- JUZ EXAM PAGE -->
        <div id="juz-exam-page" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000;">
            <div class="app-header">
                <div style="display:flex; align-items:center; gap:10px;"><button class="icon-btn" onclick="window.closeJuzExam()">‚¨Ö</button><span class="header-title" id="juzExamTitle">ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</span></div>
                <div id="partBadge" style="background:#2c3e50; color:white; padding:5px 15px; border-radius:20px; font-size:12px;"></div>
            </div>
            <div class="layout-split">
                <div class="sidebar-panel">
                    <div class="score-header"><div class="big-score" id="liveScore">100%</div></div>
                    <div class="exam-section">
                        <div class="stopwatch-box"><span id="stopwatchDisplay">00:00:00</span><div style="font-size:12px;"><button onclick="window.startTimer()" style="border:none; color:green; background:none;">‚ñ∂</button> <button onclick="window.stopTimer()" style="border:none; color:red; background:none;">‚èπ</button></div></div>
                    </div>
                    <div class="exam-section">
                        <div class="score-control"><span>ﬁáﬁ™ﬁêﬁ∞ﬁåﬁßﬁõﬁ∞ (-2)</span><strong id="countTeacher" class="ctrl-val" style="color:var(--mistake);">0</strong></div>
                        <div class="score-control"><span>ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ﬁáﬁ¶ﬁÅﬁ∞ (-1)</span><div style="display:flex;gap:5px;"><button class="ctrl-btn btn-minus" onclick="window.updateScore('self',1)">+</button><span id="countSelf" class="ctrl-val">0</span><button class="ctrl-btn btn-plus" onclick="window.updateScore('self',-1)">-</button></div></div>
                        <div class="score-control"><span>ﬁåﬁ¶ﬁñﬁ™ﬁàﬁ©ﬁãﬁ™ (10)</span><input type="number" id="scoreTajweed" class="form-input" style="width:60px;" value="10" max="10" onchange="window.calcScore()"></div>
                        <div class="score-control"><span>ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞ (5)</span><input type="number" id="scoreFluency" class="form-input" style="width:60px;" value="5" max="5" onchange="window.calcScore()"></div>
                    </div>
                    <div class="exam-section" id="mutashabihSection">
                        <button class="big-btn btn-orange" style="padding:10px; font-size:14px;" onclick="window.generateQuestions()">üé≤ ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™</button>
                        <div id="questionList" style="margin:10px 0;"></div>
                        <div style="display:flex; justify-content:space-between;"><label>Q1 <input type="number" id="q1_score" value="2.5" max="2.5" style="width:50px;" onchange="window.calcScore()"></label><label>Q2 <input type="number" id="q2_score" value="2.5" max="2.5" style="width:50px;" onchange="window.calcScore()"></label></div>
                    </div>
                    <div style="padding:20px;"><button id="saveExamBtn" class="big-btn" onclick="window.saveJuzExamPart()">üíæ ﬁêﬁ≠ﬁàﬁ∞</button></div>
                </div>
                <div class="main-panel">
                    <div class="mushaf-top-bar" id="mushafTopBar"><span id="mushafJuzInfo"></span><span id="mushafSurahInfo"></span></div>
                    <div class="mushaf-page"><div id="examMushafContent" class="quran-text"><p style="color:#999; margin-top:100px;">...</p></div></div>
                    <div class="mushaf-nav"><button class="nav-btn" onclick="window.changeExamPage(1)">‚û°</button><span id="currentPageDisplay">Page</span><button class="nav-btn" onclick="window.changeExamPage(-1)">‚¨Ö</button></div>
                </div>
            </div>
        </div>

        <!-- FINAL EXAM PAGE -->
        <div id="final-exam-page" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000;">
            <div class="app-header"><button class="icon-btn" onclick="window.closeFinalExam()">‚¨Ö</button><span class="header-title">ﬁäﬁ¶ﬁÄﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</span></div>
            <div class="layout-split">
                <div class="sidebar-panel">
                    <div class="score-header"><div class="big-score" id="finalExamScore">100%</div></div>
                    <div style="text-align:center; margin:10px 0; font-weight:bold;" id="questionIndicator">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ 1 / 3</div>
                    <label class="form-label">ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁéﬁ¶ﬁàﬁß</label><select id="finalJuzSelect" class="form-input"></select>
                    <button class="big-btn btn-orange" style="padding:10px; font-size:14px; margin-top:5px;" onclick="window.loadFinalQuestion()">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁäﬁ¶ﬁÅﬁß</button>
                    <div style="margin-top:20px;">
                        <div class="score-control"><span>ﬁÉﬁ¶ﬁÇﬁéﬁ¶ﬁÖﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁãﬁ®ﬁÇﬁ∞ (-5)</span><strong id="finalTeacherCount" style="color:var(--mistake);">0</strong></div>
                        <div class="score-control"><span>ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ﬁáﬁ¶ﬁÅﬁ∞ (-2)</span><div style="display:flex;gap:5px;"><button class="ctrl-btn btn-minus" onclick="window.updateFinalScore('self',1)">+</button><span id="finalSelfCount" class="ctrl-val">0</span><button class="ctrl-btn btn-plus" onclick="window.updateFinalScore('self',-1)">-</button></div></div>
                    </div>
                    <div style="padding:20px; margin-top:auto;"><button id="nextQBtn" class="big-btn" onclick="window.nextFinalQuestion()">ﬁãﬁ¨ﬁÇﬁ∞ﬁñﬁ¨ﬁÄﬁ≠ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ‚û°</button><button id="finishExamBtn" class="big-btn btn-green hidden" onclick="window.saveFinalExam()">ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁß üíæ</button></div>
                </div>
                <div class="main-panel"><div class="mushaf-page"><div id="finalMushafContent" class="quran-text">...</div></div></div>
            </div>
        </div>

        <!-- STUDENT DASHBOARD -->
        <div id="student-dashboard" class="container hidden">
            <div class="app-header"><div class="header-title">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞</div><button class="icon-btn logout-btn" onclick="window.logout()">‚èª</button></div>
            <div style="background:white; padding:30px; border-radius:15px; text-align:center; margin-bottom:20px;"><h2 style="color:var(--st-primary);">ﬁâﬁ¶ﬁÉﬁ™ﬁôﬁ¶ﬁÑﬁß!</h2><h3 id="studentDashName"></h3></div>
            <h4 style="color:var(--st-primary);">ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁßﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞</h4>
            <div id="studentDashHistory"></div>
        </div>

    </div>

    <!-- MODALS -->
    <div id="createPassModal" class="modal">
        <div class="modal-content" style="text-align:center;"><h3 style="color:var(--primary);">ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÄﬁ¶ﬁáﬁ∞ﬁãﬁ¶ﬁàﬁß</h3><input type="password" id="newStuPass" class="form-input" placeholder="ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞"><button class="big-btn" onclick="window.saveNewPassword()">ﬁêﬁ≠ﬁàﬁ∞ & ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button></div>
    </div>
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h3>ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞</h3>
            <div class="form-grid">
                <div class="full-span"><label class="form-label">ﬁÜﬁØﬁêﬁ∞ ﬁâﬁÆﬁëﬁ®ﬁáﬁ™ﬁçﬁ∞</label><input type="text" id="m_module" class="form-input"></div>
                <div><label class="form-label">ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©</label><input type="text" id="m_id" class="form-input"></div>
                <div><label class="form-label">ﬁÇﬁ¶ﬁÇﬁ∞</label><input type="text" id="m_name" class="form-input"></div>
                <div><label class="form-label">ﬁçﬁ¨ﬁàﬁ¨ﬁçﬁ∞</label><select id="m_level" class="form-input"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                <div><label class="form-label">ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁß ﬁéﬁÆﬁåﬁ∞</label><select id="m_direction" class="form-input"><option value="top_down">ﬁâﬁ¶ﬁåﬁ®ﬁÇﬁ∞ ﬁåﬁ®ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞</option><option value="bottom_up">ﬁåﬁ®ﬁÉﬁ®ﬁÇﬁ∞ ﬁâﬁ¶ﬁåﬁ®ﬁáﬁ¶ﬁÅﬁ∞</option></select></div>
                <div class="full-span"><label class="form-label">ﬁãﬁ¶ﬁêﬁ∞ﬁàﬁ¨ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™</label><input type="text" id="m_juz_count" class="form-input"></div>
                <div class="full-span"><label class="form-label">ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™</label><input type="text" id="m_remarks" class="form-input"></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;"><button class="big-btn" onclick="window.confirmAddStudent()">ﬁêﬁ≠ﬁàﬁ∞</button><button class="big-btn btn-orange" onclick="document.getElementById('addStudentModal').style.display='none'">ﬁÜﬁ¨ﬁÇﬁ∞ﬁêﬁ¶ﬁçﬁ∞</button></div>
        </div>
    </div>
    <div id="juzSetupModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3>ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</h3>
            <select id="examJuzSelect" class="form-input"></select>
            <div style="text-align:right; margin:15px 0;"><label><input type="radio" name="examPart" value="full" checked> ﬁäﬁÆﬁåﬁ∞ ﬁáﬁ¨ﬁáﬁ∞ﬁÜﬁÆﬁÅﬁ∞</label><br><label><input type="radio" name="examPart" value="part1"> ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁÑﬁ¶ﬁáﬁ® (1/2)</label><br><label><input type="radio" name="examPart" value="part2"> ﬁäﬁ¶ﬁÄﬁ™ ﬁÑﬁ¶ﬁáﬁ® (2/2)</label></div>
            <button class="big-btn" onclick="window.startJuzExam()">ﬁäﬁ¶ﬁÅﬁß</button>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
            authDomain: "hifz-cde3b.firebaseapp.com",
            databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
            projectId: "hifz-cde3b",
            storageBucket: "hifz-cde3b.firebasestorage.app",
            messagingSenderId: "566754658580",
            appId: "1:566754658580:web:d63d0f167960f53bab9a01"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // GLOBALS
        const SURAH_NAMES_AR = ["ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©", "ÿßŸÑÿ®ŸÇÿ±ÿ©", "ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ", "ÿßŸÑŸÜÿ≥ÿßÿ°", "ÿßŸÑŸÖÿßÿ¶ÿØÿ©", "ÿßŸÑÿ£ŸÜÿπÿßŸÖ", "ÿßŸÑÿ£ÿπÿ±ÿßŸÅ", "ÿßŸÑÿ£ŸÜŸÅÿßŸÑ", "ÿßŸÑÿ™Ÿàÿ®ÿ©", "ŸäŸàŸÜÿ≥", "ŸáŸàÿØ", "ŸäŸàÿ≥ŸÅ", "ÿßŸÑÿ±ÿπÿØ", "ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ", "ÿßŸÑÿ≠ÿ¨ÿ±", "ÿßŸÑŸÜÿ≠ŸÑ", "ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°", "ÿßŸÑŸÉŸáŸÅ", "ŸÖÿ±ŸäŸÖ", "ÿ∑Ÿá", "ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°", "ÿßŸÑÿ≠ÿ¨", "ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ", "ÿßŸÑŸÜŸàÿ±", "ÿßŸÑŸÅÿ±ŸÇÿßŸÜ", "ÿßŸÑÿ¥ÿπÿ±ÿßÿ°", "ÿßŸÑŸÜŸÖŸÑ", "ÿßŸÑŸÇÿµÿµ", "ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™", "ÿßŸÑÿ±ŸàŸÖ", "ŸÑŸÇŸÖÿßŸÜ", "ÿßŸÑÿ≥ÿ¨ÿØÿ©", "ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®", "ÿ≥ÿ®ÿ£", "ŸÅÿßÿ∑ÿ±", "Ÿäÿ≥", "ÿßŸÑÿµÿßŸÅÿßÿ™", "ÿµ", "ÿßŸÑÿ≤ŸÖÿ±", "ÿ∫ÿßŸÅÿ±", "ŸÅÿµŸÑÿ™", "ÿßŸÑÿ¥Ÿàÿ±Ÿâ", "ÿßŸÑÿ≤ÿÆÿ±ŸÅ", "ÿßŸÑÿØÿÆÿßŸÜ", "ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©", "ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ", "ŸÖÿ≠ŸÖÿØ", "ÿßŸÑŸÅÿ™ÿ≠", "ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™", "ŸÇ", "ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™", "ÿßŸÑÿ∑Ÿàÿ±", "ÿßŸÑŸÜÿ¨ŸÖ", "ÿßŸÑŸÇŸÖÿ±", "ÿßŸÑÿ±ÿ≠ŸÖŸÜ", "ÿßŸÑŸàÿßŸÇÿπÿ©", "ÿßŸÑÿ≠ÿØŸäÿØ", "ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©", "ÿßŸÑÿ≠ÿ¥ÿ±", "ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©", "ÿßŸÑÿµŸÅ", "ÿßŸÑÿ¨ŸÖÿπÿ©", "ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ", "ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ", "ÿßŸÑÿ∑ŸÑÿßŸÇ", "ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ", "ÿßŸÑŸÖŸÑŸÉ", "ÿßŸÑŸÇŸÑŸÖ", "ÿßŸÑÿ≠ÿßŸÇÿ©", "ÿßŸÑŸÖÿπÿßÿ±ÿ¨", "ŸÜŸàÿ≠", "ÿßŸÑÿ¨ŸÜ", "ÿßŸÑŸÖÿ≤ŸÖŸÑ", "ÿßŸÑŸÖÿØÿ´ÿ±", "ÿßŸÑŸÇŸäÿßŸÖÿ©", "ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ", "ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™", "ÿßŸÑŸÜÿ®ÿ£", "ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™", "ÿπÿ®ÿ≥", "ÿßŸÑÿ™ŸÉŸàŸäÿ±", "ÿßŸÑÿ•ŸÜŸÅÿ∑ÿßÿ±", "ÿßŸÑŸÖÿ∑ŸÅŸÅŸäŸÜ", "ÿßŸÑÿ•ŸÜÿ¥ŸÇÿßŸÇ", "ÿßŸÑÿ®ÿ±Ÿàÿ¨", "ÿßŸÑÿ∑ÿßÿ±ŸÇ", "ÿßŸÑÿ£ÿπŸÑŸâ", "ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©", "ÿßŸÑŸÅÿ¨ÿ±", "ÿßŸÑÿ®ŸÑÿØ", "ÿßŸÑÿ¥ŸÖÿ≥", "ÿßŸÑŸÑŸäŸÑ", "ÿßŸÑÿ∂ÿ≠Ÿâ", "ÿßŸÑÿ¥ÿ±ÿ≠", "ÿßŸÑÿ™ŸäŸÜ", "ÿßŸÑÿπŸÑŸÇ", "ÿßŸÑŸÇÿØÿ±", "ÿßŸÑÿ®ŸäŸÜÿ©", "ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©", "ÿßŸÑÿπÿßÿØŸäÿßÿ™", "ÿßŸÑŸÇÿßÿ±ÿπÿ©", "ÿßŸÑÿ™ŸÉÿßÿ´ÿ±", "ÿßŸÑÿπÿµÿ±", "ÿßŸÑŸáŸÖÿ≤ÿ©", "ÿßŸÑŸÅŸäŸÑ", "ŸÇÿ±Ÿäÿ¥", "ÿßŸÑŸÖÿßÿπŸàŸÜ", "ÿßŸÑŸÉŸàÿ´ÿ±", "ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ", "ÿßŸÑŸÜÿµÿ±", "ÿßŸÑŸÖÿ≥ÿØ", "ÿßŸÑÿ•ÿÆŸÑÿßÿµ", "ÿßŸÑŸÅŸÑŸÇ", "ÿßŸÑŸÜÿßÿ≥"];
        
        let classesData = [];
        let currentClassIdx = -1, currentStudentIdx = -1;
        let currentUserType = 'teacher';
        let currentStudentObj = null;
        let currentSessionType = '';
        let examState = {}, finalExamState = {};
        let currentMistakes = [];
        let isViewMode = false;
        let editingRecordIndex = -1;
        let currentRecPage = 1;

        // LOAD DATA
        const dbRef = ref(db, 'hifz_system_v1');
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            classesData = data || [];
            if(document.getElementById('management-page').classList.contains('hidden') === false) window.renderManageClassList();
        });

        function updateFirebase() { set(ref(db, 'hifz_system_v1'), classesData); }

        // --- GLOBAL FUNCTIONS ---
        window.switchLogin = (type) => {
            document.getElementById('teacher-login-form').classList.toggle('hidden', type !== 'teacher');
            document.getElementById('student-login-form').classList.toggle('hidden', type !== 'student');
            document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', (type==='teacher' && i===0) || (type==='student' && i===1)));
        };
        window.loginTeacher = () => {
            if(document.getElementById('teacherPassInput').value === '1234') {
                currentUserType = 'teacher';
                document.body.classList.remove('student-mode');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                window.openPage('teacher-dashboard');
            } else alert('Password Error');
        };
        window.handleStudentLoginStep = () => {
            const id = document.getElementById('stuIdInput').value.trim();
            if(!id) return alert("ID Required");
            let found = null, cIdx = -1, sIdx = -1;
            if(classesData) classesData.forEach((c, ci) => { if(c.students) c.students.forEach((s, si) => { if(s.id === id) { found=s; cIdx=ci; sIdx=si; } }); });
            if(!found) return alert("Not Found");
            currentClassIdx = cIdx; currentStudentIdx = sIdx; currentStudentObj = found;
            if(!found.password) document.getElementById('createPassModal').style.display = 'flex';
            else {
                const passField = document.getElementById('stuPassField');
                if(passField.classList.contains('hidden')) passField.classList.remove('hidden');
                else {
                    if(document.getElementById('stuPassInput').value === found.password) window.loginSuccessStudent();
                    else alert("Wrong Password");
                }
            }
        };
        window.saveNewPassword = () => {
            const pass = document.getElementById('newStuPass').value;
            if(pass) { classesData[currentClassIdx].students[currentStudentIdx].password = pass; updateFirebase(); document.getElementById('createPassModal').style.display='none'; window.loginSuccessStudent(); }
        };
        window.loginSuccessStudent = () => {
            currentUserType = 'student';
            document.body.classList.add('student-mode');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('studentDashName').innerText = currentStudentObj.name;
            window.renderHistory(currentStudentObj, 'studentDashHistory', null);
            window.openPage('student-dashboard');
        };
        window.logout = () => location.reload();
        window.openPage = (id) => {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            ['juz-exam-page', 'final-exam-page', 'recorder-page'].forEach(p => document.getElementById(p).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'management-page') window.renderManageClassList();
        };
        window.goBackFromCategory = () => { if(currentUserType === 'student') window.openPage('student-dashboard'); else window.openPage('grading-menu-page'); };

        // --- MGMT ---
        window.createClass = () => {
            let name = document.getElementById('newClassName').value;
            if(name) { classesData.push({name:name, students:[]}); updateFirebase(); window.renderManageClassList(); }
        };
        window.renderManageClassList = () => {
            const div = document.getElementById('manageClassList'); div.innerHTML='';
            if(classesData) classesData.forEach((c, i) => div.innerHTML += `<div class="list-item" onclick="window.openClass(${i})"><strong>${c.name}</strong><small>${c.teacher||''}</small></div>`);
        };
        window.openClass = (i) => { currentClassIdx = i; window.renderStudentList(); window.openPage('class-details-page'); };
        window.renderStudentList = () => {
            const div = document.getElementById('studentManageList'); div.innerHTML='';
            const students = classesData[currentClassIdx].students || [];
            if(students.length === 0) div.innerHTML = "<p style='text-align:center; color:#999'>No students yet.</p>";
            
            students.forEach(s => {
                let pass = s.password ? `(Pass: ${s.password})` : '(No Pass)';
                div.innerHTML += `
                    <div class="list-item">
                        <div><strong>${s.name}</strong> <small>(${s.id})</small></div>
                        <small style="color:${s.password?'green':'red'}">${pass}</small>
                    </div>`;
            });
        };
        window.openAddStudentModal = () => { 
            ['m_module','m_id','m_name','m_juz_count','m_remarks'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('addStudentModal').style.display='flex'; 
        }
        
        window.confirmAddStudent = () => {
            const name = document.getElementById('m_name').value;
            const id = document.getElementById('m_id').value;
            if(!name || !id) return alert("Name & ID Required");

            if(!classesData[currentClassIdx].students) classesData[currentClassIdx].students = [];
            
            classesData[currentClassIdx].students.push({
                name: name,
                id: id,
                module: document.getElementById('m_module').value,
                level: document.getElementById('m_level').value,
                direction: document.getElementById('m_direction').value,
                juzCount: document.getElementById('m_juz_count').value,
                remarks: document.getElementById('m_remarks').value,
                history: [], juzExams: {}
            });
            updateFirebase(); 
            document.getElementById('addStudentModal').style.display='none'; 
            window.renderStudentList();
        }
        window.downloadTemplate = () => {}; window.handleExcelUpload = () => {};

        // --- GRADING ---
        window.openGradingClassList = () => {
            const div = document.getElementById('gradingClassList'); div.innerHTML='';
            if(classesData) classesData.forEach((c, i) => div.innerHTML += `<div class="list-item" onclick="window.openGradingStudentList(${i})"><strong>${c.name}</strong></div>`);
            window.openPage('grading-class-page');
        };
        window.openGradingStudentList = (i) => {
            currentClassIdx = i;
            const div = document.getElementById('gradingStudentList'); div.innerHTML='';
            const students = classesData[i].students || [];
            students.forEach((s, idx) => div.innerHTML += `<div class="list-item" onclick="window.openStudentMenu(${idx})">${s.name}</div>`);
            window.openPage('grading-student-page');
        };
        window.openStudentMenu = (i) => {
            currentStudentIdx = i;
            document.getElementById('gradingStudentName').innerText = classesData[currentClassIdx].students[i].name;
            window.openPage('grading-menu-page');
        };
        window.openCategoryPage = (type) => {
            currentSessionType = type;
            let title = type === 'juz_exam' ? "ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞" : (type === 'new_lesson' ? "ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™" : (type==='final_exam'?"ﬁäﬁ¶ﬁÄﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞":"ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß"));
            document.getElementById('catPageTitle').innerText = title;
            const s = currentUserType==='student'?currentStudentObj:classesData[currentClassIdx].students[currentStudentIdx];
            window.renderHistory(s, 'categoryHistoryList', type);
            document.getElementById('addRecordBtn').style.display = (currentUserType==='student')?'none':'block';
            window.openPage('category-page');
        };
        window.handleAddButtonClick = () => {
            if(currentSessionType==='juz_exam') window.openJuzExamSetup();
            else if(currentSessionType==='final_exam') window.openFinalExam();
            else window.openRecorder(currentSessionType);
        };

        window.renderHistory = (student, listId, filterType) => {
            const list = document.getElementById(listId); list.innerHTML = '';
            if(!student.history) student.history = [];
            const records = filterType ? student.history.filter(r => r.type === filterType) : student.history;
            if(!records.length) list.innerHTML = '<p style="text-align:center;color:#999;">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</p>';
            
            records.slice().reverse().forEach(rec => {
                const realIndex = student.history.indexOf(rec);
                let html = '';
                let deleteBtn = currentUserType === 'teacher' ? `<button class="btn-delete-hist" onclick="event.stopPropagation(); window.deleteHistoryRecord(${realIndex})">üóë</button>` : '';

                if(rec.type === 'juz_exam') {
                    let status = rec.status === 'partial' ? '<span class="hist-badge bg-pending">ﬁäﬁ¶ﬁÄﬁ™ﬁÑﬁ¶ﬁáﬁ® ﬁÇﬁ™ﬁÇﬁ®ﬁâﬁ≠</span>' : '<span class="hist-badge bg-complete">ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶</span>';
                    html = `
                        <div class="hist-card type-juz_exam" onclick='window.viewJuzRecord(${JSON.stringify(rec)})'>
                            <div class="hist-header"><span class="hist-title">Juz ${rec.juz} Exam</span>${status}</div>
                            <div class="hist-body">
                                <div class="hist-grid">
                                    <div class="hist-item"><span class="hist-label">ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</span><span class="hist-val">${rec.date}</span></div>
                                    <div class="hist-item"><span class="hist-label">ﬁàﬁ¶ﬁéﬁ™ﬁåﬁ™</span><span class="hist-val">${rec.duration}</span></div>
                                    <div class="hist-item"><span class="hist-label">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ ﬁÜﬁ™ﬁÅﬁ∞</span><span class="hist-val" style="color:red">${rec.details.teacherMistakes}</span></div>
                                    <div class="hist-item"><span class="hist-label">ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ ﬁÜﬁ™ﬁÅﬁ∞</span><span class="hist-val">${rec.details.selfMistakes}</span></div>
                                    <div class="hist-item"><span class="hist-label">ﬁåﬁ¶ﬁñﬁ™ﬁàﬁ©ﬁãﬁ™</span><span class="hist-val">${rec.details.tajweed}</span></div>
                                    <div class="hist-item"><span class="hist-label">ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞</span><span class="hist-val">${rec.details.fluency}</span></div>
                                    <div class="hist-item"><span class="hist-label">ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞</span><span class="hist-val">${rec.details.mutashabihMarks}</span></div>
                                </div>
                            </div>
                            <div class="hist-footer exam-score">${rec.score}%</div>
                            ${deleteBtn}
                        </div>`;
                } else if(rec.type === 'final_exam') {
                    html = `<div class="hist-card type-final_exam"><div class="hist-header"><span class="hist-title">Final Exam</span></div><div class="hist-footer">${rec.score}%</div>${deleteBtn}</div>`;
                } else {
                    const sInfo = rec.startDetails ? `${rec.startDetails.surah}:${rec.startDetails.ayah}` : '-';
                    const eInfo = rec.endDetails ? `${rec.endDetails.surah}:${rec.endDetails.ayah}` : '-';
                    html = `
                        <div class="hist-card type-${rec.type}" onclick='window.viewLessonRecord(${JSON.stringify(rec)})'>
                            <div class="hist-header"><span class="hist-title">Page ${rec.page}</span><span class="hist-date">${rec.date}</span></div>
                            <div class="hist-body">
                                <div class="hist-grid">
                                    <div class="hist-box"><span class="hist-label">ﬁäﬁ¨ﬁÅﬁ™ﬁÇﬁ©</span><span class="hist-val">${sInfo}</span></div>
                                    <div class="hist-box"><span class="hist-label">ﬁÇﬁ®ﬁâﬁ™ﬁÇﬁ©</span><span class="hist-val">${eInfo} (ﬁû ${rec.endPage})</span></div>
                                </div>
                            </div>
                            <div class="hist-footer" style="color:var(--mistake);">ﬁÜﬁ™ﬁÅﬁ∞: ${rec.mistakesCount}</div>
                            ${deleteBtn}
                        </div>`;
                }
                list.innerHTML += html;
            });
        };

        window.deleteHistoryRecord = (index) => {
            if(confirm("ﬁâﬁ® ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁàﬁ≠ﬁåﬁ¶ÿü")) {
                const s = classesData[currentClassIdx].students[currentStudentIdx];
                s.history.splice(index, 1);
                updateFirebase();
                window.renderHistory(s, 'categoryHistoryList', currentSessionType);
            }
        }

        // RECORDER
        window.openRecorder = (type) => {
            currentSessionType = type; isViewMode = false; currentMistakes = [];
            document.getElementById('recorderTitle').innerText = "ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞";
            document.getElementById('recSaveBtn').style.display = 'block';
            document.getElementById('viewModeBadge').style.display = 'none';
            document.getElementById('startPage').value = '';
            document.getElementById('endPage').value = '';
            document.getElementById('mistakeCountDisplay').innerText = 0;
            document.getElementById('mushafContent').innerHTML = '<p style="color:#999; margin-top:100px;">...</p>';
            
            // Auto fill: Get last page + 1
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            if(s.history) {
                const recs = s.history.filter(r => r.type === type);
                if(recs.length > 0) {
                    const last = recs[recs.length-1];
                    const nextP = parseInt(last.endPage || last.page) + 1;
                    if(nextP <= 604) {
                        document.getElementById('startPage').value = nextP;
                        window.loadSmartPage();
                    }
                }
            }
            document.getElementById('recorder-page').classList.remove('hidden');
        };
        window.closeRecorder = () => {
            document.getElementById('recorder-page').classList.add('hidden');
            if(currentUserType === 'student') window.renderHistory(currentStudentObj, 'studentDashHistory', null);
            else if(currentStudentIdx !== -1) window.renderHistory(classesData[currentClassIdx].students[currentStudentIdx], 'categoryHistoryList', currentSessionType);
        };
        window.loadSmartPage = async (applyHighlights=false) => {
            const page = document.getElementById('startPage').value;
            if(!page) return;
            const res = await fetch(`https://api.alquran.cloud/v1/page/${page}/quran-uthmani`);
            const data = await res.json();
            window.renderMushafText(data.data.ayahs, 'mushafContent', currentMistakes, false);
            if(!isViewMode && data.data.ayahs.length > 0) {
                const first = data.data.ayahs[0]; const last = data.data.ayahs[data.data.ayahs.length-1];
                document.getElementById('endPage').value = page;
                
                populateSurahSelects(); // Ensure list is ready
                document.getElementById('startSurah').value = first.surah.number;
                document.getElementById('endSurah').value = last.surah.number;
                window.updateAyahSelect('startAyah', first.numberInSurah); 
                window.updateAyahSelect('endAyah', last.numberInSurah);
            }
        };
        window.renderMushafText = (ayahs, target, highlights, isExam) => {
            let html = '';
            // Update Header
            const f = ayahs[0];
            const headerTarget = isExam ? 'mushafTopBar' : 'recMushafTopBar';
            const juzTarget = isExam ? 'mushafJuzInfo' : 'recMushafJuz';
            const surahTarget = isExam ? 'mushafSurahInfo' : 'recMushafSurah';
            
            if(document.getElementById(juzTarget)) document.getElementById(juzTarget).innerText = `Juz ${f.juz}`;
            if(document.getElementById(surahTarget)) document.getElementById(surahTarget).innerText = `ÿ≥Ÿàÿ±ÿ© ${f.surah.name}`;

            ayahs.forEach(a => {
                const words = a.text.split(' ');
                words.forEach((w, i) => {
                    const id = `p${a.page}_s${a.surah.number}_a${a.numberInSurah}_w${i}`;
                    let cls = highlights.includes(id) ? 'word mistake' : 'word';
                    let fn = isExam ? `window.clickExamWord('${id}')` : `window.clickRecWord('${id}')`;
                    html += `<span id="${id}" class="${cls}" onclick="${fn}">${w}</span> `;
                });
                html += `<span class="ayah-marker">(${a.numberInSurah})</span> `;
            });
            document.getElementById(target).innerHTML = html;
        };
        window.clickRecWord = (id) => {
            if(isViewMode) return;
            const el = document.getElementById(id);
            if(el.classList.contains('mistake')) { el.classList.remove('mistake'); currentMistakes = currentMistakes.filter(x=>x!==id); }
            else { el.classList.add('mistake'); currentMistakes.push(id); }
            document.getElementById('mistakeCountDisplay').innerText = currentMistakes.length;
        };
        window.saveRecord = () => {
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            if(!s.history) s.history = [];
            
            const ssIdx = document.getElementById('startSurah').selectedIndex;
            const esIdx = document.getElementById('endSurah').selectedIndex;
            
            const startObj = { surah: SURAH_NAMES_AR[ssIdx], ayah: document.getElementById('startAyah').value };
            const endObj = { surah: SURAH_NAMES_AR[esIdx], ayah: document.getElementById('endAyah').value };

            s.history.push({
                type: currentSessionType, date: document.getElementById('recDate').value,
                page: document.getElementById('startPage').value, endPage: document.getElementById('endPage').value,
                startDetails: startObj, endDetails: endObj,
                mistakesCount: currentMistakes.length, mistakeDetails: currentMistakes
            });
            updateFirebase(); window.closeRecorder();
        };
        window.viewLessonRecord = (rec) => {
            isViewMode = true; currentMistakes = rec.mistakeDetails || [];
            document.getElementById('recorderTitle').innerText = "View Record";
            document.getElementById('recSaveBtn').style.display = 'none';
            document.getElementById('viewModeBadge').style.display = 'block';
            document.getElementById('recDate').value = rec.date;
            document.getElementById('startPage').value = rec.page;
            document.getElementById('endPage').value = rec.endPage;
            document.getElementById('mistakeCountDisplay').innerText = rec.mistakesCount;
            document.getElementById('recorder-page').classList.remove('hidden');
            window.loadSmartPage(true);
        };
        window.viewJuzRecord = (rec) => {
            // View Exam in Exam UI (Read Only)
            document.getElementById('juzExamTitle').innerText = "View Exam";
            document.getElementById('juz-exam-page').classList.remove('hidden');
            document.getElementById('liveScore').innerText = rec.score + "%";
            document.getElementById('saveExamBtn').style.display = 'none';
            
            // Populate Readonly fields
            document.getElementById('stopwatchDisplay').innerText = rec.duration || "00:00:00";
            document.getElementById('countTeacher').innerText = rec.details.teacherMistakes;
            document.getElementById('countSelf').innerText = rec.details.selfMistakes;
            document.getElementById('scoreTajweed').value = rec.details.tajweed;
            document.getElementById('scoreFluency').value = rec.details.fluency;
            
            isViewMode = true;
            examState.mistakesList = rec.mistakeDetails || [];
            let startP = ((rec.juz-1)*20)+2; 
            window.loadExamPage(startP);
        };

        // JUZ EXAM
        window.openJuzExamSetup = () => { 
            const juzSel = document.getElementById('examJuzSelect'); juzSel.innerHTML = '';
            for(let i=1; i<=30; i++) juzSel.add(new Option(`ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ${i}`, i));
            document.getElementById('juzSetupModal').style.display='flex'; 
        };
        window.startJuzExam = () => {
            const juz = parseInt(document.getElementById('examJuzSelect').value);
            const mode = document.querySelector('input[name="examPart"]:checked').value;
            let startPage = ((juz-1)*20)+2; if(mode === 'part2') startPage += 10;
            
            examState = { juz: juz, mode: mode, mistakesTeacher: 0, mistakesSelf: 0, currentPage: startPage, mistakesList: [], isMutashabih: false, timer: null, seconds: 0 };
            document.getElementById('juzSetupModal').style.display='none';
            document.getElementById('juzExamTitle').innerText = `ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ${juz}`;
            document.getElementById('partBadge').innerText = mode==='full'?'Full':(mode==='part1'?'Part 1':'Part 2');
            document.getElementById('liveScore').innerText = "100%";
            document.getElementById('countTeacher').innerText = "0"; document.getElementById('countSelf').innerText = "0";
            document.getElementById('mutashabihSection').style.display = (mode==='part1')?'none':'block';
            document.getElementById('saveExamBtn').style.display = 'block';
            isViewMode = false;
            
            window.loadExamPage(startPage);
            document.getElementById('juz-exam-page').classList.remove('hidden');
        };
        window.closeJuzExam = () => { window.stopTimer(); document.getElementById('juz-exam-page').classList.add('hidden'); };
        window.loadExamPage = async (page) => {
            document.getElementById('currentPageDisplay').innerText = `Page ${page}`;
            const res = await fetch(`https://api.alquran.cloud/v1/page/${page}/quran-uthmani`);
            const data = await res.json();
            const first = data.data.ayahs[0];
            document.getElementById('mushafJuzInfo').innerText = `Juz ${first.juz}`; document.getElementById('mushafSurahInfo').innerText = `ÿ≥Ÿàÿ±ÿ© ${first.surah.name}`;
            window.renderMushafText(data.data.ayahs, 'examMushafContent', examState.mistakesList, true);
        };
        window.changeExamPage = (dir) => {
            let newPage = examState.currentPage + dir;
            if(newPage < 1 || newPage > 604) return;
            examState.currentPage = newPage; window.loadExamPage(newPage);
        };
        window.clickExamWord = (id) => {
            if(isViewMode) return;
            const el = document.getElementById(id);
            if(el.classList.contains('mistake')) {
                el.classList.remove('mistake'); examState.mistakesList = examState.mistakesList.filter(x=>x!==id);
                if(!examState.isMutashabih) window.updateScore('teacher', -1);
            } else {
                el.classList.add('mistake'); examState.mistakesList.push(id);
                if(!examState.isMutashabih) window.updateScore('teacher', 1);
            }
        };
        window.updateScore = (type, delta) => {
            if(type==='teacher') examState.mistakesTeacher = Math.max(0, examState.mistakesTeacher+delta);
            else examState.mistakesSelf = Math.max(0, examState.mistakesSelf+delta);
            document.getElementById('countTeacher').innerText = examState.mistakesTeacher;
            document.getElementById('countSelf').innerText = examState.mistakesSelf;
            window.calcScore();
        };
        window.calcScore = () => {
            let deduct = (examState.mistakesTeacher*2) + (examState.mistakesSelf*1) + (10 - document.getElementById('scoreTajweed').value) + (5 - document.getElementById('scoreFluency').value);
            if(examState.mode !== 'part1') deduct += (2.5 - document.getElementById('q1_score').value) + (2.5 - document.getElementById('q2_score').value);
            let final = Math.max(0, 100 - deduct);
            document.getElementById('liveScore').innerText = final + "%";
            return final;
        };
        window.setTimerMode = (mode) => {
            document.getElementById('stopwatchMode').classList.toggle('hidden', mode !== 'stopwatch');
            document.getElementById('manualMode').classList.toggle('hidden', mode !== 'manual');
        };
        window.startTimer = () => {
            if(examState.timer) return;
            examState.timer = setInterval(() => { examState.seconds++; let d = new Date(0); d.setSeconds(examState.seconds); document.getElementById('stopwatchDisplay').innerText = d.toISOString().substr(11,8); }, 1000);
        };
        window.stopTimer = () => { clearInterval(examState.timer); examState.timer = null; };
        window.generateQuestions = () => {
            examState.isMutashabih = true;
            const list = document.getElementById('questionList'); list.innerHTML = '';
            let base = ((examState.juz-1)*20)+2; if(examState.mode === 'part2') base+=10;
            for(let i=0; i<3; i++) {
                let p = base + Math.floor(Math.random()*10);
                list.innerHTML += `<button style="display:block;width:100%;margin-bottom:5px;padding:5px;" onclick="window.loadExamPage(${p})">Q${i+1} - Page ${p}</button>`;
            }
        };
        window.saveJuzExamPart = () => {
            const score = window.calcScore();
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            let duration = document.getElementById('stopwatchDisplay').innerText;
            if(!s.juzExams) s.juzExams={}; if(!s.juzExams[examState.juz]) s.juzExams[examState.juz]={};
            
            // Collect Details
            let details = {
                teacherMistakes: examState.mistakesTeacher,
                selfMistakes: examState.mistakesSelf,
                tajweed: document.getElementById('scoreTajweed').value,
                fluency: document.getElementById('scoreFluency').value,
                mutashabihMarks: (examState.mode!=='part1') ? (parseFloat(document.getElementById('q1_score').value) + parseFloat(document.getElementById('q2_score').value)) : 0
            };

            if(examState.mode === 'part1') {
                s.juzExams[examState.juz].part1 = score;
                s.history.push({
                    type:'juz_exam', status:'partial', date:new Date().toLocaleDateString(), 
                    juz:examState.juz, score:score, duration:duration, 
                    details: details, mistakeDetails: examState.mistakesList
                });
            } else {
                let p1 = s.juzExams[examState.juz].part1 || 0;
                let final = (examState.mode === 'full') ? score : (p1 + score) / 2;
                s.history.push({
                    type:'juz_exam', status:'completed', date:new Date().toLocaleDateString(), 
                    juz:examState.juz, score:final, duration:duration, 
                    details: details, mistakeDetails: examState.mistakesList
                });
            }
            updateFirebase(); window.closeJuzExam(); window.openStudentMenu(currentStudentIdx);
        };

        // FINAL EXAM
        window.openFinalExam = () => {
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            finalExamState = { currentQ: 1, maxQ: (s.level >= 3 ? 3 : 2), totalMistakesT: 0, totalMistakesS: 0 };
            document.getElementById('finalExamScore').innerText = "100%";
            document.getElementById('questionIndicator').innerText = `ﬁêﬁ™ﬁàﬁßﬁçﬁ™ 1 / ${finalExamState.maxQ}`;
            document.getElementById('finalTeacherCount').innerText = 0; document.getElementById('finalSelfCount').innerText = 0;
            
            const finalJuzSel = document.getElementById('finalJuzSelect'); finalJuzSel.innerHTML = '';
            for(let i=1; i<=30; i++) finalJuzSel.add(new Option(`ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ${i}`, i));
            
            document.getElementById('final-exam-page').classList.remove('hidden');
        };
        window.closeFinalExam = () => { document.getElementById('final-exam-page').classList.add('hidden'); };
        window.loadFinalQuestion = async () => {
            const juz = document.getElementById('finalJuzSelect').value;
            const startP = ((juz-1)*20)+2; const randomP = startP + Math.floor(Math.random()*18);
            const res = await fetch(`https://api.alquran.cloud/v1/page/${randomP}/quran-uthmani`);
            const data = await res.json();
            window.renderMushafText(data.data.ayahs, 'finalMushafContent', [], true);
        };
        window.updateFinalScore = (type, delta) => {
            if(type==='teacher') finalExamState.totalMistakesT = Math.max(0, finalExamState.totalMistakesT+delta);
            else finalExamState.totalMistakesS = Math.max(0, finalExamState.totalMistakesS+delta);
            document.getElementById('finalTeacherCount').innerText = finalExamState.totalMistakesT;
            document.getElementById('finalSelfCount').innerText = finalExamState.totalMistakesS;
            window.calcFinalScore();
        };
        window.calcFinalScore = () => {
            let deduct = (finalExamState.totalMistakesT*5) + (finalExamState.totalMistakesS*2);
            let score = Math.max(0, 100 - deduct);
            document.getElementById('finalExamScore').innerText = score + "%";
            return score;
        };
        window.nextFinalQuestion = () => {
            if(finalExamState.currentQ < finalExamState.maxQ) {
                finalExamState.currentQ++;
                document.getElementById('questionIndicator').innerText = `ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ${finalExamState.currentQ} / ${finalExamState.maxQ}`;
                if(finalExamState.currentQ === finalExamState.maxQ) {
                    document.getElementById('nextQBtn').classList.add('hidden');
                    document.getElementById('finishExamBtn').classList.remove('hidden');
                }
            }
        };
        window.saveFinalExam = () => {
            const score = window.calcFinalScore();
            const s = classesData[currentClassIdx].students[currentStudentIdx];
            s.history.push({type:'final_exam', date:new Date().toLocaleDateString(), score:score, mistakesCount:(finalExamState.totalMistakesT+finalExamState.totalMistakesS)});
            updateFirebase(); window.closeFinalExam(); window.openStudentMenu(currentStudentIdx);
        };

        // HELPERS
        function populateSurahSelects() {
            const s1 = document.getElementById('startSurah'), s2 = document.getElementById('endSurah');
            if(s1 && s2) { s1.innerHTML=''; s2.innerHTML=''; SURAH_NAMES_AR.forEach((n,i) => { s1.add(new Option(n, i+1)); s2.add(new Option(n, i+1)); }); }
        }
        window.updateAyahSelect = (id, val) => { document.getElementById(id).innerHTML = `<option value="${val}">${val}</option>`; }
    </script>
</body>
</html>
