<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ﬁ§ﬁ™ﬁÉﬁ∞ﬁáﬁßﬁÇﬁ∞ ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ - V9.2 (Fixed Layout)</title>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* FONTS */
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');
        @font-face { font-family: 'Faruma'; src: local('Faruma'), local('Faruma-Regular'); }
        @font-face { font-family: 'Mv Waheed'; src: local('Mv Waheed'), local('Mv Waheed-Regular'); }
        
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #27ae60;
            --highlight: #f39c12;
            --bg: #f4f6f8;
            --sidebar-w: 280px;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Faruma', 'Noto Sans Thaana', sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            color: #333;
        }

        h1, h2, h3 { font-family: 'Mv Waheed', 'Faruma', sans-serif; margin: 0 0 10px 0; }
        button { font-family: inherit; cursor: pointer; }

        /* --- LAYOUT UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .gap-10 { gap: 10px; }
        .w-full { width: 100%; }

        /* --- FULL SCREEN OVERLAYS --- */
        #loading-overlay, #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }
        #loading-overlay { background: white; }
        #login-screen { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }

        /* --- LOGIN BOX --- */
        .login-box {
            background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 380px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; color: #333;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd;
            border-radius: 8px; font-size: 16px; text-align: center;
        }
        .btn-big {
            width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 8px;
            font-size: 16px; font-weight: bold; transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }

        /* --- MAIN DASHBOARD LAYOUT --- */
        .app-container { display: flex; height: 100vh; width: 100%; overflow: hidden; }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-w); background: white; border-left: 1px solid #ddd;
            display: flex; flex-direction: column; flex-shrink: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 100;
        }
        .sidebar-header { padding: 20px; background: var(--primary); color: white; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* STUDENT CARD IN SIDEBAR */
        .student-card {
            background: white; border: 1px solid #eee; padding: 10px; border-radius: 8px;
            margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;
            transition: 0.2s;
        }
        .student-card:hover { background: #eafaf1; border-color: var(--accent); }
        .student-card.active { background: var(--accent); color: white; border-color: var(--accent); }
        .student-card.active .id-badge { background: white; color: var(--accent); }
        
        .st-avatar { 
            width: 35px; height: 35px; background: #eee; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555;
        }
        .id-badge {
            font-size: 10px; background: #eee; color: #555; padding: 2px 6px; 
            border-radius: 4px; font-family: sans-serif;
        }

        /* MAIN CONTENT AREA */
        .content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-bar {
            padding: 15px; background: white; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .scrollable-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* MUSHAF PANEL */
        .mushaf-panel {
            width: 0; background: #34495e; overflow: hidden;
            transition: width 0.3s ease; display: flex; flex-direction: column;
            border-right: 1px solid #ccc;
        }
        .mushaf-panel.open { width: 35%; }
        .mushaf-img { max-width: 100%; display: block; }
        .mistake-dot {
            position: absolute; width: 24px; height: 24px; background: rgba(231, 76, 60, 0.8);
            border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);
            cursor: pointer; z-index: 10;
        }

        /* FORMS */
        .entry-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-group { flex: 1; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; font-size: 14px; }
        .section-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .sec-btn { 
            flex: 1; padding: 10px; border: 2px solid transparent; border-radius: 8px; 
            cursor: pointer; text-align: center; font-weight: bold; background: #f8f9fa;
        }
        .sec-btn.active { background: white; border-color: var(--accent); color: var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* TABLE */
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th, .data-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: right; }
        .data-table th { background: #f8f9fa; color: #555; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; right: 0; height: 100%; transform: translateX(100%); width: 280px; }
            .sidebar.open { transform: translateX(0); }
            .mushaf-panel.open { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; }
            .mobile-menu-btn { display: block !important; font-size: 24px; cursor: pointer; }
            .desktop-only { display: none; }
            .form-row { flex-direction: column; gap: 5px; }
        }
        .mobile-menu-btn { display: none; }

        /* UTILS */
        .btn { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; font-family: inherit;}
        .btn-sm { font-size: 12px; padding: 4px 8px; }
        .bg-green { background: var(--accent); }
        .bg-blue { background: #3498db; }
        .bg-red { background: #e74c3c; }
        .bg-grey { background: #95a5a6; }

        /* MODAL */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 500px; max-width: 95%; max-height: 90vh; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay">
        <h3>...ﬁëﬁ≠ﬁìﬁßﬁÑﬁ≠ﬁêﬁ∞ ﬁáﬁ¶ﬁÅﬁ∞ ﬁéﬁ™ﬁÖﬁ¶ﬁÇﬁ©</h3>
        <div style="margin-top:10px; width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite;"></div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden">
        <div class="login-box">
            <h2>ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ V9.2</h2>
            <div id="role-select">
                <button class="btn-big btn-accent" onclick="toggleLoginView('student')">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</button>
                <button class="btn-big btn-primary" onclick="toggleLoginView('teacher')">üë®‚Äçüè´ ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
            </div>
            
            <div id="login-form" class="hidden">
                <h3 id="login-title">Login</h3>
                <input type="text" id="login-id" class="login-input" placeholder="ID / Username">
                <input type="password" id="login-pass" class="login-input" placeholder="Password">
                <button class="btn-big btn-green" onclick="processLogin()">ﬁàﬁ¶ﬁÇﬁ∞ﬁÇﬁ¶ﬁàﬁß</button>
                <button class="btn-big btn-grey" onclick="toggleLoginView('back')">ﬁäﬁ¶ﬁÄﬁ¶ﬁåﬁ¶ﬁÅﬁ∞</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="app-container hidden">
        
        <!-- SIDEBAR (Teacher & Student Shared Structure) -->
        <aside class="sidebar" id="mainSidebar">
            <div class="sidebar-header">
                <div class="flex" style="justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; color:white;" id="sidebarTitle">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</h3>
                    <span onclick="toggleSidebar()" style="cursor:pointer; font-size:24px;">&times;</span>
                </div>
            </div>
            
            <!-- Filter Controls (Teacher Only) -->
            <div id="teacher-controls" style="padding:10px; background:#f8f9fa; border-bottom:1px solid #ddd;">
                <select id="classSelect" onchange="loadStudents(this.value)" style="width:100%; margin-bottom:5px;"></select>
                <div class="flex gap-10">
                    <button class="btn bg-blue w-full btn-sm" onclick="openModal('settings')">‚öôÔ∏è ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞</button>
                    <button class="btn bg-grey w-full btn-sm" onclick="logout()">üö™ Logout</button>
                </div>
            </div>

            <!-- Student Info (Student Only) -->
            <div id="student-controls" class="hidden" style="padding:10px; text-align:center; background:#f8f9fa;">
                <h4 id="stNameDisplay" style="margin:0; color:var(--primary);">Name</h4>
                <span id="stIdDisplay" class="id-badge">ID</span>
                <button class="btn bg-red w-full btn-sm" style="margin-top:5px;" onclick="logout()">üö™ Logout</button>
            </div>

            <!-- Student List -->
            <div id="studentList" class="sidebar-content">
                <!-- Students Generated Here -->
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="content-area">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="flex center gap-10">
                    <span class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</span>
                    <div>
                        <h2 id="mainHeader" style="margin:0; color:var(--primary);">Dashboard</h2>
                        <small id="subHeader" style="color:#777;">Select a student</small>
                    </div>
                </div>
                <div class="flex gap-10">
                    <button class="btn bg-green" onclick="exportData()">Excel</button>
                    <button class="btn bg-blue" onclick="toggleMushaf()">üìñ <span class="desktop-only">ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ∞</span></button>
                </div>
            </div>

            <!-- Scrollable Area -->
            <div class="scrollable-content">
                
                <!-- TEACHER: Entry Form -->
                <div id="entryForm" class="entry-box hidden">
                    <div class="form-row">
                        <div class="form-group"><label>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="entryDate"></div>
                        <div class="form-group"><label>ﬁÑﬁßﬁàﬁ¶ﬁåﬁ∞</label>
                            <select id="lessonType" onchange="toggleLessonType(this.value)">
                                <option value="daily">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</option>
                                <option value="exam">ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</option>
                            </select>
                        </div>
                    </div>

                    <!-- Daily Lesson Sections -->
                    <div id="daily-sections">
                        <div class="section-selector">
                            <div class="sec-btn active" id="btn-new" onclick="setSection('new')">ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™</div>
                            <div class="sec-btn" id="btn-short" onclick="setSection('short')">ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</div>
                            <div class="sec-btn" id="btn-long" onclick="setSection('long')">ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß</div>
                        </div>

                        <!-- Dynamic Inputs based on active section -->
                        <div class="form-row">
                            <div style="flex:1"><label>ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß</label><input type="number" id="inpPage" placeholder="#" onchange="handlePage(this.value)"></div>
                            <div style="flex:2"><label>ﬁäﬁ¨ﬁÅﬁ≠</label><div class="flex gap-10"><select id="inpSurah" class="arabic-input"><option>...</option></select><input type="number" id="inpStart" placeholder="Verse"></div></div>
                            <div style="flex:2"><label>ﬁÇﬁ®ﬁâﬁ≠</label><div class="flex gap-10"><select id="inpEndSurah" class="arabic-input"><option>...</option></select><input type="number" id="inpEnd" placeholder="Verse"></div></div>
                            <div style="flex:1"><label>ﬁÜﬁ™ﬁÅﬁ∞</label><input type="number" id="inpMistakes" value="0" readonly style="background:#eee; font-weight:bold; text-align:center;"></div>
                        </div>
                    </div>

                    <!-- Exam Section -->
                    <div id="exam-section" class="hidden">
                        <div class="form-row">
                            <div style="flex:1"><label>ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™</label><input type="text" id="examJuzu" placeholder="30"></div>
                            <div style="flex:1"><label>ﬁâﬁ®ﬁÇﬁ∞ﬁàﬁ¶ﬁÉﬁ™</label>
                                <select id="examPortion" onchange="calcExam()">
                                    <option value="whole">ﬁâﬁ™ﬁÖﬁ®</option>
                                    <option value="half">1/2</option>
                                </select>
                            </div>
                            <div style="flex:1"><label>ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</label><h3 id="examMark" style="margin:0; color:blue;">100%</h3></div>
                        </div>
                        <div class="form-row">
                            <div style="flex:1"><label>ﬁìﬁ©ﬁóﬁ¶ﬁÉﬁ™ (-2)</label><input type="number" id="examT" value="0" onchange="calcExam()"></div>
                            <div style="flex:1"><label>ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ (-1)</label><input type="number" id="examS" value="0" onchange="calcExam()"></div>
                            <div style="flex:1"><label>ﬁåﬁ¶ﬁñﬁ∞ﬁàﬁ©ﬁãﬁ™ (10)</label><input type="number" id="examTaj" value="10" onchange="calcExam()"></div>
                        </div>
                    </div>

                    <button class="btn bg-green w-full" style="margin-top:10px; padding:12px;" onclick="saveData()">üíæ ﬁêﬁ≠ﬁàﬁ∞</button>
                </div>

                <!-- HISTORY TABLE -->
                <div style="margin-top:20px;">
                    <h3>ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ﬁåﬁ¶ﬁáﬁ∞</h3>
                    <div id="historyList"></div>
                </div>

            </div>
        </main>

        <!-- MUSHAF PANEL -->
        <aside class="mushaf-panel" id="mushafPanel">
            <div class="mushaf-header">
                <span id="mushafTitle">Page 1</span>
                <div>
                    <button class="btn btn-sm bg-grey" onclick="changePage(1)">Next</button>
                    <button class="btn btn-sm bg-red" onclick="toggleMushaf()">Close</button>
                </div>
            </div>
            <div class="mushaf-container">
                <div style="position:relative; display:inline-block;" id="mushafWrapper" onclick="placeDot(event)">
                    <img id="mushafImg" class="mushaf-img" src="">
                </div>
            </div>
        </aside>

    </div>

    <!-- MODAL (Settings/Student Info) -->
    <div id="modal" class="modal hidden">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modalTitle">Settings</h3>
                <span style="cursor:pointer; font-size:24px;" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

<script>
    // --- CONFIG ---
    // PASTE YOUR FIREBASE CONFIG HERE
    const firebaseConfig = {
      apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
      authDomain: "hifz-cde3b.firebaseapp.com",
      databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
      projectId: "hifz-cde3b",
      storageBucket: "hifz-cde3b.firebasestorage.app",
      messagingSenderId: "566754658580",
      appId: "1:566754658580:web:d63d0f167960f53bab9a01"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch(e) { console.error(e); }

    // --- STATE ---
    let appState = {
        userRole: null, // 'teacher' or 'student'
        classes: {},
        records: [],
        users: {},
        currentClass: null,
        currentStudent: null, // Full Name
        activeSection: 'new', // new, short, long
        currentPage: 1,
        dots: [] // Current session dots
    };

    const surahNames = ["ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©","ÿßŸÑÿ®ŸÇÿ±ÿ©","ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ","ÿßŸÑŸÜÿ≥ÿßÿ°","ÿßŸÑŸÖÿßÿ¶ÿØÿ©","ÿßŸÑÿ£ŸÜÿπÿßŸÖ","ÿßŸÑÿ£ÿπÿ±ÿßŸÅ","ÿßŸÑÿ£ŸÜŸÅÿßŸÑ","ÿßŸÑÿ™Ÿàÿ®ÿ©","ŸäŸàŸÜÿ≥","ŸáŸàÿØ","ŸäŸàÿ≥ŸÅ","ÿßŸÑÿ±ÿπÿØ","ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ","ÿßŸÑÿ≠ÿ¨ÿ±","ÿßŸÑŸÜÿ≠ŸÑ","ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°","ÿßŸÑŸÉŸáŸÅ","ŸÖÿ±ŸäŸÖ","ÿ∑Ÿá","ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°","ÿßŸÑÿ≠ÿ¨","ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ","ÿßŸÑŸÜŸàÿ±","ÿßŸÑŸÅÿ±ŸÇÿßŸÜ","ÿßŸÑÿ¥ÿπÿ±ÿßÿ°","ÿßŸÑŸÜŸÖŸÑ","ÿßŸÑŸÇÿµÿµ","ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™","ÿßŸÑÿ±ŸàŸÖ","ŸÑŸÇŸÖÿßŸÜ","ÿßŸÑÿ≥ÿ¨ÿØÿ©","ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®","ÿ≥ÿ®ÿ£","ŸÅÿßÿ∑ÿ±","Ÿäÿ≥","ÿßŸÑÿµÿßŸÅÿßÿ™","ÿµ","ÿßŸÑÿ≤ŸÖÿ±","ÿ∫ÿßŸÅÿ±","ŸÅÿµŸÑÿ™","ÿßŸÑÿ¥Ÿàÿ±Ÿâ","ÿßŸÑÿ≤ÿÆÿ±ŸÅ","ÿßŸÑÿØÿÆÿßŸÜ","ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©","ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ","ŸÖÿ≠ŸÖÿØ","ÿßŸÑŸÅÿ™ÿ≠","ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™","ŸÇ","ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™","ÿßŸÑÿ∑Ÿàÿ±","ÿßŸÑŸÜÿ¨ŸÖ","ÿßŸÑŸÇŸÖÿ±","ÿßŸÑÿ±ÿ≠ŸÖŸÜ","ÿßŸÑŸàÿßŸÇÿπÿ©","ÿßŸÑÿ≠ÿØŸäÿØ","ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©","ÿßŸÑÿ≠ÿ¥ÿ±","ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©","ÿßŸÑÿ∂ŸÅ","ÿßŸÑÿ¨ŸÖÿπÿ©","ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ","ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ","ÿßŸÑÿ∑ŸÑÿßŸÇ","ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ","ÿßŸÑŸÖŸÑŸÉ","ÿßŸÑŸÇŸÑŸÖ","ÿßŸÑÿÆÿßŸÇÿ©","ÿßŸÑŸÖÿπÿßÿ±ÿ¨","ŸÜŸàÿ≠","ÿßŸÑÿ¨ŸÜ","ÿßŸÑŸÖÿ≤ŸÖŸÑ","ÿßŸÑŸÖÿØÿ´ÿ±","ÿßŸÑŸÇŸäÿßŸÖÿ©","ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ","ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™","ÿßŸÑŸÜÿ®ÿ£","ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™","ÿπÿ®ÿ≥","ÿßŸÑÿ™ŸÉŸàŸäÿ±","ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±","ÿßŸÑÿ∑ŸÅŸäŸÅŸäŸÜ","ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ","ÿßŸÑÿ®ÿ±Ÿàÿ¨","ÿßŸÑÿ∑ÿßÿ±ŸÇ","ÿßŸÑÿ£ÿπŸÑŸâ","ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©","ÿßŸÑŸÅÿ¨ÿ±","ÿßŸÑÿ®ŸÑÿØ","ÿßŸÑÿ¥ŸÖÿ≥","ÿßŸÑŸÑŸäŸÑ","ÿßŸÑÿ∂ÿ≠Ÿâ","ÿßŸÑÿ¥ÿ±ÿ≠","ÿßŸÑÿ™ŸäŸÜ","ÿßŸÑÿπŸÑŸÇ","ÿßŸÑŸÇÿØÿ±","ÿßŸÑÿ®ŸäŸÜÿ©","ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©","ÿßŸÑÿπÿßÿØŸäÿßÿ™","ÿßŸÑŸÇÿßÿ±ÿπÿ©","ÿßŸÑÿ™ŸÉÿßÿ´ÿ±","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸÅŸäŸÑ","ŸÇÿ±Ÿäÿ¥","ÿßŸÑŸÖÿßÿπŸàŸÜ","ÿßŸÑŸÉŸàÿ´ÿ±","ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ","ÿßŸÑŸÜÿµÿ±","ÿßŸÑŸÖÿ≥ÿØ","ÿßŸÑÿ•ÿÆŸÑÿßÿµ","ÿßŸÑŸÅŸÑŸÇ","ÿßŸÑŸÜÿßÿ≥"];

    // --- INITIALIZE ---
    window.onload = function() {
        populateSurahDropdowns();
        document.getElementById('entryDate').valueAsDate = new Date();
        loadMushafImage(1);
        
        if(db) {
            // Load Data
            db.ref('/').on('value', snap => {
                const data = snap.val() || {};
                appState.classes = data.classes || {};
                appState.users = data.users || {};
                
                // Convert records object to array
                appState.records = [];
                if(data.records) {
                    Object.keys(data.records).forEach(k => {
                        appState.records.push({ ...data.records[k], key: k });
                    });
                }
                
                // Refresh UI if logged in
                if(appState.userRole === 'teacher') {
                    renderClassDropdown();
                    if(appState.currentStudent) renderHistory();
                } else if (appState.userRole === 'student') {
                    renderHistory(); // Filtered for student
                }

                document.getElementById('loading-overlay').classList.add('hidden');
                if(!appState.userRole) document.getElementById('login-screen').style.display = 'flex';
            });
        }
    };

    function populateSurahDropdowns() {
        const selects = ['inpSurah', 'inpEndSurah'];
        selects.forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = '<option>...</option>';
            surahNames.forEach((s, i) => {
                el.innerHTML += `<option value="${i+1}">${i+1}. ${s}</option>`;
            });
        });
    }

    // --- AUTH ---
    function toggleLoginView(view) {
        if(view === 'back') {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('role-select').classList.remove('hidden');
        } else {
            document.getElementById('role-select').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('login-title').innerText = view === 'teacher' ? 'ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞ ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞' : 'ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞';
            appState.tempRole = view;
        }
    }

    function processLogin() {
        const id = document.getElementById('login-id').value.trim();
        const pass = document.getElementById('login-pass').value.trim();
        
        if(appState.tempRole === 'teacher') {
            if(pass === '1234') {
                appState.userRole = 'teacher';
                showDashboard('teacher');
            } else alert('Wrong Password');
        } else {
            // Student Login
            let foundStudent = null;
            let foundClass = null;
            // Check ID in all classes
            Object.keys(appState.classes).forEach(c => {
                const students = appState.classes[c].students || [];
                students.forEach(s => {
                    if(s.includes(id)) { foundStudent = s; foundClass = c; }
                });
            });

            if(foundStudent) {
                // Check password or create default
                if(!appState.users[id]) db.ref('users/'+id).set('1234');
                
                if(appState.users[id] && appState.users[id] !== pass && pass !== '1234') {
                    alert('Wrong Password');
                } else {
                    appState.userRole = 'student';
                    appState.currentStudent = foundStudent;
                    appState.currentClass = foundClass;
                    showDashboard('student');
                }
            } else {
                alert('ID not found');
            }
        }
    }

    function showDashboard(role) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-container').classList.remove('hidden');
        
        if(role === 'teacher') {
            document.getElementById('teacher-controls').classList.remove('hidden');
            document.getElementById('student-controls').classList.add('hidden');
            renderClassDropdown();
        } else {
            document.getElementById('teacher-controls').classList.add('hidden');
            document.getElementById('student-controls').classList.remove('hidden');
            document.getElementById('stNameDisplay').innerText = appState.currentStudent;
            document.getElementById('entryForm').classList.add('hidden'); // Hide entry form for student
            document.getElementById('mainHeader').innerText = "Student Portal";
            renderHistory();
        }
    }

    function logout() { location.reload(); }

    // --- SIDEBAR & LISTS ---
    function renderClassDropdown() {
        const sel = document.getElementById('classSelect');
        sel.innerHTML = '';
        const classes = Object.keys(appState.classes);
        classes.forEach(c => {
            sel.innerHTML += `<option value="${c}">${c}</option>`;
        });
        if(classes.length > 0 && !appState.currentClass) loadStudents(classes[0]);
    }

    function loadStudents(className) {
        appState.currentClass = className;
        const list = document.getElementById('studentList');
        list.innerHTML = '';
        
        const students = appState.classes[className]?.students || [];
        students.forEach(s => {
            const div = document.createElement('div');
            div.className = 'student-card';
            // Parse Name and ID
            let name = s; let id = "";
            if(s.includes("IUM")) {
                const p = s.split("IUM"); name = p[0]; id = "IUM"+p[1];
            } else if (s.includes("(")) {
                const p = s.split("("); name = p[0]; id = p[1].replace(")","");
            }
            
            div.innerHTML = `
                <div class="st-avatar">${name.trim().charAt(0)}</div>
                <div>
                    <div style="font-weight:bold;">${name}</div>
                    ${id ? `<span class="id-badge">${id}</span>` : ''}
                </div>
            `;
            div.onclick = () => selectStudent(s, div);
            list.appendChild(div);
        });
    }

    function selectStudent(name, el) {
        appState.currentStudent = name;
        document.querySelectorAll('.student-card').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        
        document.getElementById('mainHeader').innerText = name;
        document.getElementById('subHeader').innerText = appState.currentClass;
        document.getElementById('entryForm').classList.remove('hidden');
        
        // Clear Form & Load Data
        clearInputs();
        appState.dots = [];
        loadMushafImage(1);
        autoFill();
        renderHistory();
        
        if(window.innerWidth <= 768) toggleSidebar();
    }

    // --- MAIN LOGIC (AutoFill, Save, etc) ---
    function setSection(sec) {
        appState.activeSection = sec;
        document.querySelectorAll('.sec-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+sec).classList.add('active');
        // Clear inputs for this section to avoid confusion or reload from autofill
        autoFill(); 
    }

    function autoFill() {
        if(!appState.currentStudent) return;
        // Logic to find last lesson and populate inputs
        // Simplified for this version
        const myRecs = appState.records.filter(r => r.student === appState.currentStudent && r.type === 'daily');
        myRecs.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        if(myRecs.length > 0) {
            const last = myRecs[0][appState.activeSection];
            if(last && last.en) {
                // Try to find next page logic here...
            }
        }
    }

    function saveData() {
        const type = document.getElementById('lessonType').value;
        const rec = {
            id: Date.now(),
            date: document.getElementById('entryDate').value,
            class: appState.currentClass,
            student: appState.currentStudent,
            type: type
        };

        if(type === 'daily') {
            const sec = appState.activeSection;
            rec[sec] = {
                s: surahNames[document.getElementById('inpSurah').value - 1] || 'Unknown',
                st: document.getElementById('inpStart').value,
                en: document.getElementById('inpEnd').value,
                m: document.getElementById('inpMistakes').value,
                dots: appState.dots
            };
        } else {
            rec.juzu = document.getElementById('examJuzu').value;
            rec.score = document.getElementById('examTotal').innerText;
        }

        db.ref('records').push(rec);
        alert('Saved');
        appState.dots = [];
        clearInputs();
        loadMushafImage(appState.currentPage); // Clear dots visually
    }

    function renderHistory() {
        const div = document.getElementById('historyList');
        div.innerHTML = '';
        const recs = appState.records.filter(r => r.student === appState.currentStudent);
        recs.sort((a,b) => new Date(b.date) - new Date(a.date));

        recs.forEach(r => {
            let html = `<div style="background:white; border-radius:8px; padding:10px; margin-bottom:10px; border-right:4px solid ${r.type==='exam'?'orange':'green'}; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                <div class="flex" style="justify-content:space-between;">
                    <strong>${r.date}</strong>
                    ${appState.userRole === 'teacher' ? `<button style="color:red; background:none; border:none;" onclick="deleteRec('${r.key}')">√ó</button>` : ''}
                </div>`;
            
            if(r.type === 'daily') {
                ['new', 'short', 'long'].forEach(s => {
                    if(r[s]) {
                        const dotsData = encodeURIComponent(JSON.stringify(r[s].dots || []));
                        html += `<div style="margin-top:5px; font-size:14px;">
                            <span style="font-weight:bold; color:#555">${s.toUpperCase()}:</span> 
                            ${r[s].s} (${r[s].st}-${r[s].en}) - <span style="color:red">${r[s].m} Mist.</span>
                            ${r[s].dots ? `<button class="btn-sm bg-blue" onclick="viewDots('${dotsData}')">üëÅÔ∏è</button>` : ''}
                        </div>`;
                    }
                });
            } else {
                html += `<div>Exam Juzu ${r.juzu}: ${r.score}</div>`;
            }
            html += `</div>`;
            div.innerHTML += html;
        });
    }

    // --- MUSHAF ---
    function toggleMushaf(forceOpen) {
        const p = document.getElementById('mushafPanel');
        if(forceOpen || !p.classList.contains('open')) p.classList.add('open');
        else p.classList.remove('open');
    }
    
    function loadMushafImage(page) {
        if(!page) return;
        appState.currentPage = page;
        document.getElementById('mushafImg').src = `https://android.quran.com/data/width_1260/page${page.toString().padStart(3,'0')}.png`;
        document.getElementById('mushafTitle').innerText = "Page " + page;
        
        // Remove existing dots
        document.querySelectorAll('.mistake-dot').forEach(e => e.remove());
        
        // Draw session dots
        appState.dots.forEach(d => {
            if(d.page == page) drawDot(d.x, d.y);
        });
    }

    function placeDot(e) {
        if(appState.userRole !== 'teacher') return;
        const rect = e.target.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        appState.dots.push({x, y, page: appState.currentPage});
        document.getElementById('inpMistakes').value = parseInt(document.getElementById('inpMistakes').value) + 1;
        drawDot(x, y);
    }

    function drawDot(x, y) {
        const d = document.createElement('div');
        d.className = 'mistake-dot';
        d.style.left = x + 'px'; d.style.top = y + 'px';
        document.getElementById('mushafWrapper').appendChild(d);
    }

    function viewDots(data) {
        const dots = JSON.parse(decodeURIComponent(data));
        if(!dots || dots.length === 0) return alert("No mistakes marked");
        
        // Load the page of the first dot
        loadMushafImage(dots[0].page);
        toggleMushaf(true);
        
        // Draw readonly dots
        setTimeout(() => {
            dots.forEach(d => {
                const dot = document.createElement('div');
                dot.className = 'mistake-dot readonly';
                dot.style.left = d.x + 'px'; dot.style.top = d.y + 'px';
                dot.style.background = 'gold';
                document.getElementById('mushafWrapper').appendChild(dot);
            });
        }, 500); // Slight delay for image load
    }

    function changePage(d) { loadMushafImage(parseInt(appState.currentPage) + d); }
    function handlePage(v) { loadMushafImage(v); }
    function adjM(id, val) { 
        // Not used in simplified HTML structure but good to keep logic
    }
    
    // --- UTILS ---
    function toggleSidebar() { document.getElementById('mainSidebar').classList.toggle('open'); }
    function toggleLessonType(val) {
        document.getElementById('daily-sections').style.display = val === 'daily' ? 'block' : 'none';
        document.getElementById('exam-section').style.display = val === 'exam' ? 'block' : 'none';
    }
    function clearInputs() {
        document.getElementById('inpStart').value = '';
        document.getElementById('inpEnd').value = '';
        document.getElementById('inpMistakes').value = '0';
    }
    function deleteRec(k) { if(confirm('Delete?')) db.ref('records/'+k).remove(); }
    
    // --- MODAL ---
    function openModal(type) {
        const modal = document.getElementById('modal');
        const body = document.getElementById('modalBody');
        const title = document.getElementById('modalTitle');
        modal.classList.remove('hidden');
        
        if(type === 'settings') {
            title.innerText = "Settings & Backup";
            body.innerHTML = `
                <label>Add Class:</label><div class="flex gap-10"><input id="newCls"><button class="btn bg-blue" onclick="addClass()">Add</button></div>
                <hr>
                <label>Add Students (Bulk):</label>
                <textarea id="bulkSt" style="width:100%; height:100px; border:1px solid #ddd;" placeholder="Name IUM123"></textarea>
                <button class="btn bg-green w-full" onclick="addBulk()">Add to ${appState.currentClass}</button>
                <hr>
                <button class="btn bg-grey w-full" onclick="alert('Student Passwords managed automatically (1234)')">Manage Passwords</button>
            `;
        }
    }
    function closeModal() { document.getElementById('modal').classList.add('hidden'); }
    
    function addClass() {
        const n = document.getElementById('newCls').value;
        if(n) { db.ref('classes/'+n).set({students:[]}); alert('Done'); }
    }
    function addBulk() {
        const txt = document.getElementById('bulkSt').value;
        const arr = txt.split('\n').filter(s=>s.trim());
        const current = appState.classes[appState.currentClass].students || [];
        db.ref('classes/'+appState.currentClass+'/students').set([...current, ...arr]);
        alert('Done');
    }

</script>
</body>
</html>
