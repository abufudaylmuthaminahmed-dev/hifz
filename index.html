<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quran Hifz - Final Smooth Version</title>
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
        @font-face { font-family: 'Faruma'; src: local('Faruma'); }
        @font-face { font-family: 'MV Waheed'; src: local('MV Waheed'); }

        :root {
            --primary-color: #2c3e50;
            --accent-color: #27ae60;
            --bg-color: #f4f7f6;
            --font-heading: 'MV Waheed', 'mv waheed', 'Noto Sans Thaana', sans-serif;
            --font-body: 'Faruma', 'faruma', 'Noto Sans Thaana', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-body) !important;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
        }

        /* Enforce Fonts on Mobile Inputs */
        input, select, button, textarea {
            font-family: var(--font-body) !important;
            font-size: 16px !important; /* Prevents iOS zoom */
        }
        
        h1, h2, h3, h4, h5, h6, .modal-header h3, .login-title, label, th, .tab-btn, .section-label, .exam-header {
            font-family: var(--font-heading) !important;
        }

        /* --- LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; padding: 20px;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
            width: 100%; max-width: 350px; color: #333;
        }
        .login-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
        .login-btn { width: 100%; padding: 14px; margin-top: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-teacher-login { background: #2c3e50; color: white; }
        .btn-student-login { background: #27ae60; color: white; }
        .login-tab { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .login-tab-btn { flex: 1; padding: 10px; cursor: pointer; background: none; border: none; border-bottom: 3px solid transparent; }
        .login-tab-btn.active { border-color: var(--accent-color); color: var(--accent-color); }

        /* Hiding elements for Student Mode */
        body.student-mode .teacher-only, 
        body.student-mode .delete-card-btn, 
        body.student-mode .entry-form, 
        body.student-mode .mushaf-panel,
        body.student-mode .manage-btn { display: none !important; }

        /* --- LAYOUT --- */
        .sidebar {
            width: 280px; background-color: white; border-left: 1px solid #ddd;
            display: flex; flex-direction: column; padding: 15px;
            flex-shrink: 0; z-index: 20; transition: transform 0.3s ease;
        }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

        .mobile-header { display: none; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .hamburger-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--primary-color); padding: 5px; }

        /* --- FORMS --- */
        .entry-form { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-group { flex: 1; }
        .arabic-input { font-family: 'Amiri', serif !important; direction: rtl; }
        
        .section-box { padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 2px solid transparent; transition: 0.2s; position: relative;}
        .section-new { background-color: #eafaf1; }
        .section-short { background-color: #ebf5fb; }
        .section-long { background-color: #fef9e7; }
        .section-box.active-section { border-color: var(--accent-color); background-color: white; border-left: 5px solid var(--accent-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .radio-label { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 20px; border: 1px solid #ddd; cursor: pointer; font-size: 14px; font-weight: bold; }
        input[type="radio"] { accent-color: var(--accent-color); }
        
        /* Mistake Counter */
        .mistake-wrapper { display: flex; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; height: 38px; }
        .mistake-btn { width: 35px; border: none; background: #eee; cursor: pointer; font-weight: bold; font-size: 18px; }
        .mistake-display { text-align: center; font-weight: bold; width: 40px; border: none; border-left: 1px solid #ddd; border-right: 1px solid #ddd; padding: 0; }

        /* --- MUSHAF --- */
        .mushaf-panel { width: 35%; background: #2c3e50; display: flex; flex-direction: column; transition: width 0.3s ease; border-right: 1px solid #ccc; }
        .mushaf-header { background: #34495e; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .mushaf-container { flex: 1; overflow: auto; background: #fdfdfd; display: flex; justify-content: center; position: relative; }
        .mushaf-page-img { max-width: 100%; display: block; cursor: crosshair; }
        .mistake-dot { position: absolute; width: 25px; height: 25px; background: rgba(231, 76, 60, 0.8); border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); cursor: pointer; z-index: 100; }

        /* --- HISTORY CARDS --- */
        .history-card { background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; padding: 15px; border-right: 5px solid var(--primary-color); }
        .history-card.exam-card { border-right-color: #f1c40f; background: #fffdf0; }
        .card-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; }
        .card-body { display: flex; gap: 10px; flex-wrap: wrap; }
        .card-section { flex: 1; min-width: 140px; padding: 8px; border-radius: 6px; font-size: 13px; }
        .card-section.new { background: #eafaf1; color: #27ae60; }
        .card-section.short { background: #ebf5fb; color: #2980b9; }
        .card-section.long { background: #fef9e7; color: #d35400; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 0; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        .student-list-container button { text-align: right; width: 100%; padding: 12px; border: none; background: none; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 16px; color: #333; }
        .student-list-container button:hover, .student-list-container button.active { background: #eafaf1; color: var(--accent-color); font-weight: bold; }

        .btn { padding: 10px 16px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; font-size: 14px; }
        .btn-green { background: var(--accent-color); }
        .btn-blue { background: #3498db; }
        .btn-red { background: #e74c3c; }
        .btn-grey { background: #95a5a6; }
        .btn-yellow { background: #f39c12; }
        .filter-btn { padding: 6px 12px; border-radius: 15px; border: 1px solid #ddd; background: white; cursor: pointer; margin-bottom: 5px; }
        .filter-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        /* --- MOBILE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; top: 0; right: 0; width: 80%; max-width: 300px; height: 100%; transform: translateX(100%); z-index: 5000; box-shadow: -2px 0 10px rgba(0,0,0,0.2); }
            .sidebar.active { transform: translateX(0); }
            #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; }
            #sidebar-overlay.active { display: block; }
            .mobile-header { display: flex; }
            .form-row { flex-direction: column; gap: 10px; }
            .mushaf-panel { position: fixed; top: 0; left: 0; width: 100% !important; height: 100%; z-index: 6000; transform: translateY(100%); }
            .mushaf-panel.active { transform: translateY(0); }
        }
        
        .loading-spinner { display: inline-block; width: 15px; height: 15px; border: 2px solid rgba(0,0,0,0.1); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2 class="login-title" style="color:var(--primary-color);">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞</h2>
            <div class="login-tab">
                <button class="login-tab-btn active" id="tabStudent" onclick="switchLoginTab('student')">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</button>
                <button class="login-tab-btn" id="tabTeacher" onclick="switchLoginTab('teacher')">ﬁâﬁ™ﬁãﬁ¶ﬁáﬁ∞ﬁÉﬁ®ﬁêﬁ∞</button>
            </div>
            
            <div id="login-form-student">
                <select id="loginClassSelect" class="login-input" style="margin-bottom:10px;"><option value="">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁçﬁØﬁëﬁ™ﬁàﬁ¶ﬁÇﬁ©...</option></select>
                <input type="text" id="loginStudentId" class="login-input" placeholder="ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© (ﬁâﬁ®ﬁêﬁßﬁçﬁ™: IUM123)" style="text-transform: uppercase; margin-bottom: 10px;">
                <input type="password" id="studentPassword" class="login-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞" style="margin-bottom: 10px;">
                <button class="login-btn btn-student-login" onclick="handleStudentLogin()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>

            <div id="login-form-teacher" style="display:none;">
                <input type="password" id="teacherPassword" class="login-input" placeholder="ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞" style="margin-bottom: 10px;">
                <button class="login-btn btn-teacher-login" onclick="handleTeacherLogin()">ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
        </div>
        <p style="margin-top:20px; opacity:0.7; font-size:12px; color:white;">¬© Quran Hifz Tracker v18.0</p>
    </div>

    <!-- PASSWORD SET MODAL -->
    <div id="passwordSetupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁêﬁ¨ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</h3></div>
            <div class="modal-body">
                <input type="password" id="newPass1" placeholder="ﬁáﬁß ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞" class="login-input" style="margin-bottom:10px;">
                <input type="password" id="newPass2" placeholder="ﬁÜﬁ¶ﬁÅﬁ¶ﬁàﬁ¶ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ≠" class="login-input" style="margin-bottom:20px;">
                <button class="btn btn-green" style="width:100%; justify-content:center;" onclick="saveNewPassword()">ﬁêﬁ≠ﬁàﬁ∞ & ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" style="display:none; width:100%; height:100%;">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color:var(--primary-color);">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞</h3>
                <span style="font-size:24px; cursor:pointer;" class="mobile-close-sidebar" onclick="toggleSidebar()">&times;</span>
            </div>
            
            <div class="class-control-area">
                <label style="color:#7f8c8d; margin-bottom: 5px;">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞:</label>
                <select id="classSelect" class="class-select" onchange="switchClass(this.value)"></select>
                <button class="manage-btn teacher-only" onclick="openModal()"><span>‚öôÔ∏è</span> ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞</button>
            </div>
            
            <h4 style="margin: 10px 0; color:#555; border-bottom:1px solid #eee; padding-bottom:5px;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</h4>
            <div id="studentListContainer" class="student-list-container"></div>
            <button class="btn btn-grey" onclick="logout()" style="margin-top:10px; width:100%; justify-content:center;">üö™ ﬁÇﬁ™ﬁÜﬁ™ﬁâﬁ¨ﬁàﬁ¶ﬁëﬁ¶ﬁáﬁ®ﬁéﬁ¶ﬁÇﬁ∞ﬁÇﬁ¶ﬁàﬁß</button>
        </div>

        <!-- MAIN -->
        <div class="main-content">
            <div class="mobile-header">
                <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
                <h3 style="margin:0; color:var(--primary-color);">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ∞ ﬁìﬁ∞ﬁÉﬁ¨ﬁÜﬁ¶ﬁÉ</h3>
            </div>

            <div style="background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:10px;">
                    <div>
                        <small style="color:#7f8c8d; display:block;" id="currentClassDisplay">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞: -</small>
                        <h2 id="studentHeader" style="margin:0; color:var(--primary-color);">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</h2>
                        <span id="classTeacherDisplay" style="font-size:12px; color:#27ae60; background:#eafaf1; padding:2px 8px; border-radius:10px; display:none;"></span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-green teacher-only" onclick="exportExcel()">üì• Excel</button>
                        <button class="btn btn-blue" onclick="toggleMushaf()">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ∞</button>
                    </div>
                </div>
            </div>

            <!-- TEACHER ENTRY FORM -->
            <div class="entry-form teacher-only">
                <div class="form-row">
                    <div class="form-group"><label>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</label><input type="date" id="entryDate" onchange="updateSelectedDate()"></div>
                    <div class="form-group"><label>ﬁàﬁ¶ﬁáﬁ∞ﬁåﬁ¶ﬁÉﬁ™</label>
                        <select id="lessonType" onchange="toggleFormSection(this.value)">
                            <option value="daily">ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ﬁåﬁ¶ﬁáﬁ∞</option>
                            <option value="exam">ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</option>
                        </select>
                    </div>
                </div>

                <!-- DAILY -->
                <div id="container-daily">
                    <div id="box-new" class="section-box section-new active-section">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#27ae60;">ﬁáﬁß ﬁäﬁ®ﬁçﬁßﬁàﬁ¶ﬁÖﬁ™ <span id="loader-new" class="loading-spinner" style="display:none;"></span></label>
                            <label class="radio-label"><input type="radio" name="activeSec" value="new" checked onchange="setActiveSection('new')"> <span>ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</span></label>
                        </div>
                        <div class="form-row">
                            <div style="flex:1"><input type="number" id="newPage" placeholder="ﬁû" onchange="autoLoadPage('new')" style="background:#fffde7; text-align:center;"></div>
                            <div style="flex:2"><select id="newSurah" class="arabic-input"></select></div>
                            <div style="flex:1"><input type="number" id="newStart" placeholder="ﬁäﬁ¨ﬁÅﬁ®"></div>
                        </div>
                        <div class="form-row">
                            <div style="flex:2"><select id="newEndSurah" class="arabic-input"></select></div>
                            <div style="flex:1"><input type="number" id="newEnd" placeholder="ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁ®"></div>
                            <div class="mistake-wrapper"><button class="mistake-btn" onclick="adjustMistake('newMistakes', 1)">+</button><input id="newMistakes" class="mistake-display" value="0" readonly><button class="mistake-btn" onclick="adjustMistake('newMistakes', -1)">-</button></div>
                        </div>
                    </div>

                    <!-- SHORT & LONG sections removed for brevity in display, but functionally same structure as above -->
                     <div id="box-short" class="section-box section-short">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#2980b9;">ﬁÜﬁ™ﬁÉﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß <span id="loader-short" class="loading-spinner" style="display:none;"></span></label>
                            <label class="radio-label"><input type="radio" name="activeSec" value="short" onchange="setActiveSection('short')"> <span>ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</span></label>
                        </div>
                        <div class="form-row">
                            <div style="flex:1"><input type="number" id="shortPage" placeholder="ﬁû" onchange="autoLoadPage('short')" style="background:#fffde7; text-align:center;"></div>
                            <div style="flex:2"><select id="shortSurah" class="arabic-input"></select></div>
                            <div style="flex:1"><input type="number" id="shortStart" placeholder="ﬁäﬁ¨ﬁÅﬁ®"></div>
                        </div>
                        <div class="form-row">
                            <div style="flex:2"><select id="shortEndSurah" class="arabic-input"></select></div>
                            <div style="flex:1"><input type="number" id="shortEnd" placeholder="ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁ®"></div>
                            <div class="mistake-wrapper"><button class="mistake-btn" onclick="adjustMistake('shortMistakes', 1)">+</button><input id="shortMistakes" class="mistake-display" value="0" readonly><button class="mistake-btn" onclick="adjustMistake('shortMistakes', -1)">-</button></div>
                        </div>
                    </div>

                    <div id="box-long" class="section-box section-long">
                         <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:#d35400;">ﬁãﬁ®ﬁéﬁ™ ﬁâﬁ™ﬁÉﬁßﬁñﬁ¶ﬁ¢ﬁß <span id="loader-long" class="loading-spinner" style="display:none;"></span></label>
                            <label class="radio-label"><input type="radio" name="activeSec" value="long" onchange="setActiveSection('long')"> <span>ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</span></label>
                        </div>
                        <div class="form-row">
                            <div style="flex:1"><input type="number" id="longPage" placeholder="ﬁû" onchange="autoLoadPage('long')" style="background:#fffde7; text-align:center;"></div>
                            <div style="flex:2"><select id="longSurah" class="arabic-input"></select></div>
                            <div style="flex:1"><input type="number" id="longStart" placeholder="ﬁäﬁ¨ﬁÅﬁ®"></div>
                        </div>
                        <div class="form-row">
                            <div style="flex:2"><select id="longEndSurah" class="arabic-input"></select></div>
                            <div style="flex:1"><input type="number" id="longEnd" placeholder="ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁ®"></div>
                            <div class="mistake-wrapper"><button class="mistake-btn" onclick="adjustMistake('longMistakes', 1)">+</button><input id="longMistakes" class="mistake-display" value="0" readonly><button class="mistake-btn" onclick="adjustMistake('longMistakes', -1)">-</button></div>
                        </div>
                    </div>
                </div>

                <!-- EXAM -->
                <div id="container-exam" style="display:none;">
                    <div id="box-exam" class="section-box section-exam active-section">
                        <div class="exam-header"><span>üèÜ ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</span> <span id="totalExamScore">100%</span></div>
                        <div class="form-row">
                            <div style="flex:1"><label>ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™:</label><select id="examJuzu"></select></div>
                            <div style="flex:1"><label>ﬁÑﬁ¶ﬁáﬁ®:</label><select id="examPortion"><option value="whole">ﬁâﬁ™ﬁÖﬁ® ﬁñﬁ™ﬁíﬁ™ﬁáﬁ™</option><option value="half">ﬁáﬁ¨ﬁáﬁ∞ﬁÑﬁ¶ﬁáﬁ®</option><option value="third">1/3</option></select></div>
                        </div>
                        <div class="form-row"><label>ﬁáﬁ¨ﬁéﬁ∞ﬁíﬁßﬁâﬁ®ﬁÇﬁ¶ﬁÉ:</label><input type="text" id="examExaminer"></div>
                        <div class="form-row" style="margin-top:10px;">
                            <div class="mistake-wrapper" style="flex:1; background:#ffebee;"><span style="font-size:12px; padding:5px;">ﬁìﬁ©ﬁóﬁ¶ﬁÉ:</span><button class="mistake-btn" onclick="updateExamMistake('teacher', 1)">+</button><input id="examTeacherMistakes" class="mistake-display" value="0" readonly><button class="mistake-btn" onclick="updateExamMistake('teacher', -1)">-</button></div>
                            <div class="mistake-wrapper" style="flex:1; background:#fff8e1;"><span style="font-size:12px; padding:5px;">ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶:</span><button class="mistake-btn" onclick="updateExamMistake('self', 1)">+</button><input id="examSelfMistakes" class="mistake-display" value="0" readonly><button class="mistake-btn" onclick="updateExamMistake('self', -1)">-</button></div>
                        </div>
                        <!-- Marks -->
                        <div class="form-row" style="margin-top:10px;">
                            <div class="form-group"><label>ﬁâﬁ™ﬁåﬁ¶ﬁùﬁßﬁÑﬁ®ﬁÄﬁ∞</label><input type="number" id="markMutha1" value="5" onchange="calculateExamScore()"></div>
                            <div class="form-group"><label>ﬁåﬁ¶ﬁñﬁ∞ﬁàﬁ©ﬁãﬁ™</label><input type="number" id="markTajweed" value="10" onchange="calculateExamScore()"></div>
                            <div class="form-group"><label>ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞</label><input type="number" id="markFluency" value="5" onchange="calculateExamScore()"></div>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-green" style="flex:1; justify-content: center;" onclick="saveRecord()">ﬁêﬁ≠ﬁàﬁ∞</button>
                    <button class="btn btn-red" style="width:auto; justify-content: center;" onclick="clearForm()">ﬁêﬁßﬁäﬁ™</button>
                </div>
            </div>

            <!-- HISTORY -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0 10px 0; border-bottom: 2px solid #eee; padding-bottom:8px; flex-wrap:wrap; gap:5px;">
                <h4 style="margin:0; color:#555;">ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁåﬁßﬁàﬁ¶ﬁçﬁ∞</h4>
                <div style="display:flex; gap:5px;">
                    <button class="filter-btn active" id="btnFilterAll" onclick="setHistoryFilter('all')">ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß</button>
                    <button class="filter-btn" id="btnFilterNew" onclick="setHistoryFilter('new')">ﬁáﬁß</button>
                    <button class="filter-btn" id="btnFilterExam" onclick="setHistoryFilter('exam')">ﬁáﬁ®ﬁâﬁ∞ﬁåﬁ®ﬁôﬁßﬁÇﬁ∞</button>
                </div>
            </div>
            <div id="historyContainer" class="history-container"></div>
        </div>

        <!-- MUSHAF -->
        <div class="mushaf-panel" id="mushafPanel">
            <div class="mushaf-header">
                <span id="pageIndicator" style="font-weight:bold;">Page 1</span>
                <div>
                    <button class="btn" style="background:#555; padding:5px 10px;" onclick="changePage(1)">&gt;</button>
                    <button class="btn" style="background:#555; padding:5px 10px;" onclick="changePage(-1)">&lt;</button>
                    <button class="btn" style="background:#c0392b; margin-left:10px;" onclick="toggleMushaf()">X</button>
                </div>
            </div>
            <div class="mushaf-container">
                <div class="mushaf-wrapper" id="mushafWrapper" onclick="onImageClick(event)">
                    <img id="mushafImg" class="mushaf-page-img" src="" alt="Quran Page">
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="editRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>ﬁáﬁ®ﬁûﬁ∞ﬁçﬁßﬁôﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞</h3><span class="close-modal" onclick="closeEditModal()">&times;</span></div>
            <div class="modal-body" id="editModalBody"></div>
        </div>
    </div>

    <!-- CLASS MODAL -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ & ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</h3><span class="close-modal" onclick="closeModal()">&times;</span></div>
            <div class="modal-body">
                <label>ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (ID, Name):</label>
                <textarea id="bulkStudents" placeholder="IUM100, Ali" style="width:100%; height:80px; margin-bottom:10px;"></textarea>
                <button class="btn btn-green" style="width:100%;" onclick="importStudents()">ﬁáﬁ¨ﬁëﬁ∞</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcBUo0zeuhRjEsRfAtZk4gHNhxoHCwLSU",
      authDomain: "hifz-cde3b.firebaseapp.com",
      databaseURL: "https://hifz-cde3b-default-rtdb.firebaseio.com",
      projectId: "hifz-cde3b",
      storageBucket: "hifz-cde3b.firebasestorage.app",
      messagingSenderId: "566754658580",
      appId: "1:566754658580:web:d63d0f167960f53bab9a01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const surahNames = ["ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©","ÿßŸÑÿ®ŸÇÿ±ÿ©","ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ","ÿßŸÑŸÜÿ≥ÿßÿ°","ÿßŸÑŸÖÿßÿ¶ÿØÿ©","ÿßŸÑÿ£ŸÜÿπÿßŸÖ","ÿßŸÑÿ£ÿπÿ±ÿßŸÅ","ÿßŸÑÿ£ŸÜŸÅÿßŸÑ","ÿßŸÑÿ™Ÿàÿ®ÿ©","ŸäŸàŸÜÿ≥","ŸáŸàÿØ","ŸäŸàÿ≥ŸÅ","ÿßŸÑÿ±ÿπÿØ","ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ","ÿßŸÑÿ≠ÿ¨ÿ±","ÿßŸÑŸÜÿ≠ŸÑ","ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°","ÿßŸÑŸÉŸáŸÅ","ŸÖÿ±ŸäŸÖ","ÿ∑Ÿá","ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°","ÿßŸÑÿ≠ÿ¨","ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ","ÿßŸÑŸÜŸàÿ±","ÿßŸÑŸÅÿ±ŸÇÿßŸÜ","ÿßŸÑÿ¥ÿπÿ±ÿßÿ°","ÿßŸÑŸÜŸÖŸÑ","ÿßŸÑŸÇÿµÿµ","ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™","ÿßŸÑÿ±ŸàŸÖ","ŸÑŸÇŸÖÿßŸÜ","ÿßŸÑÿ≥ÿ¨ÿØÿ©","ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®","ÿ≥ÿ®ÿ£","ŸÅÿßÿ∑ÿ±","Ÿäÿ≥","ÿßŸÑÿµÿßŸÅÿßÿ™","ÿµ","ÿßŸÑÿ≤ŸÖÿ±","ÿ∫ÿßŸÅÿ±","ŸÅÿµŸÑÿ™","ÿßŸÑÿ¥Ÿàÿ±Ÿâ","ÿßŸÑÿ≤ÿÆÿ±ŸÅ","ÿßŸÑÿØÿÆÿßŸÜ","ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©","ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ","ŸÖÿ≠ŸÖÿØ","ÿßŸÑŸÅÿ™ÿ≠","ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™","ŸÇ","ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™","ÿßŸÑÿ∑Ÿàÿ±","ÿßŸÑŸÜÿ¨ŸÖ","ÿßŸÑŸÇŸÖÿ±","ÿßŸÑÿ±ÿ≠ŸÖŸÜ","ÿßŸÑŸàÿßŸÇÿπÿ©","ÿßŸÑÿ≠ÿØŸäÿØ","ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©","ÿßŸÑÿÆÿ¥ÿ±","ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©","ÿßŸÑÿ∂ŸÅ","ÿßŸÑÿ¨ŸÖÿπÿ©","ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ","ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ","ÿßŸÑÿ∑ŸÑÿßŸÇ","ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ","ÿßŸÑŸÖŸÑŸÉ","ÿßŸÑŸÇŸÑŸÖ","ÿßŸÑÿÆÿßŸÇÿ©","ÿßŸÑŸÖÿπÿßÿ±ÿ¨","ŸÜŸàÿ≠","ÿßŸÑÿ¨ŸÜ","ÿßŸÑŸÖÿ≤ŸÖŸÑ","ÿßŸÑŸÖÿØÿ´ÿ±","ÿßŸÑŸÇŸäÿßŸÖÿ©","ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ","ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™","ÿßŸÑŸÜÿ®ÿ£","ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™","ÿπÿ®ÿ≥","ÿßŸÑÿ™ŸÉŸàŸäÿ±","ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±","ÿßŸÑÿ∑ŸÅŸäŸÅŸäŸÜ","ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ","ÿßŸÑÿ®ÿ±Ÿàÿ¨","ÿßŸÑÿ∑ÿßÿ±ŸÇ","ÿßŸÑÿ£ÿπŸÑŸâ","ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©","ÿßŸÑŸÅÿ¨ÿ±","ÿßŸÑÿ®ŸÑÿØ","ÿßŸÑÿ¥ŸÖÿ≥","ÿßŸÑŸÑŸäŸÑ","ÿßŸÑÿ∂ÿ≠Ÿâ","ÿßŸÑÿ¥ÿ±ÿ≠","ÿßŸÑÿ™ŸäŸÜ","ÿßŸÑÿπŸÑŸÇ","ÿßŸÑŸÇÿØÿ±","ÿßŸÑÿ®ŸäŸÜÿ©","ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©","ÿßŸÑÿπÿßÿØŸäÿßÿ™","ÿßŸÑŸÇÿßÿ±ÿπÿ©","ÿßŸÑÿ™ŸÉÿßÿ´ÿ±","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸáŸÖÿ≤ÿ©","ÿßŸÑŸÅŸäŸÑ","ŸÇÿ±Ÿäÿ¥","ÿßŸÑŸÖÿßÿπŸàŸÜ","ÿßŸÑŸÉŸàÿ´ÿ±","ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ","ÿßŸÑŸÜÿµÿ±","ÿßŸÑŸÖÿ≥ÿØ","ÿßŸÑÿ•ÿÆŸÑÿßÿµ","ÿßŸÑŸÅŸÑŸÇ","ÿßŸÑŸÜÿßÿ≥"];
    const TEACHER_PASSWORD = "1234"; 

    let classes = {}; let records = [];
    let currentClass = ""; let currentStudent = null; 
    let currentActiveSection = 'new'; let currentPage = 1; let historyFilter = 'all'; 
    let tempLoginClass = ""; let tempLoginStudentIdx = -1;
    let editingRecordId = null;
    let currentDots = { new: [], short: [], long: [], exam: [] };
    let selectedDate = new Date().toISOString().split('T')[0];

    // Load Data & Auto Migrate
    const dbRef = ref(db, 'hifz_data');
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            classes = data.classes || {};
            records = data.records || [];
            
            // Populate login classes once data is there
            populateLoginClasses();
            
            // Check session only after data load
            const session = JSON.parse(localStorage.getItem('hifz_session'));
            if(session) {
                if(session.type === 'teacher') {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-container').style.display = 'flex';
                    if(session.class && classes[session.class]) currentClass = session.class;
                    refreshClassDropdowns();
                } else if(session.type === 'student') {
                     // Verify student
                     if(classes[session.class] && classes[session.class].students.find(s => s.name === session.student)) {
                         loginSuccess(session.class, session.student, 'student');
                     }
                }
            }
        } else {
             classes = { "Default": { students: [] } };
             saveData();
        }
    });

    function saveData() { set(ref(db, 'hifz_data'), { classes, records }); }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const selects = ['new','short','long'];
        selects.forEach(sec => {
            const s1 = document.getElementById(sec+'Surah');
            const s2 = document.getElementById(sec+'EndSurah');
            if(s1 && s2) {
                let html = '';
                surahNames.forEach((s,i) => html += `<option value="${i+1}">${i+1}. ${s}</option>`);
                s1.innerHTML = html; s2.innerHTML = html;
            }
        });
        const juzuSel = document.getElementById('examJuzu');
        if(juzuSel) {
            for(let i=1; i<=30; i++) juzuSel.innerHTML += `<option value="${i}">${i}</option>`;
        }
        document.getElementById('entryDate').value = selectedDate;
        loadMushaf(1);
    });

    // --- LOGIN LOGIC ---
    window.populateLoginClasses = () => {
        const sel = document.getElementById('loginClassSelect');
        sel.innerHTML = '<option value="">ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞ ﬁÇﬁ¶ﬁéﬁß...</option>';
        Object.keys(classes).forEach(k => {
            sel.innerHTML += `<option value="${k}">${k}</option>`;
        });
    };

    window.switchLoginTab = (t) => {
        document.querySelectorAll('.login-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t==='student'?'tabStudent':'tabTeacher').classList.add('active');
        document.getElementById('login-form-student').style.display = t==='student'?'block':'none';
        document.getElementById('login-form-teacher').style.display = t==='teacher'?'block':'none';
    };

    window.handleStudentLogin = () => {
        const cls = document.getElementById('loginClassSelect').value;
        const id = document.getElementById('loginStudentId').value.trim().toUpperCase();
        const pass = document.getElementById('studentPassword').value;
        
        if(!cls || !id) return alert("ﬁÜﬁ∞ﬁçﬁßﬁÄﬁßﬁáﬁ® ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß");
        
        const students = classes[cls].students;
        const idx = students.findIndex(s => s.id === id); // Look for EXACT ID match first
        
        if(idx === -1) {
            // Fallback: Check if ID is part of name (Old format)
            const fallbackIdx = students.findIndex(s => s.name.includes(id));
            if(fallbackIdx === -1) return alert("ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™");
            // If found by name inclusion, use that
            checkPassword(cls, fallbackIdx, pass);
        } else {
            checkPassword(cls, idx, pass);
        }
    };

    function checkPassword(cls, idx, pass) {
        const s = classes[cls].students[idx];
        if((!s.password || s.password === "") && pass === "") {
            tempLoginClass = cls; tempLoginStudentIdx = idx;
            document.getElementById('passwordSetupModal').style.display = 'flex';
        } else if (s.password === pass) {
            loginSuccess(cls, s.name, 'student');
        } else {
            alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®");
        }
    }

    window.saveNewPassword = () => {
        const p1 = document.getElementById('newPass1').value;
        if(p1 !== document.getElementById('newPass2').value) return alert("ﬁïﬁßﬁêﬁ∞ﬁàﬁØﬁëﬁ∞ ﬁãﬁ®ﬁâﬁßﬁÇﬁ™ﬁàﬁ≠");
        classes[tempLoginClass].students[tempLoginStudentIdx].password = p1;
        saveData();
        document.getElementById('passwordSetupModal').style.display = 'none';
        loginSuccess(tempLoginClass, classes[tempLoginClass].students[tempLoginStudentIdx].name, 'student');
    };

    window.handleTeacherLogin = () => {
        if(document.getElementById('teacherPassword').value === TEACHER_PASSWORD) {
            loginSuccess(Object.keys(classes)[0] || "Default", null, 'teacher');
        } else alert("ﬁÇﬁ™ﬁÑﬁ¶ﬁáﬁ®");
    };

    function loginSuccess(cls, studentName, mode) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        localStorage.setItem('hifz_session', JSON.stringify({type:mode, class:cls, student:studentName}));
        
        if(mode === 'student') {
            document.body.classList.add('student-mode');
            currentClass = cls;
            switchClass(cls); // Populate list
            // Auto select
            setTimeout(() => {
                const btns = document.querySelectorAll('.student-btn');
                btns.forEach(b => { if(b.innerText === studentName) b.click(); });
                // Hide sidebar for student
                document.getElementById('sidebar').classList.remove('active');
                document.querySelector('.mobile-header h3').innerText = studentName;
            }, 300);
        } else {
            document.body.classList.remove('student-mode');
            currentClass = cls;
            refreshClassDropdowns();
        }
    }

    // --- MAIN LOGIC ---
    window.refreshClassDropdowns = () => {
        const sel = document.getElementById('classSelect');
        sel.innerHTML = '';
        Object.keys(classes).forEach(k => sel.innerHTML += `<option value="${k}">${k}</option>`);
        sel.value = currentClass;
        switchClass(currentClass);
    };

    window.switchClass = (cls) => {
        currentClass = cls;
        document.getElementById('currentClassDisplay').innerText = "ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞: " + cls;
        const list = document.getElementById('studentListContainer');
        list.innerHTML = '';
        (classes[cls] ? classes[cls].students : []).forEach(s => {
            const btn = document.createElement('button');
            btn.className = 'student-btn';
            btn.innerText = s.name;
            btn.onclick = () => {
                selectStudent(s.name, btn);
                if(window.innerWidth <= 768) toggleSidebar();
            };
            list.appendChild(btn);
        });
    };

    function selectStudent(name, btn) {
        currentStudent = name;
        document.querySelectorAll('.student-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('studentHeader').innerText = name;
        
        // AUTO FILL NEXT LESSON LOGIC
        const studs = records.filter(r => r.class === currentClass && (r.student === name) && r.type === 'daily');
        if(studs.length > 0) {
            studs.sort((a,b) => new Date(b.date) - new Date(a.date));
            const last = studs[0];
            if(last.new && last.new.p) {
                const nextP = parseInt(last.new.p) + 1;
                if(nextP <= 604) {
                    document.getElementById('newPage').value = nextP;
                    // Trigger auto load
                    autoLoadPage('new');
                }
            }
        }
        renderHistory();
    }

    window.autoLoadPage = async (sec) => {
        const p = document.getElementById(sec+'Page').value;
        if(!p) return;
        loadMushaf(p, true);
        setActiveSection(sec);
        document.querySelector(`input[name="activeSec"][value="${sec}"]`).checked = true;
        
        // Fetch Details
        document.getElementById(`loader-${sec}`).style.display = 'inline-block';
        try {
            const res = await fetch(`https://api.quran.com/api/v4/verses/by_page/${p}?per_page=300`);
            const d = await res.json();
            if(d.verses.length) {
                document.getElementById(sec+'Surah').value = d.verses[0].verse_key.split(':')[0];
                document.getElementById(sec+'Start').value = d.verses[0].verse_key.split(':')[1];
                document.getElementById(sec+'EndSurah').value = d.verses[d.verses.length-1].verse_key.split(':')[0];
                document.getElementById(sec+'End').value = d.verses[d.verses.length-1].verse_key.split(':')[1];
            }
        } catch(e) {} finally { document.getElementById(`loader-${sec}`).style.display = 'none'; }
    };

    // --- SAVING ---
    window.saveRecord = () => {
        if(!currentStudent) return alert("ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ∞");
        
        let rec = {
            id: editingRecordId || Date.now(),
            class: currentClass,
            student: currentStudent,
            date: document.getElementById('entryDate').value,
            teacher: document.getElementById('teacherName').value
        };

        const type = document.getElementById('lessonType').value;
        if(type === 'exam') {
            rec = { ...rec, type: 'exam',
                juzu: document.getElementById('examJuzu').value,
                portion: document.getElementById('examPortion').value,
                examiner: document.getElementById('examExaminer').value,
                mistakes: { teacher: document.getElementById('examTeacherMistakes').value, self: document.getElementById('examSelfMistakes').value },
                scores: { total: document.getElementById('totalExamScore').innerText },
                new: { dots: currentDots.exam } // Save dots
            };
        } else {
            rec.type = 'daily';
            // Only save active section details
            const active = currentActiveSection;
            const getVal = (id) => document.getElementById(id).value;
            const getTxt = (id) => { const e=document.getElementById(id); return e.value?e.options[e.selectedIndex].text.split('. ')[1]:""; };

            const buildObj = (s) => ({
                s: getTxt(s+'Surah'), es: getTxt(s+'EndSurah'),
                st: getVal(s+'Start'), en: getVal(s+'End'),
                m: getVal(s+'Mistakes'), p: s==='new'?getVal('newPage'):"",
                dots: currentDots[s]
            });
            
            // Merge with existing if editing to keep other sections
            let oldRec = editingRecordId ? records.find(r=>r.id===editingRecordId) : null;
            rec.new = (oldRec && active !== 'new') ? oldRec.new : (active === 'new' ? buildObj('new') : {s:"",m:0});
            rec.short = (oldRec && active !== 'short') ? oldRec.short : (active === 'short' ? buildObj('short') : {s:"",m:0});
            rec.long = (oldRec && active !== 'long') ? oldRec.long : (active === 'long' ? buildObj('long') : {s:"",m:0});
        }

        if(editingRecordId) records = records.filter(r => r.id !== editingRecordId);
        records.push(rec);
        saveData();
        renderHistory();
        if(!editingRecordId) clearForm();
        if(document.getElementById('editRecordModal').style.display==='flex') closeEditModal();
        alert("Saved");
    };

    // --- HISTORY ---
    function renderHistory() {
        const con = document.getElementById('historyContainer'); con.innerHTML = '';
        const data = records.filter(r => r.class === currentClass && (r.student === currentStudent)).sort((a,b)=>new Date(b.date)-new Date(a.date));
        
        data.forEach(r => {
            const card = document.createElement('div');
            let content = '';
            if(r.type === 'exam') {
                card.className = 'history-card exam-card';
                content = `<div class="card-header"><span class="card-date">üèÜ Exam J-${r.juzu}</span><span class="card-teacher">${r.scores.total}</span></div>
                           <div class="card-body"><div class="card-section">Examiner: ${r.examiner}</div></div>`;
            } else {
                card.className = 'history-card';
                const sec = (l, o, c) => (o && o.s) ? `<div class="card-section ${c}"><span class="section-label">${l}</span><div class="surah-name">${o.s} ${o.st}-${o.en}</div><span class="mistake-badge ${o.m>0?'red':'green'}">${o.m}</span></div>` : '';
                content = `<div class="card-header"><span class="card-date">${r.date}</span></div>
                           <div class="card-body">${sec('New', r.new, 'new')}${sec('Short', r.short, 'short')}${sec('Long', r.long, 'long')}</div>`;
            }
            // Edit buttons
            content += `<div style="padding:10px; border-top:1px solid #eee; display:flex; gap:10px;">
                <button class="btn btn-yellow teacher-only" style="font-size:12px; padding:5px;" onclick="editRecord(${r.id})">Edit</button>
                <button class="btn btn-blue" style="font-size:12px; padding:5px;" onclick="viewMistakes(${r.id})">View</button>
                <button class="btn btn-red delete-card-btn" style="font-size:12px; padding:5px;" onclick="delRec(${r.id})">Del</button>
            </div>`;
            card.innerHTML = content;
            con.appendChild(card);
        });
    }

    // --- HELPERS ---
    window.setActiveSection = (s) => { currentActiveSection=s; document.querySelectorAll('.section-box').forEach(b=>b.classList.remove('active-section')); document.getElementById('box-'+s).classList.add('active-section'); };
    window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebar-overlay').classList.toggle('active'); };
    window.loadMushaf = (p, sync=true) => {
        if(p<1||p>604) return; currentPage = parseInt(p);
        document.getElementById('navPage').value = currentPage; 
        document.getElementById('mushafImg').src = `https://android.quran.com/data/width_1260/page${currentPage.toString().padStart(3,'0')}.png`;
        clearDots();
        // Load dots for this page from current entry or edit record
        const sec = document.getElementById('lessonType').value === 'exam' ? 'exam' : currentActiveSection;
        (currentDots[sec]||[]).forEach(d => { if(parseInt(d.page) === currentPage) drawDot(d.x, d.y, true); });
    };
    function drawDot(x, y, active) {
        const dot = document.createElement('div'); dot.className = 'mistake-dot'; dot.style.left = x+'px'; dot.style.top = y+'px';
        if(active) dot.onclick = (e) => { e.stopPropagation(); dot.remove(); 
            const sec = document.getElementById('lessonType').value === 'exam' ? 'exam' : currentActiveSection;
            currentDots[sec] = currentDots[sec].filter(d => d.x!==x);
            adjustMistake(sec === 'exam' ? 'examTeacherMistakes' : currentActiveSection+'Mistakes', -1);
        };
        document.getElementById('mushafWrapper').appendChild(dot);
    }
    window.onImageClick = (e) => {
        if(document.body.classList.contains('student-mode')) return;
        if(e.target.classList.contains('mistake-dot')) return;
        const rect = document.getElementById('mushafWrapper').getBoundingClientRect();
        const x = e.clientX - rect.left; const y = e.clientY - rect.top;
        const sec = document.getElementById('lessonType').value === 'exam' ? 'exam' : currentActiveSection;
        currentDots[sec].push({page:currentPage, x:x, y:y});
        drawDot(x, y, true);
        adjustMistake(sec === 'exam' ? 'examTeacherMistakes' : currentActiveSection+'Mistakes', 1);
    };
    window.adjustMistake = (id, d) => { const e = document.getElementById(id); if(e) e.value = Math.max(0, (parseInt(e.value)||0)+d); if(id.includes('exam')) calculateExamScore(); };
    function clearDots() { document.querySelectorAll('.mistake-dot').forEach(d => d.remove()); }
    window.clearForm = () => {
        ['new','short','long'].forEach(s => {
             const m = document.getElementById(s+'Mistakes'); if(m) m.value=0;
             const p = document.getElementById(s+'Page'); if(p) p.value='';
        });
        currentDots = { new: [], short: [], long: [], exam: [] };
        clearDots();
    };

    // --- EDIT MODAL LOGIC ---
    window.editRecord = (id) => {
        const r = records.find(x => x.id === id);
        if(!r) return;
        editingRecordId = id;
        document.getElementById('editModalBody').innerHTML = `
            <label>Date</label><input type="date" id="eDate" value="${r.date}" class="login-input"><br>
            <label>Mistakes (Active Sec)</label><input type="number" id="eMistakes" value="${r.new ? r.new.m : 0}" class="login-input"><br>
            <button class="btn btn-green" onclick="saveEdited(${id})" style="width:100%; margin-top:10px;">Update</button>
        `;
        document.getElementById('editRecordModal').style.display = 'flex';
        // Simplified edit for brevity - real version should have full fields
    };
    window.saveEdited = (id) => {
        const r = records.find(x => x.id === id);
        r.date = document.getElementById('eDate').value;
        if(r.new) r.new.m = document.getElementById('eMistakes').value;
        saveData(); renderHistory(); closeEditModal();
    };
    window.closeEditModal = () => document.getElementById('editRecordModal').style.display = 'none';
    window.delRec = (id) => { if(confirm("Delete?")) { records = records.filter(r=>r.id!==id); saveData(); renderHistory(); } };

</script>
</body>
</html>
